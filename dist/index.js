"use strict";var Aa=Object.create;var qt=Object.defineProperty;var $a=Object.getOwnPropertyDescriptor;var Da=Object.getOwnPropertyNames;var Ia=Object.getPrototypeOf,Fa=Object.prototype.hasOwnProperty;var Qe=(e,t)=>{for(var r in t)qt(e,r,{get:t[r],enumerable:!0})},fs=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Da(t))!Fa.call(e,s)&&s!==r&&qt(e,s,{get:()=>t[s],enumerable:!(o=$a(t,s))||o.enumerable});return e};var A=(e,t,r)=>(r=e!=null?Aa(Ia(e)):{},fs(t||!e||!e.__esModule?qt(r,"default",{value:e,enumerable:!0}):r,e)),ja=e=>fs(qt({},"__esModule",{value:!0}),e);var ns={};Qe(ns,{AbstractRequestClient:()=>at,ExecuteHook:()=>Re,HookCancel:()=>it,HttpSymbol:()=>R,HttpSymbolKind:()=>N,LogLevel:()=>$e,OnRequestHook:()=>he,OnResponseHook:()=>ye,OnStreaming:()=>be,ParseEndRegionHook:()=>rt,ParseHook:()=>Ze,ParseMetaDataHook:()=>et,ProvideAssertValue:()=>tt,ProvideEnvironmentsHook:()=>st,ProvideVariablesHook:()=>ot,RepeatOrder:()=>Et,ReplaceVariableHook:()=>nt,RequestClientEvent:()=>ne,ResponseLoggingHook:()=>xe,TestResultStatus:()=>X,VariableType:()=>Z,cli:()=>ms,createEmptyProcessorContext:()=>ls,getEnvironments:()=>fu,getVariables:()=>xa,io:()=>j,send:()=>as,store:()=>Ao,testSymbols:()=>J,utils:()=>y});module.exports=ja(ns);var ms={};Qe(ms,{createProgram:()=>Ea,execute:()=>Uu,initFileProvider:()=>Ms,initIOProvider:()=>Lo});var qa=require("path");var y={};Qe(y,{ENVIRONMENT_NONE:()=>vs,HandlebarsSingleLine:()=>gt,OAuth2Regex:()=>Pl,RegionSeparator:()=>Te,addHttpFileRequestClientHooks:()=>ft,addSkippedTestResult:()=>Q,addTestResultToHttpRegion:()=>me,assertHasNoResponseBody:()=>no,assertHasResponseBody:()=>so,assertHeaderContains:()=>oo,assertHeaderEquals:()=>ro,assertMaxTotalTime:()=>to,assertResponseBodyEquals:()=>io,assertStatusEquals:()=>eo,cleanVariables:()=>Ft,cloneRequest:()=>bs,cloneResponse:()=>ae,createResponseProxy:()=>jt,decodeJWT:()=>zr,defaultConfigFiles:()=>Dt,deleteHeader:()=>Jr,deleteVariableInContext:()=>Ce,distinct:()=>Va,ensureString:()=>Fe,equalsPath:()=>lo,errorToString:()=>al,executeGlobalScripts:()=>Be,executeRequestClientFactory:()=>go,expandVariable:()=>Ps,extensionName:()=>ao,findHttpRegionInContext:()=>Me,findRootDir:()=>At,findRootDirOfFile:()=>Ot,getBufferEncoding:()=>Ve,getDisplayName:()=>ct,getHeader:()=>E,getHeaderArray:()=>za,getHeaderBoolean:()=>Wa,getHeaderNumber:()=>Ja,getHeaderString:()=>Ga,getHttpyacConfig:()=>uo,getMarkdownSyntax:()=>Os,getPartOfBody:()=>Yr,getPlugins:()=>po,getRegionDescription:()=>ho,importHttpFileInContext:()=>bt,isBufferEncoding:()=>xs,isError:()=>te,isHttpRegionSendContext:()=>Ho,isHttpRegionsSendContext:()=>Co,isHttpRequest:()=>O,isHttpRequestMethod:()=>Ka,isHttpResponse:()=>Qr,isMimeTypeCSS:()=>_r,isMimeTypeFormUrlEncoded:()=>ke,isMimeTypeHtml:()=>Ur,isMimeTypeImage:()=>Ua,isMimeTypeJSON:()=>dt,isMimeTypeJavascript:()=>Mr,isMimeTypeMarkdown:()=>ut,isMimeTypeMultiPartFormData:()=>Kr,isMimeTypeMultiPartMixed:()=>Gr,isMimeTypeNewlineDelimitedJSON:()=>Wr,isMimeTypePdf:()=>Na,isMimeTypeXml:()=>Nr,isOpenIdInformation:()=>vl,isProcessorContext:()=>kl,isPromise:()=>Ne,isString:()=>c,isStringEmpty:()=>ve,isUndefined:()=>Ie,iterateDirectoryTree:()=>$t,iterateUntilRoot:()=>pe,joinMarkdown:()=>Vt,knownMetaData:()=>Fs,logResponse:()=>Se,mergeRawHttpHeaders:()=>el,mergeResponses:()=>It,parseComments:()=>ht,parseContentType:()=>Pe,parseDefaultHeadersFactory:()=>Ro,parseError:()=>we,parseFileImport:()=>yt,parseHandlebarsString:()=>M,parseHandlebarsSymbols:()=>re,parseInlineResponse:()=>Po,parseJson:()=>pt,parseMimeType:()=>lt,parseQueryLineFactory:()=>ko,parseRequestHeaderFactory:()=>Mt,parseRequestLineFactory:()=>wo,parseSubsequentLines:()=>Bt,parseUrlLineFactory:()=>vo,promiseQueue:()=>So,randomArrayValue:()=>To,randomData:()=>xt,randomEmail:()=>Ue,randomText:()=>G,repeat:()=>mo,replaceFilePath:()=>le,replaceInvalidChars:()=>tl,replaceVariables:()=>I,report:()=>S,requestLoggerFactory:()=>Xr,resolveClientCertificates:()=>Rs,setVariableInContext:()=>F,shortenFileName:()=>rl,shrinkCloneResponse:()=>Zr,sleep:()=>ce,stateGenerator:()=>Ba,stringifySafe:()=>$,testFactory:()=>mt,testFactoryAsync:()=>co,toAbsoluteFilename:()=>V,toBoolean:()=>ue,toBufferLike:()=>ie,toEnvironmentKey:()=>B,toHttpString:()=>xl,toHttpStringHeader:()=>yo,toHttpStringRequest:()=>qs,toHttpStringResponse:()=>Ls,toMarkdown:()=>Rl,toMarkdownHeader:()=>bo,toMarkdownMeta:()=>Ds,toMarkdownRequest:()=>As,toMarkdownResponse:()=>Es,toMarkdownTestResults:()=>$s,toMarkdownTimings:()=>Is,toMultiLineArray:()=>Y,toMultiLineString:()=>U,toNumber:()=>P,toQueryParams:()=>Xa,toString:()=>x,unsetVariableInContext:()=>dl,useDefaultOnError:()=>He});function Va(e){function t(r,o,s){return s.indexOf(r)===o}return e.filter(t)}var _=A(require("chalk")),ys=require("util");var j={};Qe(j,{Logger:()=>De,completionItemProvider:()=>W,fileProvider:()=>p,httpClientProvider:()=>se,javascriptProvider:()=>H,log:()=>f,userInteractionProvider:()=>q});var W={emptyLineProvider:[],variableProvider:[],requestHeaderProvider:[]};var p={EOL:`\r
`,exists:()=>{throw new Error("Not Implemented")},dirname:()=>{throw new Error("Not Implemented")},hasExtension:()=>{throw new Error("Not Implemented")},isAbsolute:()=>{throw new Error("Not Implemented")},joinPath:()=>{throw new Error("Not Implemented")},readFile:()=>{throw new Error("Not Implemented")},readBuffer:()=>{throw new Error("Not Implemented")},writeBuffer:()=>{throw new Error("Not Implemented")},readdir:()=>{throw new Error("Not Implemented")},fsPath:gs,toString:gs};function gs(e){return typeof e=="string"?e:e.toString()}var se={};var H={require:{},evalExpression:async function(t,r){return r.variables[t]}};var K=require("hookpoint"),Ze=class extends K.LastOutHook{constructor(){super(t=>!!t),this.id="ParseHook"}},et=class extends K.LastOutHook{constructor(){super(t=>!!t),this.id="ParseMetaDataHook"}},tt=class extends K.LastOutHook{constructor(){super(t=>t!==!1),this.id="ProvideAssertValue"}},rt=class extends K.SeriesHook{constructor(){super(),this.id="ParseEndRegionHook"}},ot=class extends K.SeriesHook{constructor(){super(),this.id="ProvideVariablesHook"}},st=class extends K.SeriesHook{constructor(){super(),this.id="ProvideEnvironmentsHook"}},nt=class extends K.WaterfallHook{constructor(){super(t=>t===void 0),this.id="ReplaceVariableHook"}},he=class extends K.SeriesHook{constructor(){super(),this.id="BeforeRequestHook"}},ye=class extends K.SeriesHook{constructor(){super(),this.id="AfterRequestHook"}},be=class extends K.SeriesHook{constructor(){super(),this.id="OnStreaming"}},xe=class extends K.SeriesHook{constructor(){super(),this.id="ResponseLoggingHook"}},Re=class extends K.SeriesHook{constructor(){super(t=>!t),this.id="ExecuteHook"}};var hs=require("hookpoint"),it=hs.HookCancel;var R=class{constructor(t){this.name=t.name||"symbol",this.description=t.description,this.kind=t.kind,this.startLine=t.startLine,this.startOffset=t.startOffset,this.endLine=t.endLine,this.endOffset=t.endOffset,this.children=t.children,this.source=t.source}getSymbolsForLine(t){let r=[];if((this.startLine<=t||this.endLine>=t)&&(r.push(this),this.children))for(let o of this.children)r.push(...o.getSymbolsForLine(t));return r}filter(t){let r=[];if(t(this)&&r.push(this),this.children)for(let o of this.children)r.push(...o.filter(t));return r}};var N=(h=>(h.request="request",h.requestLine="requestLine",h.requestHeader="requestHeader",h.requestBody="requestBody",h.response="response",h.gql="gql",h.proto="proto",h.script="script",h.metaData="metaData",h.comment="comment",h.url="url",h.operator="operator",h.key="key",h.value="value",h.variable="variable",h.path="path",h.variableDefinition="variableDefinition",h.text="text",h))(N||{});var $e=(i=>(i[i.trace=1]="trace",i[i.debug=2]="debug",i[i.warn=5]="warn",i[i.info=10]="info",i[i.error=100]="error",i[i.none=1e3]="none",i))($e||{});var Et=(r=>(r[r.sequential=0]="sequential",r[r.parallel=1]="parallel",r))(Et||{});var ne=class extends Event{constructor(r,o){super(r);this.detail=o}},at=class{constructor(){this.eventEmitter=new EventTarget}addEventListener(t,r){this.eventEmitter.addEventListener(t,o=>this.isRequestClientEvent(o)?r(o):void 0)}removeEventListener(t,r){this.eventEmitter.removeEventListener(t,o=>this.isRequestClientEvent(o)?r(o):void 0)}isRequestClientEvent(t){return t instanceof ne}onMessage(t,r){this.eventEmitter.dispatchEvent(new ne("message",[t,r]))}onProgress(t){this.eventEmitter.dispatchEvent(new ne("progress",t))}onMetaData(t,r){this.eventEmitter.dispatchEvent(new ne("metaData",[t,r]))}onDisconnect(){this.eventEmitter.dispatchEvent(new ne("disconnect",void 0))}triggerEnd(){this.eventEmitter.dispatchEvent(new ne("end",void 0))}};var J={ok:"\u2713",error:"\u2716",skipped:"\u25CB"};var X=(s=>(s.SUCCESS="SUCCESS",s.FAILED="FAILED",s.SKIPPED="SKIPPED",s.ERROR="ERROR",s))(X||{});var Z=(s=>(s.variable="Variable",s.url="Url",s.body="Body",s.filePath="FilePath",s))(Z||{});var De=class{constructor(t,r){this.options=t;this.parentLogger=r}collectMessages(){var t;(t=this.parentLogger)==null||t.collectMessages(),this.collectCache=[],this.priorityCache=[]}flush(){var t;(t=this.parentLogger)==null||t.flush(),this.priorityCache=this.flushCache(this.priorityCache),this.collectCache=this.flushCache(this.collectCache)}flushCache(t){if(t){for(let r of t)r();return[]}}writeLog(t,r,o,s){var n,i;if(!((n=this.options)!=null&&n.level)||t>=this.options.level){let a=()=>o(...s);(i=this.options)!=null&&i.logMethod&&(a=()=>{var d,l;return(l=(d=this.options)==null?void 0:d.logMethod)==null?void 0:l.call(d,t,...s)}),r?r.push(a):a()}}info(...t){var r;(r=this.parentLogger)==null||r.info(...t),this.writeLog(10,this.collectCache,console.info,t)}log(...t){var r;(r=this.parentLogger)==null||r.log(...t),this.writeLog(10,this.collectCache,console.log,t)}trace(...t){var r;(r=this.parentLogger)==null||r.trace(...t),this.writeLog(1,this.collectCache,this.options.noTrace?console.debug:console.trace,t)}debug(...t){var r;(r=this.parentLogger)==null||r.debug(...t),this.writeLog(2,this.collectCache,console.debug,t)}error(...t){var r;(r=this.parentLogger)==null||r.error(...t),this.writeLog(100,this.collectCache,console.error,t)}warn(...t){var r;(r=this.parentLogger)==null||r.warn(...t),this.writeLog(5,this.collectCache,console.warn,t)}logPriority(...t){this.writeLog(10,this.priorityCache,console.info,t)}clear(){console.clear()}},f=new De({level:5,noTrace:!0});var q={isTrusted:()=>!0,showNote:async function(){throw new Error("Not Implemented")},showInputPrompt:async function(){throw new Error("Not Implemented")},showListPrompt:async function(){throw new Error("Not Implemented")}};function U(e){return e.join(p.EOL)}function Y(e){return e.split(/\r?\n/gu)}function Ie(e){return typeof e>"u"}function c(e){return typeof e=="string"}function ve(e){return typeof e=="string"&&/^(\s*)?$/u.test(e)}function Ba(e=30){let t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-._~",r=[];for(let o=e;o>0;--o)r.push(t[Math.floor(Math.random()*t.length)]);return r.join("")}function x(e){if(c(e))return e;if(typeof e=="number")return`${e}`;if(e instanceof Date)return e.toISOString();if(e instanceof Error)return e.message;if(Buffer.isBuffer(e))return e.toString("utf-8");if(Array.isArray(e)&&e.every(t=>Buffer.isBuffer(t))){let t=e.map(r=>Buffer.isBuffer(r)&&r.toString("utf8"));return $(t)}if(e)return $(e)}function $(e,t=0){try{return JSON.stringify(e,(r,o)=>Ma(o)?Buffer.from(o.data).toString("base64"):o,t)}catch(r){return f.debug("JSON.stringify error",r),JSON.stringify(e,(()=>{let s=new WeakSet;return(n,i)=>{if(typeof i=="object"&&i!==null){if(s.has(i))return;s.add(i)}return i}})(),t)}}function Fe(e){return typeof e>"u"||e===null||c(e)?e:`${e}`}function Ma(e){let t=e;return(t==null?void 0:t.type)==="Buffer"&&Array.isArray(t.data)&&!!t.data.length}function ue(e,t=!1){var s;if(typeof e=="boolean")return e;if(typeof e=="number")return!!e;let r=(s=Fe(e))==null?void 0:s.trim();if(!r)return t;if(/^true$/iu.test(r))return!0;if(/^false$/iu.test(r))return!1;let o=parseFloat(r);return isNaN(o)?t:!!o}function P(e){if(typeof e=="number")return e;let t=Fe(e);if(t){let r=Number.parseFloat(t.trim());if(!Number.isNaN(r))return r}}function ie(e){return Buffer.isBuffer(e)?e:x(e)}function lt(e){var n,i;let[t,...r]=e.split(";").map(a=>a.trim()),o=(n=r.find(a=>a.startsWith("charset=")))==null?void 0:n.split("=")[1],s=(i=r.find(a=>a.startsWith("boundary=")))==null?void 0:i.split("=")[1];return{mimeType:t,contentType:e,charset:o,boundary:s}}function dt(e){return!!e&&(e.mimeType==="application/json"||e.mimeType==="text/json"||e.mimeType.indexOf("+json")>=0||e.mimeType.indexOf("x-amz-json")>=0)}function Mr(e){return(e==null?void 0:e.mimeType)==="application/javascript"||(e==null?void 0:e.mimeType)==="text/x-javascript"}function Nr(e){return!!e&&(e.mimeType==="application/xml"||e.mimeType==="text/xml"||e.mimeType.indexOf("+xml")>=0)}function Ur(e){return(e==null?void 0:e.mimeType)==="text/html"}function _r(e){return(e==null?void 0:e.mimeType)==="text/css"}function ut(e){return(e==null?void 0:e.mimeType)==="text/markdown"}function Kr(e){return(e==null?void 0:e.mimeType)==="multipart/form-data"}function Gr(e){return(e==null?void 0:e.mimeType)==="multipart/mixed"}function Wr(e){return(e==null?void 0:e.mimeType)==="application/x-ndjson"}function ke(e){return(e==null?void 0:e.mimeType)==="application/x-www-form-urlencoded"}function Na(e){return(e==null?void 0:e.mimeType)==="application/pdf"}function Ua(e){return e?["image/jpeg","image/gif","image/webp","image/png","image/bmp"].indexOf(e.mimeType)>=0:!1}function Ka(e){return e?["ACL","BASELINE-CONTROL","CHECKIN","CHECKOUT","CONNECT","COPY","DELETE","GET","GRAPHQL","HEAD","LOCK","MERGE","MKACTIVITY","MKCALENDAR","MKCOL","MKWORKSPACE","MOVE","OPTIONS","PATCH","POST","PROPFIND","PROPPATCH","PUT","REPORT","SEARCH","TRACE","UNLOCK","VERSION-CONTROL"].includes(e.toUpperCase()):!1}function O(e){return(e==null?void 0:e.protocol)==="HTTP"}function Jr(e,...t){if(e)for(let r of t){let o=Object.entries(e).find(([s])=>s.toLowerCase()===r.toLowerCase());o&&o.length>1&&delete e[o[0]]}}function Ga(e,t){let r=E(e,t);if(c(r))return r}function Wa(e,t,r=!1){let o=E(e,t);return ue(o,r)}function E(e,t){if(e){let r=Object.entries(e).find(([o])=>o.toLowerCase()===t.toLowerCase());if(r&&r.length>1)return r[1]}}function Ja(e,t){let r=E(e,t);return P(r)}function za(e,t,r=[]){let o=E(e,t);return o?c(o)?[o]:o:r}function Pe(e){let t=E(e,"content-type");if(c(t))return lt(t)}function zr(e){try{let t=e.split(".");if(t.length!==3)return null;let r=t[1];switch(r=r.replace(/-/gu,"+"),r=r.replace(/_/gu,"/"),r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:return null}let o=new ys.TextDecoder().decode(Buffer.from(r,"base64"));return JSON.parse(o)}catch(t){return f.warn(t),null}}function Xa(e){return Object.entries(e).filter(([,t])=>!!t).map(([t,r])=>Array.isArray(r)?r.map(o=>`${t}=${encodeURIComponent(o||"")}`).join("&"):`${t}=${encodeURIComponent(r||"")}`).join("&")}function Xr(e,t,r){return async function(s,n){var d,l,u,m,g,v,k,L,D,b;let i=t;if(r&&(n!=null&&n.testResults)&&n.testResults.some(h=>["FAILED","ERROR"].includes(h.status))&&(i=r),!i||i.onlyFailed&&(!(n!=null&&n.testResults)||n.testResults.every(h=>h.status==="SUCCESS")))return;if(e(""),e("---------------------"),e(""),(d=n==null?void 0:n.metaData)!=null&&d.title||(l=n==null?void 0:n.metaData)!=null&&l.name||(u=n==null?void 0:n.metaData)!=null&&u.description){let h=((m=n==null?void 0:n.metaData)==null?void 0:m.title)||((g=n==null?void 0:n.metaData)==null?void 0:g.name);h&&e(_.default`{gray === ${h} ===}`),(v=n==null?void 0:n.metaData)!=null&&v.description&&e(_.default`{gray ${n.metaData.description}}`),e("")}let a=(s==null?void 0:s.request)||(n==null?void 0:n.request);if(a&&(i.useShort?e(_.default`{yellow ${(a==null?void 0:a.method)||"GET"}} {gray ${(a==null?void 0:a.url)||"?"}}`):i.requestOutput&&Ya(a,{headers:i.requestHeaders,bodyLength:i.requestBodyLength}).forEach(h=>e(h))),s)if(i.useShort)e(_.default`{gray =>} {cyan.bold ${s.statusCode}} ({yellow ${((k=s.timings)==null?void 0:k.total)||"?"} ms}, {yellow ${((L=s.meta)==null?void 0:L.size)||"?"}})`);else{let h=[];if(i.responseHeaders&&(h.length>0&&h.push(""),h.push(...Qa(s))),i.timings&&(h.length>0&&h.push(""),h.push(...Za(s))),c(s.body)&&i.responseBodyLength!==void 0){let T=s.body;i.responseBodyPrettyPrint&&s.prettyPrintBody&&(T=s.prettyPrintBody),T=Yr(T,i.responseBodyLength),T&&(h.length>0&&h.push(""),h.push(T))}e(U(h))}if(n!=null&&n.testResults)for(let h of n.testResults){let T=_.default`{green ${J.ok} ${h.message||"Test passed"}}`;if(h.status==="SKIPPED")T=_.default`{yellow ${J.skipped} Test skipped}`;else if(["ERROR","FAILED"].includes(h.status)){let Xe=h.error?` (${(D=h.error)==null?void 0:D.displayMessage})`:"";if(T=_.default`{red ${J.error} ${h.message||"Test failed"}${Xe}}`,!(t!=null&&t.useShort)&&h.status==="ERROR"&&((b=h.error)!=null&&b.error.stack)){let Ye=Y(h.error.error.stack).slice(0,3);T=U([T,...Ye])}}e(T)}}}function Yr(e,t){let r=e;if(!(typeof t>"u"||t<0))return t>0&&(r=e.slice(0,Math.min(e.length,t)),e.length>=t&&(r+=`... (${e.length-t} characters more)`)),r}function Ya(e,t){var o,s,n,i;let r=[];return r.push(_.default`{cyan.bold ${e.method} ${e.url}}`),e.headers&&t.headers&&r.push(...Object.entries(e.headers).map(([a,d])=>_.default`{yellow ${a}}: ${d}`).sort()),O(e)&&((s=(o=e.options)==null?void 0:o.https)!=null&&s.certificate||(i=(n=e.options)==null?void 0:n.https)!=null&&i.pfx)&&r.push(_.default`{yellow client-cert}: true`),c(e.body)&&t.bodyLength!==void 0&&(r.push(""),r.push(_.default`{gray ${Yr(e.body,t.bodyLength)}}`)),r}function Qa(e){let t=[];return t.push(_.default`{cyan.bold ${e.protocol}} {cyan.bold ${e.statusCode}} {bold ${e.statusMessage?` - ${e.statusMessage}`:""}}`),e.headers&&t.push(...Object.entries(e.headers).filter(([r])=>!r.startsWith(":")).map(([r,o])=>_.default`{yellow ${r}}: ${o}`).sort()),t}function Za(e){let t=[];return e.timings&&(t.push(_.default`{cyan.bold Timings}:`),t.push(...Object.entries(e.timings).filter(([,r])=>!!r).map(([r,o])=>_.default`{yellow ${r}}: ${o}`).sort())),t}function bs(e){return{url:e.url,method:e.method,body:e.body,contentType:e.contentType&&{...e.contentType},headers:e.headers&&{...e.headers},supportsStreaming:e.supportsStreaming}}function Qr(e){let t=e;return!!(t!=null&&t.statusCode)}function Zr(e){let t=ae(e);return delete t.rawBody,delete t.prettyPrintBody,delete t.request,t}function ae(e){return{name:e.name,protocol:e.protocol,statusCode:e.statusCode,statusMessage:e.statusMessage,httpVersion:e.httpVersion,headers:e.headers,body:e.body,rawHeaders:e.rawHeaders,rawBody:e.rawBody,parsedBody:e.parsedBody,prettyPrintBody:e.prettyPrintBody,contentType:e.contentType,timings:e.timings&&{...e.timings},meta:e.meta,tags:e.tags,request:e.request&&bs(e.request)}}function el(e){let t={};for(let r=0;r<e.length;r+=2){let o=e[r],s=e[r+1];if(typeof s>"u")continue;let n=o.toLowerCase();t[n]=t[n]||[],t[n].push(s)}return t}function je(e,t){if(!e)throw new Error(t)}function eo(e,t){je(e.statusCode===t,`response status is ${e.statusCode} (expected: ${t})`)}function to(e,t){var r,o;je((r=e.timings)!=null&&r.total?e.timings.total<t:!0,`total time is ${(o=e.timings)==null?void 0:o.total} (expected max ${t})`)}function ro(e,t,r){let o=E(e.headers,t);je(o===r,`response header ${t} is ${o} (expected: ${r})`)}function oo(e,t,r){let o=E(e.headers,t);(c(o)||Array.isArray(o))&&je(!!o.indexOf(r),`response header contains ${r}`)}function so(e){console.assert(!!e.body,"response body exists")}function no(e){je(!e.body,"response body does not exists")}function io(e,t){je(e.body===t,`response body equals ${t}`)}function xs(e){return["ascii","utf8","utf-8","utf16le","ucs2","ucs-2","base64","latin1","binary","hex"].indexOf(e)>=0}function Ve(e){return e&&xs(e)?e:"utf8"}async function V(e,t){if(e){if(await p.isAbsolute(e)&&await p.exists(e))return e;if(t&&c(e)){let r=p.joinPath(t,e);if(await p.exists(r))return r}}}function ao(e){let t=p.toString(e),r=t.lastIndexOf(".");if(r>0&&r<t.length-2)return t.slice(r+1)}function tl(e){return e.replace(/[/\\?%*:|"<>\s()@\-~,=$]/gu,"_").split("_").filter(r=>r.length>0).join("_")}function rl(e,t=50){let r=[],o=0;for(let n of e.split("_").reverse())n.length+o<t?(r.push(n),o+=n.length+1):r.length===0&&r.push(n);let s=r.reverse().join("_");return s.slice(Math.max(s.length-t,0))}async function Ot(e,t,...r){let o=e,s=p.fsPath(e);!await p.isAbsolute(e)&&t&&s&&(o=p.joinPath(t,s));let n=p.dirname(o);return await At(n,...r)}async function At(e,...t){return $t(e,async r=>{let o=await p.readdir(r);if(o.some(s=>t.indexOf(s)>=0))return!0;for(let s of t)if(o.some(n=>s.startsWith(n))&&await p.exists(p.joinPath(r,s)))return!0;return!1})}async function pe(e,t,r){return $t(e,async o=>(await r(o),!!t&&lo(t,o)))}async function $t(e,t){if(e){if(await t(e))return e;if(!lo(p.dirname(e),e))return $t(p.dirname(e),t)}}function lo(e,t){return!!e&&!!t&&p.toString(e)===p.toString(t)}async function uo(e,t){let r;return t&&(r=await ol(t),r||(r=await sl(e,t)),r&&await Rs(r,t)),r}var Dt=[".httpyac.js",".httpyac.cjs",".httpyac.config.js",".httpyac.config.cjs","httpyac.config.js","httpyac.config.cjs",".httpyac.json","httpyac.config.json"];async function ol(e){let t;for(let r of Dt){let o=r&&p.joinPath(e,r);if(o&&await p.exists(o)){t=p.fsPath(o);break}}if(t){let r=p.fsPath(e);if(r&&H.loadModule){let o=H.loadModule(t,r,!0);return typeof o=="function"?o():o}}}async function sl(e,t){let r=[];if(await pe(e,t,async o=>{var n;let s=(n=await pt(p.joinPath(o,"package.json")))==null?void 0:n.httpyac;s&&r.push(s)}),r.length>0)return Object.assign({},...r.reverse())}async function pt(e){try{if(await p.exists(e)){let t=await p.readFile(e,"utf-8");return JSON.parse(t)}}catch(t){f.debug(`json parse of ${e} failed`,t)}}async function Rs(e,t){if(e.clientCertificates)for(let[,r]of Object.entries(e.clientCertificates))r.cert&&(r.cert=await V(r.cert,t)||r.cert),r.key&&(r.key=await V(r.key,t)||r.key),r.pfx&&(r.pfx=await V(r.pfx,t)||r.pfx)}async function po(e){let t=await nl(e),r={};if(t!=null&&t.json){let o=[...Object.keys(t.json.dependencies||{}),...Object.keys(t.json.devDependencies||{})].filter(il);for(let s of o){let n=p.fsPath(t.dir);if(n&&H.loadModule){let i=H.loadModule(s,n);i&&(r[s]=i)}}}return r}async function nl(e){let t=await At(e,"package.json");if(t)return{dir:t,json:await pt(p.joinPath(t,"package.json"))}}function il(e){return/^(httpyac-|@[\w-]+(\.)?[\w-]+\/httpyac-)plugin-/u.test(e)}var vs="__NONE__";function B(e){return e&&e.length>0?e.sort().join(","):vs}function te(e){if(!e)return!1;if(e instanceof Error)return!0;let t=e;return!!t.message&&!!t.stack&&!!t.name}function we(e){var t;if(e.stack){let r=/^(?<error>.*):\s*(?<message>.*)\r?\n\s*at (?<file>.*):(?<line>\d*):(?<offset>\d*)/mu.exec(e.stack);if(r&&((t=r.groups)!=null&&t.error))return{error:e,errorType:r.groups.error,message:r.groups.message,file:r.groups.file,line:r.groups.line,offset:r.groups.offset,displayMessage:`${r.groups.error}: ${r.groups.message} - ${r.groups.file}:${r.groups.line}:${r.groups.offset}`}}return{error:e,displayMessage:e.message}}function al(e){return te(e)?$({message:e.message,name:e.name,stack:e.stack}):x(e)}async function He(e,t){try{return await e}catch(r){return f.warn("promise has read error",r),t}}var Ts=require("hookpoint");var fo=require("hookpoint");function S(e,t){var r,o;f.debug(t),(o=(r=e.progress)==null?void 0:r.report)==null||o.call(r,{message:t})}async function mo(e,t){var n,i;let r=[],o=1;(n=t.repeat)!=null&&n.count&&t.isMainContext&&(o=t.repeat.count);for(let a=0;a<o;a++)r.push(e);let s=[];if(((i=t.repeat)==null?void 0:i.type)===1){let a=await Promise.all(r.map(d=>d()));for(let d of a)d&&a.push(d)}else for(let a of r){let d=await a();d&&s.push(d)}return It(s)}function It(e){if(e.length>1){let t=ae(e[0]);delete t.prettyPrintBody,delete t.rawBody,delete t.meta,delete t.timings;let r={responses:[],statusCount:{},count:e.length},o=[];for(let s of e){s.statusCode>t.statusCode&&(t.statusCode=s.statusCode,t.statusMessage=s.statusMessage);let n=`${s.statusCode}`;r.statusCount[n]?r.statusCount[n]+=1:r.statusCount[n]=1,s.timings&&o.push(s.timings),delete s.prettyPrintBody,delete s.parsedBody,delete s.rawBody,r.responses.push(ae(s)),o.length>0&&(t.timings=ll(o))}return t.parsedBody=r,t.body=$(r,2),t}return e.pop()}function ll(e){let t=[],r=[],o=[],s=[],n=[],i=[],a=[],d=[];for(let u of e)t.push(u.dns||0),r.push(u.download||0),o.push(u.firstByte||0),s.push(u.request||0),n.push(u.tcp||0),i.push(u.tls||0),a.push(u.total||0),d.push(u.wait||0);let l=u=>{let m=u.filter(g=>g>0);if(m.length>0)return m.reduce((g,v)=>g+v,0)/m.length};return{dns:l(t),download:l(r),firstByte:l(o),request:l(s),tcp:l(n),tls:l(i),total:l(a),wait:l(d)}}var ks=require("hookpoint");async function I(e,t,r){var o,s;return(s=(o=r.progress)==null?void 0:o.isCanceled)!=null&&s.call(o)?(f.trace("process canceled by user"),ks.HookCancel):await r.httpFile.hooks.replaceVariable.trigger(e,t,r)}async function le(e,t,r){var s,n,i,a;let o=await I(e,"FilePath",t);if(c(o)){let d=await V(o,p.dirname(t.httpFile.fileName));if(d)return await r(d);let l=`file not found: ${e}`;(n=(s=q).showWarnMessage)==null||n.call(s,l),f.warn(l)}else{let d=`file replace made file invalid: ${e} <> ${o}`;(a=(i=q).showWarnMessage)==null||a.call(i,d),f.warn(d)}}function Ps(e,t){if(e&&c(e)){let r=e,o,s=/\{{2}\s*([a-zA-Z0-9_]+)\s*\}{2}/gu;for(;(o=s.exec(r))!==null;){let[n,i]=o,a=Ps(t[i],t);t[i]=a,r=r.replace(n,()=>`${a}`)}return r}return e}function F(e,t){if(e){let r=Ft(e);Object.assign(t.variables,r);let o=B(t.activeEnvironment);t.httpRegion.variablesPerEnv[o]||(t.httpRegion.variablesPerEnv[o]={}),Object.assign(t.httpRegion.variablesPerEnv[o],r)}}function Ft(e){return Object.fromEntries(Object.entries(e).filter(([t])=>!H.isAllowedKeyword||H.isAllowedKeyword(t)))}function Ce(e,t){delete t.variables[e];let r=B(t.activeEnvironment);t.httpRegion.variablesPerEnv[r]&&delete t.httpRegion.variablesPerEnv[r][e]}function dl(e,t){let r=B(t.activeEnvironment),o=t.httpRegion.variablesPerEnv[r];for(let s of Object.keys(e))delete t.variables[s],o&&delete o[s]}var Cs=require("uuid");function co({httpRegion:e},t){return async function(o,s){var i;let n={message:o,status:"SUCCESS"};if(typeof s=="function")try{await s(n)}catch(a){ws(n,a),t.ignoreErrorFile&&((i=n.error)!=null&&i.errorType)&&(n.error.displayMessage=`${n.error.errorType}: ${n.error.message}`)}me(e,n)}}function ws(e,t){e.status="FAILED",te(t)?e.error=we(t):e.error={displayMessage:`${t}`,error:new Error(`${t}`)}}function mt({httpRegion:e,variables:t}){let r=function(n,i){let a={message:n,status:"SUCCESS"};if(typeof i=="function")try{i()}catch(d){ws(a,d)}me(e,a)};function o(){return Qr(t.response)?t.response:e.response}return r.status=s=>{let n=o();n&&r(`response status equals to ${s}`,()=>eo(n,s))},r.totalTime=s=>{let n=o();n&&r(`total time exceeded ${s}`,()=>to(n,s))},r.header=(s,n)=>{let i=o();i&&r(`response header ${s} equals ${n}`,()=>ro(i,s,n))},r.headerContains=(s,n)=>{let i=o();i&&r(`response header ${s} contains ${n}`,()=>oo(i,s,n))},r.responseBody=s=>{let n=o();n&&r(`response body equals ${s}`,()=>io(n,s))},r.hasResponseBody=()=>{let s=o();s&&r("response body exists",()=>so(s))},r.hasNoResponseBody=()=>{let s=o();s&&r("response body does not exists",()=>no(s))},r}function me(e,t){e.testResults||(e.testResults=[]),e.testResults.push(t)}function Q(e,t="request is skipped"){me(e,{message:t,status:"SKIPPED"})}function go(e,t){return async function(r){var s;let{request:o}=r;if(o!=null&&o.url){if(!await gl(r))return!1;let n=e(o,r);F({$requestClient:n},r),r.requestClient=n;let i=pl(n,r),a=((s=n.getSessionId)==null?void 0:s.call(n))||(0,Cs.v4)(),d=bl(t,a,o,()=>{n.disconnect(new Error("user cancellation"))});try{let l=[];ml(n,r),cl(n,r,l),fl(n,r,l),S(r,n.reportMessage);let u=await n.connect(d.connection);f.debug(`requestClient ${o.url} connect`),d.connectionCount++,u!==d.connection&&(d.connection=u),await Promise.all([mo(()=>n.send(),r),hl(r).then(()=>{var v;(v=n.streamEnded)==null||v.call(n)})]);let m=await Promise.all(l),g=It(ul(...m));return g&&!await yl(g,r)?!1:(d.connectionCount--,Hs(t,d)&&(f.debug(`requestClient ${o.url} disconnect`),n.disconnect()),!0)}catch(l){throw d.connectionCount--,Hs(t,d)&&((r.scriptConsole||f).error(r.request),f.debug(`requestClient ${o.url} disconnect`),te(l)?n.disconnect(l):n.disconnect(new Error(x(l)))),l}finally{n.triggerEnd(),i==null||i(),delete r.requestClient,Ce("$requestClient",r)}}return!1}}function ul(...e){let t=[];for(let r of e)r&&t.push(r);return t}function pl(e,t){var r,o;if((r=t.progress)!=null&&r.register)return(o=t.progress)==null?void 0:o.register(()=>{Q(t.httpRegion,"user cancellation"),e.disconnect(new Error("user cancellation"))})}function ml(e,t){var r;if(t.isMainContext&&((r=t.progress)!=null&&r.report)){let o=0;e.addEventListener("progress",s=>{var a;let n=s.detail,i=n-o;if(o=n,(a=t.progress)!=null&&a.report){f.trace(`progress to ${n}`);let d=t.progress.divider||1;t.progress.report({message:"request progress",increment:i/d*100})}})}}function cl(e,t,r){e.addEventListener("message",o=>{let[s,n]=o.detail;f.debug(s,(n==null?void 0:n.message)||(n==null?void 0:n.body)),r.push(Promise.resolve(n)),e.supportsStreaming&&!t.httpRegion.metaData.noStreamingLog&&t.logStream&&r.push(t.logStream(s,{...n}))})}function fl(e,t,r){e.addEventListener("metaData",o=>{let[s,n]=o.detail;f.debug(`event ${s} for ${n.protocol}`,(n==null?void 0:n.message)||(n==null?void 0:n.body)),t.httpRegion.metaData.metaDataLogging&&t.logStream&&r.push(t.logStream(s,n))})}async function gl(e){let t=e.hooks.onRequest;return e.progress&&t.addInterceptor(Ss(()=>{var r;return!!((r=e.progress)!=null&&r.isCanceled())})),e.request&&await t.trigger(e.request,e)!==fo.HookCancel}async function hl(e){let t=e.hooks.onStreaming;e.progress&&t.addInterceptor(Ss(()=>{var r;return!!((r=e.progress)!=null&&r.isCanceled())})),await t.trigger(e)}async function yl(e,t){return await t.hooks.onResponse.trigger(jt(e),t)===fo.HookCancel?!1:(t.httpRegion.response=e,!0)}function Ss(e){return{id:"isCanceled",async beforeTrigger(){return!e()},async afterTrigger(){return!e()}}}function jt(e){return new Proxy(e,{set(...r){let[o,s,n]=r,i=Reflect.set(...r);return s==="body"&&(delete o.prettyPrintBody,delete o.parsedBody,delete o.rawBody,typeof n=="string"&&(o.rawBody=Buffer.from(n))),i}})}function bl(e,t,r,o){let s=e.getUserSession(t);if(s!=null&&s.connection)return s;let n={id:t,description:"Pending Connection",details:{method:r.method,url:r.url},title:`${r.method} ${r.url}`,type:"Stream",connectionCount:0,delete:o};return e.setUserSession(n),n}function Hs(e,t){return t.connectionCount<=0&&(delete t.delete,e.removeUserSession(t.id)),t.connectionCount===0}function ct(e,t="global"){var r,o,s,n;if(e){if(c(e.metaData.title))return e.metaData.title;if(c(e.metaData.name))return e.metaData.name;if((r=e.request)!=null&&r.url){let i=e.request.url.indexOf("?");i<0&&(i=e.request.url.length);let a=((n=(s=(o=e.symbol.children)==null?void 0:o.find)==null?void 0:s.call(o,d=>d.kind==="requestLine"))==null?void 0:n.startLine)||e.symbol.startLine;return`${e.request.method} ${e.request.url.slice(0,i)} (line: ${a+1})`}}return t}function ho(e,t="-"){var r;return c(e.metaData.description)?e.metaData.description:(r=e.request)!=null&&r.url?`${e.request.method} ${e.request.url}`:t}async function Se(e,t){let r;e&&(r=ae(e),await t.hooks.responseLogging.trigger(jt(r),t)===Ts.HookCancel)||!t.httpRegion.metaData.noLog&&t.logResponse&&await t.logResponse(r,t.httpRegion)}async function Be(e){for(let t of e.httpFile.globalHttpRegions)if(!await t.execute(e))return!1;return!0}function ft(e,t){return{onRequest:t.hooks.onRequest.merge(...t.globalHttpRegions.map(r=>r.hooks.onRequest),e.onRequest),onResponse:t.hooks.onResponse.merge(e.onResponse,...t.globalHttpRegions.map(r=>r.hooks.onResponse)),onStreaming:t.hooks.onStreaming.merge(e.onStreaming,...t.globalHttpRegions.map(r=>r.hooks.onStreaming)),responseLogging:t.hooks.responseLogging.merge(e.responseLogging,...t.globalHttpRegions.map(r=>r.hooks.responseLogging))}}function xl(e,t){let r=[];return e.request&&(r.push(...qs(e.request,{body:!!(t!=null&&t.requestBody)})),r.push("")),r.push(...Ls(e,{prettyPrint:!!(t!=null&&t.prettyPrint),body:!!(t!=null&&t.responseBody)})),U(r)}function Ls(e,t){let r=[];return r.push(`${e.protocol} ${e.statusCode} ${e.statusMessage?` - ${e.statusMessage}`:""}`),e.headers&&r.push(...yo(e.headers)),t!=null&&t.body&&c(e.body)&&(r.push(""),r.push(t!=null&&t.prettyPrint&&e.prettyPrintBody?e.prettyPrintBody:e.body)),r}function qs(e,t){let r=[];return r.push(`${e.method} ${e.url}`),e.headers&&r.push(...yo(e.headers)),t!=null&&t.body&&c(e.body)&&(r.push(""),r.push(e.body)),r}function yo(e){return Object.entries(e).map(([t,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):c(r)||(o=$(r))),`${t}: ${o}`})}function Rl(e,t){let r=[];return e.request&&(r.push(...As(e.request,{body:!!(t!=null&&t.requestBody)})),r.push("")),r.push(...Es(e,{prettyPrint:!!(t!=null&&t.prettyPrint),body:!!(t!=null&&t.responseBody)})),t!=null&&t.testResults&&(r.push(""),r.push(""),r.push(...$s(t.testResults))),t!=null&&t.timings&&e.timings&&(r.push(""),r.push(""),r.push(...Is(e.timings))),t!=null&&t.meta&&e.meta&&(r.push(""),r.push(""),r.push(...Ds(e.meta))),Vt(r)}function Es(e,t){let r=[];if(r.push(`\`${e.protocol} ${e.statusCode}${e.statusMessage?` - ${e.statusMessage}`:""}\``),e.headers&&r.push(...bo(e.headers)),t!=null&&t.body&&c(e.body)){r.push(""),r.push(`\`\`\`${Os(e.contentType)}`);let o=t.prettyPrint&&e.prettyPrintBody?e.prettyPrintBody:e.body;r.push(Vt(Y(o))),r.push("```")}return r}function Os(e){return dt(e)?"json":Nr(e)?"xml":Ur(e)?"html":Mr(e)?"js":_r(e)?"css":ut(e)?"markdown":""}function As(e,t){let r=[];return r.push(`\`${e.method} ${e.url}\``),e.headers&&r.push(...bo(e.headers)),t!=null&&t.body&&c(e.body)&&(r.push(""),r.push("```json"),r.push(Vt(Y(e.body))),r.push("```")),r}function $s(e){let t=[];t.push("`TestResults`"),t.push("");for(let r of e){let o=`${J.ok}: ${r.message}`;r.status==="SKIPPED"?o=`${J.skipped}: ${r.message}`:["FAILED","ERROR"].includes(r.status)&&(o=`${J.error}: ${r.message}`,r.error&&(o+=` (${r.error.displayMessage})`)),t.push(o)}return t}function bo(e){return Object.entries(e).map(([t,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):c(r)||(o=$(r))),`*${t}*: ${o}`}).sort()}function Ds(e){let t=[];t.push("`Meta`"),t.push("");for(let[r,o]of Object.entries(e))Array.isArray(o)?o.length>0&&t.push(`*${r}*: ${o.join(",")}`):t.push(`*${r}*: ${o}`);return t}function Is(e){let t=[];return t.push("`Timings`"),t.push(""),e.wait&&t.push(`*Wait*: ${e.wait} ms`),e.dns&&t.push(`*DNS*: ${e.dns} ms`),e.tcp&&t.push(`*TCP*: ${e.tcp} ms`),e.tls&&t.push(`*TLS*: ${e.tls} ms`),e.request&&t.push(`*Request*: ${e.request} ms`),e.firstByte&&t.push(`*First Byte*: ${e.firstByte} ms`),e.download&&t.push(`*Download*: ${e.download} ms`),e.total&&t.push(`*Total*: ${e.total} ms`),t}function Vt(e){return e.join(`  ${p.EOL}`)}function vl(e){let t=e;return!!(t!=null&&t.accessToken)}function kl(e){let t=e;return!!(t!=null&&t.httpRegion)&&!!(t!=null&&t.httpFile)&&!!(t!=null&&t.variables)&&!!(t!=null&&t.config)}var gt=/\{{2}\s*(.+?)\s*\}{2}/gu,Te=/^\s*#{3,}(?<title>.*)$/u,Pl=/^\s*(?<type>openid|oauth2)(\s+(?<flow>client(_credentials)?|(authorization_)?code|device(_code)?|password|implicit|hybrid))?(\s+(?<variablePrefix>[^\s]*))?\s*((token_exchange)\s+(?<tokenExchangePrefix>[^\s]*))?\s*$/iu;async function Bt(e,t,r){let o={parseResults:[]},s=e.next();for(;!s.done;){let n=!1;for(let i of t){let a=await i(s.value,r);if(a){o.parseResults.push(a),n=!0;break}}if(!n)break;o.nextLine=s.value.line,s=e.next()}return o}function Mt(e){return async function(r){var s;let o=/^\s*(?<key>[!#$%&'*+\-.^_`|~0-9A-Za-z]+)\s*:\s*(?<value>.*?),?\s*$/u.exec(r.textLine);if((s=o==null?void 0:o.groups)!=null&&s.key){let n=o.groups.key,i=o.groups.value,a=e[n];a?Array.isArray(a)?a.push(i):e[n]=[a,i]:e[n]=i;let d=r.textLine.indexOf(i);return{symbols:[new R({name:n,description:i,kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.length,children:[new R({name:n,description:"request header key",kind:"key",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.indexOf(n)+n.length}),i?new R({name:i,description:"request header value",kind:"value",startLine:r.line,startOffset:d,endLine:r.line,endOffset:d+i.length,children:re(i,r.line,d)}):void 0].filter(l=>!!l)})]}}return!1}}function Ro(e=(t,r)=>{r.request&&(r.request.headers?Object.assign(r.request.headers,t):r.request.headers=t)}){return async function(r,o){var n;let s=/^\s*\.{3}(?<variableName>[^\s]+),?\s*$/u.exec(r.textLine);if((n=s==null?void 0:s.groups)!=null&&n.variableName){let i=new xo(s.groups.variableName,e);o.httpRegion.hooks.execute.addObjHook(d=>d.process,i);let a=r.textLine.trim();return{symbols:[new R({name:a||"hader variable",description:"Header Variable",kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(a),endOffset:r.textLine.length,endLine:r.line,children:[new R({name:s.groups.variableName,description:"Header Variable",kind:"variable",startLine:r.line,startOffset:s.index,endOffset:s.groups.variableName.length,endLine:r.line})]})]}}return!1}}var xo=class{constructor(t,r){this.data=t;this.setHeaders=r;this.id="defaultHeaders"}async process(t){if(this.data&&t.variables){S(t,"set request headers");let r=await H.evalExpression(this.data,t);r&&this.setHeaders(Object.assign({},r),t)}return!0}};function vo(e){return async function(r){if(/^\s*(\/)[^*]*$/u.test(r.textLine)){let o=r.textLine.trim();return e(o),{symbols:[new R({name:o||"URL Part",description:"URL Part",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line,children:re(r.textLine,r.line)})]}}return!1}}function ko(e){return async function(r){if(/^\s*(\?|&)((([^(=?&)]+)=(.*))|\{\{.*\}\})\s*$/u.test(r.textLine)){let o=r.textLine.trim();return e(o),{symbols:[new R({name:o||"Query",description:"Query",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line,children:re(r.textLine,r.line,0)})]}}return!1}}async function ht(e,t,r=/^\s*((#\s+)|(\/{2}))/u){var o;if(r.test(e.textLine)){let s={symbols:[new R({name:"comment",description:e.textLine,kind:"metaData",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length})]},n=/^\s*(#+|\/{2,})\s+@(?<key>[^\s]*)(\s+)?"?(?<value>.*)?"?$/u.exec(e.textLine);if(n&&n.groups&&n.groups.key){let i=n.groups.key.replace(/-./gu,d=>d[1].toUpperCase());s.symbols[0].children=[new R({name:i||"metadata",description:n.groups.value||"-",kind:"metaData",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:[new R({name:i||"metadata key",description:((o=Fs.find(d=>d.name===i))==null?void 0:o.description)||"key of meta data",kind:"key",startLine:e.line,startOffset:e.textLine.indexOf(n.groups.key),endLine:e.line,endOffset:e.textLine.indexOf(n.groups.key)+n.groups.key.length})]})];let a;n.groups.value&&(a=n.groups.value.trim(),s.symbols[0].children.push(new R({name:n.groups.value||"metadata value",description:"value of meta data",kind:"value",startLine:e.line,startOffset:e.textLine.indexOf(n.groups.value),endLine:e.line,endOffset:e.textLine.indexOf(n.groups.value)+n.groups.value.length}))),t.httpRegion.metaData=Object.assign(t.httpRegion.metaData||{},{[i]:a||!0}),await t.httpFile.hooks.parseMetaData.trigger(i,a,t)}return s}return!1}var Fs=[{name:"name",description:"responses of a requests with a name are automatically added as variables and can be reused by other requests",completions:["${1}"]},{name:"debug",description:"enable debug log level"},{name:"description",description:"additional description of region",completions:["${1}"]},{name:"disabled",description:"requests can be disabled"},{name:"extension",description:"extension of file for save or openWith.",completions:["${1}"]},{name:"forceRef",description:"When the request is called, it is ensured that the referenced request is always called beforehand",completions:["${1}"]},{name:"import",description:"reference Requests from other files.",completions:["${1}"]},{name:"injectVariables",description:"Inject Variables in request body (needed because of compatibility with Intellij)."},{name:"jwt",description:"supports auto decode of jwt token."},{name:"language",description:"language id of the response view",completions:["${1}"]},{name:"loop",description:"allows multiple Invocations of a Request with different parameters.",completions:["for ${1} of ${2}","for ${1}","while ${1}"]},{name:"keepStreaming",description:"keep streaming until the user session is ended manually"},{name:"noLog",description:"prevent logging of request data in output console"},{name:"noCookieJar",description:"cookieJar support is disabled for this request"},{name:"noClientCert",description:"SSL client certificate is not send for this request"},{name:"noProxy",description:"disable proxy for this request"},{name:"noRejectUnauthorized",description:"all invalid SSL certificates will be ignored and no error will be thrown."},{name:"noResponseView",description:"prevent output in editor document."},{name:"noStreamingLog",description:"prevent logging of streaming request data in output console"},{name:"note",description:"shows a confirmation dialog before sending request",completions:["${1}"]},{name:"openWith",description:"viewType of custom editor to preview files",completions:["${1}"]},{name:"ref",description:"When the request is called, it is ensured that the referenced request is called beforehand",completions:["${1}"]},{name:"ratelimit",description:"allows throttling requests",completions:["minIdleTime ${1}","max ${1} expire ${2}","minIdleTime ${1} max ${2} expire ${3}"]},{name:"save",description:"If specified, the response will not be displayed but saved directly."},{name:"sleep",description:"wait specified milliseconds, before next step.",completions:["${1}"]},{name:"title",description:"additional title of region",completions:["${1}"]},{name:"timeout",description:"set timeout for request",completions:["${1}"]},{name:"verbose",description:"enable trace log level"}],wl=100;async function M(e,t){if(!c(e))return e;let r,o,s=e,n=0;for(;o!==s&&n++<wl;)for(o=s;(r=gt.exec(o))!==null;){let[i,a]=r,d=await t(a,i);if(typeof d<"u"&&i===e)return d;let l=d===null?"null":x(d);typeof l<"u"&&(s=s.replace(i,()=>l))}return s}function re(e,t,r=0){let o=[];if(e){let s;for(;(s=gt.exec(e))!==null;){let[n,i]=s;o.push(new R({name:i||"variable",description:i,startLine:t,endLine:t,kind:"variable",startOffset:r+s.index,endOffset:r+s.index+n.length,source:i}))}}return o}async function Po(e,t,r){var n,i;let o=e(),s=o.next();if(!s.done){if(t.data.httpResponseSymbol){let d=t.data.httpResponseSymbol;return d.body.push(s.value.textLine),d.symbol.endLine=s.value.line,d.symbol.endOffset=s.value.textLine.length,{nextParserLine:s.value.line,symbols:[]}}let a=r.exec(s.value.textLine);if(a&&((n=a.groups)!=null&&n.statusCode)){let d={};t.httpRegion.response={protocol:`HTTP/${a.groups.httpVersion||"1.1"}`,httpVersion:a.groups.httpVersion,statusCode:+a.groups.statusCode,statusMessage:a.groups.statusMessage,headers:d};let l=new R({name:"response",description:"response",kind:"response",startLine:s.value.line,startOffset:0,endLine:s.value.line,endOffset:s.value.textLine.length,children:[]});t.data.httpResponseSymbol={symbol:l,body:[]};let u=[t.data.httpResponseSymbol.symbol],m={nextParserLine:s.value.line,symbols:u},g=await Bt(o,[Mt(d)],t);m.nextParserLine=g.nextLine||m.nextParserLine;for(let v of g.parseResults)for(let k of v.symbols)(i=l.children)==null||i.push(k),l.endLine=k.endLine,l.endOffset=k.endOffset;return m}}return!1}function yt(e){let t=/^<(?:(?<injectVariables>@)(?<encoding>\w+)?)?\s+(?<fileName>.+?)\s*$/u.exec(e);if(t&&t.length===4&&t.groups)return{fileName:t.groups.fileName.trim(),injectVariables:!!t.groups.injectVariables,encoding:Ve(t.groups.encoding)}}function wo(e){return async function(r,o){var i,a,d;let s=r(),n=s.next();if(!n.done&&Sl(n.value,o,e)){if(o.httpRegion.request)return{endRegionLine:n.value.line-1,nextParserLine:n.value.line-1,symbols:[]};let l=Cl(n.value,e);if(!l)return!1;o.httpRegion.request=l.request;let u=new R({name:n.value.textLine||"request line",description:`${e.protocol} request-line`,kind:"requestLine",startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:n.value.textLine.length,children:[l.symbol]}),m={nextParserLine:n.value.line,symbols:[u]},g={};l.request.headers=g;let v=await Bt(s,[ht,Mt(g),Ro(),ko(k=>l.request.url+=k),vo(k=>l.request.url+=k)],o);m.nextParserLine=v.nextLine||m.nextParserLine;for(let k of v.parseResults)(a=(i=m.symbols)==null?void 0:i.push)==null||a.call(i,...k.symbols);if((d=e.modifyRequest)==null||d.call(e,l.request),l.request.headers){let k=E(l.request.headers,"content-type");c(k)&&(l.request.contentType=lt(k))}return o.httpRegion.hooks.execute.addHook(e.protocol.toLowerCase(),go(e.requestClientFactory,e.sessionStore)),m}return!1}}function Cl(e,t){var s,n,i,a;let r=t.methodRegex.exec(e.textLine);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,protocol:t.protocol.toUpperCase(),method:((s=r.groups)==null?void 0:s.method)||t.method||t.protocol},symbol:new R({name:r.groups.url||"request",description:`${t.protocol} Url`,kind:"url",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:re(e.textLine,e.line)})};let o=(n=t.protocolRegex)==null?void 0:n.exec(e.textLine);if(o&&o.length>1&&((i=o.groups)!=null&&i.url))return{request:{url:o.groups.url,protocol:t.protocol.toUpperCase(),method:((a=o.groups)==null?void 0:a.method)||t.method||t.protocol},symbol:new R({name:o.groups.url||"request",description:`${t.protocol} Url`,kind:"url",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:re(e.textLine,e.line)})}}function Sl(e,t,r){var o,s,n,i;return ve(e.textLine)||t.forceRegionDelimiter&&t.httpRegion.request?!1:(s=(o=r.methodRegex.exec(e.textLine))==null?void 0:o.groups)!=null&&s.url?!0:!t.httpRegion.request&&r.protocolRegex?!!((i=(n=r.protocolRegex.exec(e.textLine))==null?void 0:n.groups)!=null&&i.url):!1}function Ho(e){let t=e;return!!(t!=null&&t.httpRegion)}function Co(e){let t=e;return Array.isArray(t==null?void 0:t.httpRegions)}function Me(e,t){let r=t.httpFile.findHttpRegion(e);if(r)return r;if(t.options.httpFiles)for(let{ref:o}of t.options.httpFiles.filter(s=>s.base===t.httpFile)){let s=o.findHttpRegion(e);if(s)return s}}async function bt(e,t,r){var s,n;let o=await le(e,r,async i=>{f.debug(`parse imported file ${i}`),r.options.httpFiles||(r.options.httpFiles=[]);let a=r.options.httpFiles.filter(l=>l.ref.fileName===i);if(a.length>0){let l=a[0].ref;return a.some(u=>u.base===r.httpFile)||r.options.httpFiles.push({base:r.httpFile,ref:l}),l}let d=await t.getOrCreate(i,async()=>await p.readFile(i,"utf-8"),0,{workingDir:r.httpFile.rootDir,config:r.config});return r.hooks=ft(r.hooks,d),r.options.httpFiles.push({base:r.httpFile,ref:d}),d});if(o&&(!r.options.globalScriptsExecuted||((n=(s=r.options.globalScriptsExecuted).indexOf)==null?void 0:n.call(s,o))<0)){r.options.globalScriptsExecuted||(r.options.globalScriptsExecuted=[]),f.debug(`execute global scripts for import ${o.fileName}`),r.options.globalScriptsExecuted.push(o);let i={...r,httpFile:o};return await Be(i)}return!!o}function Ne(e){let t=e;return t&&!!t.then}function ce(e){return new Promise(t=>setTimeout(t,e))}async function So(e,...t){let r=[],o=async()=>{let n;for(;n=t.shift();)r.push(await n())},s=[];for(let n=0;n<e;n++)s.push(o());return await Promise.all(s),r}var js=A(require("dayjs")),Vs=require("uuid"),xt={alphabetic:(e=10)=>G(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"),numeric:(e=10)=>G(e),hexadecimal:(e=10)=>G(e,"1234567890ABCDEF"),email:Ue,float:(e=0,t=100)=>Math.random()*(t-e)+e,integer:(e=0,t=100)=>Math.floor(Math.random()*(t-e)+e),uuid:()=>(0,Vs.v4)(),date:(e=new Date,t=void 0)=>(0,js.default)(e).format(t)};function Ue(){return`${G(30)}@${G(10)}.${To(["com","org","at","de","fr","uk","it","ch","info","edu","asia","gov","app","io"])}`}function G(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_"){let r=[];if(e>0){let o=t.split("");for(let s=0;s<e;s++)r.push(To(o))}return r.join("")}function To(e){return e[Math.floor(Math.random()*(e.length-1))]}var Le=require("fs"),Bs=require("os"),fe=require("path");async function Lo(){Ms(),await ql(),Tl()}function Tl(){process.platform==="win32"&&(J.ok="[x]",J.error="[-]",J.skipped="[*]")}function Ms(){p.EOL=Bs.EOL,p.isAbsolute=async e=>(0,fe.isAbsolute)(p.toString(e)),p.dirname=e=>(0,fe.dirname)(p.toString(e)),p.hasExtension=(e,...t)=>{let r=(0,fe.extname)(p.toString(e));return r.startsWith(".")&&(r=r.slice(1)),t.indexOf(r)>=0},p.joinPath=(e,t)=>(0,fe.join)(p.toString(e),t),p.exists=async e=>{try{return!!await Le.promises.stat(p.toString(e))}catch{return!1}},p.readFile=async(e,t)=>{let r=p.fsPath(e);if(r)return Le.promises.readFile(r,t);throw new Error("No valid path for cli")},p.readBuffer=async e=>{let t=p.fsPath(e);if(t){let r=(0,Le.createReadStream)(t);return Ll(r)}throw new Error("No valid path for cli")},p.writeBuffer=(e,t)=>Le.promises.writeFile(p.toString(e),t),p.readdir=async e=>Le.promises.readdir(p.toString(e))}function Ll(e){return new Promise((t,r)=>{let o=[];e.on("data",s=>{Buffer.isBuffer(s)?o.push(s):o.push(Buffer.from(s))}),e.on("end",()=>t(Buffer.concat(o))),e.on("error",s=>r(s)),e.resume()})}async function ql(){let e=(await import("inquirer")).default;q.showNote=async function(r){return(await e.prompt([{type:"confirm",name:"note",message:r}])).note},q.showInputPrompt=async function(r,o,s){return s?(await e.prompt([{type:"password",name:"placeholder",message:r,mask:"*",default:o}])).placeholder:(await e.prompt([{type:"input",name:"placeholder",message:r,default:o}])).placeholder},q.showListPrompt=async function(r,o){return(await e.prompt([{type:"list",name:"placeholder",message:r,choices:o}])).placeholder},q.getClipboard=async function(){return""},q.setClipboard=async function(r){}}var ze=A(require("chalk")),Ca=require("commander"),Lt=require("fs"),ge=require("path");var Gs=require("assert");var Nt=class{constructor(){this.id=["endsWith"]}match(t,r){let o=x(t),s=x(r);return o&&s?o==null?void 0:o.endsWith(s):!1}};var Ut=class{constructor(){this.id=["==","===","equals"]}match(t,r){return typeof t=="object"?$(t)===$(r):t===r}};var _t=class{constructor(){this.id=["exists","isTrue"]}match(t){return!!t}};var Kt=class{constructor(){this.id=[">="]}match(t,r){let o=P(t),s=P(r);return o!==void 0&&s!==void 0?o>=s:!1}};var Gt=class{constructor(){this.id=[">"]}match(t,r){let o=P(t),s=P(r);return o!==void 0&&s!==void 0?o>s:!1}};var Wt=class{constructor(){this.id=["contains","includes"]}match(t,r){let o=x(t),s=x(r);return o&&s?o.includes(s):Array.isArray(t)?t.indexOf(r)>=0:!1}};var Jt=class{constructor(){this.id=["isArray"]}match(t){return Array.isArray(t)}};var zt=class{constructor(){this.id=["isBoolean"]}match(t){return typeof t=="boolean"}};var Xt=class{constructor(){this.id=["isFalse"]}match(t){return!t}};var Yt=class{constructor(){this.id=["isNumber"]}match(t){return typeof t=="number"}};var Qt=class{constructor(){this.id=["isString"]}match(t){return typeof t=="string"}};var Zt=class{constructor(){this.id=["<="]}match(t,r){let o=P(t),s=P(r);return o!==void 0&&s!==void 0?o<=s:!1}};var er=class{constructor(){this.id=["<"]}match(t,r){let o=P(t),s=P(r);return o!==void 0&&s!==void 0?o<s:!1}};var tr=class{constructor(){this.id=["matches"];this.noAutoConvert=!0}match(t,r){let o=x(t),s=x(r);return o&&s?new RegExp(s,"u").test(o):!1}};var Ns=require("crypto");var rr=class{constructor(){this.id=["md5"];this.noAutoConvert=!0}match(t,r){let o=ie(t);return o?(0,Ns.createHash)("md5").update(o).digest("base64")===r:!1}};var or=class{constructor(){this.id=["!=","!==","not equals"]}match(t,r){return t!==r}};var Us=require("crypto");var sr=class{constructor(){this.id=["sha256"];this.noAutoConvert=!0}match(t,r){let o=ie(t);return o?(0,Us.createHash)("sha256").update(o).digest("base64")===r:!1}};var _s=require("crypto");var nr=class{constructor(){this.id=["sha512"];this.noAutoConvert=!0}match(t,r){let o=ie(t);return o?(0,_s.createHash)("sha512").update(o).digest("base64")===r:!1}};var ir=class{constructor(){this.id=["startsWith"]}match(t,r){let o=x(t),s=x(r);return o&&s?o==null?void 0:o.startsWith(s):!1}};var Ks=[new Nt,new Ut,new _t,new Kt,new Gt,new Wt,new Jt,new zt,new Yt,new Qt,new Zt,new er,new tr,new or,new ir,new sr,new rr,new nr,new Xt];async function Ws(e,{httpRegion:t}){let o=e().next();if(!o.done&&o.value.textLine){let s=o.value.textLine,i=`^\\s*\\?\\?\\s*(?<type>[^\\s]*)(\\s+(?<value>.*))?\\s+(?<predicate>(${Ks.reduce((d,l)=>(d.push(...l.id),d),[]).join("|")}))\\s*(?<expected>.*)\\s*$`,a=new RegExp(i,"iu").exec(s);if(a&&a.groups&&a.groups.type&&a.groups.predicate){let d=a.groups.type,l=a.groups.value,u=a.groups.expected,m=Ks.find(g=>{var v;return((v=a.groups)==null?void 0:v.predicate)&&g.id.indexOf(a.groups.predicate)>=0});return m&&t.hooks.onResponse.addHook(`test ${s}`,async(g,v)=>{await co(v,{ignoreErrorFile:!0})(`${l||d} ${m.id[0]} ${u||""}`.trim(),async L=>{let D=await v.httpFile.hooks.provideAssertValue.trigger(d,l,g,v),b=u&&await I(u,"Variable",v);b!==u&&(L.message=`${l||d} ${m.id[0]} ${b}`);let h=m.noAutoConvert?b:Ol(D,b);(0,Gs.ok)(m.match(D,h),`${l||d} (${D}) ${m.id[0]} ${x(h)||""}`.trim())})}),{nextParserLine:o.value.line,symbols:[new R({name:`assert ${a.groups.type}`,description:`${a.groups.predicate} ${a.groups.expected||""}`.trim(),kind:"script",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length})]}}}return!1}function Ol(e,t){if(t!=null){if(typeof e=="number")return P(t);if(typeof e=="boolean")return ue(t,!!t);if(typeof e=="string")return x(t);if(e===null&&t==="null")return null;if(e===void 0&&t==="undefined")return;if(typeof e=="object"&&typeof t=="string")try{return JSON.parse(t)}catch{return t}}return t}W.emptyLineProvider.push(()=>[{name:"?? status == ",description:"Status assert (200)"},{name:"?? status == 200",description:"Status assert (200)"},{name:"?? duration <",description:"Duration assert"},{name:"?? body contains",description:"Body assert"},{name:"?? body matches",description:"Body assert"},{name:"?? body md5",description:"Body assert"},{name:"?? body sh256",description:"Body assert"},{name:"?? header",description:"Header assert"}]);function Js(e,t,r){var o,s,n,i,a,d,l;if(e==="duration")switch(t){case"firstByte":return(o=r==null?void 0:r.timings)==null?void 0:o.firstByte;case"download":return(s=r==null?void 0:r.timings)==null?void 0:s.download;case"wait":return(n=r==null?void 0:r.timings)==null?void 0:n.wait;case"request":return(i=r==null?void 0:r.timings)==null?void 0:i.request;case"tcp":return(a=r==null?void 0:r.timings)==null?void 0:a.tcp;case"tls":return(d=r==null?void 0:r.timings)==null?void 0:d.tls;default:return(l=r==null?void 0:r.timings)==null?void 0:l.total}return!1}function zs(e,t,r){return e==="header"&&t?E(r.headers,t):!1}async function Xs(e,t,r,o){return e==="js"&&t?await H.evalExpression(t,o,{response:r}):e==="body"?t?await H.evalExpression(`(response.parsedBody || response.body).${t}`,o,{response:r}):r.body:!1}function Ys(e,t,r){return e==="status"?r==null?void 0:r.statusCode:!1}var ar=class{constructor(){this.id="testFailed";this.before=["processedHttpRegion"]}async onError(t,r){if(te(t)){let{httpRegion:o}=r.args[0];me(o,{message:t.message,error:we(t),status:"ERROR"})}return!0}};function Qs(e){e.hooks.execute.addInterceptor(new ar),e.hooks.provideAssertValue.addHook("status",Ys,{before:["request"]}),e.hooks.provideAssertValue.addHook("header",zs,{before:["request"]}),e.hooks.provideAssertValue.addHook("javascript",Xs,{before:["request"]}),e.hooks.provideAssertValue.addHook("duration",Js,{before:["request"]}),e.hooks.parse.addHook("assert",Ws,{before:["request"]})}W.variableProvider.push(()=>[{name:"$prompt ",description:"Prompt"},{name:"$input",description:"Input"},{name:"$input-askonce",description:"Input"},{name:"$password",description:"Password"},{name:"$pick <placeholder> $value:",description:"Password"},{name:"$pick-askonce <placeholder> $value:",description:"Password"},{name:"$timestamp",description:"Timestamp"},{name:"$datetime",description:"Datetime"},{name:"$localDatetime",description:"Local Datetime"}]);var Zs="$default",en="$shared";async function tn(e){var t;if((t=e.config)!=null&&t.environments){let r=Object.keys(e.config.environments).filter(o=>[Zs,en].indexOf(o)<0);return f.info("Config Env Provider found environments",r),r}return[]}async function rn(e,t){var o;let r=[];if((o=t.config)!=null&&o.environments){let s=t.config.environments;r.push(s[en]),e&&e.length>0?r.push(...e.map(n=>s[n])):r.push(s[Zs])}return Object.assign({},...r)}var Ao={};Qe(Ao,{HttpFile:()=>Rt,HttpFileStore:()=>vt,HttpRegion:()=>Ke,UserSessionStore:()=>dr,closeHttpRegion:()=>lr,createReaderFactory:()=>qo,getEnvironmentConfig:()=>_e,parseHttpFile:()=>Oo,pluginStore:()=>ee,setSource:()=>Eo,userSessionStore:()=>w});var on=A(require("chalk")),sn=A(require("lodash/merge"));async function _e(e,t){let r=[];if(t){let s=await uo(t.fileName,t.rootDir);s&&r.push(s)}e&&r.push(e);let o=(0,sn.default)({log:{level:5,supportAnsiColors:!0},cookieJarEnabled:!0,envDirName:"env"},...r);return Al(o),o}function Al(e){var t,r,o;typeof((t=e==null?void 0:e.log)==null?void 0:t.level)>"u"?f.options.level=5:f.options.level=(r=e==null?void 0:e.log)==null?void 0:r.level,((o=e==null?void 0:e.log)==null?void 0:o.supportAnsiColors)===!1&&(on.default.level=0)}var Rt=class{constructor(t,r){this.fileName=t;this.rootDir=r;this.hooks={parse:new Ze,parseMetaData:new et,parseEndRegion:new rt,provideAssertValue:new tt,replaceVariable:new nt,provideEnvironments:new st,provideVariables:new ot,execute:new Re,onStreaming:new be,onRequest:new he,onResponse:new ye,responseLogging:new xe};this.httpRegions=[]}findHttpRegion(t){return this.httpRegions.find(r=>{var o;return((o=r.metaData)==null?void 0:o.name)===t&&!r.metaData.disabled})}get globalHttpRegions(){return this.httpRegions.filter(t=>t.isGlobal()&&!t.metaData.disabled)}};var dn=require("hookpoint");async function lr(e){await e.httpFile.hooks.parseEndRegion.trigger(e);let{httpRegion:t}=e;e.httpRegion.symbol.name=ct(t),e.httpRegion.symbol.description=ho(t),e.httpFile.httpRegions.push(e.httpRegion),delete e.forceRegionDelimiter}function qo(e,t){return function*(o){for(let s=e;s<t.length;s++){let n=t[s];if(yield{textLine:n,line:s},!o&&Te.test(n))break}}}var ln=require("hookpoint");var nn=require("hookpoint");var Ke=class e{constructor(t,r=0){this.httpFile=t;this.variablesPerEnv={};this.metaData={};this.hooks={execute:new Re,onRequest:new he,onStreaming:new be,onResponse:new ye,responseLogging:new xe};this.dependentsPerEnv=[];this.symbol=new R({name:"-",description:"-",kind:"request",startLine:r,startOffset:0,endLine:r,endOffset:0})}get id(){return`${this.httpFile.fileName}_${this.symbol.startLine}`}isGlobal(){return!(this.request||this.metaData.name)}clone(t){let r=new e(t||this.httpFile);return r.request=this.request,Object.assign(r.symbol,this.symbol),Object.assign(r.hooks,this.hooks),Object.assign(r.variablesPerEnv,this.variablesPerEnv),Object.assign(r.metaData,this.metaData),r}async execute(t,r){var s,n,i;delete this.response,this.testResults=[],t.httpRegion&&this.registerRegionDependent(t.httpRegion),(n=(s=t.progress)==null?void 0:s.report)==null||n.call(s,{message:`${this.symbol.name}`});let o=this.hooks.execute;if(!this.isGlobal()){o=this.httpFile.hooks.execute.merge(o);for(let a of this.httpFile.httpRegions.filter(d=>d.isGlobal()))a instanceof e&&a.registerRegionDependent(this)}try{let a=await o.trigger({...t,httpFile:this.httpFile,httpRegion:this,hooks:ft(this.hooks,this.httpFile),isMainContext:r});return this.isGlobal()||this.resetDependentRegionsWithVisitor(B(t.activeEnvironment),this,[]),a!==nn.HookCancel&&a.every(d=>!!d)}catch(a){return te(a)&&(me(this,{message:a.message,status:"ERROR",error:we(a)}),a.handled||(await((i=t.logResponse)==null?void 0:i.call(t,this.response,this)),a.handled=!0)),!1}}resetDependentRegionsWithVisitor(t,r,o){let s=r.dependentsPerEnv.filter(n=>!o.includes(n));for(let n of s)delete n.response,delete n.variablesPerEnv[t],o.push(n),n instanceof e&&this.resetDependentRegionsWithVisitor(t,n,o)}registerRegionDependent(t){t&&!this.dependentsPerEnv.includes(t)&&t!==this&&this.dependentsPerEnv.push(t)}};function Eo(e,t){for(let r of e)an(r.symbol,t)}function an(e,t){e.source=U(t.slice(e.startLine,e.endLine+1));let r=e.endOffset-t[e.endLine].length;if(r>=0&&(r=void 0),e.source=e.source.slice(e.startOffset,r),e.children)for(let o of e.children)an(o,t)}async function Oo(e,t,r){let o=Y(t),s={lines:o,httpFile:e,httpRegion:new Ke(e,0),data:{},httpFileStore:r};for(let n=0;n<o.length;n++){let i=await e.hooks.parse.trigger(qo(n,o),s);i&&i!==ln.HookCancel&&(i.endRegionLine!==void 0&&i.endRegionLine>=0&&(s.httpRegion.symbol.endLine=i.endRegionLine,s.httpRegion.symbol.endOffset=o[i.endRegionLine].length,await lr(s),s.httpRegion=new Ke(e,i.nextParserLine+1)),i.symbols&&(s.httpRegion.symbol.children?s.httpRegion.symbol.children.push(...i.symbols):s.httpRegion.symbol.children=i.symbols),n=i.nextParserLine)}return await lr(s),s.httpRegion.symbol.endLine=o.length-1,s.httpRegion.symbol.endOffset=o[o.length-1].length,Eo(e.httpRegions,o),e}var ee={};var vt=class{constructor(t={}){this.plugins=t;this.storeCache=[]}getFromStore(t,r){let o=p.toString(t),s=this.storeCache.find(n=>n.cacheKey===o);return s||(s={cacheKey:o,version:r},this.storeCache.push(s)),s}get(t){var o;let r=p.toString(t);return(o=this.storeCache.find(s=>s.cacheKey===r))==null?void 0:o.httpFile}getAll(){let t=[];for(let r of this.storeCache)r.httpFile&&t.push(r.httpFile);return t}getOrCreate(t,r,o,s){let n=this.getFromStore(t,o);return o>n.version||!n.httpFile?(n.promise&&o<=n.version||(n.promise=r().then(i=>this.parse(t,i,s)).then(i=>{if(delete n.promise,n.httpFile)for(let a of i.httpRegions){let d=n.httpFile.httpRegions.find(l=>l.symbol.source===a.symbol.source);d&&Object.assign(a.variablesPerEnv,d.variablesPerEnv)}return n.version=o,n.httpFile=i,i}).catch(i=>{throw delete n.promise,n.httpFile&&this.remove(n.httpFile.fileName),i})),n.promise):n.promise||Promise.resolve(n.httpFile)}async parse(t,r,o){let s=await this.initHttpFile(t,o);return await Oo(s,r,this)}remove(t){let r=p.toString(t),o=this.storeCache.findIndex(s=>s.cacheKey===r);return o>=0?(this.storeCache.splice(o,1),!0):!1}rename(t,r){let o=p.toString(t),s=this.storeCache.find(n=>n.cacheKey===o);s&&(s.cacheKey=p.toString(r),s.httpFile&&(s.httpFile.fileName=r))}clear(){this.storeCache.length=0}async initHttpFile(t,r){var d,l;let o=await V(t,r.workingDir)||t,s=await Ot(o,r.workingDir,...Dt)||await Ot(o,r.workingDir,"package.json",((d=r.config)==null?void 0:d.envDirName)||"env")||r.workingDir,n=new Rt(o,s);r.config=await _e(r.config,n);let i={...ee,...this.plugins};s&&(Object.assign(i,await po(s)),(l=r.config)!=null&&l.configureHooks&&(i[".httpyac.js"]=r.config.configureHooks));let a=process.env.HTTPYAC_PLUGIN;if(a)try{let u=require(a);u.configureHooks&&(i.HTTPYAC_PLUGIN=u.configureHooks)}catch(u){f.warn("Global Hook Plugin not loaded",u)}return await this.configureHooks(n,r,i),n}async configureHooks(t,r,o){if(r.config){let s={version:"1.0.0",rootDir:t.rootDir,config:r.config,httpFile:t,hooks:t.hooks,log:f,fileProvider:p,sessionStore:w,userInteractionProvider:q,httpClientProvider:se,javascriptProvider:H,utils:y,getHookCancel:()=>dn.HookCancel};for(let[n,i]of Object.entries(o))try{let a=i(s);Ne(a)&&await a}catch(a){f.error(`error in ${n}`,a)}}}};var dr=class{constructor(){this.userSessions=[];this.sessionChangedListener=[]}onSessionChanged(t){return this.sessionChangedListener.push(t),()=>{let r=this.sessionChangedListener.indexOf(t);r>=0&&this.sessionChangedListener.splice(r,1)}}async reset(){for(let t of this.userSessions)t.delete&&t.delete();this.userSessions.length=0,this.notifySessionChanged()}getUserSession(t){return this.userSessions.find(r=>r.id===t)}setUserSession(t){this.removeUserSession(t.id),this.userSessions.push(t),this.notifySessionChanged()}notifySessionChanged(){for(let t of this.sessionChangedListener)t()}removeUserSession(t){let r=this.userSessions.find(o=>o.id===t);r&&(this.userSessions.splice(this.userSessions.indexOf(r),1),r.delete&&r.delete(),this.notifySessionChanged())}isUserSession(t){let r=t;return r&&!!r.description&&!!r.id&&!!r.title&&!!r.type&&!!r.details}},w=new dr;async function un(){let e=w.getUserSession("last_response");return e!=null&&e.response?{response:e.response}:{}}var pn=A(require("lodash/cloneDeep"));var ur=class{constructor(){this.id="createRequest"}async beforeLoop(t){let[r]=t.args;return r.httpRegion.request&&(S(r,"init request"),r.request=(0,pn.default)(r.httpRegion.request)),!0}};var mn=require("hookpoint");var Dl="variable",pr=class{constructor(){this.id="variable"}async beforeLoop(t){let r=t.args[0];return r.options.lazyVariables=!0,!0}async beforeTrigger(t){var o;let r=t.args[0];return((o=t.hookItem)==null?void 0:o.id)!==Dl&&r.options.lazyVariables&&(await this.replaceAllVariables(r),delete r.options.lazyVariables),!0}async replaceAllVariables(t){for(let[r,o]of Object.entries(t.variables)){let s=await I(o,"Variable",t);s!==mn.HookCancel&&(t.variables[r]=s)}}};var mr=class{constructor(){this.id="logResponse"}async afterLoop(t){let r=t.args[0],o;return r.httpRegion.response&&(o=ae(r.httpRegion.response),o.tags||(o.tags=[]),o.tags.push("httpRegion",r.isMainContext?"mainResponse":"refResponse"),delete r.httpRegion.response),await Se(o,r),!0}};var cr=class{constructor(){this.id="processedHttpRegion";this.emitted=new WeakSet}getResponseLoggingInterceptor(){return{id:this.id,afterLoop:this.afterResponseLoggingLoop.bind(this)}}async beforeLoop(t){let[r]=t.args;if(r.processedHttpRegions){let o=this.toProcessedHttpRegion(r);r.processedHttpRegions.push(o)}return!0}async onError(t,r){return this.updateProcessedHttpRegionAfterLoop(r.args[0]),this.emitProcessedHttpRegion(r.args[0]),!0}async afterLoop(t){return this.updateProcessedHttpRegionAfterLoop(t.args[0]),this.emitProcessedHttpRegion(t.args[0]),!0}updateProcessedHttpRegionAfterLoop(t){var o,s,n;let r=(s=(o=t.processedHttpRegions)==null?void 0:o.slice().reverse())==null?void 0:s.find(i=>i.id===t.httpRegion.id);r&&(r.end=performance.now(),r.duration=r.end-r.start,r.metaData={...t.httpRegion.metaData},r.testResults=t.httpRegion.testResults,r.response=t.httpRegion.response||r.response,r.request=((n=t.httpRegion.response)==null?void 0:n.request)||r.request)}async afterResponseLoggingLoop(t){var n;let[r,o]=t.args,s=(n=o.processedHttpRegions)==null?void 0:n.find(i=>i.id===o.httpRegion.id);return s&&(s.request=r.request,s.response=r),this.updateProcessedHttpRegionAfterLoop(o),this.emitProcessedHttpRegion(o),!0}toProcessedHttpRegion(t){return{id:t.httpRegion.id,filename:t.httpFile.fileName,symbol:t.httpRegion.symbol,isGlobal:t.httpRegion.isGlobal(),testResults:t.httpRegion.testResults,start:performance.now()}}emitProcessedHttpRegion(t){var o;if(!t.processedHttpRegionListener)return;let r=(o=t.processedHttpRegions)==null?void 0:o.find(s=>s.id===t.httpRegion.id);r&&!this.emitted.has(r)&&r.duration!==void 0&&(this.emitted.add(r),t.processedHttpRegionListener(r))}};var fr=class{constructor(){this.id="regionScopedVariables"}async beforeLoop(t){var s;let r=t.args[0],o=B(r.activeEnvironment);if((s=r.config)!=null&&s.useRegionScopedVariables){let n=r.options;n.variables=r.variables,r.variables=Object.assign({},r.variables,...r.httpFile.globalHttpRegions.map(i=>i.variablesPerEnv[o]))}else r.variables=Object.assign(r.variables,...r.httpFile.httpRegions.map(n=>n.variablesPerEnv[o]));return!0}async afterLoop(t){var o;let r=t.args[0];if((o=r.config)!=null&&o.useRegionScopedVariables){let s=r.options;if(s.variables){let n=r.variables;r.variables=s.variables,this.autoShareNewVariables(n,r)}}return!0}autoShareNewVariables(t,r){for(let[o,s]of Object.entries(t))r.variables[o]||(r.variables[o]=s)}};function cn(e,t,r){return e==="disabled"?(t?typeof t=="string"&&r.httpRegion.hooks.execute.addHook("disabled",async o=>{let s=await H.evalExpression(t,o);return s&&Q(o.httpRegion),!s}):r.httpRegion.hooks.execute.addInterceptor({id:"disabled",async beforeLoop(o){o.bail=!0;let{httpRegion:s}=o.args[0];return Q(s),!0}}),!0):!1}function fn(e,t,r){return e==="forceRegionDelimiter"&&(r.forceRegionDelimiter=!0),!1}function gn(e,t,r){return e==="import"&&t?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new $o(t,r.httpFileStore)),!0):!1}var $o=class{constructor(t,r){this.fileName=t;this.httpFileStore=r;this.id="import"}async process(t){return bt(this.fileName,this.httpFileStore,t)}};function hn(e,t,r){return e==="jwt"?(r.httpRegion.hooks.onResponse.addHook("jwt",async o=>{let s=o.parsedBody||o.body;if(s&&typeof s=="object"){let n=Object.entries(s),i=n;t&&(i=n.filter(([l])=>t.indexOf(l)>=0));for(let[l,u]of i){let m=Fl(u);m&&n.push([`${l}_parsed`,m])}let a=Object.fromEntries(n),d=$(a,2);o.body=d,o.prettyPrintBody=d,o.parsedBody=a}}),!0):!1}function Fl(e){return c(e)?zr(e):null}var yn=require("uuid");function bn(e,t,r){if(e==="keepStreaming"){let o=`keep_streaming_${(0,yn.v4)()}`;return r.httpRegion.hooks.onStreaming.addHook("keepStreaming",async s=>{s.request&&(S(s,"stream until manual cancellation"),await new Promise(n=>{s.requestClient&&s.requestClient.addEventListener("disconnect",()=>n(!0))}))}),r.httpRegion.hooks.onResponse.addHook("keepStreaming",()=>{w.removeUserSession(o)}),!0}return!1}var xn=require("hookpoint"),Rn=require("uuid");function vn(e,t,r){var o,s,n,i;if(e==="loop"&&t){let a=/^\s*for\s+(?<variable>.*)\s+of\s+(?<iterable>.*)\s*/u.exec(t);if((o=a==null?void 0:a.groups)!=null&&o.iterable&&((s=a==null?void 0:a.groups)!=null&&s.variable))return Do(r,{type:1,variable:a.groups.variable,iterable:a.groups.iterable}),!0;let d=/^\s*for\s*(?<counter>\d*)\s*$/u.exec(t);if((n=d==null?void 0:d.groups)!=null&&n.counter)return Do(r,{type:0,counter:Number.parseInt(d.groups.counter,10)}),!0;let l=/^\s*while\s*(?<expression>.*)\s*$/u.exec(t);if((i=l==null?void 0:l.groups)!=null&&i.expression)return Do(r,{type:2,expression:l.groups.expression}),!0}return!1}function Do(e,t){let r=new Io(t);e.httpRegion.hooks.execute.addInterceptor(r),e.httpRegion.hooks.execute.addObjHook(o=>o.process,r)}var Io=class{constructor(t){this.data=t;this.isInLoop=!1;this.id=`loop_${(0,Rn.v4)()}`}async beforeLoop(t){return this.hook=t.hook,this.isInLoop&&(t.index=t.hook.items.findIndex(r=>r.id===this.id)),!0}async process(t){if(this.hook&&!this.isInLoop){let r=[];try{this.isInLoop=!0;let o=this.iterate(t),s=await o.next();for(;!s.done;){S(t,`${s.value.index+1} loop pass`);let n={...t,httpRegion:this.createHttpRegionClone(t.httpRegion,s.value.index),variables:Object.assign(t.variables,s.value.variables)};if(await this.hook.trigger(n)===xn.HookCancel)return!1;r.push(n.variables.response),s=await o.next()}t.httpRegion.metaData.name&&r.length>0&&F({[`${t.httpRegion.metaData.name}`]:r[0],[`${t.httpRegion.metaData.name}List`]:r},t)}finally{this.isInLoop=!1}}return!0}async afterTrigger(t){var r;return!this.isInLoop&&((r=t.hookItem)==null?void 0:r.id)===this.id&&(t.bail=!0),!0}async*iterate(t){switch(this.data.type){case 1:yield*this.iterateForOfLoop(t);break;case 0:yield*this.iterateForLoop();break;case 2:yield*this.iterateWhileLoop(t);break;default:break}}async*iterateForOfLoop(t){if(this.data.variable&&this.data.iterable){let r=await H.evalExpression(this.data.iterable,t),o;if(Array.isArray(r)&&(o=r),o){let s=0;for(let n of o){let i={$index:s};i[this.data.variable]=n,yield{index:s,variables:i},s++}}}}async*iterateWhileLoop(t){if(this.data.expression){let r=0;for(;await H.evalExpression(this.data.expression,t);)yield{index:r,variables:{$index:r}},r++}}*iterateForLoop(){if(this.data.counter)for(let t=0;t<this.data.counter;t++)yield{index:t,variables:{$index:t}}}createHttpRegionClone(t,r){let o=t.clone();return o.metaData.name=t.metaData.name?`${t.metaData.name}${r}`:void 0,o}};function kn(e,t,r){return e==="noRedirect"?(r.httpRegion.hooks.onRequest.addHook("noRedirect",async o=>{o.noRedirect=!0}),!0):!1}function Pn(e,t,r){return e==="noRejectUnauthorized"?(r.httpRegion.hooks.onRequest.addHook("noRejectUnauthorized",async o=>{o.noRejectUnauthorized=!0}),!0):!1}function wn(e,t,r){if(e==="note"){let o=t||`Are you sure you want to send the request ${ct(r.httpRegion)}?`;return r.httpRegion.hooks.execute.addInterceptor({id:"note",beforeLoop:()=>q.showNote(o)}),!0}return!1}function Hn(e,t,r){return e==="proxy"?(r.httpRegion.hooks.onRequest.addHook("proxy",async o=>{o.proxy=t}),!0):!1}function Cn(e,t,{httpRegion:r}){if(e==="ratelimit"&&t){let o=/^\s*(slot(:)?\s*(?<slot>[^\s]+))?\s*(minIdleTime(:)?\s*(?<minIdleTime>\d*))?\s*(max(:)?\s*(?<max>\d*))\s*(expire(:)?\s*(?<expire>\d*))?\s*$/iu.exec(t);if(o!=null&&o.groups){let s=o.groups.slot||"rateLimit",n=o.groups.minIdleTime||"0",i=o.groups.max||"0",a=o.groups.expire||"0";r.hooks.execute.addHook("rateLimit",async d=>{let l=Bl(s,Number.parseInt(n,10),Number.parseInt(i,10),Number.parseInt(a,10));return l.requests.push(await jl(l,d)),!0})}}return!1}async function jl(e,t){for(;e.requests.length>0;){let r=new Date;if(Ml(e.requests,r,e.expire),e.max>0&&e.requests.length>=e.max){let o=e.requests[0],s=e.expire+o.getTime()-r.getTime();s>0&&(S(t,`rate limit max reached. wait for ${s}`),f.debug(`rate limit max reached. wait for ${s} (slot ${e.slot})`),await ce(s),f.debug("rate limit max waited"));continue}if(e.requests.length>0){let o=e.requests[e.requests.length-1];if(o&&e.minIdleTime>0){let s=o.getTime()+e.minIdleTime-r.getTime();if(s>0){S(t,`rate limit minIdleTime, wait for ${s}`),f.debug(`rate limit minIdleTime, wait for ${s} (slot ${e.slot})`),await ce(s),f.debug("rate limit minIdleTime waited");continue}}}return r}return new Date}function Vl(e){let t=e;return!!(t!=null&&t.requests)&&t.type==="RateLimit"}function Bl(e,t,r,o){let s=`ratelimit_${e}`,n=w.getUserSession(s);if(Vl(n))return n.max=r,n.minIdleTime=t,n.expire=o,n;let i=[];t>0&&i.push(`minIdleTime ${t}ms`),o>0&&i.push(`max ${r} with expire ${o}ms`);let a={id:s,type:"RateLimit",title:`rate limit slot ${e}`,details:{slot:e,minIdleTime:t,max:r,expire:o},description:i.join(", "),slot:e,minIdleTime:t,max:r,expire:o,requests:[]};return w.setUserSession(a),a}function Ml(e,t,r){if(r>0){let o=0;for(let s of e)if(t.getTime()-s.getTime()>=r)o++;else break;e.splice(0,o)}else e.splice(0,e.length-1)}var Sn=20,gr=[],hr=0,Tn=500;function Ln(e,t,r){return["ref","forceRef"].indexOf(e)>=0&&t?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new Fo({name:t,force:e==="forceRef"})),!0):!1}var Fo=class{constructor(t){this.data=t;this.id="ref"}async process(t){var s;let r=await I(this.data.name,this.id,t);if(typeof r!="string"||!r)throw f.error(`ref ${this.data.name} not resolvable to a valid name: ${this.data.name} -> ${r}`),new Error(`ref ${this.data.name} not resolvable to a valid name: ${this.data.name} -> ${r}`);hr++;let o=`${t.httpRegion.id}:${r}`;if(hr>Tn)throw f.error(`Total reference calls (${hr}) exceeded limit (${Tn})`),new Error(`Too many reference calls (${hr}) - possible infinite loop or runaway forceRef`);if(gr.length>=Sn){let n=gr.slice(-10).join(" -> ");throw f.error(`Reference depth limit (${Sn}) exceeded. Recent refs: ${n}`),new Error(`Reference depth limit exceeded - possible infinite loop. Recent: ${n}`)}gr.push(o);try{let n=!0;S(t,`load reference ${r}`);let i=Me(r,t);if(i){if(this.isReferenceErroredOrSkipped(i))return Q(t.httpRegion),!1;let a=B(t.activeEnvironment);F(i.variablesPerEnv[a],t),f.trace("import variables",i.variablesPerEnv[a]);let d=Ie(t.variables[r])&&!((s=t.processedHttpRegions)!=null&&s.some(l=>l.id===i.id));(this.data.force||d)&&(n=await i.execute(t),n&&F(i.variablesPerEnv[a],t))}else throw f.error(`ref ${r} not found`),new Error(`ref ${r} not found`);return n}finally{gr.pop()}}isReferenceErroredOrSkipped(t){var r;return!!((r=t.testResults)!=null&&r.some(o=>o.status==="ERROR"||o.status==="SKIPPED"))}};function qn(e,t,r){return e==="responseRef"&&t&&(r.httpRegion.responseRefs||(r.httpRegion.responseRefs=[]),r.httpRegion.responseRefs.push(t)),!1}function En(e,t,r){return e==="sleep"&&t?(r.httpRegion.hooks.execute.addHook("sleep",async o=>{let s=await H.evalExpression(t,o);return Number.isSafeInteger(s)&&(await S(o,`Sleep for ${s}ms`),await ce(s)),!0}),!0):!1}function On(e,t,r){let o=P(t);return e==="timeout"&&o!==void 0?(r.httpRegion.hooks.onRequest.addHook("timeout",async s=>{s.timeout=o}),!0):!1}function An(e,t,r){if(e==="verbose"||e==="debug"){let o=e==="debug"?2:1;return f.options.level=o,r.httpRegion.hooks.execute.addInterceptor({id:"verbose",async beforeLoop(){return f.options.level=o,!0}}),!0}return!1}async function $n(e,{httpRegion:t}){let r=e(!0),o=Ul(r);return o?(t.metaData.description||(t.metaData.description=o.comment),{nextParserLine:o.endLine,symbols:[new R({name:"comment",description:o.comment,kind:"comment",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset})]}):!1}function Ul(e){var r;let t=e.next();if(!t.done){let o=t.value.line,s=/^\s*\/\/\s*(?<comment>.*)\s*$/u.exec(t.value.textLine);if((r=s==null?void 0:s.groups)!=null&&r.comment)return{startLine:o,endLine:o,endOffset:t.value.textLine.length,comment:s.groups.comment};if(/^\s*\/\*$/u.exec(t.value.textLine)){t=e.next();let i=[];for(;!t.done;){if(/^\s*\*\/\s*$/u.test(t.value.textLine))return{startLine:o,endLine:t.value.line,endOffset:t.value.textLine.length,comment:U(i)};i.push(t.value.textLine),t=e.next()}}}return!1}var Dn=/^\s*(#+|\/{2})/u;async function In(e,t){var i,a;let r=e(),{httpRegion:o,data:s}=t;s.metaTitle&&(o.metaData.title=s.metaTitle.trim(),o.metaData.name||(o.metaData.name=s.metaTitle.trim()),delete s.metaTitle);let n=r.next();if(!n.done){let d=n.value.textLine;if(Dn.test(d)){if(_l(t)&&d.trim()!=="###")return f.debug("request with markdown only supports delimiter after request line"),!1;let l={nextParserLine:n.value.line,symbols:[]},u=Te.exec(d);if(u)l.endRegionLine=n.value.line-1,l.symbols.push(new R({name:"separator",description:((i=u.groups)==null?void 0:i.title)||"-",kind:"metaData",startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:d.length})),s.metaTitle=(a=u.groups)==null?void 0:a.title;else{let m=await ht(n.value,t,Dn);m&&(l.symbols=m.symbols)}return l}}return!1}function _l(e){var t;if((t=e.httpRegion.request)!=null&&t.headers){let r=Pe(e.httpRegion.request.headers);if(ut(r))return!0}return!1}async function Fn(e,t){var o,s,n;let r=e();if(t.httpRegion.request){let i=jo(t),a=r.next();if(!a.done&&(i.rawBody.length>0||!ve(a.value.textLine))){let d=[];!i.symbol||i.symbol.endLine!==a.value.line-1?(i.symbol=new R({name:"request body",description:"request body",kind:"requestBody",startLine:a.value.line,startOffset:0,endLine:a.value.line,endOffset:a.value.textLine.length,children:re(a.value.textLine,a.value.line)}),d.push(i.symbol)):(i.symbol.endLine=a.value.line,i.symbol.endOffset=a.value.textLine.length,(s=(o=i.symbol.children)==null?void 0:o.push)==null||s.call(o,...re(a.value.textLine,a.value.line)));let l=yt(a.value.textLine);return l?(i.rawBody.push(l),(n=i.symbol.children)==null||n.push(new R({name:"filename",description:l.fileName,kind:"path",startLine:a.value.line,startOffset:a.value.textLine.indexOf(l.fileName),endLine:a.value.line,endOffset:a.value.textLine.indexOf(l.fileName)+l.fileName.length}))):i.rawBody.push(a.value.textLine),{nextParserLine:a.value.line,symbols:d}}}return!1}function jo(e){let t=e.data.request_body;return t||(t={rawBody:[]},e.data.request_body=t),t}var yr=class{get id(){return"multipart/mixed"}async beforeLoop(t){var o;let r=t.args[1];if(r.httpRegion.request&&Gr(r.httpRegion.request.contentType)){if(r.forceRegionDelimiter===void 0)r.forceRegionDelimiter=!0;else if(r.forceRegionDelimiter){let s=((o=r.httpRegion.request.contentType)==null?void 0:o.boundary)||"",n=jo(r).rawBody.slice().pop();c(n)&&n.includes(`--${s}--`)&&(r.forceRegionDelimiter=!1)}}return!0}};async function jn(e,{httpRegion:t}){var s;let o=e().next();if(!o.done){let n=o.value.textLine,i=/^\s*>>(?<force>!)?\s+(?<fileName>.+)\s*$/u.exec(n);if(i&&((s=i.groups)!=null&&s.fileName)){let a=i.groups.fileName.trim(),d=!!i.groups.force;return t.hooks.onResponse.addHook("outputRedirection",async(l,u)=>{try{if(l.rawBody){let m=x(await I(a,"Variable",u));if(m){let g=await Kl(m,d,u.httpFile.fileName);g?await p.writeBuffer(g,l.rawBody):f.debug(`file ${a} not found`)}else f.debug(`file ${a} not found`)}}catch(m){f.error(`output redirection failed for ${a}`,m)}}),{nextParserLine:o.value.line,symbols:[new R({name:"outputredirection",description:i.groups.filename,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new R({name:"filename",description:a,kind:"path",startLine:o.value.line,startOffset:o.value.textLine.indexOf(a),endLine:o.value.line,endOffset:o.value.textLine.indexOf(a)+a.length})]})]}}}return!1}async function Kl(e,t,r){let o=await Vo(e,r);if(!t&&await p.exists(o)){let s=e.lastIndexOf(".");if(s>0&&s<e.length-2){let n=e.slice(0,s),i=e.slice(s+1),a=1;for(o=await Vo(`${n}-${a}.${i}`,r);await p.exists(o);)o=await Vo(`${n}-${a++}.${i}`,r)}}return o}async function Vo(e,t){if(!await p.isAbsolute(e)){let r=p.dirname(t);if(r)return p.joinPath(r,e)}return e}var Vn=wo({protocol:"HTTP",methodRegex:/^\s*(?<method>GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS|CONNECT|TRACE|PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|CHECKOUT|CHECKIN|REPORT|MERGE|MKACTIVITY|MKWORKSPACE|VERSION-CONTROL|BASELINE-CONTROL|MKCALENDAR|ACL|SEARCH|GRAPHQL)\s+(?<url>.+?)$/u,protocolRegex:/^\s*(?<url>.+)\s*$/iu,requestClientFactory(e,t){if(se.createRequestClient)return se.createRequestClient(e,t);throw new Error("Missing Http Client Provider")},modifyRequest(e){e.method==="HTTP"&&(e.method="GET"),O(e)&&Gl(e)},sessionStore:w});function Gl(e){var t;if(e.url){let r=/(?<url>.*)\s+HTTP\/(?<version>(\S+))/u.exec(e.url);(t=r==null?void 0:r.groups)!=null&&t.version&&r.groups.url&&(e.url=r.groups.url.trim(),["1.1","1.0"].indexOf(r.groups.version)<0&&(e.options||(e.options={}),e.options.http2=!0))}}async function Bn(e,t){return Po(e,t,/^\s*HTTP\/(?<httpVersion>\S+)\s*(?<statusCode>[1-5][0-9][0-9])\s*(-)?\s*(?<statusMessage>.*)$/u)}async function Mn(e,{httpRegion:t}){var s;let o=e().next();if(!o.done){let n=o.value.textLine,i=/^\s*<>\s*(?<fileName>.+?)\s*$/u.exec(n);if(i&&((s=i.groups)!=null&&s.fileName)){t.responseRefs||(t.responseRefs=[]);let a=i.groups.fileName;return t.responseRefs.push(a),{nextParserLine:o.value.line,symbols:[new R({name:"responseRef",description:i.groups.filename,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new R({name:"filename",description:a,kind:"path",startLine:o.value.line,startOffset:n.indexOf(a),endLine:o.value.line,endOffset:n.indexOf(a)+a.length})]})]}}}return!1}async function Nn(e,{httpRegion:t}){let o=e().next();if(!o.done){let s=o.value.textLine,n=/^\s*@(?<useGlobal>global\.)?(?<key>[^\s=:]*)\s*(?<lazyIndicator>:?)=*\s*"?(?<value>.*)"?\s*$/u.exec(s);if(n&&n.groups&&n.groups.key&&n.groups.value){let i=n.groups.key,a=!!n.groups.lazyIndicator,d=!!n.groups.useGlobal,l=n.groups.value;return t.hooks.execute.addHook(`variable_${i}`,async u=>{let m=l;a?u.options.lazyVariables=!0:m=await I(l,"Variable",u);let g=u.variables.$global;return d&&g&&typeof g=="object"?Object.assign(g,{[i]:m}):F({[i]:m},u),!0}),{nextParserLine:o.value.line,symbols:[new R({name:n.groups.key,description:n.groups.value,kind:"variableDefinition",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new R({name:n.groups.key,description:"key",kind:"key",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.key),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.key)+n.groups.key.length}),new R({name:n.groups.value,description:"value",kind:"value",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.value),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.value)+n.groups.value.length})]})]}}}return!1}function Un(e){e.httpRegion.hooks.execute.addInterceptor({id:"cancel",beforeLoop:async function(r){var s,n;return(n=(s=r.args[0].progress)==null?void 0:s.isCanceled)!=null&&n.call(s)?(f.debug("process canceled by user"),!1):!0}})}async function _n(e,t){var r;if(e&&((r=t.config)!=null&&r.defaultHeaders)){S(t,"set default request headers");let o=t.config.defaultHeaders;if(!e.headers)e.headers={...o};else for(let[s,n]of Object.entries(o))E(e.headers,s)||(e.headers[s]=n)}}var Kn=A(require("encodeurl"));async function Gn(e){e.body&&c(e.body)&&ke(e.contentType)&&(e.body=(0,Kn.default)(e.body))}var Wn={id:"excludeProxy",afterLoop:async function(t){var s,n;let[r,o]=t.args;return r.proxy||(r.proxy=(s=o.config)==null?void 0:s.proxy),r.proxy&&(o.httpRegion.metaData.noProxy||(n=o.config)!=null&&n.proxyExcludeList&&o.config.proxyExcludeList.some(i=>r.url.startsWith(i)))&&delete r.proxy,!0}};var Jn={id:"isTrusted",afterLoop:async function(t){if(!q.isTrusted()){let[r]=t.args;return await q.showNote(`Is call to ${r.method} ${r.url} allowed, because workspace is not trusted.`)}return!0}};var de=require("hookpoint");async function zn(e,t){if(S(t,"replace variables in request"),e.url){let r=await I(e.url,"Url",t)||e.url;if(r===de.HookCancel)return de.HookCancel;c(r)&&(e.url=r)}if(await Bo(e,t)===!1)return de.HookCancel;if(await Jl(e,t)===!1)return de.HookCancel}async function Bo(e,t){if(e.body){if(c(e.body)){let r=await I(e.body,"Body",t);if(r===de.HookCancel)return!1;c(r)||Buffer.isBuffer(r)?e.body=r:e.body=x(r)}else if(Array.isArray(e.body)){let r=[];for(let o of e.body)if(c(o)){let s=await I(o,"Body",t);if(s===de.HookCancel)return!1;c(s)&&r.push(s)}else r.push(o);e.body=r}}return!0}async function Jl(e,t){if(e.headers)for(let[r,o]of Object.entries(e.headers))if(Array.isArray(o)){let s=[];for(let n of o){let i=await I(n,r,t);if(i===de.HookCancel)return!1;s.push(i)}e.headers[r]=s}else{let s=await I(o,r,t);if(s===de.HookCancel)return!1;e.headers[r]=s}return!0}async function Xn(e,t){if(e.body&&Array.isArray(e.body)){let r=[];for(let o of e.body)if(c(o))r.push(o);else if(Buffer.isBuffer(o))r.push(o);else{let s=await o(t);s&&r.push(s)}e.body=r}}async function Yn(e){if(e){let t={Accept:"*/*","User-Agent":"httpyac"};if(!e.headers)e.headers=t;else for(let[r,o]of Object.entries(t))E(e.headers,r)||(e.headers[r]=o)}}async function Qn(e,{variables:t}){zl(e,t),Xl(e,t),Yl(e,t),Zl(e,t),Ql(e)}function zl(e,t){e&&t&&typeof t.request_rejectUnauthorized<"u"&&(e.noRejectUnauthorized=!ue(t.request_rejectUnauthorized))}function Xl(e,t){e&&t&&typeof t.request_noRedirect<"u"&&(e.noRedirect=ue(t.request_noRedirect))}function Yl(e,t){c(t==null?void 0:t.request_proxy)&&(e.proxy=t.request_proxy)}function Ql(e){if(e.proxy||!O(e))return;let t=process.env.https_proxy||process.env.HTTPS_PROXY,r=process.env.http_proxy||process.env.HTTP_PROXY;e.url.toLowerCase().startsWith("https")&&c(t)?e.proxy=t:c(r)&&(e.proxy=process.env.httpProxy)}function Zl(e,t){let r=P(t==null?void 0:t.request_timeout);r!==void 0&&(e.timeout=r)}async function Zn(e,t){e.body&&(e.body=await Mo(e.body,t))}async function Mo(e,t){return c(e)||Buffer.isBuffer(e)?e:await ed(e,t)}async function ed(e,t){let r=[];for(let o of e)if(c(o))r.push(o);else if(Buffer.isBuffer(o))r.push(o);else{let s=await o(t);s&&r.push(s)}return r.some(o=>Buffer.isBuffer(o))?Buffer.concat(r.map(o=>Buffer.isBuffer(o)?o:Buffer.from(o))):r.join("")}async function ei(e){if(e.body&&c(e.body)&&ke(e.contentType)){let t=Y(e.body);if(t.length>0){let r=[],o=["=","&"];for(let s of t)r.push(o.reduce((n,i)=>n.split(i).map(a=>a.trim()).join(i),s));e.body=r.join("")}}}async function oi(e){var r;let t=od(e);if(e.httpRegion.request&&t){let o=e.httpRegion.request;nd(t.rawBody);let s=await id(t.rawBody);if(s.length>0){let n=ld(s,o.contentType);n.length>0&&!n[0].wait&&(o.body=(r=n.shift())==null?void 0:r.body),n.length>0&&ud(n,e)}}}function ti(e,t){return ke(t)?ad(e):(sd(e,t),rd(e,t))}function rd(e,t){let r=[],o=[],s=Kr(t)?`\r
`:p.EOL;for(let n of e)c(n)?o.push(n):(o.length>0&&(o.push(""),r.push(o.join(s)),o.length=0),r.push(n),o.push(""));return o.length>0&&r.length===0?o.join(s):(o.length>0&&r.push(o.join(s)),r)}function od(e){let t=e.data.request_body;return t&&delete e.data.request_body,t}function sd(e,t){e.every(r=>c(r))&&Wr(t)&&e.push("")}function nd(e){for(;e.length>0&&ve(e[e.length-1]);)e.pop();if(e.length>0){let t=e[e.length-1];c(t)&&/\s*<--->\s*/u.test(t)&&e.pop()}}async function id(e){let t=[];for(let r of e)if(c(r))t.push(r);else{let{injectVariables:o,fileName:s}=r,n=(i,a)=>{var d;if(a.httpRegion.metaData.injectVariables)return!0;if((d=a.config)!=null&&d.requestBodyInjectVariablesExtensions){let l=ao(i);if(l)return a.config.requestBodyInjectVariablesExtensions.indexOf(l)>=0}return!1};t.push(async i=>await le(s,i,async a=>o||n(r.fileName,i)?await p.readFile(a,r.encoding):p.readBuffer(a)))}return t}function ad(e){let t=e.reduce((r,o,s)=>{let n=r;return c(o)&&(n+=`${s===0||o.startsWith("&")?"":p.EOL}${o}`),n},"");return c(t)?t:""}function ld(e,t){let r=[],o=[],s=!1;for(let n of e){let i=dd(n);i?(o.push({wait:s,body:ti(r,t)}),s=i.waitForServer,r.length=0):r.push(n)}return r.length>0&&o.push({wait:s,body:ti(r,t)}),o}function dd(e){var t;if(c(e)){let r=/\s*={3}\s*(?<wait>wait-for-server)?\s*$/u.exec(e);if(r)return{waitForServer:!!((t=r==null?void 0:r.groups)!=null&&t.wait)}}}function ud(e,t){t.httpRegion.hooks.onStreaming.addHook("streaming_body",async r=>{if(r.requestClient)return new Promise(o=>{pd(e,r,o)})})}async function pd(e,t,r){var s;let o=0;for(let n of e){let i=e.indexOf(n)===e.length-1;if(n.wait&&o++,o===0)await ri(n,t),i&&r();else{let a=0,d=o;(s=t.requestClient)==null||s.addEventListener("message",async()=>{++a===d&&(await ri(n,t),i&&r())})}}}async function ri(e,t){var r;if(await Bo(e,t),e.body){let o=await Mo(e.body,t);o&&await((r=t.requestClient)==null?void 0:r.send(o))}}async function si(e){if(e.data.httpResponseSymbol){if(e.httpRegion.response&&e.data.httpResponseSymbol.body.length>0){let t=e.httpRegion.response,r=U(e.data.httpResponseSymbol.body);t.body=r,t.rawBody=Buffer.from(r),t.headers&&(t.contentType=Pe(t.headers));let o=e.data.httpResponseSymbol.symbol;if(o.children){let s=e.data.httpResponseSymbol.body.at(-1);o.children.push(new R({name:"response body",description:"response body",kind:"response",startLine:o.endLine-e.data.httpResponseSymbol.body.length+1,startOffset:0,endLine:o.endLine,endOffset:(s==null?void 0:s.length)||0}))}}delete e.data.httpResponseSymbol}}async function ni(e){let{httpRegion:t,httpFile:r}=e,{metaData:o}=t;md(o),cd(t,r)}function md(e){let t=e.name;if(typeof t!="string")return;let r=No(e);for(let o of r)if(o===t){let s=`Self-reference detected: region named "${t}" has @ref/@forceRef to itself. This causes an infinite loop. Check for missing ### separator between requests.`;throw f.error(s),new Error(s)}}function cd(e,t){let r=e.metaData.name;if(typeof r!="string")return;let o=No(e.metaData);if(o.length===0)return;let s=new Map;for(let l of t.httpRegions){let u=l.metaData.name;typeof u=="string"&&s.set(u,No(l.metaData))}s.set(r,o);let n=new Set,i=[];function a(l){if(i.includes(l)){let m=i.indexOf(l);return[...i.slice(m),l]}if(n.has(l))return null;n.add(l),i.push(l);let u=s.get(l);if(u)for(let m of u){let g=a(m);if(g)return g}return i.pop(),null}let d=a(r);if(d){let u=`Circular reference detected: ${d.join(" -> ")}. This will cause an infinite loop at runtime.`;throw f.error(u),new Error(u)}}function No(e){let t=[];return typeof e.ref=="string"&&t.push(...e.ref.split(/\s*,\s*/)),typeof e.forceRef=="string"&&t.push(...e.forceRef.split(/\s*,\s*/)),t}var ii={id:"escapeVariable",afterLoop:async function(t){let[r]=t.args;if(c(r)){let o=/(?:\\\{){2}([^}]+?)(?:\\\}){2}/gu,s,n=r;for(;c(n)&&(s=o.exec(r))!==null;){let[i,a]=s;n=n.replace(i,()=>`{{${a}}}`)}n!==r&&t.results.push(n)}return!0}};async function ai(e,t,r){return M(e,async o=>{let s=yt(o);if(s){let n=await le(s.fileName,r,async i=>s.injectVariables||s.encoding?await p.readFile(i,s.encoding):p.readBuffer(i));return s.injectVariables&&(n=await I(n,t,r)),n}})}async function li(e,t,{variables:r,request:o}){if(c(e)&&"Url"===t&&e.startsWith("/")){let s=E(o==null?void 0:o.headers,"Host");if(c(s)){let[,n]=s.toString().split(":");return`${n==="443"||n==="8443"?"https":"http"}://${s}${e}`}if(r.host)return`${r.host}${e}`}return e}async function di(e,t,r){return M(e,async o=>r.variables[o])}var Ge=A(require("dayjs")),Uo=A(require("dayjs/plugin/utc")),ui=require("uuid");Ge.default.extend(Uo.default);async function pi(e,t,{variables:r}){return M(e,async o=>{var n,i,a,d,l,u,m,g,v,k,L,D;let s=o.trim();if(s==="$guid")return(0,ui.v4)();if(s.startsWith("$randomInt")){let b=/^\$randomInt\s*(?<min>-?\d+)?\s*(?<max>-?\d+)?\s*$/u.exec(s);if(b&&((n=b.groups)!=null&&n.min)&&((i=b.groups)!=null&&i.max)){let h=P((a=b.groups)==null?void 0:a.min)??0,T=P((d=b.groups)==null?void 0:d.max)??100;if(!Number.isNaN(h)&&!Number.isNaN(T)){if(h>T){let Xe=T;T=h,h=Xe}return`${Math.floor(Math.random()*(T-h))+h}`}}}else if(s.startsWith("$timestamp")){let b=/^\$timestamp(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if(b){Ge.default.extend(Uo.default);let h=Ge.default.utc();return(l=b.groups)!=null&&l.offset&&((u=b.groups)!=null&&u.option)&&(h=h.add(Number(b.groups.offset),b.groups.option)),`${h.unix()}`}}else if(s.startsWith("$datetime")){let b=/^\$datetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if((m=b==null?void 0:b.groups)!=null&&m.type){let h=Ge.default.utc();return(g=b.groups)!=null&&g.offset&&((v=b.groups)!=null&&v.option)&&(h=h.add(Number(b.groups.offset),b.groups.option)),b.groups.type==="rfc1123"?h.toDate().toUTCString():b.groups.type==="iso8601"?h.toISOString():h.format(b.groups.type.slice(1,b.groups.type.length-1))}}else if(s.startsWith("$localDatetime")){let b=/^\$localDatetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if((k=b==null?void 0:b.groups)!=null&&k.type){let h=Ge.default.utc().local();return(L=b.groups)!=null&&L.offset&&((D=b.groups)!=null&&D.option)&&(h=h.add(Number(b.groups.offset),b.groups.option)),b.groups.type==="rfc1123"?h.locale("en").format("ddd, DD MMM YYYY HH:mm:ss ZZ"):b.groups.type==="iso8601"?h.format():h.format(b.groups.type.slice(1,b.groups.type.length-1))}}else{if(s.startsWith("$processEnv"))return process.env[s.slice(11).trim()]||"";if(s.startsWith("$dotenv"))return r[s.slice(7).trim()]||""}})}var mi=require("hookpoint");async function ci(e,t,{variables:r}){return M(e,async o=>{var i;let n=/^\$(?<type>(prompt|input|password))(?<askonce>-askonce)?\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))?\s*$/u.exec(o);if((i=n==null?void 0:n.groups)!=null&&i.placeholder){let a=n.groups.placeholder.trim(),d=n.groups.type,l=`input_${a}`,u=w.getUserSession(l);if(n.groups.askonce){if((r==null?void 0:r[a])!==void 0)return r[a];if(u!=null&&u.answer)return u.answer}let m=d==="password",g=await q.showInputPrompt(a,(u==null?void 0:u.answer)||n.groups.value,m);return g!==void 0?(w.setUserSession({id:l,title:m?a:`${a}=${g}`,description:`Cache for ${d}`,type:"input",details:{placeholder:a,inputType:d,answer:m?void 0:g},answer:g}),g):mi.HookCancel}})}var fi=require("hookpoint");async function gi(e,t,r){return M(e,async o=>{var n,i;let s=/^\$pick(?<save>-askonce)?\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))\s*$/u.exec(o);if((n=s==null?void 0:s.groups)!=null&&n.placeholder&&((i=s==null?void 0:s.groups)!=null&&i.value)){let a=s.groups.placeholder.trim(),d=`input_${a}`,l=w.getUserSession(d);if(l!=null&&l.answer&&s.groups.save)return l.answer;let u=await gd(s.groups.value,r),m=await q.showListPrompt(a,u);return m!==void 0?(w.setUserSession({id:d,title:`${a}=${m}`,description:"Cache for $pick",type:"input",details:{placeholder:a,answer:m},answer:m}),m):fi.HookCancel}})}async function gd(e,t){let r=e.split(",");if(r.length===1)try{let o=await H.evalExpression(e,t);if(Array.isArray(o))return o}catch(o){f.trace("error in quickpick",o)}return r}function hi(e,t){let{httpRegion:r}=t;if(c(r.metaData.name)){let o=r.metaData.name.trim().replace(/\s/gu,"-").replace(/-./gu,s=>s[1].toUpperCase());F({[o]:e.parsedBody||e.body,[`${o}Response`]:e},t)}}var yi={id:"jsonResponseBody",beforeLoop:async function(t){let[r]=t.args;if(r&&dt(r.contentType)&&c(r.body)&&r.body.length>0)try{r.parsedBody||(r.parsedBody=JSON.parse(r.body)),r.prettyPrintBody||(r.prettyPrintBody=$(r.parsedBody,2))}catch(o){f.warn("json parse error",r.body,o)}return!0}};function bi(e,t){let r=Zr(e);w.setUserSession({id:"last_response",title:"last response",description:`response of ${t.httpRegion.symbol.name}`,details:{},type:"LAST_RESPONSE",response:r}),t.variables.response=e}function xi(e){bd(e),xd(e),Rd(e),wd(e),Pd(e),vd(e),Hd(e),kd(e)}function bd(e){e.hooks.onRequest.addHook("attachDefaultHeaders",_n),e.hooks.onRequest.addHook("setEnvRequestOptions",Qn),e.hooks.onRequest.addHook("resolveRequestBody",Xn),e.hooks.onRequest.addHook("setDefaultHttpyacHeaders",Yn),e.hooks.onRequest.addHook("requestVariableReplacer",zn),e.hooks.onRequest.addHook("transformRequestBody",Zn),e.hooks.onRequest.addHook("transformMultilineFormUrlEncoded",ei),e.hooks.onRequest.addHook("encodeRequestBody",Gn),e.hooks.onRequest.addInterceptor(Jn),e.hooks.onRequest.addInterceptor(Wn)}function xd(e){e.hooks.onResponse.addHook("handleMetaDataName",hi),e.hooks.onResponse.addHook("setLastResponseInVariables",bi),e.hooks.onResponse.addInterceptor(yi)}function Rd(e){e.hooks.parse.addHook("meta",In),e.hooks.parse.addHook("comment",$n),e.hooks.parse.addHook("variable",Nn),e.hooks.parse.addHook("request",Vn),e.hooks.parse.addHook("outputRedirection",jn),e.hooks.parse.addHook("responseRef",Mn),e.hooks.parse.addHook("response",Bn),e.hooks.parse.addHook("requestBody",Fn),e.hooks.parse.addInterceptor(new yr)}function vd(e){e.hooks.parseEndRegion.addHook("registerCancelExecutionInterceptor",Un),e.hooks.parseEndRegion.addHook("response",si),e.hooks.parseEndRegion.addHook("requestBody",oi),e.hooks.parseEndRegion.addHook("validateHttpRegion",ni)}function kd(e){e.hooks.replaceVariable.addHook("host",li),e.hooks.replaceVariable.addHook("name",di),e.hooks.replaceVariable.addHook("file",ai),e.hooks.replaceVariable.addHook("showInputBox",ci),e.hooks.replaceVariable.addHook("showQuickPick",gi),e.hooks.replaceVariable.addHook("restClientDynamic",pi),e.hooks.replaceVariable.addInterceptor(ii)}function Pd(e){e.hooks.parseMetaData.addHook("disabled",cn),e.hooks.parseMetaData.addHook("import",gn),e.hooks.parseMetaData.addHook("jwt",hn),e.hooks.parseMetaData.addHook("keepStreaming",bn),e.hooks.parseMetaData.addHook("loop",vn),e.hooks.parseMetaData.addHook("noRedirect",kn),e.hooks.parseMetaData.addHook("noRejectUnauthorized",Pn),e.hooks.parseMetaData.addHook("timeout",On),e.hooks.parseMetaData.addHook("note",wn),e.hooks.parseMetaData.addHook("proxy",Hn),e.hooks.parseMetaData.addHook("rateLimit",Cn),e.hooks.parseMetaData.addHook("ref",Ln),e.hooks.parseMetaData.addHook("responseRef",qn),e.hooks.parseMetaData.addHook("sleep",En),e.hooks.parseMetaData.addHook("verbose",An),e.hooks.parseMetaData.addHook("forceRegionDelimiter",fn)}function wd(e){let t=new cr;e.hooks.execute.addInterceptor(new fr),e.hooks.execute.addInterceptor(t),e.hooks.responseLogging.addInterceptor(t.getResponseLoggingInterceptor()),e.hooks.execute.addInterceptor(new ur),e.hooks.execute.addInterceptor(new pr),e.hooks.execute.addInterceptor(new mr)}function Hd(e){e.hooks.provideEnvironments.addHook("config",tn),e.hooks.provideVariables.addHook("config",rn),e.hooks.provideVariables.addHook("response",un)}var Ri=require("dotenv");var _o=".env";async function vi(e){let t=[];if(process.env.HTTPYAC_ENV)try{t.push(...await p.readdir(process.env.HTTPYAC_ENV))}catch(s){f.warn(`HTTPYAC_ENV ${process.env.HTTPYAC_ENV} has read error`,s)}let r=p.dirname(e.httpFile.fileName);r&&await pe(r,e.httpFile.rootDir,async s=>{t.push(...await Cd(Pi(e),s)),t.push(...await He(p.readdir(s),[]))});let o=[];for(let s of t){let n;s.startsWith(`${_o}.`)?n=s.slice(5):s.endsWith(_o)&&(n=s.slice(0,s.length-4)),n&&o.push(n)}return f.info("dotenv Env Provider found environments",o),o}async function Cd(e,t){let r=[];if(e){let o=await V(e,t);o&&r.push(...await He(p.readdir(o),[]))}return r}async function ki(e,t){let r=Sd(e),o=[];process.env.HTTPYAC_ENV&&o.push(...await Ko(r,process.env.HTTPYAC_ENV));let s=p.dirname(t.httpFile.fileName);if(s){let n=[];await pe(s,t.httpFile.rootDir,async i=>{n.unshift(...await Td(Pi(t),r,i)),n.unshift(...await Ko(r,i))}),o.push(...n)}return Object.assign({},...o)}function Pi(e){var t;return((t=e.config)==null?void 0:t.envDirName)||"env"}function Sd(e){let t=[_o];if(e)for(let r of e)t.push(`${r}.env`,`.env.${r}`);return t}async function Td(e,t,r){let o=[];if(e){let s=await V(e,r);s&&o.push(...await Ko(t,s))}return o}async function Ko(e,t){let r=await He(p.readdir(t),[]),o=e.filter(n=>r.indexOf(n)>=0),s=[];for(let n of o){let i=p.joinPath(t,n);f.trace(`.env environment file found: ${i}`);try{let a=await p.readFile(i,"utf-8"),d=(0,Ri.parse)(a);s.push(d)}catch(a){f.trace(`${p.toString(i)} not found`,a)}}return s}function wi(e){e.hooks.provideEnvironments.addHook("dotenv",vi),e.hooks.provideVariables.addHook("dotenv",ki)}var Hi=A(require("aws4")),Ci=require("url");async function Si(e,t,r){var s;let{request:o}=r;if(t.toLowerCase()==="authorization"&&c(e)&&O(o)&&(o!=null&&o.url)){let n=/^\s*(aws)\s+(?<accessKeyId>[^\s]*)\s+(?<secretAccessKey>[^\s]*)\s*(token:\s*(?<token>[^\s]*))?\s*(region:\s*(?<region>[^\s]*))?\s*(service:\s*(?<service>[^\s]*))?\s*$/iu.exec(e);if(n&&n.groups&&n.groups.accessKeyId&&n.groups.secretAccessKey){S(r,"get AWS Authorization");let i={accessKeyId:n.groups.accessKeyId,secretAccessKey:n.groups.secretAccessKey,sessionToken:n.groups.token},a=new Ci.URL(o.url);o.headers||(o.headers={});let d={method:o.method,headers:o.headers,host:a.host,path:`${a.pathname}${a.search}`,region:n.groups.region,service:n.groups.service,body:Buffer.isBuffer(o.body)||c(o.body)?o.body:void 0},l=await Hi.default.sign(d,i);return Object.assign(o,{http2:!1}),Object.assign(o.headers,l.headers),(s=l.headers)==null?void 0:s.Authorization}}return e}var Ld=/^\s*(basic)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,qd=/^\s*(basic)\s+(?<user>.*):(?<password>.*)$/iu;async function Ti(e,t){if(t.toLowerCase()==="authorization"&&c(e)){let r=qd.exec(e)||Ld.exec(e);if(r&&r.groups&&r.groups.user)return`Basic ${Buffer.from(`${r.groups.user}:${r.groups.password}`).toString("base64")}`}return e}var Li=require("url");async function qi(e,t,r){var i,a,d;let{request:o,httpRegion:s,httpFile:n}=r;if(c(e)&&O(o)&&!s.metaData.noClientCert){if(t==="Url"&&((i=r.config)!=null&&i.clientCertificates))await Ed(e,o,r);else if(t.toLowerCase().endsWith("clientcert")){let l=/^\s*(cert:\s*(?<cert>[^\s]*)\s*)?(key:\s*(?<key>[^\s]*)\s*)?(pfx:\s*(?<pfx>[^\s]*)\s*)?(passphrase:\s*(?<passphrase>[^\s]*)\s*)?\s*$/u.exec(e);if((a=l==null?void 0:l.groups)!=null&&a.cert||(d=l==null?void 0:l.groups)!=null&&d.pfx){await Ei(o,{cert:l.groups.cert,key:l.groups.key,pfx:l.groups.pfx,passphrase:l.groups.passphrase},n);return}}}return e}async function Ed(e,t,r){var s,n;let o=Od(e);if(o&&((s=r.config)!=null&&s.clientCertificates)){let i=(n=r.config)==null?void 0:n.clientCertificates[o.host];i&&await Ei(t,i,r.httpFile)}}function Od(e){try{return new Li.URL(e)}catch{return}}async function Ei(e,t,r){let o=p.dirname(r.fileName);e.options||(e.options={}),e.options.https=Object.assign({},e.options.https,{certificate:await Go(t.cert,o),key:await Go(t.key,o),pfx:await Go(t.pfx,o),passphrase:t.passphrase})}async function Go(e,t){if(e)if(c(e)){let r=await V(e,t);if(r)return await p.readBuffer(r)}else return await p.readBuffer(e)}W.emptyLineProvider.push(()=>[{name:"GET",description:"The GET method requests a representation of the specified resource. Requests using GET should only retrieve data."},{name:"HEAD",description:"The GET method requests a representation of the specified resource. Requests using GET should only retrieve data."},{name:"POST",description:"The POST method is used to submit an entity to the specified resource, often causing a change in state or side effects on the server."},{name:"PUT",description:"The PUT method replaces all current representations of the target resource with the request payload."},{name:"DELETE",description:"The DELETE method deletes the specified resource."},{name:"CONNECT",description:"The CONNECT method establishes a tunnel to the server identified by the target resource."},{name:"OPTIONS",description:"The OPTIONS method is used to describe the communication options for the target resource."},{name:"TRACE",description:"The TRACE method performs a message loop-back test along the path to the target resource."},{name:"PATCH",description:"The PATCH method is used to apply partial modifications to a resource."}]);W.requestHeaderProvider.push(e=>O(e)?[{name:"A-IM",description:"Acceptable instance-manipulations for the request."},{name:"Accept",description:"Media type(s)\xA0that is/are acceptable for the response. See\xA0Content negotiation."},{name:"Accept-Charset",description:"Character sets that are acceptable."},{name:"Accept-Datetime",description:"Acceptable version in time."},{name:"Accept-Encoding",description:"List of acceptable encodings. See\xA0HTTP compression."},{name:"Accept-Language",description:"List of acceptable human languages for response. See\xA0Content negotiation."},{name:"Access-Control-Request-Method",description:"Initiates a request for\xA0cross-origin resource sharing\xA0with\xA0Origin\xA0(below)."},{name:"Access-Control-Request-Headers",description:"Initiates a request for\xA0cross-origin resource sharing\xA0with\xA0Origin\xA0(below)."},{name:"Authorization",description:"Authentication credentials for\xA0HTTP authentication."},{name:"Cache-Control",description:"Used to specify directives that\xA0must\xA0be obeyed by all caching mechanisms along the request-response chain."},{name:"Connection",description:"Control options for the current connection and list of hop-by-hop request fields. Must not be used with HTTP/2."},{name:"Content-Encoding",description:"The type of encoding used on the data. See\xA0HTTP compression."},{name:"Content-Length",description:"The length of the request body in\xA0octets\xA0(8-bit bytes)."},{name:"Content-MD5",description:"A\xA0Base64-encoded binary\xA0MD5\xA0sum of the content of the request body."},{name:"Content-Type",description:"The\xA0Media type\xA0of the body of the request (used with POST and PUT requests)."},{name:"Cookie",description:"An\xA0HTTP cookie\xA0previously sent by the server with\xA0Set-Cookie\xA0(below)."},{name:"Date",description:'The date and time at which the message was originated (in "HTTP-date" format as defined by\xA0RFC 7231 Date/Time Formats).'},{name:"Expect",description:"Indicates that particular server behaviors are required by the client."},{name:"Forwarded",description:"Disclose original information of a client connecting to a web server through an HTTP proxy."},{name:"From",description:"The email address of the user making the request."},{name:"Host",description:"The domain name of the server (for\xA0virtual hosting), and the\xA0TCP port\xA0number on which the server is listening. The\xA0port\xA0number may be omitted if the port is the standard port for the service requested. Mandatory since HTTP/1.1.\xA0If the request is generated directly in HTTP/2, it should not be used."},{name:"HTTP2-Settings",description:"A request that upgrades from HTTP/1.1 to HTTP/2 MUST include exactly one\xA0HTTP2-Setting\xA0header field. The\xA0HTTP2-Settings\xA0header field is a connection-specific header field that includes parameters that govern the HTTP/2 connection, provided in anticipation of the server accepting the request to upgrade."},{name:"If-Match",description:"Only perform the action if the client supplied entity matches the same entity on the server. This is mainly for methods like PUT to only update a resource if it has not been modified since the user last updated it."},{name:"If-Modified-Since",description:"Allows a\xA0304 Not Modified\xA0to be returned if content is unchanged."},{name:"If-None-Match",description:"Allows a\xA0304 Not Modified\xA0to be returned if content is unchanged, see\xA0HTTP ETag."},{name:"If-Range",description:"If the entity is unchanged, send me the part(s) that I am missing; otherwise, send me the entire new entity."},{name:"If-Unmodified-Since",description:"Only send the response if the entity has not been modified since a specific time."},{name:"Max-Forwards",description:"Limit the number of times the message can be forwarded through proxies or gateways."},{name:"Origin",description:"Initiates a request for\xA0cross-origin resource sharing\xA0(asks server for\xA0Access-Control-*\xA0response fields)."},{name:"Pragma",description:"Implementation-specific fields that may have various effects anywhere along the request-response chain."},{name:"Proxy-Authorization",description:"Authorization credentials for connecting to a proxy."},{name:"Range",description:"Request only part of an entity. Bytes are numbered from 0. See\xA0Byte serving."},{name:"Referer",description:'This is the address of the previous web page from which a link to the currently requested page was followed. (The word "referrer" has been misspelled in the RFC as well as in most implementations to the point that it has become standard usage and is considered correct terminology)'},{name:"TE",description:'The transfer encodings the user agent is willing to accept: the same values as for the response header field Transfer-Encoding can be used, plus the "trailers" value (related to the "chunked" transfer method) to notify the server it expects to receive additional fields in the trailer after the last, zero-sized, chunk. Only\xA0trailers\xA0is supported in HTTP/2.'},{name:"Trailer",description:"The Trailer general field value indicates that the given set of header fields is present in the trailer of a message encoded with\xA0chunked transfer coding."},{name:"Transfer-Encoding",description:"The form of encoding used to safely transfer the entity to the user.\xA0Currently defined methods\xA0are:\xA0chunked, compress, deflate, gzip, identity. Must not be used with HTTP/2"},{name:"User-Agent",description:"The\xA0user agent string\xA0of the user agent."},{name:"Upgrade",description:"Ask the server to upgrade to another protocol. Must not be used in HTTP/2."},{name:"Via",description:"Informs the server of proxies through which the request was sent."},{name:"Warning",description:"A general warning about possible problems with the entity body."},{name:"Upgrade-Insecure-Requests",description:"Tells a server which (presumably in the middle of a HTTP -> HTTPS migration) hosts mixed content that the client would prefer redirection to HTTPS and can handle\xA0Content-Security-Policy: upgrade-insecure-requests Must not be used with HTTP/2"},{name:"X-Requested-With",description:"Mainly used to identify\xA0Ajax\xA0requests (most\xA0JavaScript frameworks\xA0send this field with value of\xA0XMLHttpRequest); also identifies Android apps using WebView"},{name:"DNT",description:"Requests a web application to disable their tracking of a user. This is Mozilla`s version of the X-Do-Not-Track header field (since\xA0Firefox 4.0\xA0Beta 11).\xA0Safari\xA0and\xA0IE9\xA0also have support for this field.\xA0On March 7, 2011, a draft proposal was submitted to IETF.\xA0The\xA0W3C\xA0Tracking Protection Working Group is producing a specification."},{name:"X-Forwarded-For",description:"A\xA0de facto\xA0standard\xA0for identifying the originating IP address of a client connecting to a web server through an HTTP proxy or load balancer. Superseded by\xA0Forwarded\xA0header."},{name:"X-Forwarded-Host",description:"A\xA0de facto\xA0standard\xA0for identifying the original host requested by the client in the\xA0Host\xA0HTTP request header, since the host name and/or port of the reverse proxy (load balancer) may differ from the origin server handling the request. Superseded by\xA0Forwarded\xA0header."},{name:"X-Forwarded-Proto",description:"A\xA0de facto\xA0standard\xA0for identifying the originating protocol of an HTTP request, since a reverse proxy (or a load balancer) may communicate with a web server using HTTP even if the request to the reverse proxy is HTTPS. An alternative form of the header (X-ProxyUser-Ip) is used by Google clients talking to Google servers. Superseded by\xA0Forwarded\xA0header."},{name:"Front-End-Https",description:"Non-standard header field used by Microsoft applications and load-balancers"},{name:"X-Http-Method-Override",description:"Requests a web application to override the method specified in the request (typically POST) with the method given in the header field (typically PUT or DELETE). This can be used when a user agent or firewall prevents PUT or DELETE methods from being sent directly (note that this is either a bug in the software component, which ought to be fixed, or an intentional configuration, in which case bypassing it may be the wrong thing to do)."},{name:"X-ATT-DeviceId",description:"Allows easier parsing of the MakeModel/Firmware that is usually found in the User-Agent String of AT&T Devices"},{name:"X-Wap-Profile",description:"Links to an XML file on the Internet with a full description and details about the device currently connecting. In the example to the right is an XML file for an AT&T Samsung Galaxy S2."},{name:"Proxy-Connection",description:"Implemented as a misunderstanding of the HTTP specifications. Common because of mistakes in implementations of early HTTP versions. Has exactly the same functionality as standard Connection field. Must not be used with HTTP/2."},{name:"X-UIDH",description:'Server-side\xA0deep packet insertion\xA0of a unique ID identifying customers of\xA0Verizon Wireless; also known as "perma-cookie" or "supercookie"'},{name:"X-Csrf-Token",description:"Used to prevent\xA0cross-site request forgery. Alternative header names are:\xA0X-CSRFToken\xA0and\xA0X-XSRF-TOKEN"},{name:"X-Request-ID",description:"Correlates HTTP requests between a client and server."},{name:"X-Correlation-ID",description:"Correlates HTTP requests between a client and server."},{name:"Save-Data",description:"The Save-Data client hint request header available in Chrome, Opera, and Yandex browsers lets developers deliver lighter, faster applications to users who opt-in to data saving mode in their browser."}]:[]);var kt=require("tough-cookie");var br=class{constructor(){this.id="cookieJar"}async beforeTrigger(t){let{request:r,httpRegion:o,config:s,options:n}=t.args[0];if(O(r)&&!o.metaData.noCookieJar&&(s!=null&&s.cookieJarEnabled)){let i=this.getCookieStorePrefix(t.args[0]),a=w.userSessions.filter(m=>m.type==="Cookie"&&m.id.startsWith(i)),d=new kt.MemoryCookieStore;for(let m of a)m.cookie&&d.putCookie(m.cookie,g=>{g&&f.info(g)});n.memoryStore=d;let l={};s.cookieJarEnabled!==!0&&Object.assign(l,s.cookieJarEnabled);let u=new kt.CookieJar(d,l);r.options||(r.options={}),r.options.cookieJar=u}return!0}async afterTrigger(t){let{options:r}=t.args[0],o=r.memoryStore;if(o&&o instanceof kt.MemoryCookieStore){o.getAllCookies((n,i)=>{if(!n)for(let a of i||[]){let d={id:`${this.getCookieStorePrefix(t.args[0])}_${a.toString()}`,title:`${a.domain} ${a.path} ${a.key}`,description:`${a}`,type:"Cookie",details:Object.fromEntries(Object.entries(a).map(([l,u])=>u?u instanceof Date?[l,u.toISOString()]:[l,u]:[]).filter(l=>l.length>0)),cookie:a};w.setUserSession(d)}});let s=w.userSessions.filter(n=>n.type==="Cookie");for(let n of s)n.cookie&&o.putCookie(n.cookie,i=>{i&&f.info(i)})}return!0}getCookieStorePrefix(t){var r,o;return`Cookies_${B(t.activeEnvironment)}_${((o=(r=t.httpFile.rootDir)==null?void 0:r.toString)==null?void 0:o.call(r))||"none"}`}};var Oi=require("tough-cookie");async function Ai(e,t,r){var s;let{request:o}=r;if(t.toLowerCase()==="cookie"&&O(o)&&o.url&&((s=o.options)==null?void 0:s.cookieJar)instanceof Oi.CookieJar){if(c(e))o.options.cookieJar.setCookie(e,o.url);else if(Array.isArray(e))for(let n of e)await o.options.cookieJar.setCookie(n,o.url);return}return e}var Bi=require("crypto"),Mi=require("url"),Ni=require("uuid");var $i=require("filesize"),xr=A(require("got")),Di=require("http-proxy-agent"),Ii=require("https-proxy-agent"),Fi=A(require("lodash/merge")),ji=require("socks-proxy-agent");async function Vi(e,t){try{let r=Wo(e,t),s=await(0,xr.default)(e.url||"",r);return qe(s,e)}catch(r){if(r instanceof xr.CancelError)return!1;throw r}}function Wo(e,t){var s;let{config:r}=t,o=(0,Fi.default)({decompress:!0,retry:0,throwHttpErrors:!1,allowGetBody:!0},r==null?void 0:r.request,{method:e.method,headers:e.headers,body:e.body,timeout:e.timeout},e.options);return e.noRedirect&&(o.followRedirect=!1),e.noRejectUnauthorized&&(o.https=((s=e.options)==null?void 0:s.https)||{},o.https.rejectUnauthorized=!1),Ad(o,e.proxy),$d(o.headers),f.debug("request",o),o}function Ad(e,t){if(t)if(t.startsWith("socks://")){let r=new ji.SocksProxyAgent(t);e.agent={http:r,https:r}}else e.agent={http:new Di.HttpProxyAgent(t),https:new Ii.HttpsProxyAgent(t)}}function $d(e){if(e){for(let[t,r]of Object.entries(e))if(typeof r<"u"){let o;Array.isArray(r)?o=r.map(s=>x(s)||s):o=x(r)||"",e[t]=o}}}function qe(e,t){var r;return{name:`${e.statusCode} - ${t.method||"GET"} ${t.url}`,statusCode:e.statusCode,protocol:`HTTP/${e.httpVersion}`,statusMessage:e.statusMessage,body:e.body,rawHeaders:e.rawHeaders,rawBody:e.rawBody,headers:e.headers,timings:e.timings.phases,httpVersion:e.httpVersion,request:{protocol:"HTTP",method:e.request.options.method,url:`${e.request.options.url}`,headers:e.request.options.headers,body:Jo(e.request.options.body)},contentType:Pe(e.headers),meta:{ip:e.ip,redirectUrls:e.redirectUrls,size:(0,$i.filesize)(e.rawHeaders.map(o=>o.length).reduce((o,s)=>o+s,0)+(((r=e.rawBody)==null?void 0:r.length)||0))}}}function Jo(e){if(typeof e=="string"||Buffer.isBuffer(e))return e}var Dd=/^\s*(digest)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,Id=/^\s*(digest)\s+(?<user>.*):(?<password>.*)$/iu;async function Ui(e,t,r){let{request:o}=r;if(t.toLowerCase()==="authorization"&&c(e)&&O(o)){let s=Id.exec(e)||Dd.exec(e);if(s&&s.groups&&s.groups.user&&s.groups.password){o.options||(o.options={}),o.options.hooks||(o.options.hooks={}),o.options.hooks.afterResponse||(o.options.hooks.afterResponse=[]),o.options.hooks.afterResponse.push(Fd(s.groups.user,s.groups.password,r));return}}return e}function Fd(e,t,r){return async function(s,n){let i=s.headers["www-authenticate"];if(s.statusCode===401&&i&&i.toLowerCase().startsWith("digest")){let a=qe(s,{url:s.request.requestUrl});await Se(a,r);let d=new Mi.URL(s.url),l={qop:"",algorithm:"",realm:"",nonce:"",opaque:""};Bd(l,i);let u=/(^|,)\s*auth\s*($|,)/u.test(l.qop)&&"auth",m=u&&"00000001",g=u&&(0,Ni.v4)().replace(/-/gu,""),v=Vd(l.algorithm,e,t,l.realm,l.nonce,g),k=Pt(`${s.request.options.method}:${d.pathname}`),L=Pt(u?`${v}:${l.nonce}:${m}:${g}:${u}:${k}`:`${v}:${l.nonce}:${k}`);return n({headers:{authorization:`Digest ${jd({username:e,realm:l.realm,nonce:l.nonce,uri:d.pathname,qop:u,response:L,nc:m,cnonce:g,algorithm:l.algorithm,opaque:l.opaque})}`}})}return s}}function jd(e){let t=[];for(let[r,o]of Object.entries(e))o&&(["qop","nc","algorithm"].indexOf(r)>=0?t.push(`${r}=${o}`):t.push(`${r}="${o}"`));return t.join(", ")}function Pt(e){return(0,Bi.createHash)("md5").update(e).digest("hex")}function Vd(e,t,r,o,s,n){let i=Pt(`${t}:${o}:${r}`);return n&&(e==null?void 0:e.toLowerCase())==="md5-sess"?Pt(`${i}:${s}:${n}`):i}function Bd(e,t){for(let r of t.split(",")){let o=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/giu.exec(r);o&&(e[o[1]]=o[2]||o[3])}}var wt=A(require("got"));var Rr=class extends at{constructor(r,o){super();this.request=r;this.context=o}get reportMessage(){return`perform Http Request (${this.request.url})`}get supportsStreaming(){return!1}get nativeClient(){return wt.default}async connect(){return this.nativeClient}async send(r){if(O(this.request)&&this.request.url)try{let o=Wo(this.request,this.context);r&&(o.body=ie(r)),this.cancelableRequest=(0,wt.default)(this.request.url,o),this.registerEvents(this.cancelableRequest);let s=await this.cancelableRequest;this.onMessage("message",qe(s,this.request))}catch(o){if(o instanceof wt.CancelError)return;throw o instanceof TypeError&&o.message==="Invalid URL"&&(o.message=`Invalid URL: ${o.input||this.request.url}`),o}finally{delete this.cancelableRequest}}disconnect(r){var o;r&&((o=this.cancelableRequest)==null||o.cancel(),this.onDisconnect())}registerEvents(r){r.on("downloadProgress",s=>{this.onProgress(s.percent)});let o=s=>(...n)=>{this.onMetaData(s,{protocol:"HTTP",statusCode:0,message:n.length>0?`${x(n[0])}`:void 0,body:{...n}})};r.on("redirect",o("redirect")),r.on("retry",o("retry")),r.on("downloadProgress",o("downloadProgress")),r.on("uploadProgress",o("uploadProgress"))}};async function _i(e,t){var r,o;if(e&&O(e)){e.options||(e.options={}),(r=e.options)!=null&&r.hooks||(e.options.hooks={}),(o=e.options)!=null&&o.hooks.beforeRedirect||(e.options.hooks.beforeRedirect=[]),e.options.hooks.beforeRequest||(e.options.hooks.beforeRequest=[]);let s;e.options.hooks.beforeRequest.push(n=>{s={protocol:"HTTP",method:n.method,url:`${n.url}`,headers:n.headers,body:Jo(n.body)}}),e.options.hooks.beforeRedirect.push(async(n,i)=>{let a=qe(i,s||{url:x(n.url)||""});await Se(a,t)})}}function Ki(e,t,r){return e==="postRedirectGet"?(r.httpRegion.hooks.onRequest.addHook("postRedirectGet",async o=>{O(o)&&(o.options||(o.options={}),o.options.hooks||(o.options.hooks={}),o.options.hooks.beforeRedirect||(o.options.hooks.beforeRedirect=[]),o.options.hooks.beforeRedirect.push(s=>{s.method="GET",s.body=void 0}))}),!0):!1}se.exchange=Vi;se.createRequestClient=(e,t)=>new Rr(e,t);function Gi(e){e.hooks.parseMetaData.addHook("postRedirectGet",Ki),e.hooks.execute.addInterceptor(new br),e.hooks.replaceVariable.addHook("aws",Si),e.hooks.replaceVariable.addHook("basicAuth",Ti),e.hooks.replaceVariable.addHook("clientCertificate",qi),e.hooks.replaceVariable.addHook("digestAuth",Ui),e.hooks.replaceVariable.addHook("cookie",Ai),e.hooks.onRequest.addHook("logHttpRedirect",_i)}var We=class{constructor(t,r,o){this.extensions=t;this.beginCodeBlock=r;this.endCodeBlock=o}async beforeTrigger(t){let r=t.args[0],o=t.args[1];if(p.hasExtension(o.httpFile.fileName,...this.extensions)){let s=this.getHttpBlockLines(o.lines,o.data);t.args[0]=function*(i){if(s.length>0){let a=r(!0);for(let d of a){let l=s.find(u=>u.startLine<=d.line&&d.line<u.endLine);if(l)if(l.startLine===d.line)yield{line:d.line,textLine:"###"};else{if(!i&&Te.test(d.textLine))break;yield d}else break}}}}return!0}getHttpBlockLines(t,r){if(r.codeBlocks)return r.codeBlocks;let o=[],s=-1;for(let n=0;n<t.length;n++){let i=t[n];s<0?Array.isArray(this.beginCodeBlock)?t.length>n+this.beginCodeBlock.length&&this.beginCodeBlock.every((a,d)=>a.test(t[n+d]))&&(s=n+this.beginCodeBlock.length-1,n+=this.beginCodeBlock.length-1):this.beginCodeBlock.test(i)&&(s=n):this.endCodeBlock.test(i)&&(o.push({startLine:s,endLine:n}),s=-1)}return r.codeBlocks=o,o}};var vr=class extends We{constructor(){super(["adoc","asciidoc","asc"],[/^\[source,http\]\s*$/iu,/^----\s*$/u],/^----\s*$/u);this.id="asciidoc"}};var kr=class extends We{constructor(){super(["md","markdown","mdown","mkdn","mdtxt","mdtext","text","rmd"],/^```\s*(http|rest)$/iu,/^```\s*$/u);this.id="markdown"}};function Wi(e){e.hooks.parse.addInterceptor(new kr),e.hooks.parse.addInterceptor(new vr)}var z=require("crypto");var Pr=class{constructor(){this.hmac=new Xo}sha1(){return new oe((0,z.createHash)("sha1"))}sha256(){return new oe((0,z.createHash)("sha256"))}sha384(){return new oe((0,z.createHash)("sha384"))}sha512(){return new oe((0,z.createHash)("sha512"))}md5(){return new oe((0,z.createHash)("md5"))}},oe=class e{constructor(t){this.hash=t}updateWithText(t,r){let o=Ve(r),s=this.hash.update(Buffer.from(t,o));return new e(s)}updateWithHex(t){let r=this.hash.update(Buffer.from(t,"hex"));return new e(r)}updateWithBase64(t,r){let o=this.hash.update(Buffer.from(t,r?"base64url":"base64"));return new e(o)}digest(){return new zo(this.hash)}},zo=class{constructor(t){this.hash=t}toHex(){return this.hash instanceof z.Hmac?this.hash.digest("hex"):this.hash.digest("hex")}toBase64(t){let r=t?"base64url":"base64";return this.hash instanceof z.Hmac?this.hash.digest(r):this.hash.digest(r)}},Xo=class{sha1(){return new Ee("sha1")}sha256(){return new Ee("sha256")}sha384(){return new Ee("sha384")}sha512(){return new Ee("sha512")}md5(){return new Ee("md5")}},Ee=class{constructor(t){this.algorithm=t}withTextSecret(t,r){let o=(0,z.createHmac)(this.algorithm,Buffer.from(t,Ve(r)));return new oe(o)}withHexSecret(t){let r=(0,z.createHmac)(this.algorithm,Buffer.from(t,"hex"));return new oe(r)}withBase64Secret(t,r){let o=(0,z.createHmac)(this.algorithm,Buffer.from(t,r?"base64url":"base64"));return new oe(o)}};var Ji=require("assert");var Oe=class{constructor(t){this.context=t;this.userSession=this.getIntellijSession()}getIntellijSession(){let t="intellij_global_cache",r=w.getUserSession(t);if(this.isIntellijGlobalCacheSession(r))return r;let o={id:t,title:"Intellij Cache",description:"Global Cache for all Intellij Variables",details:{},type:"intellij_global_cache"};return w.setUserSession(o),o}isIntellijGlobalCacheSession(t){return!!(t!=null&&t.id)&&!!t.title}set(t,r){this.userSession.details[t]=r,F({[t]:r},this.context)}get(t){return this.context.variables[t]}isEmpty(){return Object.entries(this.userSession.details).length===0}clear(t){delete this.userSession.details[t],Ce(t,this.context)}clearAll(){for(let[t]of Object.entries(this.userSession.details))this.clear(t)}};var wr=class{constructor(t){this.context=t;this.global=new Oe(t)}test(t,r){mt(this.context)(t,r)}assert(t,r){(0,Ji.ok)(t,r)}log(t){this.context.scriptConsole&&this.context.scriptConsole.info(t)}exit(){var t;(t=this.context.scriptConsole)==null||t.warn("exit not supported")}};var Xi=require("uuid");function Hr(e){let t=e.trim();if(["$uuid","$random.uuid"].indexOf(t)>=0)return(0,Xi.v4)();if(t==="$timestamp")return x(Date.now());if(t==="$isoTimestamp")return new Date().toISOString();if(t==="$randomInt")return`${Math.floor(Math.random()*1e3)}`;if(t.startsWith("$random.integer")){let r=zi(t);if(r)return`${Math.floor(r)}`}if(t.startsWith("$random.float")){let r=zi(t);if(r)return`${r}`}if(t.startsWith("$random.alphabetic"))return Md(t);if(t.startsWith("$random.alphanumeric"))return Nd(t);if(t.startsWith("$random.hexadecimal"))return Ud(t);if(t.startsWith("$random.email"))return Ue()}function zi(e){var r,o,s,n;let t=/^\$random.(integer|float)\s*\(\s*(?<from>-?\d+)\s*,\s*(?<to>-?\d+)\s*\)$/u.exec(e);if(t&&((r=t.groups)!=null&&r.from)&&((o=t.groups)!=null&&o.to)){let i=P((s=t.groups)==null?void 0:s.from)||0,a=P((n=t.groups)==null?void 0:n.to)||0;if(!Number.isNaN(i)&&!Number.isNaN(a)){if(i>a){let d=a;a=i,i=d}return Math.random()*(a-i)+i}}}function Md(e){var r,o;let t=/^\$random.alphabetic\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=P((o=t.groups)==null?void 0:o.length);if(s)return G(s,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz")}}function Nd(e){var r,o;let t=/^\$random.alphanumeric\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=P((o=t.groups)==null?void 0:o.length);if(s)return G(s)}}function Ud(e){var r,o;let t=/^\$random.hexadecimal\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=P((o=t.groups)==null?void 0:o.length);if(s)return G(s,"1234567890ABCDEF")}}async function Yi(e,t,r){return M(e,async o=>Hr(o))}var Cr=class{url(){return this._url}body(){return this._body||""}constructor(t){var r,o,s,n;this._url=((r=t.request)==null?void 0:r.url)||"",this.method=((o=t.request)==null?void 0:o.method)||"",this._body=((s=t.request)==null?void 0:s.body)&&x((n=t.request)==null?void 0:n.body),this.headers=new Tr(t),this.environment=new qr(t.variables),this.variables=new Oe(t)}},Sr=class{constructor(t){var r;this.url=new Qo(t),this.method=((r=t.request)==null?void 0:r.method)||"",this.body=new Yo(t),this.headers=new Tr(t),this.environment=new qr(t.variables),this.variables=new Oe(t)}},Yo=class{constructor(t){this.context=t}getRaw(){var t;return x((t=this.context.request)==null?void 0:t.body)||""}tryGetSubstituted(){var r;let t=Zo(this.getRaw(),this.context.variables);return t&&((r=this.context.request)!=null&&r.body)&&(this.context.request.body=t),t}},Tr=class{constructor(t){this.context=t}all(){var t;return(t=this.context.request)!=null&&t.headers?Object.keys(this.context.request.headers).map(r=>new Lr(r,this.context)):[]}findByName(t){var r;return E((r=this.context.request)==null?void 0:r.headers,t)?new Lr(t,this.context):null}},Lr=class{constructor(t,r){this.name=t;this.context=r}value(){return this.getRawValue()}getRawValue(){var t;return x(E((t=this.context.request)==null?void 0:t.headers,this.name))||""}tryGetSubstitutedValue(){var r;let t=Zo(this.getRawValue(),this.context.variables);return t&&((r=this.context.request)!=null&&r.headers)&&(Jr(this.context.request.headers,this.name),this.context.request.headers[this.name]=t),t}},Qo=class{constructor(t){this.context=t}getRaw(){var t;return((t=this.context.request)==null?void 0:t.url)||""}tryGetSubstituted(){var r;let t=Zo(this.getRaw(),this.context.variables);return t&&((r=this.context.request)!=null&&r.body)&&(this.context.request.body=t),t}},qr=class{constructor(t){this.variables=t}get(t){let r=x(this.variables[t]);return Ie(r)?null:r}};function Zo(e,t){let r=e,o=[Hr,s=>{let n=t[s];if(!Ie(n))return x(n)}];for(let s of o)r=_d(r,s);return r}function _d(e,t){if(!c(e))return e;let r,o,s=e,n=0;for(;o!==s&&n++<100;)for(o=s;(r=gt.exec(o))!==null;){let[i,a]=r,d=t(a,i);if(typeof d<"u"&&i===e)return d;let l=x(d);typeof l<"u"&&(s=s.replace(i,()=>l))}return s}var Er=class{constructor(t){this.body=t.parsedBody||t.body,this.status=t.statusCode,this.contentType=es(t.contentType),this.headers=new Or(t.headers)}};function es(e){return{mimeType:(e==null?void 0:e.mimeType)||"application/octet-stream",charset:(e==null?void 0:e.charset)||"utf-8"}}var Or=class{constructor(t){this.headers=t}valueOf(t){if(this.headers){let r=E(this.headers,t);if(r&&c(r))return r}return null}valuesOf(t){if(this.headers){let r=E(this.headers,t);if(r){if(c(r))return[r];if(Array.isArray(r))return r}}return[]}},Ar=class{constructor(t,r){this.requestClient=t;this.resolve=r;this.status=0;this.contentType=es();this.lazyHeaders={};this.body={onEachLine:(...o)=>this.onEachLine(...o),onEachMessage:(...o)=>this.onEachMessage(...o)},this.headers=new Or(this.lazyHeaders)}onEachLine(t,r){this.onEachMessage(t,r)}onEachMessage(t,r){let o=s=>{let[,n]=s.detail;this.status=n.statusCode,Object.assign(this.headers,n.headers),this.contentType=es(n.contentType);let i=x(n.body);i&&t(i,()=>{this.requestClient.removeEventListener("message",o),this.resolve()},l=>this.requestClient.send(l))};this.requestClient.addEventListener("message",o),r&&this.requestClient.addEventListener("end",r)}};var Qi=A(require("dayjs"));var Zi=require("uuid"),$r=class{alphabetic(t=10){return G(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz")}numeric(t=10){return G(t)}hexadecimal(t=10){return G(t,"1234567890ABCDEF")}get email(){return Ue()}float(t=0,r=100){return Math.random()*(r-t)+t}integer(t=0,r=100){return Math.floor(Math.random()*(r-t)+t)}get uuid(){return(0,Zi.v4)()}date(t=new Date,r=void 0){return(0,Qi.default)(t).format(r)}};var Dr=class{btoa(t){return global.btoa(t)}atob(t){return global.atob(t)}};W.variableProvider.push(()=>[{name:"$uuid",description:"UUID"},{name:"$uuid",description:"UUID"},{name:"$random.uuid",description:"UUID"},{name:"$timestamp",description:"Timestamp"},{name:"$isoTimestamp",description:"ISOTimestamp"},{name:"$randomInt",description:"randomInt (0 -1000)"},{name:"$random.integer",description:"integer"},{name:"$random.float",description:"float"},{name:"$random.alphabetic",description:"Alphabetic Text"},{name:"$random.alphanumeric",description:"Alphanumeric Text"},{name:"$random.hexadecimal",description:"Hexadecimal String"},{name:"$random.email",description:"EMail"}]);var Ir=class{constructor(t,r){this.scriptData=t;this.id="intellij";r&&(this.before=["requestVariableReplacer"])}isStreamingScript(t){return["onEachLine","onEachMessage"].some(r=>t.script.indexOf(r)>0)}async processOnRequest(t,r){S(r,"execute Intellij Javascript");let o=await this.loadScript(r);if(this.isStreamingScript(o))return;let s=ts(r);await this.executeScriptData(o,s,r)}async processOnStreaming(t){let r=await this.loadScript(t);if(this.scriptData=r,this.isStreamingScript(r)&&t.requestClient){let o=t.requestClient;await new Promise(s=>{let n=ts(t);n.response=new Ar(o,s),this.executeScriptData(r,n,t)})}}async processOnResponse(t,r){S(r,"execute Intellij Javascript");let o=await this.loadScript(r);if(this.isStreamingScript(o))return;let s=ts(r);s.response=new Er(t),await this.executeScriptData(o,s,r)}async executeScriptData(t,r,o){return H.runScript?(await H.runScript(t.script,{fileName:o.httpFile.fileName,context:{console:o.scriptConsole,...r},lineOffset:t.lineOffset}),!0):!1}async loadScript(t){if(this.isIntellijScriptData(this.scriptData))try{return{script:await le(this.scriptData.fileName,t,r=>p.readFile(r,"utf-8"))||"",lineOffset:0}}catch(r){throw(t.scriptConsole||f).error(this.scriptData.fileName,r),new Error(`error loading script ${this.scriptData.fileName}`)}else return this.scriptData}isIntellijScriptData(t){return!!t.fileName}};function ts(e){let t={client:new wr(e),crypto:new Pr,$random:new $r,$env:process.env,Window:new Dr};return e.request&&(e.httpRegion.response?t.request=new Cr(e):t.request=new Sr(e)),t}async function ea(){let e=w.getUserSession("intellij_global_cache");return(e==null?void 0:e.details)||{}}async function ta(e,{httpRegion:t}){let r=e(),o=Gd(r,!!t.request);if(o){let s=new Ir(o.data,o.isBeforeRequest);return o.isBeforeRequest?t.hooks.onRequest.addObjHook(n=>n.processOnRequest,s):(t.hooks.onStreaming.addObjHook(n=>n.processOnStreaming,s),t.hooks.onResponse.addObjHook(n=>n.processOnResponse,s)),{nextParserLine:o.endLine,symbols:[new R({name:"Intellij Script",description:"Intellij Script",kind:"script",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset,children:o.symbols})]}}return!1}function Gd(e,t){var o,s,n;let r=e.next();if(!r.done){let i=r.value.line,a=/^\s*(?<event>(<|>))\s+(?<fileName>[^\s{%}]+\s*)$/u.exec(r.value.textLine);if((o=a==null?void 0:a.groups)!=null&&o.fileName){if(a.groups.event==="<"&&t)return!1;let u=a.groups.fileName.trim();return{startLine:i,endLine:i,endOffset:r.value.textLine.length,data:{fileName:u},isBeforeRequest:a.groups.event==="<",symbols:[new R({name:"filename",description:u,kind:"path",startLine:r.value.line,startOffset:r.value.textLine.indexOf(u),endLine:r.value.line,endOffset:r.value.textLine.indexOf(u)+u.length})]}}let d=/^\s*(?<event>(<|>))\s+\{%\s*(?<script>.*)\s*%\}\s*$/u.exec(r.value.textLine);if((s=d==null?void 0:d.groups)!=null&&s.script)return d.groups.event==="<"&&t?!1:{startLine:i,endLine:i,endOffset:r.value.textLine.length,data:{script:d.groups.script,lineOffset:i},isBeforeRequest:d.groups.event==="<"};let l=/^\s*(?<event>(<|>))\s+\{%\s*$/u.exec(r.value.textLine);if((n=l==null?void 0:l.groups)!=null&&n.event){if(l.groups.event==="<"&&t)return!1;r=e.next();let u=[];for(;!r.done;){if(/^\s*%\}\s*$/u.test(r.value.textLine))return{startLine:i,endLine:r.value.line,endOffset:r.value.textLine.length,data:{script:U(u),lineOffset:i},isBeforeRequest:l.groups.event==="<"};u.push(r.value.textLine),r=e.next()}}}return!1}async function ra(e,t,r){return M(e,async o=>{if(o.trim()==="$projectRoot")return r.httpFile.rootDir})}async function oa(e){let t=Object.keys(await sa(e));return f.info("Intellij Env Provider found environments",t),t}async function sa(e){var i;let t=[],r=a=>["http-client.env.json","http-client.private.env.json"].includes(a),o=process.env.HTTPYAC_ENV;if(o&&c(o)){let a=await V(o,e.httpFile.rootDir);a&&t.push(...await rs(a,r))}if((i=e.config)!=null&&i.envDirName){let a=await V(e.config.envDirName,e.httpFile.rootDir);a&&t.push(...await rs(a,r))}let s=p.dirname(e.httpFile.fileName);s&&await pe(s,e.httpFile.rootDir,async a=>{t.push(...await rs(a,r))});let n={};t.length>0&&f.trace(`Intellij environment files found: ${t.join(", ")}`),t.sort((a,d)=>{let l=p.toString(a),u=p.toString(d),m=l.endsWith("private.env.json"),g=u.endsWith("private.env.json");return m===g?l.localeCompare(u):m?1:-1});for(let a of t){let d=await Wd(a);if(d)for(let[l,u]of Object.entries(d))n[l]?(p.toString(a).endsWith("private.env.json")||f.warn(`Multiple files with environment ${l} were found.`),Object.assign(n[l],u)):n[l]=u}return n}async function rs(e,t){return(await He(p.readdir(e),[])).filter(t).map(o=>p.joinPath(e,o))}async function na(e,t){let r=await sa(t),o=[];if(e)for(let s of e)o.push(r[s]);return Object.assign({},...o)}async function Wd(e){try{if(await p.exists(e)){let t=await p.readFile(e,"utf-8");return JSON.parse(t)}}catch(t){f.trace(`${e} not found`),f.trace(t)}}function ia(e){e.hooks.parse.addHook("intellijScript",ta,{before:["request"]}),e.hooks.provideEnvironments.addHook("intellij",oa),e.hooks.provideVariables.addHook("intellij",na),e.hooks.provideVariables.addHook("intellij_global",ea),e.hooks.replaceVariable.addHook("intellijDynamic",Yi,{before:["name"]}),e.hooks.replaceVariable.addHook("intellijProjectContext",ra,{before:["name"]})}W.emptyLineProvider.push(()=>[{name:`{{@streaming
`,description:"Streaming Javascript Block"},{name:`{{@response
`,description:"Response Javascript Block"},{name:`{{@request
`,description:"Request Javascript Block"}]);W.variableProvider.push(()=>[{name:"$random.alphabetic()",description:"random letters"},{name:"$random.number()",description:"random number"},{name:"$random.hexadecimal()",description:"random hexadecimal"},{name:"$random.email()",description:"random email"},{name:"$random.float()",description:"random float"},{name:"$random.integer()",description:"random integer"},{name:"$random.uuid()",description:"random uuid"},{name:"$random.date()",description:"Date format function"}]);async function aa(e){let t=la(e),r=w.getUserSession(t);return(r==null?void 0:r.details)||{$global:{}}}var Fr=class{constructor(){this.id="globalVariables"}async afterLoop(t){let[r]=t.args,o=r.variables.$global;if(o&&typeof o=="object"&&Object.keys(o).length>0){let s=la(r.activeEnvironment);w.setUserSession({id:s,title:"global store",description:r.activeEnvironment?`global Variables for ${r.activeEnvironment.join(", ")}`:"global Variables",type:"global_cache",details:{$global:o}})}return!0}};function la(e){return`global_cache_${B(e)}`}var jr=class{constructor(t,r){this.context=t;this.httpFileStore=r}findHttpRegionInContext(t){return Me(t,this.context)}async import(t){return await bt(t,this.httpFileStore,this.context)}setVariables(t){F(t,this.context)}async execute(t,r){r&&F(r,this.context);let o;if(c(t)?o=Me(t,this.context):o=t,o&&await(o==null?void 0:o.execute(this.context))){let n=B(this.context.activeEnvironment);F(o.variablesPerEnv[n],this.context)}return this.context.variables}};var Ht=A(require("module")),Ct=A(require("path")),da=A(require("vm"));function ua(e,t){let r;try{try{r=Ht.default.createRequire(Ct.default.resolve(t,"package.json")).resolve(e)}catch{r=require.resolve(e,{paths:[t]})}}catch(o){f.debug(o)}return r}function pa(e,t,r=!1){if(q.isTrusted("loadModule"))try{return r&&zd(e,t),Ht.default.createRequire(Ct.default.resolve(t,"package.json"))(e)}catch{let o=ua(e,t);if(o)return r&&os(o),require(o)}}function Jd(e,t){let r=new Ht.default(e,require.main);return r.filename=e,r.paths=Ht.default._nodeModulePaths(Ct.default.dirname(e)),t&&r._compile(t,e),r}function zd(e,t){let r=ua(e,t);r&&os(r)}function os(e,t=new Map){let r=require.cache[e];r&&(t.set(e,!0),r.children.forEach(o=>{t.get(o.id)||os(o.id,t)}),delete require.cache[e])}async function St(e,t){if(!q.isTrusted("runScript"))return{};let r=Xd(t.fileName),o=Jd(r);function s(m){let g=H.require;return g&&g[m]?g[m]:o.require(m)}let n=Qd(t.context),i=Object.assign({$context:n,...n}),a=Object.keys(i),d=`(async function userJS(exports, require, module, __filename, __dirname, context){ with(context){${p.EOL}${e}${p.EOL}}})`;await da.default.runInThisContext(d,{filename:r,lineOffset:t.lineOffset,displayErrors:!0}).apply(i,[o.exports,s,o,r,Ct.default.dirname(r),i]),Yd(a,i,t.deleteVariable);let u=o.exports;if(Ne(u))u=await u;else for(let[m,g]of Object.entries(u))Ne(g)&&(u[m]=await g);return u}function Xd(e){return p.fsPath(e)||p.toString(e)}function Yd(e,t,r){if(r)for(let o of e)try{t[o]===void 0&&r(o)}catch(s){f.info(`error on delete of ${o}`,s)}}async function Vr(e,t,r){if(!q.isTrusted("evalExpression"))return;let o=`exports.$result = (${e});`,s=t.httpRegion.symbol.startLine;if(t.httpRegion.symbol.source){let i=Y(t.httpRegion.symbol.source).findIndex(a=>a.indexOf(e)>=0);i>=0&&(s+=i)}return(await St(o,{fileName:t.httpFile.fileName,context:{...t.variables,httpFile:t.httpFile,httpRegion:t.httpRegion,request:t.request,console:t.scriptConsole,$random:xt,...r,$context:t},lineOffset:s})).$result}function Qd(e){let t={};for(let[r,o]of Object.entries(e)){let s=r.trim().replace(/\s/gu,"-").replace(/-./gu,n=>n[1].toUpperCase());ca.indexOf(s)<0&&typeof o<"u"&&(t[s]=o)}return t}function ma(e){return ca.indexOf(e)>=0?(f.warn(`Keyword ${e} prevented, because Javascript Keyword`),!1):Zd.indexOf(e)>=0?(f.warn(`Keyword ${e} prevented, because used by httpYac`),!1):!0}var Zd=["httpFile","httpRegion","request","test","sleep"],ca=["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","implements","import","in","instanceof","interface","let","new","null","package","private","protected","public","return","super","switch","static","this","throw","try","true","typeof","var","void","while","with","yield"];var tu=/^\s*\{\{(@js\s+)?(?<modifier>\+|@)?(?<event>(request|streaming|response|after|responseLogging)?)?\s*$/iu,ru=/^\s*\}\}\s*$/u;async function fa(e,{httpRegion:t,httpFile:r,httpFileStore:o}){let s=e(),n=s.next();if(!n.done){let i=tu.exec(n.value.textLine);if(i!=null&&i.groups){let a=n.value.line;n=s.next();let d=[];for(;!n.done;){if(ru.test(n.value.textLine)){let l={script:U(d),lineOffset:a},u=i.groups.modifier==="+";switch(i.groups.event){case"request":nu(u?r.hooks:t.hooks,l,o);break;case"streaming":ou(u?r.hooks:t.hooks,l,o);break;case"response":iu(u?r.hooks:t.hooks,l,o);break;case"after":lu(u?r.hooks:t.hooks,l,o);break;case"responseLogging":au(u?r.hooks:t.hooks,l,o);break;default:su(u?r.hooks:t.hooks,l,o);break}return{nextParserLine:n.value.line,symbols:[new R({name:"script",description:"nodejs script",kind:"script",startLine:a,startOffset:0,endLine:n.value.line,endOffset:n.value.textLine.length})]}}d.push(n.value.textLine),n=s.next()}}}return!1}function ou(e,t,r){e.onStreaming.addHook("js",async o=>await Je(t,o,r,"streaming")?void 0:it)}function su(e,t,r){e.execute.addHook("js",o=>Je(t,o,r))}function nu(e,t,r){e.onRequest.addHook("js",async(o,s)=>await Je(t,s,r,"request")?void 0:it)}function iu(e,t,r){e.onResponse.addHook("js",async(o,s)=>(s.variables.response=o,await Je(t,s,r,"response")?void 0:it))}function au(e,t,r){e.responseLogging.addHook("js",async(o,s)=>{let n=s.variables.response;s.variables.response=o,await Je(t,s,r,"responseLogging"),s.variables.response=n})}function lu(e,t,r){e.execute.addInterceptor(new ss(t,r))}var ss=class{constructor(t,r){this.scriptData=t;this.httpFileStore=r;this.id=`afterJavascript_${t.script}`}async afterLoop(t){return await Je(this.scriptData,t.args[0],this.httpFileStore,"after")}};async function Je(e,t,r,o){S(t,o?`execute javascript (@${o})`:"execute javascript");let s=await St(e.script,{fileName:t.httpFile.fileName,context:{...t.variables,httpFile:t.httpFile,httpRegion:t.httpRegion,request:t.request,console:t.scriptConsole,sleep:ce,test:mt(t),$httpyac:new jr(t,r),$random:xt,$context:t},lineOffset:e.lineOffset,deleteVariable:i=>Ce(i,t)}),n=s.$cancel;return n&&(delete s.$cancel,Q(t.httpRegion)),F(s,t),!n}async function ga(e,t,r){return await M(e,async(o,s)=>{try{return await Vr(o,r)}catch(n){if(t==="Variable")(r.scriptConsole||f).debug(`variable ${o} not defined`),(r.scriptConsole||f).debug(n);else throw(r.scriptConsole||f).error(`expression ${o} throws error`),n;return s}})}var ha=A(require("dayjs")),du=A(require("uuid"));j.javascriptProvider.loadModule=pa;function ya(e){e.hooks.replaceVariable.addHook("javascript",ga,{before:["aws"]}),e.hooks.parse.addHook("javascript",fa,{before:["request"]}),e.hooks.execute.addInterceptor(new Fr),e.hooks.provideVariables.addHook("globalVariables",aa),uu(),j.javascriptProvider.evalExpression=Vr,j.javascriptProvider.runScript=St,j.javascriptProvider.isAllowedKeyword=ma}function uu(){Object.assign(j.javascriptProvider.require,{httpyac:ns,dayjs:ha.default,uuid:du})}ee.core=xi;ee.dotenv=wi;ee.http=Gi;ee.intellij=ia;ee.injection=Wi;ee.javascript=ya;ee.assert=Qs;var is=require("hookpoint");async function as(e){let t=!1;return Ho(e)?t=await mu(e):Co(e)?t=await ba(e):t=await cu(e),t}async function mu(e){let t=await ls(e);return await Be(t)?await e.httpRegion.execute(t,!0):!1}async function ba(e){let t=await ls(e);if(await Be(t)){e.progress&&(e.progress.divider=e.httpRegions.length);let r=!0;for(let o of e.httpRegions){let s=await o.execute(t,!0);r=r&&s}return r}return!1}async function cu(e){let t=[];for(let r of e.httpFile.httpRegions)e.httpRegionPredicate&&!e.httpRegionPredicate(r)?f.debug(`${r.symbol.name} disabled by predicate`):r.isGlobal()||t.push(r);return await ba({...e,httpRegions:t})}async function ls(e){return Object.assign(e,{variables:await xa(e),options:{}})}async function xa(e){e.config=await _e(e.config,e.httpFile);let t=await e.httpFile.hooks.provideVariables.trigger(e.activeEnvironment,e);if(t===is.HookCancel)return e.variables||{};let r={...e.variables},o=Object.assign(e.variables||{},...t.map(s=>Ft(s)),r);return f.debug("current environment variables",o),o}async function fu(e){e.config=await _e(e.config,e.httpFile);let t=await e.httpFile.hooks.provideEnvironments.trigger(e);return t!==is.HookCancel&&t.length>0?t.reduce((r,o)=>{for(let s of o)r.indexOf(s)<0&&r.push(s);return r},[]).sort():[]}function ds(e){if(e.json||e.jsonl)return 1e3;if(e.silent)return 100;if(e.verbose)return 1}function Tt(e,t){return e+t}function us(e,t){let r=[];for(let s of e)r.push(Br(s,t));let o=r;return t.filter==="only-failed"&&(o=r.filter(s=>s.summary.failedTests>0)),{_meta:{version:"1.1.0"},requests:o,summary:hu(r)}}function hu(e){return{totalRequests:e.length,skippedRequests:e.filter(t=>t.summary.skippedTests>0).length,failedRequests:e.filter(t=>t.summary.failedTests>0).length,successRequests:e.filter(t=>t.summary.failedTests+t.summary.erroredTests+t.summary.skippedTests===0).length,erroredRequests:e.filter(t=>t.summary.erroredTests>0).length,totalTests:e.map(t=>t.summary.totalTests).reduce(Tt,0),failedTests:e.map(t=>t.summary.failedTests).reduce(Tt,0),successTests:e.map(t=>t.summary.successTests).reduce(Tt,0),erroredTests:e.map(t=>t.summary.erroredTests).reduce(Tt,0),skippedTests:e.map(t=>t.summary.skippedTests).reduce(Tt,0)}}function Br(e,t){var o,s,n,i,a,d,l,u,m,g,v,k,L,D;let r=t.output;return t.outputFailed&&((s=(o=e.testResults)==null?void 0:o.some)!=null&&s.call(o,b=>!b.status))&&(r=t.outputFailed),{fileName:p.fsPath(e.filename)||p.toString(e.filename),response:yu(e.response,r),name:x((n=e.metaData)==null?void 0:n.name)||e.symbol.name,line:e.symbol.startLine,title:x((i=e.metaData)==null?void 0:i.title),description:x((a=e.metaData)==null?void 0:a.description),testResults:e.testResults,timestamp:new Date(performance.timeOrigin+e.start).toISOString(),duration:e.duration,summary:{totalTests:((d=e.testResults)==null?void 0:d.length)||0,failedTests:((u=(l=e.testResults)==null?void 0:l.filter)==null?void 0:u.call(l,b=>b.status==="FAILED").length)||0,successTests:((g=(m=e.testResults)==null?void 0:m.filter)==null?void 0:g.call(m,b=>b.status==="SUCCESS").length)||0,erroredTests:((k=(v=e.testResults)==null?void 0:v.filter)==null?void 0:k.call(v,b=>b.status==="ERROR").length)||0,skippedTests:((D=(L=e.testResults)==null?void 0:L.filter)==null?void 0:D.call(L,b=>b.status==="SKIPPED").length)||0}}}function yu(e,t){var r;if(e)switch(delete e.rawHeaders,delete e.rawBody,delete e.prettyPrintBody,delete e.parsedBody,delete e.contentType,delete e.tags,t){case"body":case"response":return delete e.request,e;case"short":return delete e.body,delete e.request,e;case"none":return;case"headers":return delete e.body,(r=e.request)==null||delete r.body,e;case"exchange":default:return e}}var ps=!1,Ra={id:"bailOnFailed",beforeLoop:async function(t){if(ps){let[r]=t.args;return Q(r.httpRegion,"request skipped because of bail"),!1}return!0},onError:async function(){return ps=!0,!0},afterTrigger:async function(t){var s,n;return((n=(s=t.args[0].httpRegion.testResults)==null?void 0:s.find)==null?void 0:n.call(s,i=>["FAILED"].includes(i.status)))&&(ps=!0),!0}};var va={id:"loggerFlush",afterLoop:async function(t){var o,s;let r=t.args[0];return(s=(o=r==null?void 0:r.scriptConsole)==null?void 0:o.flush)==null||s.call(o),!0}};var ka={id:"testExitCode",onError:async function(){return process.exitCode=10,!0},afterTrigger:async function(t){let r=t.args[0];if(r.httpRegion.testResults===void 0)return!0;let o=!1,s=!1;for(let n of r.httpRegion.testResults){if(n.status==="ERROR"){o=!0;break}n.status==="FAILED"&&(s=!0)}return o?process.exitCode=19:s&&(process.exitCode=20),!0}};function Pa(e){return function(r){r.hooks.execute.addInterceptor(va),r.hooks.execute.addInterceptor(ka),e&&r.hooks.execute.addInterceptor(Ra)}}async function wa(e,t){if(t.all)return e.map(o=>({httpFile:o}));let r=bu(e,t);return r.length>0?r:await Pu(e)}function bu(e,t){let r=[],o=vu(t.tag);for(let s of e){let n=s.httpRegions.filter(i=>!!(xu(i,t.name)||ku(i,o)||Ru(i,t.line)));n.length>0&&r.push({httpFile:s,httpRegions:n})}return r}function xu(e,t){var r;return!t||t.length===0||!c((r=e.metaData)==null?void 0:r.name)?!1:t.includes(e.metaData.name)}function Ru(e,t){return t!==void 0?t&&e.symbol.startLine<=t&&e.symbol.endLine>=t:!1}function vu(e){let t=[];if(!e||e.length===0)return t;for(let r of e){if(!r)continue;let s=r.replace(/\s+/gu,"").split(",").filter(Boolean);for(let n of s){let i=n.split("+").filter(Boolean);i.length>0&&t.push(i)}}return t}function ku(e,t){var o,s;if(!t||t.length===0||!c((o=e.metaData)==null?void 0:o.tag))return!1;let r=(s=e.metaData.tag)==null?void 0:s.split(",").map(n=>n.trim()).filter(Boolean);return!r||r.length===0?!1:t.some(n=>n.every(i=>r.includes(i)))}async function Pu(e){var i;let t={},r=e.length>1,o=`${process.cwd()}`;for(let a of e){let d=(i=Fe(a.fileName))==null?void 0:i.replace(o,".");t[r?`${d}: all`:"all"]=[{httpFile:a}];for(let l of a.httpRegions)if(!l.isGlobal()){let u=l.symbol.name;t[r?`${d}: ${u}`:u]=[{httpRegions:[l],httpFile:a}]}}let n=await(await import("inquirer")).default.prompt([{type:"list",name:"region",message:"please choose which region to use",choices:Object.entries(t).map(([a])=>a)}]);return n.region&&t[n.region]?t[n.region]:[]}function Sa(){return new Ca.Command("uctest").description("HTTP test runner for Unsafe Code Lab").usage("[@tag...] [:name...] [path...] [options]").argument("[args...]","Tags (@tag), names (:name), and paths").option("-a, --all","run ALL tests (ignore default @ci tag filter)").option("-k, --keep-going","continue running after failures (default: stop on first)").option("-e, --env  <env...>","list of environments").option("--filter <filter>","filter requests output (only-failed)").option("--insecure","allow insecure server connections when using ssl").option("-i --interactive","do not exit the program after request, go back to selection").option("--json","use json output").option("--jsonl","stream json lines output").option("-l, --line <line>","line of the http requests").option("--no-color","disable color support").option("-o, --output <output>","output format of response (short, body, headers, response, exchange, none)","none").option("--output-failed <output>","output format of failed response (short, body, headers, response, exchange, none)","exchange").option("--raw","prevent formatting of response body").option("--quiet","").option("--repeat <count>","repeat count for requests",P).option("--repeat-mode <mode>","repeat mode: sequential, parallel (default)").option("--parallel <count>","send parallel requests",P).option("-s, --silent","log only request").option("--prune-refs","only execute leaf requests (prune referenced dependencies)").option("-r, --resume","resume from last failed request").option("--state-file <path>","path to state file for resume (default: .uctest-state)").option("--timeout <timeout>","maximum time allowed for connections",P).option("--var  <variables...>",'list of variables (e.g foo="bar")').option("-v, --verbose","make the operation more talkative").action(Hu)}function wu(e){let t=[],r=[],o=[];for(let s of e)if(s.startsWith("@")){let n=s.slice(1);n&&t.push(n)}else if(s.startsWith(":")){let n=s.slice(1);n&&r.push(n)}else o.push(s);return{tags:t,names:r,paths:o}}async function Hu(e,t){var m,g;let r=wu(e);r.tags.length>0&&(t.tag=r.tags),r.names.length>0&&(t.name=r.names),!t.tag&&!t.all&&(t.tag=["ci"]);let o=r.paths.length>0?r.paths:["./**/*.http"],s=!t.keepGoing,n=Fu(t),{httpFiles:i,config:a}=await Vu(o,s,n.config||{});n.config=a,ju(t,n);let d=(0,ge.join)(process.cwd(),".uctest-state"),l=t.resume?t.stateFile||d:void 0,u=l?await $u(l):void 0;try{if(i.length>0){let v=!0;for(;t.interactive||v;){v=!1;let k=await wa(i,t);t.pruneRefs&&(k=Eu(k)),u&&(k=Ou(k,u),u=void 0);let L=Lu(k,i),D=L.totalRequests,b=L.totalFiles,h=0,T=t.jsonl?Tu():void 0;t.jsonl?(T==null||T({type:"start",totalRequests:D,totalFiles:b}),n.processedHttpRegionListener=Ae=>{h+=1,T==null||T({type:"request",index:h,totalRequests:D,request:Br(Ae,t)})}):n.processedHttpRegionListener=void 0,n.processedHttpRegions=[];let Xe=k.map(({httpFile:Ae,httpRegions:Oa})=>async function(){!t.json&&n.scriptConsole&&k.length>1&&n.scriptConsole.info(`--------------------- ${Ae.fileName}  --`),await as(Object.assign({},n,{httpFile:Ae,httpRegions:Oa}))});await So(t.parallel||1,...Xe);let Ye=n.processedHttpRegions||[],cs=t.resume&&s?qu(Ye):void 0;if(t.jsonl){h=Su(Ye,t,T,h,D);let Ae=us(Ye,t);T==null||T({type:"summary",totalRequests:D,totalFiles:b,summary:Ae.summary})}else Cu(n,t);l&&t.resume&&s&&(cs?await Du(l,cs):await Iu(l))}}else console.error(`uctest cannot find any .http files matching: ${o.join(", ")}`)}finally{(g=(m=n.scriptConsole)==null?void 0:m.flush)==null||g.call(m)}}function Cu(e,t){let r=e.processedHttpRegions||[],o=us(r,t);if(t.json)console.info($(o,2));else if(e.scriptConsole){e.scriptConsole.info("");let s=[];o.summary.successRequests>0&&s.push(ze.default`{green ${o.summary.successRequests} succeeded}`),o.summary.failedRequests>0&&s.push(ze.default`{red ${o.summary.failedRequests} failed}`),o.summary.erroredRequests>0&&s.push(ze.default`{red ${o.summary.erroredRequests} errored}`),o.summary.skippedRequests>0&&s.push(ze.default`{yellow ${o.summary.skippedRequests} skipped}`),e.scriptConsole.info(ze.default`{bold ${o.summary.totalRequests}} requests processed (${s.join(", ")})`)}}function Su(e,t,r,o,s){if(!r)return o;for(let n=o;n<e.length;n+=1)r({type:"request",index:n+1,totalRequests:s,request:Br(e[n],t)});return Math.max(o,e.length)}function Tu(){return e=>{process.stdout.write(`${$(e)}
`)}}function Lu(e,t){var a,d,l,u,m;let r=new Map,o=new Map;for(let g of t)for(let v of g.httpRegions){o.set(v,g);let k=x((a=v.metaData)==null?void 0:a.name);if(!k)continue;let L=r.get(k)||[];L.push(v),r.set(k,L)}let s=new Set,n=new Set,i=[];for(let{httpFile:g,httpRegions:v}of e){let k=v??g.httpRegions;for(let L of k)((d=L.metaData)==null?void 0:d.disabled)===!0||(l=L.metaData)!=null&&l.skip||i.push(L)}for(;i.length>0;){let g=i.pop();if(!g||s.has(g))continue;s.add(g);let v=o.get(g);v&&n.add(v);for(let k of Ta(g)){let L=r.get(k);if(L)for(let D of L)((u=D.metaData)==null?void 0:u.disabled)===!0||(m=D.metaData)!=null&&m.skip||i.push(D)}}return{totalRequests:s.size,totalFiles:n.size}}function qu(e){return e.find(t=>{var r;return(r=t.testResults)==null?void 0:r.some(o=>o.status==="ERROR"||o.status==="FAILED")})}function Eu(e){var a,d,l;let t=e.map(u=>({httpFile:u.httpFile,regions:u.httpRegions??u.httpFile.httpRegions})),r=[];for(let{regions:u}of t)for(let m of u)((a=m.metaData)==null?void 0:a.disabled)===!0||(d=m.metaData)!=null&&d.skip||r.push(m);let o=new Map;for(let u of r){let m=x((l=u.metaData)==null?void 0:l.name);if(m){let g=o.get(m)||[];g.push(u),o.set(m,g)}}let s=new Set;for(let u of r)for(let m of Ta(u)){let g=o.get(m);g==null||g.forEach(v=>s.add(v))}let n=new Set(r.filter(u=>!s.has(u))),i=[];for(let{httpFile:u,regions:m}of t){let g=m.filter(k=>n.has(k));if(g.length===0)continue;let v=m===u.httpRegions&&g.length===m.length;i.push({httpFile:u,httpRegions:v?void 0:g})}return i}function Ta(e){var o,s;let t=[],r=[(o=e.metaData)==null?void 0:o.ref,(s=e.metaData)==null?void 0:s.forceRef];for(let n of r){if(!n||n===!0)continue;let i=x(n);if(!i)continue;let a=i.split(/[,\s]+/u).map(d=>d.trim()).filter(Boolean);t.push(...a)}return t}function Ou(e,t){var s,n;let r=[],o=!0;for(let i of e){let a=i.httpRegions??i.httpFile.httpRegions,d=La(i.httpFile.fileName),l=[];for(let u of a)((s=u.metaData)==null?void 0:s.disabled)===!0||(n=u.metaData)!=null&&n.skip||(o?Au(d,u,t)&&(o=!1,l.push(u)):l.push(u));if(l.length>0){let u=a===i.httpFile.httpRegions&&l.length===a.length;r.push({httpFile:i.httpFile,httpRegions:u?void 0:l})}}return o?e:r}function Au(e,t,r){return!e||e!==r.fileName?!1:t.symbol.startLine===r.line}function La(e){if(!e)return;let t=p.fsPath(e)||p.toString(e);if(t)return(0,ge.isAbsolute)(t)?(0,ge.relative)(process.cwd(),t):t}async function $u(e){try{let t=await Lt.promises.readFile(e,"utf-8");return JSON.parse(t)}catch(t){t.code!=="ENOENT"&&console.warn(`Failed to read resume state from ${e}:`,t);return}}async function Du(e,t){var s;let r=La(t.filename);if(!r)return;let o={fileName:r,line:t.symbol.startLine,name:x((s=t.metaData)==null?void 0:s.name)};await Lt.promises.writeFile(e,$(o,2))}async function Iu(e){try{await Lt.promises.unlink(e)}catch(t){t.code!=="ENOENT"&&console.warn(`Failed to clear resume state at ${e}:`,t)}}function Fu(e){return{activeEnvironment:e.env,repeat:e.repeat?{count:e.repeat,type:e.repeatMode==="sequential"?0:1}:void 0,config:{log:{level:ds(e)},request:{timeout:e.timeout,https:e.insecure?{rejectUnauthorized:!1}:void 0}},variables:e.var?Object.fromEntries(e.var.map(r=>{let o=r.split("=");return[o[0],o.slice(1).join("=")]})):void 0}}function ju(e,t){if(e.jsonl)return;let r=new De({level:ds(e),onlyFailedTests:e.filter==="only-failed"});if(r.collectMessages(),t.scriptConsole=r,!e.json){t.logStream=Mu(e);let o=Nu(e,t.config,r);t.logResponse=async(s,n)=>{o&&await o(s,n),r.flush()}}}async function Vu(e,t,r){let o=[],s=new vt({cli:Pa(t)}),n={workingDir:process.cwd(),config:r},i=[];for(let a of e)i.push(...await Bu(a));for(let a of i){let d=await s.getOrCreate(a,async()=>await Lt.promises.readFile(a,"utf8"),0,n);o.push(d)}return{httpFiles:o,config:n.config}}async function Bu(e){let t={gitignore:!0},{globby:r}=await import("globby"),o=await r(e,t);return o&&o.length>0||ge.sep==="/"?o:await r(e.replace(/\\/gu,"/"),t)}function Mu(e){if(e.output!=="none")return async function(r,o){let s=Buffer.isBuffer(o.body)?o.body.toString("utf-8"):o.body;console.info(`${new Date().toLocaleTimeString()} - ${r}: `,s)}}function Nu(e,t,r){var i,a;let o={onlyFailed:e.filter==="only-failed",responseBodyPrettyPrint:!e.raw},s=Ha(e.output,o,(i=t==null?void 0:t.log)==null?void 0:i.options),n=Ha(e.outputFailed,o,(a=t==null?void 0:t.log)==null?void 0:a.options);if(s||n)return Xr(d=>r.logPriority(d),s,n)}function Ha(e,...t){let r;switch(e){case"body":r={responseBodyLength:0};break;case"headers":r={requestOutput:!0,requestHeaders:!0,responseHeaders:!0};break;case"response":r={responseHeaders:!0,responseBodyLength:0};break;case"none":return;case"short":r={useShort:!0};break;case"timings":r={timings:!0};break;case"exchange":r={requestOutput:!0,requestHeaders:!0,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0,timings:!0};break;default:r={requestOutput:!0,requestHeaders:!0,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0};break}return Object.assign({},...t,r)}async function Ea(){let e=await pt((0,qa.join)(__dirname,"../package.json")),t=Sa();return t.version((e==null?void 0:e.version)||"0.0.1"),t}async function Uu(e){try{await Lo(),await(await Ea()).parseAsync(e)}catch(t){throw console.error(t),process.exitCode||(process.exitCode=1),t}finally{process.exit()}}0&&(module.exports={AbstractRequestClient,ExecuteHook,HookCancel,HttpSymbol,HttpSymbolKind,LogLevel,OnRequestHook,OnResponseHook,OnStreaming,ParseEndRegionHook,ParseHook,ParseMetaDataHook,ProvideAssertValue,ProvideEnvironmentsHook,ProvideVariablesHook,RepeatOrder,ReplaceVariableHook,RequestClientEvent,ResponseLoggingHook,TestResultStatus,VariableType,cli,createEmptyProcessorContext,getEnvironments,getVariables,io,send,store,testSymbols,utils});
//# sourceMappingURL=index.js.map
