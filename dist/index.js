"use strict";var Pl=Object.create;var Gt=Object.defineProperty;var kl=Object.getOwnPropertyDescriptor;var Hl=Object.getOwnPropertyNames;var Cl=Object.getPrototypeOf,Sl=Object.prototype.hasOwnProperty;var lt=(e,t)=>{for(var r in t)Gt(e,r,{get:t[r],enumerable:!0})},$s=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Hl(t))!Sl.call(e,s)&&s!==r&&Gt(e,s,{get:()=>t[s],enumerable:!(o=kl(t,s))||o.enumerable});return e};var T=(e,t,r)=>(r=e!=null?Pl(Cl(e)):{},$s(t||!e||!e.__esModule?Gt(r,"default",{value:e,enumerable:!0}):r,e)),Tl=e=>$s(Gt({},"__esModule",{value:!0}),e);var ws={};lt(ws,{AbstractRequestClient:()=>yt,ExecuteHook:()=>$e,HookCancel:()=>ht,HttpSymbol:()=>P,HttpSymbolKind:()=>_,LogLevel:()=>Je,OnRequestHook:()=>Le,OnResponseHook:()=>Ee,OnStreaming:()=>qe,ParseEndRegionHook:()=>ct,ParseHook:()=>dt,ParseMetaDataHook:()=>ut,ProvideAssertValue:()=>pt,ProvideEnvironmentsHook:()=>mt,ProvideVariablesHook:()=>ft,RepeatOrder:()=>oo,ReplaceVariableHook:()=>gt,RequestClientEvent:()=>ge,ResponseLoggingHook:()=>Oe,TestResultStatus:()=>re,VariableType:()=>ae,cli:()=>Os,createEmptyProcessorContext:()=>Ke,getEnvironments:()=>sp,getVariables:()=>ja,io:()=>B,send:()=>ks,store:()=>Xo,testSymbols:()=>te,utils:()=>R});module.exports=Tl(ws);var Os={};lt(Os,{createProgram:()=>wl,execute:()=>mc,initFileProvider:()=>an,initIOProvider:()=>Ko});var vl=require("path");var R={};lt(R,{ENVIRONMENT_NONE:()=>Vs,HandlebarsSingleLine:()=>Ct,OAuth2Regex:()=>fd,RegionSeparator:()=>Re,addHttpFileRequestClientHooks:()=>Ht,addSkippedTestResult:()=>ne,addTestResultToHttpRegion:()=>ke,assertHasNoResponseBody:()=>Po,assertHasResponseBody:()=>wo,assertHeaderContains:()=>vo,assertHeaderEquals:()=>xo,assertMaxTotalTime:()=>Ro,assertResponseBodyEquals:()=>ko,assertStatusEquals:()=>bo,cleanVariables:()=>Yt,cloneRequest:()=>Is,cloneResponse:()=>ye,createResponseProxy:()=>Qt,decodeJWT:()=>fo,defaultConfigFiles:()=>zt,deleteHeader:()=>co,deleteVariableInContext:()=>Me,distinct:()=>Ll,ensureString:()=>Kt,equalsPath:()=>Co,errorToString:()=>Yl,executeGlobalScripts:()=>He,executeRequestClientFactory:()=>Oo,expandVariable:()=>Ns,extensionName:()=>Ho,findHttpRegionInContext:()=>Be,findRootDir:()=>Wt,findRootDirOfFile:()=>vt,getBufferEncoding:()=>Qe,getDisplayName:()=>kt,getHeader:()=>$,getHeaderArray:()=>Ml,getHeaderBoolean:()=>Il,getHeaderNumber:()=>jl,getHeaderString:()=>Fl,getHttpyacConfig:()=>So,getMarkdownSyntax:()=>Ys,getPartOfBody:()=>go,getPlugins:()=>To,getRegionDescription:()=>$o,importHttpFileInContext:()=>Lt,isBufferEncoding:()=>js,isError:()=>ue,isHttpRegionSendContext:()=>No,isHttpRegionsSendContext:()=>Uo,isHttpRequest:()=>D,isHttpRequestMethod:()=>Dl,isHttpResponse:()=>ho,isMimeTypeCSS:()=>ao,isMimeTypeFormUrlEncoded:()=>De,isMimeTypeHtml:()=>io,isMimeTypeImage:()=>$l,isMimeTypeJSON:()=>Rt,isMimeTypeJavascript:()=>so,isMimeTypeMarkdown:()=>xt,isMimeTypeMultiPartFormData:()=>lo,isMimeTypeMultiPartMixed:()=>uo,isMimeTypeNewlineDelimitedJSON:()=>po,isMimeTypePdf:()=>Ol,isMimeTypeXml:()=>no,isOpenIdInformation:()=>pd,isProcessorContext:()=>cd,isPromise:()=>Ze,isString:()=>g,isStringEmpty:()=>Ae,isUndefined:()=>Xe,iterateDirectoryTree:()=>Jt,iterateUntilRoot:()=>Pe,joinMarkdown:()=>Zt,knownMetaData:()=>rn,logResponse:()=>Ve,mergeRawHttpHeaders:()=>_l,mergeResponses:()=>Xt,parseComments:()=>St,parseContentType:()=>Fe,parseDefaultHeadersFactory:()=>Io,parseError:()=>Ie,parseFileImport:()=>Tt,parseHandlebarsString:()=>U,parseHandlebarsSymbols:()=>pe,parseInlineResponse:()=>Vo,parseJson:()=>wt,parseMimeType:()=>bt,parseQueryLineFactory:()=>Mo,parseRequestHeaderFactory:()=>tr,parseRequestLineFactory:()=>Bo,parseSubsequentLines:()=>er,parseUrlLineFactory:()=>jo,promiseQueue:()=>_o,randomArrayValue:()=>Go,randomData:()=>Et,randomEmail:()=>et,randomText:()=>Y,repeat:()=>Lo,replaceFilePath:()=>be,replaceInvalidChars:()=>Gl,replaceVariables:()=>V,report:()=>q,requestLoggerFactory:()=>mo,resolveClientCertificates:()=>Ms,setVariableInContext:()=>F,shortenFileName:()=>Kl,shrinkCloneResponse:()=>yo,sleep:()=>Ce,stateGenerator:()=>El,stringifySafe:()=>j,testFactory:()=>Pt,testFactoryAsync:()=>Eo,toAbsoluteFilename:()=>N,toBoolean:()=>we,toBufferLike:()=>he,toEnvironmentKey:()=>M,toHttpString:()=>dd,toHttpStringHeader:()=>Ao,toHttpStringRequest:()=>zs,toHttpStringResponse:()=>Js,toMarkdown:()=>ud,toMarkdownHeader:()=>Do,toMarkdownMeta:()=>en,toMarkdownRequest:()=>Qs,toMarkdownResponse:()=>Xs,toMarkdownTestResults:()=>Zs,toMarkdownTimings:()=>tn,toMultiLineArray:()=>se,toMultiLineString:()=>G,toNumber:()=>C,toQueryParams:()=>Vl,toString:()=>w,unsetVariableInContext:()=>Zl,useDefaultOnError:()=>je});function Ll(e){function t(r,o,s){return s.indexOf(r)===o}return e.filter(t)}var K=T(require("chalk")),Fs=require("util");var B={};lt(B,{Logger:()=>ze,completionItemProvider:()=>ee,fileProvider:()=>f,httpClientProvider:()=>me,javascriptProvider:()=>L,log:()=>h,userInteractionProvider:()=>O});var ee={emptyLineProvider:[],variableProvider:[],requestHeaderProvider:[]};var f={EOL:`\r
`,exists:()=>{throw new Error("Not Implemented")},dirname:()=>{throw new Error("Not Implemented")},hasExtension:()=>{throw new Error("Not Implemented")},isAbsolute:()=>{throw new Error("Not Implemented")},joinPath:()=>{throw new Error("Not Implemented")},readFile:()=>{throw new Error("Not Implemented")},readBuffer:()=>{throw new Error("Not Implemented")},writeBuffer:()=>{throw new Error("Not Implemented")},readdir:()=>{throw new Error("Not Implemented")},fsPath:As,toString:As};function As(e){return typeof e=="string"?e:e.toString()}var me={};var L={require:{},evalExpression:async function(t,r){return r.variables[t]}};var z=require("hookpoint"),dt=class extends z.LastOutHook{constructor(){super(t=>!!t),this.id="ParseHook"}},ut=class extends z.LastOutHook{constructor(){super(t=>!!t),this.id="ParseMetaDataHook"}},pt=class extends z.LastOutHook{constructor(){super(t=>t!==!1),this.id="ProvideAssertValue"}},ct=class extends z.SeriesHook{constructor(){super(),this.id="ParseEndRegionHook"}},ft=class extends z.SeriesHook{constructor(){super(),this.id="ProvideVariablesHook"}},mt=class extends z.SeriesHook{constructor(){super(),this.id="ProvideEnvironmentsHook"}},gt=class extends z.WaterfallHook{constructor(){super(t=>t===void 0),this.id="ReplaceVariableHook"}},Le=class extends z.SeriesHook{constructor(){super(),this.id="BeforeRequestHook"}},Ee=class extends z.SeriesHook{constructor(){super(),this.id="AfterRequestHook"}},qe=class extends z.SeriesHook{constructor(){super(),this.id="OnStreaming"}},Oe=class extends z.SeriesHook{constructor(){super(),this.id="ResponseLoggingHook"}},$e=class extends z.SeriesHook{constructor(){super(t=>!t),this.id="ExecuteHook"}};var Ds=require("hookpoint"),ht=Ds.HookCancel;var P=class{constructor(t){this.name=t.name||"symbol",this.description=t.description,this.kind=t.kind,this.startLine=t.startLine,this.startOffset=t.startOffset,this.endLine=t.endLine,this.endOffset=t.endOffset,this.children=t.children,this.source=t.source}getSymbolsForLine(t){let r=[];if((this.startLine<=t||this.endLine>=t)&&(r.push(this),this.children))for(let o of this.children)r.push(...o.getSymbolsForLine(t));return r}filter(t){let r=[];if(t(this)&&r.push(this),this.children)for(let o of this.children)r.push(...o.filter(t));return r}};var _=(b=>(b.request="request",b.requestLine="requestLine",b.requestHeader="requestHeader",b.requestBody="requestBody",b.response="response",b.gql="gql",b.proto="proto",b.script="script",b.metaData="metaData",b.comment="comment",b.url="url",b.operator="operator",b.key="key",b.value="value",b.variable="variable",b.path="path",b.variableDefinition="variableDefinition",b.text="text",b))(_||{});var Je=(i=>(i[i.trace=1]="trace",i[i.debug=2]="debug",i[i.warn=5]="warn",i[i.info=10]="info",i[i.error=100]="error",i[i.none=1e3]="none",i))(Je||{});var oo=(r=>(r[r.sequential=0]="sequential",r[r.parallel=1]="parallel",r))(oo||{});var ge=class extends Event{constructor(r,o){super(r);this.detail=o}},yt=class{constructor(){this.eventEmitter=new EventTarget}addEventListener(t,r){this.eventEmitter.addEventListener(t,o=>this.isRequestClientEvent(o)?r(o):void 0)}removeEventListener(t,r){this.eventEmitter.removeEventListener(t,o=>this.isRequestClientEvent(o)?r(o):void 0)}isRequestClientEvent(t){return t instanceof ge}onMessage(t,r){this.eventEmitter.dispatchEvent(new ge("message",[t,r]))}onProgress(t){this.eventEmitter.dispatchEvent(new ge("progress",t))}onMetaData(t,r){this.eventEmitter.dispatchEvent(new ge("metaData",[t,r]))}onDisconnect(){this.eventEmitter.dispatchEvent(new ge("disconnect",void 0))}triggerEnd(){this.eventEmitter.dispatchEvent(new ge("end",void 0))}};var te={ok:"\u2713",error:"\u2716",skipped:"\u25CB"};var re=(s=>(s.SUCCESS="SUCCESS",s.FAILED="FAILED",s.SKIPPED="SKIPPED",s.ERROR="ERROR",s))(re||{});var ae=(s=>(s.variable="Variable",s.url="Url",s.body="Body",s.filePath="FilePath",s))(ae||{});var ze=class{constructor(t,r){this.options=t;this.parentLogger=r}collectMessages(){var t;(t=this.parentLogger)==null||t.collectMessages(),this.collectCache=[],this.priorityCache=[]}flush(){var t;(t=this.parentLogger)==null||t.flush(),this.priorityCache=this.flushCache(this.priorityCache),this.collectCache=this.flushCache(this.collectCache)}flushCache(t){if(t){for(let r of t)r();return[]}}writeLog(t,r,o,s){var n,i;if(!((n=this.options)!=null&&n.level)||t>=this.options.level){let a=()=>o(...s);(i=this.options)!=null&&i.logMethod&&(a=()=>{var l,d;return(d=(l=this.options)==null?void 0:l.logMethod)==null?void 0:d.call(l,t,...s)}),r?r.push(a):a()}}info(...t){var r;(r=this.parentLogger)==null||r.info(...t),this.writeLog(10,this.collectCache,console.info,t)}log(...t){var r;(r=this.parentLogger)==null||r.log(...t),this.writeLog(10,this.collectCache,console.log,t)}trace(...t){var r;(r=this.parentLogger)==null||r.trace(...t),this.writeLog(1,this.collectCache,this.options.noTrace?console.debug:console.trace,t)}debug(...t){var r;(r=this.parentLogger)==null||r.debug(...t),this.writeLog(2,this.collectCache,console.debug,t)}error(...t){var r;(r=this.parentLogger)==null||r.error(...t),this.writeLog(100,this.collectCache,console.error,t)}warn(...t){var r;(r=this.parentLogger)==null||r.warn(...t),this.writeLog(5,this.collectCache,console.warn,t)}logPriority(...t){this.writeLog(10,this.priorityCache,console.info,t)}clear(){console.clear()}},h=new ze({level:5,noTrace:!0});var O={isTrusted:()=>!0,showNote:async function(){throw new Error("Not Implemented")},showInputPrompt:async function(){throw new Error("Not Implemented")},showListPrompt:async function(){throw new Error("Not Implemented")}};function G(e){return e.join(f.EOL)}function se(e){return e.split(/\r?\n/gu)}function Xe(e){return typeof e>"u"}function g(e){return typeof e=="string"}function Ae(e){return typeof e=="string"&&/^(\s*)?$/u.test(e)}function El(e=30){let t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-._~",r=[];for(let o=e;o>0;--o)r.push(t[Math.floor(Math.random()*t.length)]);return r.join("")}function w(e){if(g(e))return e;if(typeof e=="number")return`${e}`;if(e instanceof Date)return e.toISOString();if(e instanceof Error)return e.message;if(Buffer.isBuffer(e))return e.toString("utf-8");if(Array.isArray(e)&&e.every(t=>Buffer.isBuffer(t))){let t=e.map(r=>Buffer.isBuffer(r)&&r.toString("utf8"));return j(t)}if(e)return j(e)}function j(e,t=0){try{return JSON.stringify(e,(r,o)=>ql(o)?Buffer.from(o.data).toString("base64"):o,t)}catch(r){return h.debug("JSON.stringify error",r),JSON.stringify(e,(()=>{let s=new WeakSet;return(n,i)=>{if(typeof i=="object"&&i!==null){if(s.has(i))return;s.add(i)}return i}})(),t)}}function Kt(e){return typeof e>"u"||e===null||g(e)?e:`${e}`}function ql(e){let t=e;return(t==null?void 0:t.type)==="Buffer"&&Array.isArray(t.data)&&!!t.data.length}function we(e,t=!1){var s;if(typeof e=="boolean")return e;if(typeof e=="number")return!!e;let r=(s=Kt(e))==null?void 0:s.trim();if(!r)return t;if(/^true$/iu.test(r))return!0;if(/^false$/iu.test(r))return!1;let o=parseFloat(r);return isNaN(o)?t:!!o}function C(e){if(typeof e=="number")return e;let t=Kt(e);if(t){let r=Number.parseFloat(t.trim());if(!Number.isNaN(r))return r}}function he(e){return Buffer.isBuffer(e)?e:w(e)}function bt(e){var n,i;let[t,...r]=e.split(";").map(a=>a.trim()),o=(n=r.find(a=>a.startsWith("charset=")))==null?void 0:n.split("=")[1],s=(i=r.find(a=>a.startsWith("boundary=")))==null?void 0:i.split("=")[1];return{mimeType:t,contentType:e,charset:o,boundary:s}}function Rt(e){return!!e&&(e.mimeType==="application/json"||e.mimeType==="text/json"||e.mimeType.indexOf("+json")>=0||e.mimeType.indexOf("x-amz-json")>=0)}function so(e){return(e==null?void 0:e.mimeType)==="application/javascript"||(e==null?void 0:e.mimeType)==="text/x-javascript"}function no(e){return!!e&&(e.mimeType==="application/xml"||e.mimeType==="text/xml"||e.mimeType.indexOf("+xml")>=0)}function io(e){return(e==null?void 0:e.mimeType)==="text/html"}function ao(e){return(e==null?void 0:e.mimeType)==="text/css"}function xt(e){return(e==null?void 0:e.mimeType)==="text/markdown"}function lo(e){return(e==null?void 0:e.mimeType)==="multipart/form-data"}function uo(e){return(e==null?void 0:e.mimeType)==="multipart/mixed"}function po(e){return(e==null?void 0:e.mimeType)==="application/x-ndjson"}function De(e){return(e==null?void 0:e.mimeType)==="application/x-www-form-urlencoded"}function Ol(e){return(e==null?void 0:e.mimeType)==="application/pdf"}function $l(e){return e?["image/jpeg","image/gif","image/webp","image/png","image/bmp"].indexOf(e.mimeType)>=0:!1}function Dl(e){return e?["ACL","BASELINE-CONTROL","CHECKIN","CHECKOUT","CONNECT","COPY","DELETE","GET","GRAPHQL","HEAD","LOCK","MERGE","MKACTIVITY","MKCALENDAR","MKCOL","MKWORKSPACE","MOVE","OPTIONS","PATCH","POST","PROPFIND","PROPPATCH","PUT","REPORT","SEARCH","TRACE","UNLOCK","VERSION-CONTROL"].includes(e.toUpperCase()):!1}function D(e){return(e==null?void 0:e.protocol)==="HTTP"}function co(e,...t){if(e)for(let r of t){let o=Object.entries(e).find(([s])=>s.toLowerCase()===r.toLowerCase());o&&o.length>1&&delete e[o[0]]}}function Fl(e,t){let r=$(e,t);if(g(r))return r}function Il(e,t,r=!1){let o=$(e,t);return we(o,r)}function $(e,t){if(e){let r=Object.entries(e).find(([o])=>o.toLowerCase()===t.toLowerCase());if(r&&r.length>1)return r[1]}}function jl(e,t){let r=$(e,t);return C(r)}function Ml(e,t,r=[]){let o=$(e,t);return o?g(o)?[o]:o:r}function Fe(e){let t=$(e,"content-type");if(g(t))return bt(t)}function fo(e){try{let t=e.split(".");if(t.length!==3)return null;let r=t[1];switch(r=r.replace(/-/gu,"+"),r=r.replace(/_/gu,"/"),r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:return null}let o=new Fs.TextDecoder().decode(Buffer.from(r,"base64"));return JSON.parse(o)}catch(t){return h.warn(t),null}}function Vl(e){return Object.entries(e).filter(([,t])=>!!t).map(([t,r])=>Array.isArray(r)?r.map(o=>`${t}=${encodeURIComponent(o||"")}`).join("&"):`${t}=${encodeURIComponent(r||"")}`).join("&")}function mo(e,t,r){return async function(s,n){var l,d,u,p,c,m,y,v,H,x;let i=t;if(r&&(n!=null&&n.testResults)&&n.testResults.some(b=>["FAILED","ERROR"].includes(b.status))&&(i=r),!i||i.onlyFailed&&(!(n!=null&&n.testResults)||n.testResults.every(b=>b.status==="SUCCESS")))return;if(e(""),e("---------------------"),e(""),(l=n==null?void 0:n.metaData)!=null&&l.title||(d=n==null?void 0:n.metaData)!=null&&d.name||(u=n==null?void 0:n.metaData)!=null&&u.description){let b=((p=n==null?void 0:n.metaData)==null?void 0:p.title)||((c=n==null?void 0:n.metaData)==null?void 0:c.name);b&&e(K.default`{gray === ${b} ===}`),(m=n==null?void 0:n.metaData)!=null&&m.description&&e(K.default`{gray ${n.metaData.description}}`),e("")}let a=(s==null?void 0:s.request)||(n==null?void 0:n.request);if(a&&(i.useShort?e(K.default`{yellow ${(a==null?void 0:a.method)||"GET"}} {gray ${(a==null?void 0:a.url)||"?"}}`):i.requestOutput&&Bl(a,{headers:i.requestHeaders,bodyLength:i.requestBodyLength}).forEach(b=>e(b))),s)if(i.useShort)e(K.default`{gray =>} {cyan.bold ${s.statusCode}} ({yellow ${((y=s.timings)==null?void 0:y.total)||"?"} ms}, {yellow ${((v=s.meta)==null?void 0:v.size)||"?"}})`);else{let b=[];if(i.responseHeaders&&(b.length>0&&b.push(""),b.push(...Nl(s))),i.timings&&(b.length>0&&b.push(""),b.push(...Ul(s))),g(s.body)&&i.responseBodyLength!==void 0){let k=s.body;i.responseBodyPrettyPrint&&s.prettyPrintBody&&(k=s.prettyPrintBody),k=go(k,i.responseBodyLength),k&&(b.length>0&&b.push(""),b.push(k))}e(G(b))}if(n!=null&&n.testResults)for(let b of n.testResults){let k=K.default`{green ${te.ok} ${b.message||"Test passed"}}`;if(b.status==="SKIPPED")k=K.default`{yellow ${te.skipped} Test skipped}`;else if(["ERROR","FAILED"].includes(b.status)){let X=b.error?` (${(H=b.error)==null?void 0:H.displayMessage})`:"";if(k=K.default`{red ${te.error} ${b.message||"Test failed"}${X}}`,!(t!=null&&t.useShort)&&b.status==="ERROR"&&((x=b.error)!=null&&x.error.stack)){let Q=se(b.error.error.stack).slice(0,3);k=G([k,...Q])}}e(k)}}}function go(e,t){let r=e;if(!(typeof t>"u"||t<0))return t>0&&(r=e.slice(0,Math.min(e.length,t)),e.length>=t&&(r+=`... (${e.length-t} characters more)`)),r}function Bl(e,t){var o,s,n,i;let r=[];return r.push(K.default`{cyan.bold ${e.method} ${e.url}}`),e.headers&&t.headers&&r.push(...Object.entries(e.headers).map(([a,l])=>K.default`{yellow ${a}}: ${l}`).sort()),D(e)&&((s=(o=e.options)==null?void 0:o.https)!=null&&s.certificate||(i=(n=e.options)==null?void 0:n.https)!=null&&i.pfx)&&r.push(K.default`{yellow client-cert}: true`),g(e.body)&&t.bodyLength!==void 0&&(r.push(""),r.push(K.default`{gray ${go(e.body,t.bodyLength)}}`)),r}function Nl(e){let t=[];return t.push(K.default`{cyan.bold ${e.protocol}} {cyan.bold ${e.statusCode}} {bold ${e.statusMessage?` - ${e.statusMessage}`:""}}`),e.headers&&t.push(...Object.entries(e.headers).filter(([r])=>!r.startsWith(":")).map(([r,o])=>K.default`{yellow ${r}}: ${o}`).sort()),t}function Ul(e){let t=[];return e.timings&&(t.push(K.default`{cyan.bold Timings}:`),t.push(...Object.entries(e.timings).filter(([,r])=>!!r).map(([r,o])=>K.default`{yellow ${r}}: ${o}`).sort())),t}function Is(e){return{url:e.url,method:e.method,body:e.body,contentType:e.contentType&&{...e.contentType},headers:e.headers&&{...e.headers},supportsStreaming:e.supportsStreaming}}function ho(e){let t=e;return!!(t!=null&&t.statusCode)}function yo(e){let t=ye(e);return delete t.rawBody,delete t.prettyPrintBody,delete t.request,t}function ye(e){return{name:e.name,protocol:e.protocol,statusCode:e.statusCode,statusMessage:e.statusMessage,httpVersion:e.httpVersion,headers:e.headers,body:e.body,rawHeaders:e.rawHeaders,rawBody:e.rawBody,parsedBody:e.parsedBody,prettyPrintBody:e.prettyPrintBody,contentType:e.contentType,timings:e.timings&&{...e.timings},meta:e.meta,tags:e.tags,request:e.request&&Is(e.request)}}function _l(e){let t={};for(let r=0;r<e.length;r+=2){let o=e[r],s=e[r+1];if(typeof s>"u")continue;let n=o.toLowerCase();t[n]=t[n]||[],t[n].push(s)}return t}function Ye(e,t){if(!e)throw new Error(t)}function bo(e,t){Ye(e.statusCode===t,`response status is ${e.statusCode} (expected: ${t})`)}function Ro(e,t){var r,o;Ye((r=e.timings)!=null&&r.total?e.timings.total<t:!0,`total time is ${(o=e.timings)==null?void 0:o.total} (expected max ${t})`)}function xo(e,t,r){let o=$(e.headers,t);Ye(o===r,`response header ${t} is ${o} (expected: ${r})`)}function vo(e,t,r){let o=$(e.headers,t);(g(o)||Array.isArray(o))&&Ye(!!o.indexOf(r),`response header contains ${r}`)}function wo(e){console.assert(!!e.body,"response body exists")}function Po(e){Ye(!e.body,"response body does not exists")}function ko(e,t){Ye(e.body===t,`response body equals ${t}`)}function js(e){return["ascii","utf8","utf-8","utf16le","ucs2","ucs-2","base64","latin1","binary","hex"].indexOf(e)>=0}function Qe(e){return e&&js(e)?e:"utf8"}async function N(e,t){if(e){if(await f.isAbsolute(e)&&await f.exists(e))return e;if(t&&g(e)){let r=f.joinPath(t,e);if(await f.exists(r))return r}}}function Ho(e){let t=f.toString(e),r=t.lastIndexOf(".");if(r>0&&r<t.length-2)return t.slice(r+1)}function Gl(e){return e.replace(/[/\\?%*:|"<>\s()@\-~,=$]/gu,"_").split("_").filter(r=>r.length>0).join("_")}function Kl(e,t=50){let r=[],o=0;for(let n of e.split("_").reverse())n.length+o<t?(r.push(n),o+=n.length+1):r.length===0&&r.push(n);let s=r.reverse().join("_");return s.slice(Math.max(s.length-t,0))}async function vt(e,t,...r){let o=e,s=f.fsPath(e);!await f.isAbsolute(e)&&t&&s&&(o=f.joinPath(t,s));let n=f.dirname(o);return await Wt(n,...r)}async function Wt(e,...t){return Jt(e,async r=>{let o=await f.readdir(r);if(o.some(s=>t.indexOf(s)>=0))return!0;for(let s of t)if(o.some(n=>s.startsWith(n))&&await f.exists(f.joinPath(r,s)))return!0;return!1})}async function Pe(e,t,r){return Jt(e,async o=>(await r(o),!!t&&Co(t,o)))}async function Jt(e,t){if(e){if(await t(e))return e;if(!Co(f.dirname(e),e))return Jt(f.dirname(e),t)}}function Co(e,t){return!!e&&!!t&&f.toString(e)===f.toString(t)}async function So(e,t){let r;return t&&(r=await Wl(t),r||(r=await Jl(e,t)),r&&await Ms(r,t)),r}var zt=[".httpyac.js",".httpyac.cjs",".httpyac.config.js",".httpyac.config.cjs","httpyac.config.js","httpyac.config.cjs",".httpyac.json","httpyac.config.json"];async function Wl(e){let t;for(let r of zt){let o=r&&f.joinPath(e,r);if(o&&await f.exists(o)){t=f.fsPath(o);break}}if(t){let r=f.fsPath(e);if(r&&L.loadModule){let o=L.loadModule(t,r,!0);return typeof o=="function"?o():o}}}async function Jl(e,t){let r=[];if(await Pe(e,t,async o=>{var n;let s=(n=await wt(f.joinPath(o,"package.json")))==null?void 0:n.httpyac;s&&r.push(s)}),r.length>0)return Object.assign({},...r.reverse())}async function wt(e){try{if(await f.exists(e)){let t=await f.readFile(e,"utf-8");return JSON.parse(t)}}catch(t){h.debug(`json parse of ${e} failed`,t)}}async function Ms(e,t){if(e.clientCertificates)for(let[,r]of Object.entries(e.clientCertificates))r.cert&&(r.cert=await N(r.cert,t)||r.cert),r.key&&(r.key=await N(r.key,t)||r.key),r.pfx&&(r.pfx=await N(r.pfx,t)||r.pfx)}async function To(e){let t=await zl(e),r={};if(t!=null&&t.json){let o=[...Object.keys(t.json.dependencies||{}),...Object.keys(t.json.devDependencies||{})].filter(Xl);for(let s of o){let n=f.fsPath(t.dir);if(n&&L.loadModule){let i=L.loadModule(s,n);i&&(r[s]=i)}}}return r}async function zl(e){let t=await Wt(e,"package.json");if(t)return{dir:t,json:await wt(f.joinPath(t,"package.json"))}}function Xl(e){return/^(httpyac-|@[\w-]+(\.)?[\w-]+\/httpyac-)plugin-/u.test(e)}var Vs="__NONE__";function M(e){return e&&e.length>0?e.sort().join(","):Vs}function ue(e){if(!e)return!1;if(e instanceof Error)return!0;let t=e;return!!t.message&&!!t.stack&&!!t.name}function Ie(e){var t;if(e.stack){let r=/^(?<error>.*):\s*(?<message>.*)\r?\n\s*at (?<file>.*):(?<line>\d*):(?<offset>\d*)/mu.exec(e.stack);if(r&&((t=r.groups)!=null&&t.error))return{error:e,errorType:r.groups.error,message:r.groups.message,file:r.groups.file,line:r.groups.line,offset:r.groups.offset,displayMessage:`${r.groups.error}: ${r.groups.message} - ${r.groups.file}:${r.groups.line}:${r.groups.offset}`}}return{error:e,displayMessage:e.message}}function Yl(e){return ue(e)?j({message:e.message,name:e.name,stack:e.stack}):w(e)}async function je(e,t){try{return await e}catch(r){return h.warn("promise has read error",r),t}}var Ws=require("hookpoint");var qo=require("hookpoint");function q(e,t){var r,o;h.debug(t),(o=(r=e.progress)==null?void 0:r.report)==null||o.call(r,{message:t})}async function Lo(e,t){var n,i;let r=[],o=1;(n=t.repeat)!=null&&n.count&&t.isMainContext&&(o=t.repeat.count);for(let a=0;a<o;a++)r.push(e);let s=[];if(((i=t.repeat)==null?void 0:i.type)===1){let a=await Promise.all(r.map(l=>l()));for(let l of a)l&&a.push(l)}else for(let a of r){let l=await a();l&&s.push(l)}return Xt(s)}function Xt(e){if(e.length>1){let t=ye(e[0]);delete t.prettyPrintBody,delete t.rawBody,delete t.meta,delete t.timings;let r={responses:[],statusCount:{},count:e.length},o=[];for(let s of e){s.statusCode>t.statusCode&&(t.statusCode=s.statusCode,t.statusMessage=s.statusMessage);let n=`${s.statusCode}`;r.statusCount[n]?r.statusCount[n]+=1:r.statusCount[n]=1,s.timings&&o.push(s.timings),delete s.prettyPrintBody,delete s.parsedBody,delete s.rawBody,r.responses.push(ye(s)),o.length>0&&(t.timings=Ql(o))}return t.parsedBody=r,t.body=j(r,2),t}return e.pop()}function Ql(e){let t=[],r=[],o=[],s=[],n=[],i=[],a=[],l=[];for(let u of e)t.push(u.dns||0),r.push(u.download||0),o.push(u.firstByte||0),s.push(u.request||0),n.push(u.tcp||0),i.push(u.tls||0),a.push(u.total||0),l.push(u.wait||0);let d=u=>{let p=u.filter(c=>c>0);if(p.length>0)return p.reduce((c,m)=>c+m,0)/p.length};return{dns:d(t),download:d(r),firstByte:d(o),request:d(s),tcp:d(n),tls:d(i),total:d(a),wait:d(l)}}var Bs=require("hookpoint");async function V(e,t,r){var o,s;return(s=(o=r.progress)==null?void 0:o.isCanceled)!=null&&s.call(o)?(h.trace("process canceled by user"),Bs.HookCancel):await r.httpFile.hooks.replaceVariable.trigger(e,t,r)}async function be(e,t,r){var s,n,i,a;let o=await V(e,"FilePath",t);if(g(o)){let l=await N(o,f.dirname(t.httpFile.fileName));if(l)return await r(l);let d=`file not found: ${e}`;(n=(s=O).showWarnMessage)==null||n.call(s,d),h.warn(d)}else{let l=`file replace made file invalid: ${e} <> ${o}`;(a=(i=O).showWarnMessage)==null||a.call(i,l),h.warn(l)}}function Ns(e,t){if(e&&g(e)){let r=e,o,s=/\{{2}\s*([a-zA-Z0-9_]+)\s*\}{2}/gu;for(;(o=s.exec(r))!==null;){let[n,i]=o,a=Ns(t[i],t);t[i]=a,r=r.replace(n,()=>`${a}`)}return r}return e}function F(e,t){if(e){let r=Yt(e);Object.assign(t.variables,r);let o=M(t.activeEnvironment);t.httpRegion.variablesPerEnv[o]||(t.httpRegion.variablesPerEnv[o]={}),Object.assign(t.httpRegion.variablesPerEnv[o],r)}}function Yt(e){return Object.fromEntries(Object.entries(e).filter(([t])=>!L.isAllowedKeyword||L.isAllowedKeyword(t)))}function Me(e,t){delete t.variables[e];let r=M(t.activeEnvironment);t.httpRegion.variablesPerEnv[r]&&delete t.httpRegion.variablesPerEnv[r][e]}function Zl(e,t){let r=M(t.activeEnvironment),o=t.httpRegion.variablesPerEnv[r];for(let s of Object.keys(e))delete t.variables[s],o&&delete o[s]}var Gs=require("uuid");function Eo({httpRegion:e},t){return async function(o,s){var i;let n={message:o,status:"SUCCESS"};if(typeof s=="function")try{await s(n)}catch(a){Us(n,a),t.ignoreErrorFile&&((i=n.error)!=null&&i.errorType)&&(n.error.displayMessage=`${n.error.errorType}: ${n.error.message}`)}ke(e,n)}}function Us(e,t){e.status="FAILED",ue(t)?e.error=Ie(t):e.error={displayMessage:`${t}`,error:new Error(`${t}`)}}function Pt({httpRegion:e,variables:t}){let r=function(n,i){let a={message:n,status:"SUCCESS"};if(typeof i=="function")try{i()}catch(l){Us(a,l)}ke(e,a)};function o(){return ho(t.response)?t.response:e.response}return r.status=s=>{let n=o();n&&r(`response status equals to ${s}`,()=>bo(n,s))},r.totalTime=s=>{let n=o();n&&r(`total time exceeded ${s}`,()=>Ro(n,s))},r.header=(s,n)=>{let i=o();i&&r(`response header ${s} equals ${n}`,()=>xo(i,s,n))},r.headerContains=(s,n)=>{let i=o();i&&r(`response header ${s} contains ${n}`,()=>vo(i,s,n))},r.responseBody=s=>{let n=o();n&&r(`response body equals ${s}`,()=>ko(n,s))},r.hasResponseBody=()=>{let s=o();s&&r("response body exists",()=>wo(s))},r.hasNoResponseBody=()=>{let s=o();s&&r("response body does not exists",()=>Po(s))},r}function ke(e,t){e.testResults||(e.testResults=[]),e.testResults.push(t)}function ne(e,t="request is skipped"){ke(e,{message:t,status:"SKIPPED"})}function Oo(e,t){return async function(r){var s;let{request:o}=r;if(o!=null&&o.url){if(!await nd(r))return!1;let n=e(o,r);F({$requestClient:n},r),r.requestClient=n;let i=td(n,r),a=((s=n.getSessionId)==null?void 0:s.call(n))||(0,Gs.v4)(),l=ld(t,a,o,()=>{n.disconnect(new Error("user cancellation"))});try{let d=[];rd(n,r),od(n,r,d),sd(n,r,d),q(r,n.reportMessage);let u=await n.connect(l.connection);h.debug(`requestClient ${o.url} connect`),l.connectionCount++,u!==l.connection&&(l.connection=u),await Promise.all([Lo(()=>n.send(),r),id(r).then(()=>{var m;(m=n.streamEnded)==null||m.call(n)})]);let p=await Promise.all(d),c=Xt(ed(...p));return c&&!await ad(c,r)?!1:(l.connectionCount--,_s(t,l)&&(h.debug(`requestClient ${o.url} disconnect`),n.disconnect()),!0)}catch(d){throw l.connectionCount--,_s(t,l)&&((r.scriptConsole||h).error(r.request),h.debug(`requestClient ${o.url} disconnect`),ue(d)?n.disconnect(d):n.disconnect(new Error(w(d)))),d}finally{n.triggerEnd(),i==null||i(),delete r.requestClient,Me("$requestClient",r)}}return!1}}function ed(...e){let t=[];for(let r of e)r&&t.push(r);return t}function td(e,t){var r,o;if((r=t.progress)!=null&&r.register)return(o=t.progress)==null?void 0:o.register(()=>{ne(t.httpRegion,"user cancellation"),e.disconnect(new Error("user cancellation"))})}function rd(e,t){var r;if(t.isMainContext&&((r=t.progress)!=null&&r.report)){let o=0;e.addEventListener("progress",s=>{var a;let n=s.detail,i=n-o;if(o=n,(a=t.progress)!=null&&a.report){h.trace(`progress to ${n}`);let l=t.progress.divider||1;t.progress.report({message:"request progress",increment:i/l*100})}})}}function od(e,t,r){e.addEventListener("message",o=>{let[s,n]=o.detail;h.debug(s,(n==null?void 0:n.message)||(n==null?void 0:n.body)),r.push(Promise.resolve(n)),e.supportsStreaming&&!t.httpRegion.metaData.noStreamingLog&&t.logStream&&r.push(t.logStream(s,{...n}))})}function sd(e,t,r){e.addEventListener("metaData",o=>{let[s,n]=o.detail;h.debug(`event ${s} for ${n.protocol}`,(n==null?void 0:n.message)||(n==null?void 0:n.body)),t.httpRegion.metaData.metaDataLogging&&t.logStream&&r.push(t.logStream(s,n))})}async function nd(e){let t=e.hooks.onRequest;return e.progress&&t.addInterceptor(Ks(()=>{var r;return!!((r=e.progress)!=null&&r.isCanceled())})),e.request&&await t.trigger(e.request,e)!==qo.HookCancel}async function id(e){let t=e.hooks.onStreaming;e.progress&&t.addInterceptor(Ks(()=>{var r;return!!((r=e.progress)!=null&&r.isCanceled())})),await t.trigger(e)}async function ad(e,t){return await t.hooks.onResponse.trigger(Qt(e),t)===qo.HookCancel?!1:(t.httpRegion.response=e,!0)}function Ks(e){return{id:"isCanceled",async beforeTrigger(){return!e()},async afterTrigger(){return!e()}}}function Qt(e){return new Proxy(e,{set(...r){let[o,s,n]=r,i=Reflect.set(...r);return s==="body"&&(delete o.prettyPrintBody,delete o.parsedBody,delete o.rawBody,typeof n=="string"&&(o.rawBody=Buffer.from(n))),i}})}function ld(e,t,r,o){let s=e.getUserSession(t);if(s!=null&&s.connection)return s;let n={id:t,description:"Pending Connection",details:{method:r.method,url:r.url},title:`${r.method} ${r.url}`,type:"Stream",connectionCount:0,delete:o};return e.setUserSession(n),n}function _s(e,t){return t.connectionCount<=0&&(delete t.delete,e.removeUserSession(t.id)),t.connectionCount===0}function kt(e,t="global"){var r,o,s,n;if(e){if(g(e.metaData.title))return e.metaData.title;if(g(e.metaData.name))return e.metaData.name;if((r=e.request)!=null&&r.url){let i=e.request.url.indexOf("?");i<0&&(i=e.request.url.length);let a=((n=(s=(o=e.symbol.children)==null?void 0:o.find)==null?void 0:s.call(o,l=>l.kind==="requestLine"))==null?void 0:n.startLine)||e.symbol.startLine;return`${e.request.method} ${e.request.url.slice(0,i)} (line: ${a+1})`}}return t}function $o(e,t="-"){var r;return g(e.metaData.description)?e.metaData.description:(r=e.request)!=null&&r.url?`${e.request.method} ${e.request.url}`:t}async function Ve(e,t){let r;e&&(r=ye(e),await t.hooks.responseLogging.trigger(Qt(r),t)===Ws.HookCancel)||!t.httpRegion.metaData.noLog&&t.logResponse&&await t.logResponse(r,t.httpRegion)}async function He(e){for(let t of e.httpFile.globalHttpRegions)if(!await t.execute(e))return!1;return!0}function Ht(e,t){return{onRequest:t.hooks.onRequest.merge(...t.globalHttpRegions.map(r=>r.hooks.onRequest),e.onRequest),onResponse:t.hooks.onResponse.merge(e.onResponse,...t.globalHttpRegions.map(r=>r.hooks.onResponse)),onStreaming:t.hooks.onStreaming.merge(e.onStreaming,...t.globalHttpRegions.map(r=>r.hooks.onStreaming)),responseLogging:t.hooks.responseLogging.merge(e.responseLogging,...t.globalHttpRegions.map(r=>r.hooks.responseLogging))}}function dd(e,t){let r=[];return e.request&&(r.push(...zs(e.request,{body:!!(t!=null&&t.requestBody)})),r.push("")),r.push(...Js(e,{prettyPrint:!!(t!=null&&t.prettyPrint),body:!!(t!=null&&t.responseBody)})),G(r)}function Js(e,t){let r=[];return r.push(`${e.protocol} ${e.statusCode} ${e.statusMessage?` - ${e.statusMessage}`:""}`),e.headers&&r.push(...Ao(e.headers)),t!=null&&t.body&&g(e.body)&&(r.push(""),r.push(t!=null&&t.prettyPrint&&e.prettyPrintBody?e.prettyPrintBody:e.body)),r}function zs(e,t){let r=[];return r.push(`${e.method} ${e.url}`),e.headers&&r.push(...Ao(e.headers)),t!=null&&t.body&&g(e.body)&&(r.push(""),r.push(e.body)),r}function Ao(e){return Object.entries(e).map(([t,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):g(r)||(o=j(r))),`${t}: ${o}`})}function ud(e,t){let r=[];return e.request&&(r.push(...Qs(e.request,{body:!!(t!=null&&t.requestBody)})),r.push("")),r.push(...Xs(e,{prettyPrint:!!(t!=null&&t.prettyPrint),body:!!(t!=null&&t.responseBody)})),t!=null&&t.testResults&&(r.push(""),r.push(""),r.push(...Zs(t.testResults))),t!=null&&t.timings&&e.timings&&(r.push(""),r.push(""),r.push(...tn(e.timings))),t!=null&&t.meta&&e.meta&&(r.push(""),r.push(""),r.push(...en(e.meta))),Zt(r)}function Xs(e,t){let r=[];if(r.push(`\`${e.protocol} ${e.statusCode}${e.statusMessage?` - ${e.statusMessage}`:""}\``),e.headers&&r.push(...Do(e.headers)),t!=null&&t.body&&g(e.body)){r.push(""),r.push(`\`\`\`${Ys(e.contentType)}`);let o=t.prettyPrint&&e.prettyPrintBody?e.prettyPrintBody:e.body;r.push(Zt(se(o))),r.push("```")}return r}function Ys(e){return Rt(e)?"json":no(e)?"xml":io(e)?"html":so(e)?"js":ao(e)?"css":xt(e)?"markdown":""}function Qs(e,t){let r=[];return r.push(`\`${e.method} ${e.url}\``),e.headers&&r.push(...Do(e.headers)),t!=null&&t.body&&g(e.body)&&(r.push(""),r.push("```json"),r.push(Zt(se(e.body))),r.push("```")),r}function Zs(e){let t=[];t.push("`TestResults`"),t.push("");for(let r of e){let o=`${te.ok}: ${r.message}`;r.status==="SKIPPED"?o=`${te.skipped}: ${r.message}`:["FAILED","ERROR"].includes(r.status)&&(o=`${te.error}: ${r.message}`,r.error&&(o+=` (${r.error.displayMessage})`)),t.push(o)}return t}function Do(e){return Object.entries(e).map(([t,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):g(r)||(o=j(r))),`*${t}*: ${o}`}).sort()}function en(e){let t=[];t.push("`Meta`"),t.push("");for(let[r,o]of Object.entries(e))Array.isArray(o)?o.length>0&&t.push(`*${r}*: ${o.join(",")}`):t.push(`*${r}*: ${o}`);return t}function tn(e){let t=[];return t.push("`Timings`"),t.push(""),e.wait&&t.push(`*Wait*: ${e.wait} ms`),e.dns&&t.push(`*DNS*: ${e.dns} ms`),e.tcp&&t.push(`*TCP*: ${e.tcp} ms`),e.tls&&t.push(`*TLS*: ${e.tls} ms`),e.request&&t.push(`*Request*: ${e.request} ms`),e.firstByte&&t.push(`*First Byte*: ${e.firstByte} ms`),e.download&&t.push(`*Download*: ${e.download} ms`),e.total&&t.push(`*Total*: ${e.total} ms`),t}function Zt(e){return e.join(`  ${f.EOL}`)}function pd(e){let t=e;return!!(t!=null&&t.accessToken)}function cd(e){let t=e;return!!(t!=null&&t.httpRegion)&&!!(t!=null&&t.httpFile)&&!!(t!=null&&t.variables)&&!!(t!=null&&t.config)}var Ct=/\{{2}\s*(.+?)\s*\}{2}/gu,Re=/^\s*#{3,}(?<title>.*)$/u,fd=/^\s*(?<type>openid|oauth2)(\s+(?<flow>client(_credentials)?|(authorization_)?code|device(_code)?|password|implicit|hybrid))?(\s+(?<variablePrefix>[^\s]*))?\s*((token_exchange)\s+(?<tokenExchangePrefix>[^\s]*))?\s*$/iu;async function er(e,t,r){let o={parseResults:[]},s=e.next();for(;!s.done;){let n=!1;for(let i of t){let a=await i(s.value,r);if(a){o.parseResults.push(a),n=!0;break}}if(!n)break;o.nextLine=s.value.line,s=e.next()}return o}function tr(e){return async function(r){var s;let o=/^\s*(?<key>[!#$%&'*+\-.^_`|~0-9A-Za-z]+)\s*:\s*(?<value>.*?),?\s*$/u.exec(r.textLine);if((s=o==null?void 0:o.groups)!=null&&s.key){let n=o.groups.key,i=o.groups.value,a=e[n];a?Array.isArray(a)?a.push(i):e[n]=[a,i]:e[n]=i;let l=r.textLine.indexOf(i);return{symbols:[new P({name:n,description:i,kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.length,children:[new P({name:n,description:"request header key",kind:"key",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.indexOf(n)+n.length}),i?new P({name:i,description:"request header value",kind:"value",startLine:r.line,startOffset:l,endLine:r.line,endOffset:l+i.length,children:pe(i,r.line,l)}):void 0].filter(d=>!!d)})]}}return!1}}function Io(e=(t,r)=>{r.request&&(r.request.headers?Object.assign(r.request.headers,t):r.request.headers=t)}){return async function(r,o){var n;let s=/^\s*\.{3}(?<variableName>[^\s]+),?\s*$/u.exec(r.textLine);if((n=s==null?void 0:s.groups)!=null&&n.variableName){let i=new Fo(s.groups.variableName,e);o.httpRegion.hooks.execute.addObjHook(l=>l.process,i);let a=r.textLine.trim();return{symbols:[new P({name:a||"hader variable",description:"Header Variable",kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(a),endOffset:r.textLine.length,endLine:r.line,children:[new P({name:s.groups.variableName,description:"Header Variable",kind:"variable",startLine:r.line,startOffset:s.index,endOffset:s.groups.variableName.length,endLine:r.line})]})]}}return!1}}var Fo=class{constructor(t,r){this.data=t;this.setHeaders=r;this.id="defaultHeaders"}async process(t){if(this.data&&t.variables){q(t,"set request headers");let r=await L.evalExpression(this.data,t);r&&this.setHeaders(Object.assign({},r),t)}return!0}};function jo(e){return async function(r){if(/^\s*(\/)[^*]*$/u.test(r.textLine)){let o=r.textLine.trim();return e(o),{symbols:[new P({name:o||"URL Part",description:"URL Part",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line,children:pe(r.textLine,r.line)})]}}return!1}}function Mo(e){return async function(r){if(/^\s*(\?|&)((([^(=?&)]+)=(.*))|\{\{.*\}\})\s*$/u.test(r.textLine)){let o=r.textLine.trim();return e(o),{symbols:[new P({name:o||"Query",description:"Query",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line,children:pe(r.textLine,r.line,0)})]}}return!1}}async function St(e,t,r=/^\s*((#\s+)|(\/{2}))/u){var o;if(r.test(e.textLine)){let s={symbols:[new P({name:"comment",description:e.textLine,kind:"metaData",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length})]},n=/^\s*(#+|\/{2,})\s+@(?<key>[^\s]*)(\s+)?"?(?<value>.*)?"?$/u.exec(e.textLine);if(n&&n.groups&&n.groups.key){let i=n.groups.key.replace(/-./gu,l=>l[1].toUpperCase());s.symbols[0].children=[new P({name:i||"metadata",description:n.groups.value||"-",kind:"metaData",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:[new P({name:i||"metadata key",description:((o=rn.find(l=>l.name===i))==null?void 0:o.description)||"key of meta data",kind:"key",startLine:e.line,startOffset:e.textLine.indexOf(n.groups.key),endLine:e.line,endOffset:e.textLine.indexOf(n.groups.key)+n.groups.key.length})]})];let a;n.groups.value&&(a=n.groups.value.trim(),s.symbols[0].children.push(new P({name:n.groups.value||"metadata value",description:"value of meta data",kind:"value",startLine:e.line,startOffset:e.textLine.indexOf(n.groups.value),endLine:e.line,endOffset:e.textLine.indexOf(n.groups.value)+n.groups.value.length}))),t.httpRegion.metaData=Object.assign(t.httpRegion.metaData||{},{[i]:a||!0}),await t.httpFile.hooks.parseMetaData.trigger(i,a,t)}return s}return!1}var rn=[{name:"name",description:"responses of a requests with a name are automatically added as variables and can be reused by other requests",completions:["${1}"]},{name:"debug",description:"enable debug log level"},{name:"description",description:"additional description of region",completions:["${1}"]},{name:"disabled",description:"requests can be disabled"},{name:"extension",description:"extension of file for save or openWith.",completions:["${1}"]},{name:"forceRef",description:"When the request is called, it is ensured that the referenced request is always called beforehand",completions:["${1}"]},{name:"import",description:"reference Requests from other files.",completions:["${1}"]},{name:"injectVariables",description:"Inject Variables in request body (needed because of compatibility with Intellij)."},{name:"jwt",description:"supports auto decode of jwt token."},{name:"language",description:"language id of the response view",completions:["${1}"]},{name:"loop",description:"allows multiple Invocations of a Request with different parameters.",completions:["for ${1} of ${2}","for ${1}","while ${1}"]},{name:"keepStreaming",description:"keep streaming until the user session is ended manually"},{name:"noLog",description:"prevent logging of request data in output console"},{name:"noCookieJar",description:"cookieJar support is disabled for this request"},{name:"noClientCert",description:"SSL client certificate is not send for this request"},{name:"noProxy",description:"disable proxy for this request"},{name:"noRejectUnauthorized",description:"all invalid SSL certificates will be ignored and no error will be thrown."},{name:"noResponseView",description:"prevent output in editor document."},{name:"noStreamingLog",description:"prevent logging of streaming request data in output console"},{name:"note",description:"shows a confirmation dialog before sending request",completions:["${1}"]},{name:"openWith",description:"viewType of custom editor to preview files",completions:["${1}"]},{name:"ref",description:"When the request is called, it is ensured that the referenced request is called beforehand",completions:["${1}"]},{name:"ratelimit",description:"allows throttling requests",completions:["minIdleTime ${1}","max ${1} expire ${2}","minIdleTime ${1} max ${2} expire ${3}"]},{name:"save",description:"If specified, the response will not be displayed but saved directly."},{name:"sleep",description:"wait specified milliseconds, before next step.",completions:["${1}"]},{name:"title",description:"additional title of region",completions:["${1}"]},{name:"timeout",description:"set timeout for request",completions:["${1}"]},{name:"verbose",description:"enable trace log level"}],md=100;async function U(e,t){if(!g(e))return e;let r,o,s=e,n=0;for(;o!==s&&n++<md;)for(o=s;(r=Ct.exec(o))!==null;){let[i,a]=r,l=await t(a,i);if(typeof l<"u"&&i===e)return l;let d=l===null?"null":w(l);typeof d<"u"&&(s=s.replace(i,()=>d))}return s}function pe(e,t,r=0){let o=[];if(e){let s;for(;(s=Ct.exec(e))!==null;){let[n,i]=s;o.push(new P({name:i||"variable",description:i,startLine:t,endLine:t,kind:"variable",startOffset:r+s.index,endOffset:r+s.index+n.length,source:i}))}}return o}async function Vo(e,t,r){var n,i;let o=e(),s=o.next();if(!s.done){if(t.data.httpResponseSymbol){let l=t.data.httpResponseSymbol;return l.body.push(s.value.textLine),l.symbol.endLine=s.value.line,l.symbol.endOffset=s.value.textLine.length,{nextParserLine:s.value.line,symbols:[]}}let a=r.exec(s.value.textLine);if(a&&((n=a.groups)!=null&&n.statusCode)){let l={};t.httpRegion.response={protocol:`HTTP/${a.groups.httpVersion||"1.1"}`,httpVersion:a.groups.httpVersion,statusCode:+a.groups.statusCode,statusMessage:a.groups.statusMessage,headers:l};let d=new P({name:"response",description:"response",kind:"response",startLine:s.value.line,startOffset:0,endLine:s.value.line,endOffset:s.value.textLine.length,children:[]});t.data.httpResponseSymbol={symbol:d,body:[]};let u=[t.data.httpResponseSymbol.symbol],p={nextParserLine:s.value.line,symbols:u},c=await er(o,[tr(l)],t);p.nextParserLine=c.nextLine||p.nextParserLine;for(let m of c.parseResults)for(let y of m.symbols)(i=d.children)==null||i.push(y),d.endLine=y.endLine,d.endOffset=y.endOffset;return p}}return!1}function Tt(e){let t=/^<(?:(?<injectVariables>@)(?<encoding>\w+)?)?\s+(?<fileName>.+?)\s*$/u.exec(e);if(t&&t.length===4&&t.groups)return{fileName:t.groups.fileName.trim(),injectVariables:!!t.groups.injectVariables,encoding:Qe(t.groups.encoding)}}function Bo(e){return async function(r,o){var i,a,l;let s=r(),n=s.next();if(!n.done&&yd(n.value,o,e)){if(o.httpRegion.request)return{endRegionLine:n.value.line-1,nextParserLine:n.value.line-1,symbols:[]};let d=hd(n.value,e);if(!d)return!1;o.httpRegion.request=d.request;let u=new P({name:n.value.textLine||"request line",description:`${e.protocol} request-line`,kind:"requestLine",startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:n.value.textLine.length,children:[d.symbol]}),p={nextParserLine:n.value.line,symbols:[u]},c={};d.request.headers=c;let m=await er(s,[St,tr(c),Io(),Mo(y=>d.request.url+=y),jo(y=>d.request.url+=y)],o);p.nextParserLine=m.nextLine||p.nextParserLine;for(let y of m.parseResults)(a=(i=p.symbols)==null?void 0:i.push)==null||a.call(i,...y.symbols);if((l=e.modifyRequest)==null||l.call(e,d.request),d.request.headers){let y=$(d.request.headers,"content-type");g(y)&&(d.request.contentType=bt(y))}return o.httpRegion.hooks.execute.addHook(e.protocol.toLowerCase(),Oo(e.requestClientFactory,e.sessionStore)),p}return!1}}function hd(e,t){var s,n,i,a;let r=t.methodRegex.exec(e.textLine);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,protocol:t.protocol.toUpperCase(),method:((s=r.groups)==null?void 0:s.method)||t.method||t.protocol},symbol:new P({name:r.groups.url||"request",description:`${t.protocol} Url`,kind:"url",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:pe(e.textLine,e.line)})};let o=(n=t.protocolRegex)==null?void 0:n.exec(e.textLine);if(o&&o.length>1&&((i=o.groups)!=null&&i.url))return{request:{url:o.groups.url,protocol:t.protocol.toUpperCase(),method:((a=o.groups)==null?void 0:a.method)||t.method||t.protocol},symbol:new P({name:o.groups.url||"request",description:`${t.protocol} Url`,kind:"url",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:pe(e.textLine,e.line)})}}function yd(e,t,r){var o,s,n,i;return Ae(e.textLine)||t.forceRegionDelimiter&&t.httpRegion.request?!1:(s=(o=r.methodRegex.exec(e.textLine))==null?void 0:o.groups)!=null&&s.url?!0:!t.httpRegion.request&&r.protocolRegex?!!((i=(n=r.protocolRegex.exec(e.textLine))==null?void 0:n.groups)!=null&&i.url):!1}function No(e){let t=e;return!!(t!=null&&t.httpRegion)}function Uo(e){let t=e;return Array.isArray(t==null?void 0:t.httpRegions)}function Be(e,t){let r=t.httpFile.findHttpRegion(e);if(r)return r;if(t.options.httpFiles)for(let{ref:o}of t.options.httpFiles.filter(s=>s.base===t.httpFile)){let s=o.findHttpRegion(e);if(s)return s}}async function Lt(e,t,r){var s,n;let o=await be(e,r,async i=>{h.debug(`parse imported file ${i}`),r.options.httpFiles||(r.options.httpFiles=[]);let a=r.options.httpFiles.filter(d=>d.ref.fileName===i);if(a.length>0){let d=a[0].ref;return a.some(u=>u.base===r.httpFile)||r.options.httpFiles.push({base:r.httpFile,ref:d}),d}let l=await t.getOrCreate(i,async()=>await f.readFile(i,"utf-8"),0,{workingDir:r.httpFile.rootDir,config:r.config});return r.hooks=Ht(r.hooks,l),r.options.httpFiles.push({base:r.httpFile,ref:l}),l});if(o&&(!r.options.globalScriptsExecuted||((n=(s=r.options.globalScriptsExecuted).indexOf)==null?void 0:n.call(s,o))<0)){r.options.globalScriptsExecuted||(r.options.globalScriptsExecuted=[]),h.debug(`execute global scripts for import ${o.fileName}`),r.options.globalScriptsExecuted.push(o);let i={...r,httpFile:o};return await He(i)}return!!o}function Ze(e){let t=e;return t&&!!t.then}function Ce(e){return new Promise(t=>setTimeout(t,e))}async function _o(e,...t){let r=[],o=async()=>{let n;for(;n=t.shift();)r.push(await n())},s=[];for(let n=0;n<e;n++)s.push(o());return await Promise.all(s),r}var on=T(require("dayjs")),sn=require("uuid"),Et={alphabetic:(e=10)=>Y(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"),numeric:(e=10)=>Y(e),hexadecimal:(e=10)=>Y(e,"1234567890ABCDEF"),email:et,float:(e=0,t=100)=>Math.random()*(t-e)+e,integer:(e=0,t=100)=>Math.floor(Math.random()*(t-e)+e),uuid:()=>(0,sn.v4)(),date:(e=new Date,t=void 0)=>(0,on.default)(e).format(t)};function et(){return`${Y(30)}@${Y(10)}.${Go(["com","org","at","de","fr","uk","it","ch","info","edu","asia","gov","app","io"])}`}function Y(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_"){let r=[];if(e>0){let o=t.split("");for(let s=0;s<e;s++)r.push(Go(o))}return r.join("")}function Go(e){return e[Math.floor(Math.random()*(e.length-1))]}var Ne=require("fs"),nn=require("os"),Se=require("path");async function Ko(){an(),await xd(),bd()}function bd(){process.platform==="win32"&&(te.ok="[x]",te.error="[-]",te.skipped="[*]")}function an(){f.EOL=nn.EOL,f.isAbsolute=async e=>(0,Se.isAbsolute)(f.toString(e)),f.dirname=e=>(0,Se.dirname)(f.toString(e)),f.hasExtension=(e,...t)=>{let r=(0,Se.extname)(f.toString(e));return r.startsWith(".")&&(r=r.slice(1)),t.indexOf(r)>=0},f.joinPath=(e,t)=>(0,Se.join)(f.toString(e),t),f.exists=async e=>{try{return!!await Ne.promises.stat(f.toString(e))}catch{return!1}},f.readFile=async(e,t)=>{let r=f.fsPath(e);if(r)return Ne.promises.readFile(r,t);throw new Error("No valid path for cli")},f.readBuffer=async e=>{let t=f.fsPath(e);if(t){let r=(0,Ne.createReadStream)(t);return Rd(r)}throw new Error("No valid path for cli")},f.writeBuffer=(e,t)=>Ne.promises.writeFile(f.toString(e),t),f.readdir=async e=>Ne.promises.readdir(f.toString(e))}function Rd(e){return new Promise((t,r)=>{let o=[];e.on("data",s=>{Buffer.isBuffer(s)?o.push(s):o.push(Buffer.from(s))}),e.on("end",()=>t(Buffer.concat(o))),e.on("error",s=>r(s)),e.resume()})}async function xd(){O.showNote=async function(t){return console.log(`Note: ${t}`),!0},O.showInputPrompt=async function(t,r,o){if(r!==void 0)return r;throw new Error("Interactive input not supported in uctest. Use --var to pass values.")},O.showListPrompt=async function(t,r){if(r.length>0)return r[0];throw new Error("Interactive selection not supported in uctest.")},O.getClipboard=async function(){return""},O.setClipboard=async function(t){}}var W=T(require("chalk")),pl=require("commander"),at=require("fs"),A=require("path");var cn=require("assert");var rr=class{constructor(){this.id=["endsWith"]}match(t,r){let o=w(t),s=w(r);return o&&s?o==null?void 0:o.endsWith(s):!1}};var or=class{constructor(){this.id=["==","===","equals"]}match(t,r){return typeof t=="object"?j(t)===j(r):t===r}};var sr=class{constructor(){this.id=["exists","isTrue"]}match(t){return!!t}};var nr=class{constructor(){this.id=[">="]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o>=s:!1}};var ir=class{constructor(){this.id=[">"]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o>s:!1}};var ar=class{constructor(){this.id=["contains","includes"]}match(t,r){let o=w(t),s=w(r);return o&&s?o.includes(s):Array.isArray(t)?t.indexOf(r)>=0:!1}};var lr=class{constructor(){this.id=["isArray"]}match(t){return Array.isArray(t)}};var dr=class{constructor(){this.id=["isBoolean"]}match(t){return typeof t=="boolean"}};var ur=class{constructor(){this.id=["isFalse"]}match(t){return!t}};var pr=class{constructor(){this.id=["isNumber"]}match(t){return typeof t=="number"}};var cr=class{constructor(){this.id=["isString"]}match(t){return typeof t=="string"}};var fr=class{constructor(){this.id=["<="]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o<=s:!1}};var mr=class{constructor(){this.id=["<"]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o<s:!1}};var gr=class{constructor(){this.id=["matches"];this.noAutoConvert=!0}match(t,r){let o=w(t),s=w(r);return o&&s?new RegExp(s,"u").test(o):!1}};var ln=require("crypto");var hr=class{constructor(){this.id=["md5"];this.noAutoConvert=!0}match(t,r){let o=he(t);return o?(0,ln.createHash)("md5").update(o).digest("base64")===r:!1}};var yr=class{constructor(){this.id=["!=","!==","not equals"]}match(t,r){return t!==r}};var dn=require("crypto");var br=class{constructor(){this.id=["sha256"];this.noAutoConvert=!0}match(t,r){let o=he(t);return o?(0,dn.createHash)("sha256").update(o).digest("base64")===r:!1}};var un=require("crypto");var Rr=class{constructor(){this.id=["sha512"];this.noAutoConvert=!0}match(t,r){let o=he(t);return o?(0,un.createHash)("sha512").update(o).digest("base64")===r:!1}};var xr=class{constructor(){this.id=["startsWith"]}match(t,r){let o=w(t),s=w(r);return o&&s?o==null?void 0:o.startsWith(s):!1}};var pn=[new rr,new or,new sr,new nr,new ir,new ar,new lr,new dr,new pr,new cr,new fr,new mr,new gr,new yr,new xr,new br,new hr,new Rr,new ur];async function fn(e,{httpRegion:t}){let o=e().next();if(!o.done&&o.value.textLine){let s=o.value.textLine,i=`^\\s*\\?\\?\\s*(?<type>[^\\s]*)(\\s+(?<value>.*))?\\s+(?<predicate>(${pn.reduce((l,d)=>(l.push(...d.id),l),[]).join("|")}))\\s*(?<expected>.*)\\s*$`,a=new RegExp(i,"iu").exec(s);if(a&&a.groups&&a.groups.type&&a.groups.predicate){let l=a.groups.type,d=a.groups.value,u=a.groups.expected,p=pn.find(c=>{var m;return((m=a.groups)==null?void 0:m.predicate)&&c.id.indexOf(a.groups.predicate)>=0});return p&&t.hooks.onResponse.addHook(`test ${s}`,async(c,m)=>{await Eo(m,{ignoreErrorFile:!0})(`${d||l} ${p.id[0]} ${u||""}`.trim(),async v=>{let H=await m.httpFile.hooks.provideAssertValue.trigger(l,d,c,m),x=u&&await V(u,"Variable",m);x!==u&&(v.message=`${d||l} ${p.id[0]} ${x}`);let b=p.noAutoConvert?x:wd(H,x);(0,cn.ok)(p.match(H,b),`${d||l} (${H}) ${p.id[0]} ${w(b)||""}`.trim())})}),{nextParserLine:o.value.line,symbols:[new P({name:`assert ${a.groups.type}`,description:`${a.groups.predicate} ${a.groups.expected||""}`.trim(),kind:"script",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length})]}}}return!1}function wd(e,t){if(t!=null){if(typeof e=="number")return C(t);if(typeof e=="boolean")return we(t,!!t);if(typeof e=="string")return w(t);if(e===null&&t==="null")return null;if(e===void 0&&t==="undefined")return;if(typeof e=="object"&&typeof t=="string")try{return JSON.parse(t)}catch{return t}}return t}ee.emptyLineProvider.push(()=>[{name:"?? status == ",description:"Status assert (200)"},{name:"?? status == 200",description:"Status assert (200)"},{name:"?? duration <",description:"Duration assert"},{name:"?? body contains",description:"Body assert"},{name:"?? body matches",description:"Body assert"},{name:"?? body md5",description:"Body assert"},{name:"?? body sh256",description:"Body assert"},{name:"?? header",description:"Header assert"}]);function mn(e,t,r){var o,s,n,i,a,l,d;if(e==="duration")switch(t){case"firstByte":return(o=r==null?void 0:r.timings)==null?void 0:o.firstByte;case"download":return(s=r==null?void 0:r.timings)==null?void 0:s.download;case"wait":return(n=r==null?void 0:r.timings)==null?void 0:n.wait;case"request":return(i=r==null?void 0:r.timings)==null?void 0:i.request;case"tcp":return(a=r==null?void 0:r.timings)==null?void 0:a.tcp;case"tls":return(l=r==null?void 0:r.timings)==null?void 0:l.tls;default:return(d=r==null?void 0:r.timings)==null?void 0:d.total}return!1}function gn(e,t,r){return e==="header"&&t?$(r.headers,t):!1}async function hn(e,t,r,o){return e==="js"&&t?await L.evalExpression(t,o,{response:r}):e==="body"?t?await L.evalExpression(`(response.parsedBody || response.body).${t}`,o,{response:r}):r.body:!1}function yn(e,t,r){return e==="status"?r==null?void 0:r.statusCode:!1}var vr=class{constructor(){this.id="testFailed";this.before=["processedHttpRegion"]}async onError(t,r){if(ue(t)){let{httpRegion:o}=r.args[0];ke(o,{message:t.message,error:Ie(t),status:"ERROR"})}return!0}};function bn(e){e.hooks.execute.addInterceptor(new vr),e.hooks.provideAssertValue.addHook("status",yn,{before:["request"]}),e.hooks.provideAssertValue.addHook("header",gn,{before:["request"]}),e.hooks.provideAssertValue.addHook("javascript",hn,{before:["request"]}),e.hooks.provideAssertValue.addHook("duration",mn,{before:["request"]}),e.hooks.parse.addHook("assert",fn,{before:["request"]})}ee.variableProvider.push(()=>[{name:"$prompt ",description:"Prompt"},{name:"$input",description:"Input"},{name:"$input-askonce",description:"Input"},{name:"$password",description:"Password"},{name:"$pick <placeholder> $value:",description:"Password"},{name:"$pick-askonce <placeholder> $value:",description:"Password"},{name:"$timestamp",description:"Timestamp"},{name:"$datetime",description:"Datetime"},{name:"$localDatetime",description:"Local Datetime"}]);var Rn="$default",xn="$shared";async function vn(e){var t;if((t=e.config)!=null&&t.environments){let r=Object.keys(e.config.environments).filter(o=>[Rn,xn].indexOf(o)<0);return h.info("Config Env Provider found environments",r),r}return[]}async function wn(e,t){var o;let r=[];if((o=t.config)!=null&&o.environments){let s=t.config.environments;r.push(s[xn]),e&&e.length>0?r.push(...e.map(n=>s[n])):r.push(s[Rn])}return Object.assign({},...r)}var Xo={};lt(Xo,{HttpFile:()=>qt,HttpFileStore:()=>Ot,HttpRegion:()=>rt,UserSessionStore:()=>Pr,closeHttpRegion:()=>wr,createReaderFactory:()=>Wo,getEnvironmentConfig:()=>tt,parseHttpFile:()=>zo,pluginStore:()=>le,setSource:()=>Jo,userSessionStore:()=>S});var Pn=T(require("chalk")),kn=T(require("lodash/merge"));async function tt(e,t){let r=[];if(t){let s=await So(t.fileName,t.rootDir);s&&r.push(s)}e&&r.push(e);let o=(0,kn.default)({log:{level:5,supportAnsiColors:!0},cookieJarEnabled:!0,envDirName:"env"},...r);return Pd(o),o}function Pd(e){var t,r,o;typeof((t=e==null?void 0:e.log)==null?void 0:t.level)>"u"?h.options.level=5:h.options.level=(r=e==null?void 0:e.log)==null?void 0:r.level,((o=e==null?void 0:e.log)==null?void 0:o.supportAnsiColors)===!1&&(Pn.default.level=0)}var qt=class{constructor(t,r){this.fileName=t;this.rootDir=r;this.hooks={parse:new dt,parseMetaData:new ut,parseEndRegion:new ct,provideAssertValue:new pt,replaceVariable:new gt,provideEnvironments:new mt,provideVariables:new ft,execute:new $e,onStreaming:new qe,onRequest:new Le,onResponse:new Ee,responseLogging:new Oe};this.httpRegions=[]}findHttpRegion(t){return this.httpRegions.find(r=>{var o;return((o=r.metaData)==null?void 0:o.name)===t&&!r.metaData.disabled})}get globalHttpRegions(){return this.httpRegions.filter(t=>t.isGlobal()&&!t.metaData.disabled)}};var Tn=require("hookpoint");async function wr(e){await e.httpFile.hooks.parseEndRegion.trigger(e);let{httpRegion:t}=e;e.httpRegion.symbol.name=kt(t),e.httpRegion.symbol.description=$o(t),e.httpFile.httpRegions.push(e.httpRegion),delete e.forceRegionDelimiter}function Wo(e,t){return function*(o){for(let s=e;s<t.length;s++){let n=t[s];if(yield{textLine:n,line:s},!o&&Re.test(n))break}}}var Sn=require("hookpoint");var Hn=require("hookpoint");var rt=class e{constructor(t,r=0){this.httpFile=t;this.variablesPerEnv={};this.metaData={};this.hooks={execute:new $e,onRequest:new Le,onStreaming:new qe,onResponse:new Ee,responseLogging:new Oe};this.dependentsPerEnv=[];this.symbol=new P({name:"-",description:"-",kind:"request",startLine:r,startOffset:0,endLine:r,endOffset:0})}get id(){return`${this.httpFile.fileName}_${this.symbol.startLine}`}isGlobal(){return!(this.request||this.metaData.name)}clone(t){let r=new e(t||this.httpFile);return r.request=this.request,Object.assign(r.symbol,this.symbol),Object.assign(r.hooks,this.hooks),Object.assign(r.variablesPerEnv,this.variablesPerEnv),Object.assign(r.metaData,this.metaData),r}async execute(t,r){var s,n,i;delete this.response,this.testResults=[],t.httpRegion&&this.registerRegionDependent(t.httpRegion),(n=(s=t.progress)==null?void 0:s.report)==null||n.call(s,{message:`${this.symbol.name}`});let o=this.hooks.execute;if(!this.isGlobal()){o=this.httpFile.hooks.execute.merge(o);for(let a of this.httpFile.httpRegions.filter(l=>l.isGlobal()))a instanceof e&&a.registerRegionDependent(this)}try{let a=await o.trigger({...t,httpFile:this.httpFile,httpRegion:this,hooks:Ht(this.hooks,this.httpFile),isMainContext:r});return this.isGlobal()||this.resetDependentRegionsWithVisitor(M(t.activeEnvironment),this,[]),a!==Hn.HookCancel&&a.every(l=>!!l)}catch(a){return ue(a)&&(ke(this,{message:a.message,status:"ERROR",error:Ie(a)}),a.handled||(await((i=t.logResponse)==null?void 0:i.call(t,this.response,this)),a.handled=!0)),!1}}resetDependentRegionsWithVisitor(t,r,o){let s=r.dependentsPerEnv.filter(n=>!o.includes(n));for(let n of s)delete n.response,delete n.variablesPerEnv[t],o.push(n),n instanceof e&&this.resetDependentRegionsWithVisitor(t,n,o)}registerRegionDependent(t){t&&!this.dependentsPerEnv.includes(t)&&t!==this&&this.dependentsPerEnv.push(t)}};function Jo(e,t){for(let r of e)Cn(r.symbol,t)}function Cn(e,t){e.source=G(t.slice(e.startLine,e.endLine+1));let r=e.endOffset-t[e.endLine].length;if(r>=0&&(r=void 0),e.source=e.source.slice(e.startOffset,r),e.children)for(let o of e.children)Cn(o,t)}async function zo(e,t,r){let o=se(t),s={lines:o,httpFile:e,httpRegion:new rt(e,0),data:{},httpFileStore:r};for(let n=0;n<o.length;n++){let i=await e.hooks.parse.trigger(Wo(n,o),s);i&&i!==Sn.HookCancel&&(i.endRegionLine!==void 0&&i.endRegionLine>=0&&(s.httpRegion.symbol.endLine=i.endRegionLine,s.httpRegion.symbol.endOffset=o[i.endRegionLine].length,await wr(s),s.httpRegion=new rt(e,i.nextParserLine+1)),i.symbols&&(s.httpRegion.symbol.children?s.httpRegion.symbol.children.push(...i.symbols):s.httpRegion.symbol.children=i.symbols),n=i.nextParserLine)}return await wr(s),s.httpRegion.symbol.endLine=o.length-1,s.httpRegion.symbol.endOffset=o[o.length-1].length,Jo(e.httpRegions,o),e}var le={};var Ot=class{constructor(t={}){this.plugins=t;this.storeCache=[]}getFromStore(t,r){let o=f.toString(t),s=this.storeCache.find(n=>n.cacheKey===o);return s||(s={cacheKey:o,version:r},this.storeCache.push(s)),s}get(t){var o;let r=f.toString(t);return(o=this.storeCache.find(s=>s.cacheKey===r))==null?void 0:o.httpFile}getAll(){let t=[];for(let r of this.storeCache)r.httpFile&&t.push(r.httpFile);return t}getOrCreate(t,r,o,s){let n=this.getFromStore(t,o);return o>n.version||!n.httpFile?(n.promise&&o<=n.version||(n.promise=r().then(i=>this.parse(t,i,s)).then(i=>{if(delete n.promise,n.httpFile)for(let a of i.httpRegions){let l=n.httpFile.httpRegions.find(d=>d.symbol.source===a.symbol.source);l&&Object.assign(a.variablesPerEnv,l.variablesPerEnv)}return n.version=o,n.httpFile=i,i}).catch(i=>{throw delete n.promise,n.httpFile&&this.remove(n.httpFile.fileName),i})),n.promise):n.promise||Promise.resolve(n.httpFile)}async parse(t,r,o){let s=await this.initHttpFile(t,o);return await zo(s,r,this)}remove(t){let r=f.toString(t),o=this.storeCache.findIndex(s=>s.cacheKey===r);return o>=0?(this.storeCache.splice(o,1),!0):!1}rename(t,r){let o=f.toString(t),s=this.storeCache.find(n=>n.cacheKey===o);s&&(s.cacheKey=f.toString(r),s.httpFile&&(s.httpFile.fileName=r))}clear(){this.storeCache.length=0}async initHttpFile(t,r){var l,d;let o=await N(t,r.workingDir)||t,s=await vt(o,r.workingDir,...zt)||await vt(o,r.workingDir,"package.json",((l=r.config)==null?void 0:l.envDirName)||"env")||r.workingDir,n=new qt(o,s);r.config=await tt(r.config,n);let i={...le,...this.plugins};s&&(Object.assign(i,await To(s)),(d=r.config)!=null&&d.configureHooks&&(i[".httpyac.js"]=r.config.configureHooks));let a=process.env.HTTPYAC_PLUGIN;if(a)try{let u=require(a);u.configureHooks&&(i.HTTPYAC_PLUGIN=u.configureHooks)}catch(u){h.warn("Global Hook Plugin not loaded",u)}return await this.configureHooks(n,r,i),n}async configureHooks(t,r,o){if(r.config){let s={version:"1.0.0",rootDir:t.rootDir,config:r.config,httpFile:t,hooks:t.hooks,log:h,fileProvider:f,sessionStore:S,userInteractionProvider:O,httpClientProvider:me,javascriptProvider:L,utils:R,getHookCancel:()=>Tn.HookCancel};for(let[n,i]of Object.entries(o))try{let a=i(s);Ze(a)&&await a}catch(a){h.error(`error in ${n}`,a)}}}};var Pr=class{constructor(){this.userSessions=[];this.sessionChangedListener=[]}onSessionChanged(t){return this.sessionChangedListener.push(t),()=>{let r=this.sessionChangedListener.indexOf(t);r>=0&&this.sessionChangedListener.splice(r,1)}}async reset(){for(let t of this.userSessions)t.delete&&t.delete();this.userSessions.length=0,this.notifySessionChanged()}getUserSession(t){return this.userSessions.find(r=>r.id===t)}setUserSession(t){this.removeUserSession(t.id),this.userSessions.push(t),this.notifySessionChanged()}notifySessionChanged(){for(let t of this.sessionChangedListener)t()}removeUserSession(t){let r=this.userSessions.find(o=>o.id===t);r&&(this.userSessions.splice(this.userSessions.indexOf(r),1),r.delete&&r.delete(),this.notifySessionChanged())}isUserSession(t){let r=t;return r&&!!r.description&&!!r.id&&!!r.title&&!!r.type&&!!r.details}},S=new Pr;async function Ln(){let e=S.getUserSession("last_response");return e!=null&&e.response?{response:e.response}:{}}var En=T(require("lodash/cloneDeep"));var kr=class{constructor(){this.id="createRequest"}async beforeLoop(t){let[r]=t.args;return r.httpRegion.request&&(q(r,"init request"),r.request=(0,En.default)(r.httpRegion.request)),!0}};var qn=require("hookpoint");var Hd="variable",Hr=class{constructor(){this.id="variable"}async beforeLoop(t){let r=t.args[0];return r.options.lazyVariables=!0,!0}async beforeTrigger(t){var o;let r=t.args[0];return((o=t.hookItem)==null?void 0:o.id)!==Hd&&r.options.lazyVariables&&(await this.replaceAllVariables(r),delete r.options.lazyVariables),!0}async replaceAllVariables(t){for(let[r,o]of Object.entries(t.variables)){let s=await V(o,"Variable",t);s!==qn.HookCancel&&(t.variables[r]=s)}}};var Cr=class{constructor(){this.id="logResponse"}async afterLoop(t){let r=t.args[0],o;return r.httpRegion.response&&(o=ye(r.httpRegion.response),o.tags||(o.tags=[]),o.tags.push("httpRegion",r.isMainContext?"mainResponse":"refResponse"),delete r.httpRegion.response),await Ve(o,r),!0}};var Sr=class{constructor(){this.id="processedHttpRegion";this.emitted=new WeakSet}getResponseLoggingInterceptor(){return{id:this.id,afterLoop:this.afterResponseLoggingLoop.bind(this)}}async beforeLoop(t){let[r]=t.args;if(r.processedHttpRegions){let o=this.toProcessedHttpRegion(r);r.processedHttpRegions.push(o)}return!0}async onError(t,r){return this.updateProcessedHttpRegionAfterLoop(r.args[0]),this.emitProcessedHttpRegion(r.args[0]),!0}async afterLoop(t){return this.updateProcessedHttpRegionAfterLoop(t.args[0]),this.emitProcessedHttpRegion(t.args[0]),!0}updateProcessedHttpRegionAfterLoop(t){var o,s,n;let r=(s=(o=t.processedHttpRegions)==null?void 0:o.slice().reverse())==null?void 0:s.find(i=>i.id===t.httpRegion.id);r&&(r.end=performance.now(),r.duration=r.end-r.start,r.metaData={...t.httpRegion.metaData},r.testResults=t.httpRegion.testResults,r.response=t.httpRegion.response||r.response,r.request=((n=t.httpRegion.response)==null?void 0:n.request)||r.request)}async afterResponseLoggingLoop(t){var n;let[r,o]=t.args,s=(n=o.processedHttpRegions)==null?void 0:n.find(i=>i.id===o.httpRegion.id);return s&&(s.request=r.request,s.response=r),this.updateProcessedHttpRegionAfterLoop(o),this.emitProcessedHttpRegion(o),!0}toProcessedHttpRegion(t){return{id:t.httpRegion.id,filename:t.httpFile.fileName,symbol:t.httpRegion.symbol,isGlobal:t.httpRegion.isGlobal(),testResults:t.httpRegion.testResults,start:performance.now()}}emitProcessedHttpRegion(t){var o;if(!t.processedHttpRegionListener)return;let r=(o=t.processedHttpRegions)==null?void 0:o.find(s=>s.id===t.httpRegion.id);r&&!this.emitted.has(r)&&r.duration!==void 0&&(this.emitted.add(r),t.processedHttpRegionListener(r))}};var Tr=class{constructor(){this.id="regionScopedVariables"}async beforeLoop(t){var s;let r=t.args[0],o=M(r.activeEnvironment);if((s=r.config)!=null&&s.useRegionScopedVariables){let n=r.options;n.variables=r.variables,r.variables=Object.assign({},r.variables,...r.httpFile.globalHttpRegions.map(i=>i.variablesPerEnv[o]))}else r.variables=Object.assign(r.variables,...r.httpFile.httpRegions.map(n=>n.variablesPerEnv[o]));return!0}async afterLoop(t){var o;let r=t.args[0];if((o=r.config)!=null&&o.useRegionScopedVariables){let s=r.options;if(s.variables){let n=r.variables;r.variables=s.variables,this.autoShareNewVariables(n,r)}}return!0}autoShareNewVariables(t,r){for(let[o,s]of Object.entries(t))r.variables[o]||(r.variables[o]=s)}};function On(e,t,r){return e==="disabled"?(t?typeof t=="string"&&r.httpRegion.hooks.execute.addHook("disabled",async o=>{let s=await L.evalExpression(t,o);return s&&ne(o.httpRegion),!s}):r.httpRegion.hooks.execute.addInterceptor({id:"disabled",async beforeLoop(o){o.bail=!0;let{httpRegion:s}=o.args[0];return ne(s),!0}}),!0):!1}function $n(e,t,r){return e==="forceRegionDelimiter"&&(r.forceRegionDelimiter=!0),!1}function An(e,t,r){return e==="import"&&t?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new Yo(t,r.httpFileStore)),!0):!1}var Yo=class{constructor(t,r){this.fileName=t;this.httpFileStore=r;this.id="import"}async process(t){return Lt(this.fileName,this.httpFileStore,t)}};function Dn(e,t,r){return e==="jwt"?(r.httpRegion.hooks.onResponse.addHook("jwt",async o=>{let s=o.parsedBody||o.body;if(s&&typeof s=="object"){let n=Object.entries(s),i=n;t&&(i=n.filter(([d])=>t.indexOf(d)>=0));for(let[d,u]of i){let p=Sd(u);p&&n.push([`${d}_parsed`,p])}let a=Object.fromEntries(n),l=j(a,2);o.body=l,o.prettyPrintBody=l,o.parsedBody=a}}),!0):!1}function Sd(e){return g(e)?fo(e):null}var Fn=require("uuid");function In(e,t,r){if(e==="keepStreaming"){let o=`keep_streaming_${(0,Fn.v4)()}`;return r.httpRegion.hooks.onStreaming.addHook("keepStreaming",async s=>{s.request&&(q(s,"stream until manual cancellation"),await new Promise(n=>{s.requestClient&&s.requestClient.addEventListener("disconnect",()=>n(!0))}))}),r.httpRegion.hooks.onResponse.addHook("keepStreaming",()=>{S.removeUserSession(o)}),!0}return!1}var jn=require("hookpoint"),Mn=require("uuid");function Vn(e,t,r){var o,s,n,i;if(e==="loop"&&t){let a=/^\s*for\s+(?<variable>.*)\s+of\s+(?<iterable>.*)\s*/u.exec(t);if((o=a==null?void 0:a.groups)!=null&&o.iterable&&((s=a==null?void 0:a.groups)!=null&&s.variable))return Qo(r,{type:1,variable:a.groups.variable,iterable:a.groups.iterable}),!0;let l=/^\s*for\s*(?<counter>\d*)\s*$/u.exec(t);if((n=l==null?void 0:l.groups)!=null&&n.counter)return Qo(r,{type:0,counter:Number.parseInt(l.groups.counter,10)}),!0;let d=/^\s*while\s*(?<expression>.*)\s*$/u.exec(t);if((i=d==null?void 0:d.groups)!=null&&i.expression)return Qo(r,{type:2,expression:d.groups.expression}),!0}return!1}function Qo(e,t){let r=new Zo(t);e.httpRegion.hooks.execute.addInterceptor(r),e.httpRegion.hooks.execute.addObjHook(o=>o.process,r)}var Zo=class{constructor(t){this.data=t;this.isInLoop=!1;this.id=`loop_${(0,Mn.v4)()}`}async beforeLoop(t){return this.hook=t.hook,this.isInLoop&&(t.index=t.hook.items.findIndex(r=>r.id===this.id)),!0}async process(t){if(this.hook&&!this.isInLoop){let r=[];try{this.isInLoop=!0;let o=this.iterate(t),s=await o.next();for(;!s.done;){q(t,`${s.value.index+1} loop pass`);let n={...t,httpRegion:this.createHttpRegionClone(t.httpRegion,s.value.index),variables:Object.assign(t.variables,s.value.variables)};if(await this.hook.trigger(n)===jn.HookCancel)return!1;r.push(n.variables.response),s=await o.next()}t.httpRegion.metaData.name&&r.length>0&&F({[`${t.httpRegion.metaData.name}`]:r[0],[`${t.httpRegion.metaData.name}List`]:r},t)}finally{this.isInLoop=!1}}return!0}async afterTrigger(t){var r;return!this.isInLoop&&((r=t.hookItem)==null?void 0:r.id)===this.id&&(t.bail=!0),!0}async*iterate(t){switch(this.data.type){case 1:yield*this.iterateForOfLoop(t);break;case 0:yield*this.iterateForLoop();break;case 2:yield*this.iterateWhileLoop(t);break;default:break}}async*iterateForOfLoop(t){if(this.data.variable&&this.data.iterable){let r=await L.evalExpression(this.data.iterable,t),o;if(Array.isArray(r)&&(o=r),o){let s=0;for(let n of o){let i={$index:s};i[this.data.variable]=n,yield{index:s,variables:i},s++}}}}async*iterateWhileLoop(t){if(this.data.expression){let r=0;for(;await L.evalExpression(this.data.expression,t);)yield{index:r,variables:{$index:r}},r++}}*iterateForLoop(){if(this.data.counter)for(let t=0;t<this.data.counter;t++)yield{index:t,variables:{$index:t}}}createHttpRegionClone(t,r){let o=t.clone();return o.metaData.name=t.metaData.name?`${t.metaData.name}${r}`:void 0,o}};function Bn(e,t,r){return e==="noRedirect"?(r.httpRegion.hooks.onRequest.addHook("noRedirect",async o=>{o.noRedirect=!0}),!0):!1}function Nn(e,t,r){return e==="noRejectUnauthorized"?(r.httpRegion.hooks.onRequest.addHook("noRejectUnauthorized",async o=>{o.noRejectUnauthorized=!0}),!0):!1}function Un(e,t,r){if(e==="note"){let o=t||`Are you sure you want to send the request ${kt(r.httpRegion)}?`;return r.httpRegion.hooks.execute.addInterceptor({id:"note",beforeLoop:()=>O.showNote(o)}),!0}return!1}function _n(e,t,r){return e==="proxy"?(r.httpRegion.hooks.onRequest.addHook("proxy",async o=>{o.proxy=t}),!0):!1}function Gn(e,t,{httpRegion:r}){if(e==="ratelimit"&&t){let o=/^\s*(slot(:)?\s*(?<slot>[^\s]+))?\s*(minIdleTime(:)?\s*(?<minIdleTime>\d*))?\s*(max(:)?\s*(?<max>\d*))\s*(expire(:)?\s*(?<expire>\d*))?\s*$/iu.exec(t);if(o!=null&&o.groups){let s=o.groups.slot||"rateLimit",n=o.groups.minIdleTime||"0",i=o.groups.max||"0",a=o.groups.expire||"0";r.hooks.execute.addHook("rateLimit",async l=>{let d=Ed(s,Number.parseInt(n,10),Number.parseInt(i,10),Number.parseInt(a,10));return d.requests.push(await Td(d,l)),!0})}}return!1}async function Td(e,t){for(;e.requests.length>0;){let r=new Date;if(qd(e.requests,r,e.expire),e.max>0&&e.requests.length>=e.max){let o=e.requests[0],s=e.expire+o.getTime()-r.getTime();s>0&&(q(t,`rate limit max reached. wait for ${s}`),h.debug(`rate limit max reached. wait for ${s} (slot ${e.slot})`),await Ce(s),h.debug("rate limit max waited"));continue}if(e.requests.length>0){let o=e.requests[e.requests.length-1];if(o&&e.minIdleTime>0){let s=o.getTime()+e.minIdleTime-r.getTime();if(s>0){q(t,`rate limit minIdleTime, wait for ${s}`),h.debug(`rate limit minIdleTime, wait for ${s} (slot ${e.slot})`),await Ce(s),h.debug("rate limit minIdleTime waited");continue}}}return r}return new Date}function Ld(e){let t=e;return!!(t!=null&&t.requests)&&t.type==="RateLimit"}function Ed(e,t,r,o){let s=`ratelimit_${e}`,n=S.getUserSession(s);if(Ld(n))return n.max=r,n.minIdleTime=t,n.expire=o,n;let i=[];t>0&&i.push(`minIdleTime ${t}ms`),o>0&&i.push(`max ${r} with expire ${o}ms`);let a={id:s,type:"RateLimit",title:`rate limit slot ${e}`,details:{slot:e,minIdleTime:t,max:r,expire:o},description:i.join(", "),slot:e,minIdleTime:t,max:r,expire:o,requests:[]};return S.setUserSession(a),a}function qd(e,t,r){if(r>0){let o=0;for(let s of e)if(t.getTime()-s.getTime()>=r)o++;else break;e.splice(0,o)}else e.splice(0,e.length-1)}var Kn=20,Lr=[],Er=0,Wn=500;function Jn(e,t,r){return["ref","forceRef"].indexOf(e)>=0&&t?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new es({name:t,force:e==="forceRef"})),!0):!1}var es=class{constructor(t){this.data=t;this.id="ref"}async process(t){var s,n,i;if(((s=t.options)==null?void 0:s.skipRefResolution)===!0){let a=await V(this.data.name,this.id,t);if(typeof a!="string"||!a)return!0;let l=Be(a,t);if(l&&((n=t.processedHttpRegions)!=null&&n.some(d=>d.id===l.id))){let d=M(t.activeEnvironment);F(l.variablesPerEnv[d],t)}return!0}let r=await V(this.data.name,this.id,t);if(typeof r!="string"||!r)throw h.error(`ref ${this.data.name} not resolvable to a valid name: ${this.data.name} -> ${r}`),new Error(`ref ${this.data.name} not resolvable to a valid name: ${this.data.name} -> ${r}`);Er++;let o=`${t.httpRegion.id}:${r}`;if(Er>Wn)throw h.error(`Total reference calls (${Er}) exceeded limit (${Wn})`),new Error(`Too many reference calls (${Er}) - possible infinite loop or runaway forceRef`);if(Lr.length>=Kn){let a=Lr.slice(-10).join(" -> ");throw h.error(`Reference depth limit (${Kn}) exceeded. Recent refs: ${a}`),new Error(`Reference depth limit exceeded - possible infinite loop. Recent: ${a}`)}Lr.push(o);try{let a=!0;q(t,`load reference ${r}`);let l=Be(r,t);if(l){if(this.isReferenceErroredOrSkipped(l))return ne(t.httpRegion),!1;let d=M(t.activeEnvironment);F(l.variablesPerEnv[d],t),h.trace("import variables",l.variablesPerEnv[d]);let u=Xe(t.variables[r])&&!((i=t.processedHttpRegions)!=null&&i.some(p=>p.id===l.id));(this.data.force||u)&&(a=await l.execute(t),a&&F(l.variablesPerEnv[d],t))}else throw h.error(`ref ${r} not found`),new Error(`ref ${r} not found`);return a}finally{Lr.pop()}}isReferenceErroredOrSkipped(t){var r;return!!((r=t.testResults)!=null&&r.some(o=>o.status==="ERROR"||o.status==="SKIPPED"))}};function zn(e,t,r){return e==="responseRef"&&t&&(r.httpRegion.responseRefs||(r.httpRegion.responseRefs=[]),r.httpRegion.responseRefs.push(t)),!1}function Xn(e,t,r){return e==="sleep"&&t?(r.httpRegion.hooks.execute.addHook("sleep",async o=>{let s=await L.evalExpression(t,o);return Number.isSafeInteger(s)&&(await q(o,`Sleep for ${s}ms`),await Ce(s)),!0}),!0):!1}function Yn(e,t,r){let o=C(t);return e==="timeout"&&o!==void 0?(r.httpRegion.hooks.onRequest.addHook("timeout",async s=>{s.timeout=o}),!0):!1}function Qn(e,t,r){if(e==="verbose"||e==="debug"){let o=e==="debug"?2:1;return h.options.level=o,r.httpRegion.hooks.execute.addInterceptor({id:"verbose",async beforeLoop(){return h.options.level=o,!0}}),!0}return!1}async function Zn(e,{httpRegion:t}){let r=e(!0),o=$d(r);return o?(t.metaData.description||(t.metaData.description=o.comment),{nextParserLine:o.endLine,symbols:[new P({name:"comment",description:o.comment,kind:"comment",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset})]}):!1}function $d(e){var r;let t=e.next();if(!t.done){let o=t.value.line,s=/^\s*\/\/\s*(?<comment>.*)\s*$/u.exec(t.value.textLine);if((r=s==null?void 0:s.groups)!=null&&r.comment)return{startLine:o,endLine:o,endOffset:t.value.textLine.length,comment:s.groups.comment};if(/^\s*\/\*$/u.exec(t.value.textLine)){t=e.next();let i=[];for(;!t.done;){if(/^\s*\*\/\s*$/u.test(t.value.textLine))return{startLine:o,endLine:t.value.line,endOffset:t.value.textLine.length,comment:G(i)};i.push(t.value.textLine),t=e.next()}}}return!1}var ei=/^\s*(#+|\/{2})/u;async function ti(e,t){var i,a;let r=e(),{httpRegion:o,data:s}=t;s.metaTitle&&(o.metaData.title=s.metaTitle.trim(),o.metaData.name||(o.metaData.name=s.metaTitle.trim()),delete s.metaTitle);let n=r.next();if(!n.done){let l=n.value.textLine;if(ei.test(l)){if(Ad(t)&&l.trim()!=="###")return h.debug("request with markdown only supports delimiter after request line"),!1;let d={nextParserLine:n.value.line,symbols:[]},u=Re.exec(l);if(u)d.endRegionLine=n.value.line-1,d.symbols.push(new P({name:"separator",description:((i=u.groups)==null?void 0:i.title)||"-",kind:"metaData",startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:l.length})),s.metaTitle=(a=u.groups)==null?void 0:a.title;else{let p=await St(n.value,t,ei);p&&(d.symbols=p.symbols)}return d}}return!1}function Ad(e){var t;if((t=e.httpRegion.request)!=null&&t.headers){let r=Fe(e.httpRegion.request.headers);if(xt(r))return!0}return!1}async function ri(e,t){var o,s,n;let r=e();if(t.httpRegion.request){let i=ts(t),a=r.next();if(!a.done&&(i.rawBody.length>0||!Ae(a.value.textLine))){let l=[];!i.symbol||i.symbol.endLine!==a.value.line-1?(i.symbol=new P({name:"request body",description:"request body",kind:"requestBody",startLine:a.value.line,startOffset:0,endLine:a.value.line,endOffset:a.value.textLine.length,children:pe(a.value.textLine,a.value.line)}),l.push(i.symbol)):(i.symbol.endLine=a.value.line,i.symbol.endOffset=a.value.textLine.length,(s=(o=i.symbol.children)==null?void 0:o.push)==null||s.call(o,...pe(a.value.textLine,a.value.line)));let d=Tt(a.value.textLine);return d?(i.rawBody.push(d),(n=i.symbol.children)==null||n.push(new P({name:"filename",description:d.fileName,kind:"path",startLine:a.value.line,startOffset:a.value.textLine.indexOf(d.fileName),endLine:a.value.line,endOffset:a.value.textLine.indexOf(d.fileName)+d.fileName.length}))):i.rawBody.push(a.value.textLine),{nextParserLine:a.value.line,symbols:l}}}return!1}function ts(e){let t=e.data.request_body;return t||(t={rawBody:[]},e.data.request_body=t),t}var qr=class{get id(){return"multipart/mixed"}async beforeLoop(t){var o;let r=t.args[1];if(r.httpRegion.request&&uo(r.httpRegion.request.contentType)){if(r.forceRegionDelimiter===void 0)r.forceRegionDelimiter=!0;else if(r.forceRegionDelimiter){let s=((o=r.httpRegion.request.contentType)==null?void 0:o.boundary)||"",n=ts(r).rawBody.slice().pop();g(n)&&n.includes(`--${s}--`)&&(r.forceRegionDelimiter=!1)}}return!0}};async function oi(e,{httpRegion:t}){var s;let o=e().next();if(!o.done){let n=o.value.textLine,i=/^\s*>>(?<force>!)?\s+(?<fileName>.+)\s*$/u.exec(n);if(i&&((s=i.groups)!=null&&s.fileName)){let a=i.groups.fileName.trim(),l=!!i.groups.force;return t.hooks.onResponse.addHook("outputRedirection",async(d,u)=>{try{if(d.rawBody){let p=w(await V(a,"Variable",u));if(p){let c=await Dd(p,l,u.httpFile.fileName);c?await f.writeBuffer(c,d.rawBody):h.debug(`file ${a} not found`)}else h.debug(`file ${a} not found`)}}catch(p){h.error(`output redirection failed for ${a}`,p)}}),{nextParserLine:o.value.line,symbols:[new P({name:"outputredirection",description:i.groups.filename,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new P({name:"filename",description:a,kind:"path",startLine:o.value.line,startOffset:o.value.textLine.indexOf(a),endLine:o.value.line,endOffset:o.value.textLine.indexOf(a)+a.length})]})]}}}return!1}async function Dd(e,t,r){let o=await rs(e,r);if(!t&&await f.exists(o)){let s=e.lastIndexOf(".");if(s>0&&s<e.length-2){let n=e.slice(0,s),i=e.slice(s+1),a=1;for(o=await rs(`${n}-${a}.${i}`,r);await f.exists(o);)o=await rs(`${n}-${a++}.${i}`,r)}}return o}async function rs(e,t){if(!await f.isAbsolute(e)){let r=f.dirname(t);if(r)return f.joinPath(r,e)}return e}var si=Bo({protocol:"HTTP",methodRegex:/^\s*(?<method>GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS|CONNECT|TRACE|PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|CHECKOUT|CHECKIN|REPORT|MERGE|MKACTIVITY|MKWORKSPACE|VERSION-CONTROL|BASELINE-CONTROL|MKCALENDAR|ACL|SEARCH|GRAPHQL)\s+(?<url>.+?)$/u,protocolRegex:/^\s*(?<url>.+)\s*$/iu,requestClientFactory(e,t){if(me.createRequestClient)return me.createRequestClient(e,t);throw new Error("Missing Http Client Provider")},modifyRequest(e){e.method==="HTTP"&&(e.method="GET"),D(e)&&Fd(e)},sessionStore:S});function Fd(e){var t;if(e.url){let r=/(?<url>.*)\s+HTTP\/(?<version>(\S+))/u.exec(e.url);(t=r==null?void 0:r.groups)!=null&&t.version&&r.groups.url&&(e.url=r.groups.url.trim(),["1.1","1.0"].indexOf(r.groups.version)<0&&(e.options||(e.options={}),e.options.http2=!0))}}async function ni(e,t){return Vo(e,t,/^\s*HTTP\/(?<httpVersion>\S+)\s*(?<statusCode>[1-5][0-9][0-9])\s*(-)?\s*(?<statusMessage>.*)$/u)}async function ii(e,{httpRegion:t}){var s;let o=e().next();if(!o.done){let n=o.value.textLine,i=/^\s*<>\s*(?<fileName>.+?)\s*$/u.exec(n);if(i&&((s=i.groups)!=null&&s.fileName)){t.responseRefs||(t.responseRefs=[]);let a=i.groups.fileName;return t.responseRefs.push(a),{nextParserLine:o.value.line,symbols:[new P({name:"responseRef",description:i.groups.filename,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new P({name:"filename",description:a,kind:"path",startLine:o.value.line,startOffset:n.indexOf(a),endLine:o.value.line,endOffset:n.indexOf(a)+a.length})]})]}}}return!1}async function ai(e,{httpRegion:t}){let o=e().next();if(!o.done){let s=o.value.textLine,n=/^\s*@(?<useGlobal>global\.)?(?<key>[^\s=:]*)\s*(?<lazyIndicator>:?)=*\s*"?(?<value>.*)"?\s*$/u.exec(s);if(n&&n.groups&&n.groups.key&&n.groups.value){let i=n.groups.key,a=!!n.groups.lazyIndicator,l=!!n.groups.useGlobal,d=n.groups.value;return t.hooks.execute.addHook(`variable_${i}`,async u=>{let p=d;a?u.options.lazyVariables=!0:p=await V(d,"Variable",u);let c=u.variables.$global;return l&&c&&typeof c=="object"?Object.assign(c,{[i]:p}):F({[i]:p},u),!0}),{nextParserLine:o.value.line,symbols:[new P({name:n.groups.key,description:n.groups.value,kind:"variableDefinition",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new P({name:n.groups.key,description:"key",kind:"key",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.key),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.key)+n.groups.key.length}),new P({name:n.groups.value,description:"value",kind:"value",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.value),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.value)+n.groups.value.length})]})]}}}return!1}function li(e){e.httpRegion.hooks.execute.addInterceptor({id:"cancel",beforeLoop:async function(r){var s,n;return(n=(s=r.args[0].progress)==null?void 0:s.isCanceled)!=null&&n.call(s)?(h.debug("process canceled by user"),!1):!0}})}async function di(e,t){var r;if(e&&((r=t.config)!=null&&r.defaultHeaders)){q(t,"set default request headers");let o=t.config.defaultHeaders;if(!e.headers)e.headers={...o};else for(let[s,n]of Object.entries(o))$(e.headers,s)||(e.headers[s]=n)}}var ui=T(require("encodeurl"));async function pi(e){e.body&&g(e.body)&&De(e.contentType)&&(e.body=(0,ui.default)(e.body))}var ci={id:"excludeProxy",afterLoop:async function(t){var s,n;let[r,o]=t.args;return r.proxy||(r.proxy=(s=o.config)==null?void 0:s.proxy),r.proxy&&(o.httpRegion.metaData.noProxy||(n=o.config)!=null&&n.proxyExcludeList&&o.config.proxyExcludeList.some(i=>r.url.startsWith(i)))&&delete r.proxy,!0}};var fi={id:"isTrusted",afterLoop:async function(t){if(!O.isTrusted()){let[r]=t.args;return await O.showNote(`Is call to ${r.method} ${r.url} allowed, because workspace is not trusted.`)}return!0}};var xe=require("hookpoint");async function mi(e,t){if(q(t,"replace variables in request"),e.url){let r=await V(e.url,"Url",t)||e.url;if(r===xe.HookCancel)return xe.HookCancel;g(r)&&(e.url=r)}if(await os(e,t)===!1)return xe.HookCancel;if(await jd(e,t)===!1)return xe.HookCancel}async function os(e,t){if(e.body){if(g(e.body)){let r=await V(e.body,"Body",t);if(r===xe.HookCancel)return!1;g(r)||Buffer.isBuffer(r)?e.body=r:e.body=w(r)}else if(Array.isArray(e.body)){let r=[];for(let o of e.body)if(g(o)){let s=await V(o,"Body",t);if(s===xe.HookCancel)return!1;g(s)&&r.push(s)}else r.push(o);e.body=r}}return!0}async function jd(e,t){if(e.headers)for(let[r,o]of Object.entries(e.headers))if(Array.isArray(o)){let s=[];for(let n of o){let i=await V(n,r,t);if(i===xe.HookCancel)return!1;s.push(i)}e.headers[r]=s}else{let s=await V(o,r,t);if(s===xe.HookCancel)return!1;e.headers[r]=s}return!0}async function gi(e,t){if(e.body&&Array.isArray(e.body)){let r=[];for(let o of e.body)if(g(o))r.push(o);else if(Buffer.isBuffer(o))r.push(o);else{let s=await o(t);s&&r.push(s)}e.body=r}}async function hi(e){if(e){let t={Accept:"*/*","User-Agent":"httpyac"};if(!e.headers)e.headers=t;else for(let[r,o]of Object.entries(t))$(e.headers,r)||(e.headers[r]=o)}}async function yi(e,{variables:t}){Md(e,t),Vd(e,t),Bd(e,t),Ud(e,t),Nd(e)}function Md(e,t){e&&t&&typeof t.request_rejectUnauthorized<"u"&&(e.noRejectUnauthorized=!we(t.request_rejectUnauthorized))}function Vd(e,t){e&&t&&typeof t.request_noRedirect<"u"&&(e.noRedirect=we(t.request_noRedirect))}function Bd(e,t){g(t==null?void 0:t.request_proxy)&&(e.proxy=t.request_proxy)}function Nd(e){if(e.proxy||!D(e))return;let t=process.env.https_proxy||process.env.HTTPS_PROXY,r=process.env.http_proxy||process.env.HTTP_PROXY;e.url.toLowerCase().startsWith("https")&&g(t)?e.proxy=t:g(r)&&(e.proxy=process.env.httpProxy)}function Ud(e,t){let r=C(t==null?void 0:t.request_timeout);r!==void 0&&(e.timeout=r)}async function bi(e,t){e.body&&(e.body=await ss(e.body,t))}async function ss(e,t){return g(e)||Buffer.isBuffer(e)?e:await _d(e,t)}async function _d(e,t){let r=[];for(let o of e)if(g(o))r.push(o);else if(Buffer.isBuffer(o))r.push(o);else{let s=await o(t);s&&r.push(s)}return r.some(o=>Buffer.isBuffer(o))?Buffer.concat(r.map(o=>Buffer.isBuffer(o)?o:Buffer.from(o))):r.join("")}async function Ri(e){if(e.body&&g(e.body)&&De(e.contentType)){let t=se(e.body);if(t.length>0){let r=[],o=["=","&"];for(let s of t)r.push(o.reduce((n,i)=>n.split(i).map(a=>a.trim()).join(i),s));e.body=r.join("")}}}async function wi(e){var r;let t=Wd(e);if(e.httpRegion.request&&t){let o=e.httpRegion.request;zd(t.rawBody);let s=await Xd(t.rawBody);if(s.length>0){let n=Qd(s,o.contentType);n.length>0&&!n[0].wait&&(o.body=(r=n.shift())==null?void 0:r.body),n.length>0&&eu(n,e)}}}function xi(e,t){return De(t)?Yd(e):(Jd(e,t),Kd(e,t))}function Kd(e,t){let r=[],o=[],s=lo(t)?`\r
`:f.EOL;for(let n of e)g(n)?o.push(n):(o.length>0&&(o.push(""),r.push(o.join(s)),o.length=0),r.push(n),o.push(""));return o.length>0&&r.length===0?o.join(s):(o.length>0&&r.push(o.join(s)),r)}function Wd(e){let t=e.data.request_body;return t&&delete e.data.request_body,t}function Jd(e,t){e.every(r=>g(r))&&po(t)&&e.push("")}function zd(e){for(;e.length>0&&Ae(e[e.length-1]);)e.pop();if(e.length>0){let t=e[e.length-1];g(t)&&/\s*<--->\s*/u.test(t)&&e.pop()}}async function Xd(e){let t=[];for(let r of e)if(g(r))t.push(r);else{let{injectVariables:o,fileName:s}=r,n=(i,a)=>{var l;if(a.httpRegion.metaData.injectVariables)return!0;if((l=a.config)!=null&&l.requestBodyInjectVariablesExtensions){let d=Ho(i);if(d)return a.config.requestBodyInjectVariablesExtensions.indexOf(d)>=0}return!1};t.push(async i=>await be(s,i,async a=>o||n(r.fileName,i)?await f.readFile(a,r.encoding):f.readBuffer(a)))}return t}function Yd(e){let t=e.reduce((r,o,s)=>{let n=r;return g(o)&&(n+=`${s===0||o.startsWith("&")?"":f.EOL}${o}`),n},"");return g(t)?t:""}function Qd(e,t){let r=[],o=[],s=!1;for(let n of e){let i=Zd(n);i?(o.push({wait:s,body:xi(r,t)}),s=i.waitForServer,r.length=0):r.push(n)}return r.length>0&&o.push({wait:s,body:xi(r,t)}),o}function Zd(e){var t;if(g(e)){let r=/\s*={3}\s*(?<wait>wait-for-server)?\s*$/u.exec(e);if(r)return{waitForServer:!!((t=r==null?void 0:r.groups)!=null&&t.wait)}}}function eu(e,t){t.httpRegion.hooks.onStreaming.addHook("streaming_body",async r=>{if(r.requestClient)return new Promise(o=>{tu(e,r,o)})})}async function tu(e,t,r){var s;let o=0;for(let n of e){let i=e.indexOf(n)===e.length-1;if(n.wait&&o++,o===0)await vi(n,t),i&&r();else{let a=0,l=o;(s=t.requestClient)==null||s.addEventListener("message",async()=>{++a===l&&(await vi(n,t),i&&r())})}}}async function vi(e,t){var r;if(await os(e,t),e.body){let o=await ss(e.body,t);o&&await((r=t.requestClient)==null?void 0:r.send(o))}}async function Pi(e){if(e.data.httpResponseSymbol){if(e.httpRegion.response&&e.data.httpResponseSymbol.body.length>0){let t=e.httpRegion.response,r=G(e.data.httpResponseSymbol.body);t.body=r,t.rawBody=Buffer.from(r),t.headers&&(t.contentType=Fe(t.headers));let o=e.data.httpResponseSymbol.symbol;if(o.children){let s=e.data.httpResponseSymbol.body.at(-1);o.children.push(new P({name:"response body",description:"response body",kind:"response",startLine:o.endLine-e.data.httpResponseSymbol.body.length+1,startOffset:0,endLine:o.endLine,endOffset:(s==null?void 0:s.length)||0}))}}delete e.data.httpResponseSymbol}}async function ki(e){let{httpRegion:t,httpFile:r}=e,{metaData:o}=t;ru(o),ou(t,r)}function ru(e){let t=e.name;if(typeof t!="string")return;let r=ns(e);for(let o of r)if(o===t){let s=`Self-reference detected: region named "${t}" has @ref/@forceRef to itself. This causes an infinite loop. Check for missing ### separator between requests.`;throw h.error(s),new Error(s)}}function ou(e,t){let r=e.metaData.name;if(typeof r!="string")return;let o=ns(e.metaData);if(o.length===0)return;let s=new Map;for(let d of t.httpRegions){let u=d.metaData.name;typeof u=="string"&&s.set(u,ns(d.metaData))}s.set(r,o);let n=new Set,i=[];function a(d){if(i.includes(d)){let p=i.indexOf(d);return[...i.slice(p),d]}if(n.has(d))return null;n.add(d),i.push(d);let u=s.get(d);if(u)for(let p of u){let c=a(p);if(c)return c}return i.pop(),null}let l=a(r);if(l){let u=`Circular reference detected: ${l.join(" -> ")}. This will cause an infinite loop at runtime.`;throw h.error(u),new Error(u)}}function ns(e){let t=[];return typeof e.ref=="string"&&t.push(...e.ref.split(/\s*,\s*/)),typeof e.forceRef=="string"&&t.push(...e.forceRef.split(/\s*,\s*/)),t}var Hi={id:"escapeVariable",afterLoop:async function(t){let[r]=t.args;if(g(r)){let o=/(?:\\\{){2}([^}]+?)(?:\\\}){2}/gu,s,n=r;for(;g(n)&&(s=o.exec(r))!==null;){let[i,a]=s;n=n.replace(i,()=>`{{${a}}}`)}n!==r&&t.results.push(n)}return!0}};async function Ci(e,t,r){return U(e,async o=>{let s=Tt(o);if(s){let n=await be(s.fileName,r,async i=>s.injectVariables||s.encoding?await f.readFile(i,s.encoding):f.readBuffer(i));return s.injectVariables&&(n=await V(n,t,r)),n}})}async function Si(e,t,{variables:r,request:o}){if(g(e)&&"Url"===t&&e.startsWith("/")){let s=$(o==null?void 0:o.headers,"Host");if(g(s)){let[,n]=s.toString().split(":");return`${n==="443"||n==="8443"?"https":"http"}://${s}${e}`}if(r.host)return`${r.host}${e}`}return e}async function Ti(e,t,r){return U(e,async o=>r.variables[o])}var ot=T(require("dayjs")),is=T(require("dayjs/plugin/utc")),Li=require("uuid");ot.default.extend(is.default);async function Ei(e,t,{variables:r}){return U(e,async o=>{var n,i,a,l,d,u,p,c,m,y,v,H;let s=o.trim();if(s==="$guid")return(0,Li.v4)();if(s.startsWith("$randomInt")){let x=/^\$randomInt\s*(?<min>-?\d+)?\s*(?<max>-?\d+)?\s*$/u.exec(s);if(x&&((n=x.groups)!=null&&n.min)&&((i=x.groups)!=null&&i.max)){let b=C((a=x.groups)==null?void 0:a.min)??0,k=C((l=x.groups)==null?void 0:l.max)??100;if(!Number.isNaN(b)&&!Number.isNaN(k)){if(b>k){let X=k;k=b,b=X}return`${Math.floor(Math.random()*(k-b))+b}`}}}else if(s.startsWith("$timestamp")){let x=/^\$timestamp(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if(x){ot.default.extend(is.default);let b=ot.default.utc();return(d=x.groups)!=null&&d.offset&&((u=x.groups)!=null&&u.option)&&(b=b.add(Number(x.groups.offset),x.groups.option)),`${b.unix()}`}}else if(s.startsWith("$datetime")){let x=/^\$datetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if((p=x==null?void 0:x.groups)!=null&&p.type){let b=ot.default.utc();return(c=x.groups)!=null&&c.offset&&((m=x.groups)!=null&&m.option)&&(b=b.add(Number(x.groups.offset),x.groups.option)),x.groups.type==="rfc1123"?b.toDate().toUTCString():x.groups.type==="iso8601"?b.toISOString():b.format(x.groups.type.slice(1,x.groups.type.length-1))}}else if(s.startsWith("$localDatetime")){let x=/^\$localDatetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if((y=x==null?void 0:x.groups)!=null&&y.type){let b=ot.default.utc().local();return(v=x.groups)!=null&&v.offset&&((H=x.groups)!=null&&H.option)&&(b=b.add(Number(x.groups.offset),x.groups.option)),x.groups.type==="rfc1123"?b.locale("en").format("ddd, DD MMM YYYY HH:mm:ss ZZ"):x.groups.type==="iso8601"?b.format():b.format(x.groups.type.slice(1,x.groups.type.length-1))}}else{if(s.startsWith("$processEnv"))return process.env[s.slice(11).trim()]||"";if(s.startsWith("$dotenv"))return r[s.slice(7).trim()]||""}})}var qi=require("hookpoint");async function Oi(e,t,{variables:r}){return U(e,async o=>{var i;let n=/^\$(?<type>(prompt|input|password))(?<askonce>-askonce)?\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))?\s*$/u.exec(o);if((i=n==null?void 0:n.groups)!=null&&i.placeholder){let a=n.groups.placeholder.trim(),l=n.groups.type,d=`input_${a}`,u=S.getUserSession(d);if(n.groups.askonce){if((r==null?void 0:r[a])!==void 0)return r[a];if(u!=null&&u.answer)return u.answer}let p=l==="password",c=await O.showInputPrompt(a,(u==null?void 0:u.answer)||n.groups.value,p);return c!==void 0?(S.setUserSession({id:d,title:p?a:`${a}=${c}`,description:`Cache for ${l}`,type:"input",details:{placeholder:a,inputType:l,answer:p?void 0:c},answer:c}),c):qi.HookCancel}})}var $i=require("hookpoint");async function Ai(e,t,r){return U(e,async o=>{var n,i;let s=/^\$pick(?<save>-askonce)?\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))\s*$/u.exec(o);if((n=s==null?void 0:s.groups)!=null&&n.placeholder&&((i=s==null?void 0:s.groups)!=null&&i.value)){let a=s.groups.placeholder.trim(),l=`input_${a}`,d=S.getUserSession(l);if(d!=null&&d.answer&&s.groups.save)return d.answer;let u=await nu(s.groups.value,r),p=await O.showListPrompt(a,u);return p!==void 0?(S.setUserSession({id:l,title:`${a}=${p}`,description:"Cache for $pick",type:"input",details:{placeholder:a,answer:p},answer:p}),p):$i.HookCancel}})}async function nu(e,t){let r=e.split(",");if(r.length===1)try{let o=await L.evalExpression(e,t);if(Array.isArray(o))return o}catch(o){h.trace("error in quickpick",o)}return r}function Di(e,t){let{httpRegion:r}=t;if(g(r.metaData.name)){let o=r.metaData.name.trim().replace(/\s/gu,"-").replace(/-./gu,s=>s[1].toUpperCase());F({[o]:e.parsedBody||e.body,[`${o}Response`]:e},t)}}var Fi={id:"jsonResponseBody",beforeLoop:async function(t){let[r]=t.args;if(r&&Rt(r.contentType)&&g(r.body)&&r.body.length>0)try{r.parsedBody||(r.parsedBody=JSON.parse(r.body)),r.prettyPrintBody||(r.prettyPrintBody=j(r.parsedBody,2))}catch(o){h.warn("json parse error",r.body,o)}return!0}};function Ii(e,t){let r=yo(e);S.setUserSession({id:"last_response",title:"last response",description:`response of ${t.httpRegion.symbol.name}`,details:{},type:"LAST_RESPONSE",response:r}),t.variables.response=e}function ji(e){lu(e),du(e),uu(e),mu(e),fu(e),pu(e),gu(e),cu(e)}function lu(e){e.hooks.onRequest.addHook("attachDefaultHeaders",di),e.hooks.onRequest.addHook("setEnvRequestOptions",yi),e.hooks.onRequest.addHook("resolveRequestBody",gi),e.hooks.onRequest.addHook("setDefaultHttpyacHeaders",hi),e.hooks.onRequest.addHook("requestVariableReplacer",mi),e.hooks.onRequest.addHook("transformRequestBody",bi),e.hooks.onRequest.addHook("transformMultilineFormUrlEncoded",Ri),e.hooks.onRequest.addHook("encodeRequestBody",pi),e.hooks.onRequest.addInterceptor(fi),e.hooks.onRequest.addInterceptor(ci)}function du(e){e.hooks.onResponse.addHook("handleMetaDataName",Di),e.hooks.onResponse.addHook("setLastResponseInVariables",Ii),e.hooks.onResponse.addInterceptor(Fi)}function uu(e){e.hooks.parse.addHook("meta",ti),e.hooks.parse.addHook("comment",Zn),e.hooks.parse.addHook("variable",ai),e.hooks.parse.addHook("request",si),e.hooks.parse.addHook("outputRedirection",oi),e.hooks.parse.addHook("responseRef",ii),e.hooks.parse.addHook("response",ni),e.hooks.parse.addHook("requestBody",ri),e.hooks.parse.addInterceptor(new qr)}function pu(e){e.hooks.parseEndRegion.addHook("registerCancelExecutionInterceptor",li),e.hooks.parseEndRegion.addHook("response",Pi),e.hooks.parseEndRegion.addHook("requestBody",wi),e.hooks.parseEndRegion.addHook("validateHttpRegion",ki)}function cu(e){e.hooks.replaceVariable.addHook("host",Si),e.hooks.replaceVariable.addHook("name",Ti),e.hooks.replaceVariable.addHook("file",Ci),e.hooks.replaceVariable.addHook("showInputBox",Oi),e.hooks.replaceVariable.addHook("showQuickPick",Ai),e.hooks.replaceVariable.addHook("restClientDynamic",Ei),e.hooks.replaceVariable.addInterceptor(Hi)}function fu(e){e.hooks.parseMetaData.addHook("disabled",On),e.hooks.parseMetaData.addHook("import",An),e.hooks.parseMetaData.addHook("jwt",Dn),e.hooks.parseMetaData.addHook("keepStreaming",In),e.hooks.parseMetaData.addHook("loop",Vn),e.hooks.parseMetaData.addHook("noRedirect",Bn),e.hooks.parseMetaData.addHook("noRejectUnauthorized",Nn),e.hooks.parseMetaData.addHook("timeout",Yn),e.hooks.parseMetaData.addHook("note",Un),e.hooks.parseMetaData.addHook("proxy",_n),e.hooks.parseMetaData.addHook("rateLimit",Gn),e.hooks.parseMetaData.addHook("ref",Jn),e.hooks.parseMetaData.addHook("responseRef",zn),e.hooks.parseMetaData.addHook("sleep",Xn),e.hooks.parseMetaData.addHook("verbose",Qn),e.hooks.parseMetaData.addHook("forceRegionDelimiter",$n)}function mu(e){let t=new Sr;e.hooks.execute.addInterceptor(new Tr),e.hooks.execute.addInterceptor(t),e.hooks.responseLogging.addInterceptor(t.getResponseLoggingInterceptor()),e.hooks.execute.addInterceptor(new kr),e.hooks.execute.addInterceptor(new Hr),e.hooks.execute.addInterceptor(new Cr)}function gu(e){e.hooks.provideEnvironments.addHook("config",vn),e.hooks.provideVariables.addHook("config",wn),e.hooks.provideVariables.addHook("response",Ln)}var Mi=require("dotenv");var as=".env";async function Vi(e){let t=[];if(process.env.HTTPYAC_ENV)try{t.push(...await f.readdir(process.env.HTTPYAC_ENV))}catch(s){h.warn(`HTTPYAC_ENV ${process.env.HTTPYAC_ENV} has read error`,s)}let r=f.dirname(e.httpFile.fileName);r&&await Pe(r,e.httpFile.rootDir,async s=>{t.push(...await hu(Ni(e),s)),t.push(...await je(f.readdir(s),[]))});let o=[];for(let s of t){let n;s.startsWith(`${as}.`)?n=s.slice(5):s.endsWith(as)&&(n=s.slice(0,s.length-4)),n&&o.push(n)}return h.info("dotenv Env Provider found environments",o),o}async function hu(e,t){let r=[];if(e){let o=await N(e,t);o&&r.push(...await je(f.readdir(o),[]))}return r}async function Bi(e,t){let r=yu(e),o=[];process.env.HTTPYAC_ENV&&o.push(...await ls(r,process.env.HTTPYAC_ENV));let s=f.dirname(t.httpFile.fileName);if(s){let n=[];await Pe(s,t.httpFile.rootDir,async i=>{n.unshift(...await bu(Ni(t),r,i)),n.unshift(...await ls(r,i))}),o.push(...n)}return Object.assign({},...o)}function Ni(e){var t;return((t=e.config)==null?void 0:t.envDirName)||"env"}function yu(e){let t=[as];if(e)for(let r of e)t.push(`${r}.env`,`.env.${r}`);return t}async function bu(e,t,r){let o=[];if(e){let s=await N(e,r);s&&o.push(...await ls(t,s))}return o}async function ls(e,t){let r=await je(f.readdir(t),[]),o=e.filter(n=>r.indexOf(n)>=0),s=[];for(let n of o){let i=f.joinPath(t,n);h.trace(`.env environment file found: ${i}`);try{let a=await f.readFile(i,"utf-8"),l=(0,Mi.parse)(a);s.push(l)}catch(a){h.trace(`${f.toString(i)} not found`,a)}}return s}function Ui(e){e.hooks.provideEnvironments.addHook("dotenv",Vi),e.hooks.provideVariables.addHook("dotenv",Bi)}var _i=T(require("aws4")),Gi=require("url");async function Ki(e,t,r){var s;let{request:o}=r;if(t.toLowerCase()==="authorization"&&g(e)&&D(o)&&(o!=null&&o.url)){let n=/^\s*(aws)\s+(?<accessKeyId>[^\s]*)\s+(?<secretAccessKey>[^\s]*)\s*(token:\s*(?<token>[^\s]*))?\s*(region:\s*(?<region>[^\s]*))?\s*(service:\s*(?<service>[^\s]*))?\s*$/iu.exec(e);if(n&&n.groups&&n.groups.accessKeyId&&n.groups.secretAccessKey){q(r,"get AWS Authorization");let i={accessKeyId:n.groups.accessKeyId,secretAccessKey:n.groups.secretAccessKey,sessionToken:n.groups.token},a=new Gi.URL(o.url);o.headers||(o.headers={});let l={method:o.method,headers:o.headers,host:a.host,path:`${a.pathname}${a.search}`,region:n.groups.region,service:n.groups.service,body:Buffer.isBuffer(o.body)||g(o.body)?o.body:void 0},d=await _i.default.sign(l,i);return Object.assign(o,{http2:!1}),Object.assign(o.headers,d.headers),(s=d.headers)==null?void 0:s.Authorization}}return e}var Ru=/^\s*(basic)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,xu=/^\s*(basic)\s+(?<user>.*):(?<password>.*)$/iu;async function Wi(e,t){if(t.toLowerCase()==="authorization"&&g(e)){let r=xu.exec(e)||Ru.exec(e);if(r&&r.groups&&r.groups.user)return`Basic ${Buffer.from(`${r.groups.user}:${r.groups.password}`).toString("base64")}`}return e}var Ji=require("url");async function zi(e,t,r){var i,a,l;let{request:o,httpRegion:s,httpFile:n}=r;if(g(e)&&D(o)&&!s.metaData.noClientCert){if(t==="Url"&&((i=r.config)!=null&&i.clientCertificates))await vu(e,o,r);else if(t.toLowerCase().endsWith("clientcert")){let d=/^\s*(cert:\s*(?<cert>[^\s]*)\s*)?(key:\s*(?<key>[^\s]*)\s*)?(pfx:\s*(?<pfx>[^\s]*)\s*)?(passphrase:\s*(?<passphrase>[^\s]*)\s*)?\s*$/u.exec(e);if((a=d==null?void 0:d.groups)!=null&&a.cert||(l=d==null?void 0:d.groups)!=null&&l.pfx){await Xi(o,{cert:d.groups.cert,key:d.groups.key,pfx:d.groups.pfx,passphrase:d.groups.passphrase},n);return}}}return e}async function vu(e,t,r){var s,n;let o=wu(e);if(o&&((s=r.config)!=null&&s.clientCertificates)){let i=(n=r.config)==null?void 0:n.clientCertificates[o.host];i&&await Xi(t,i,r.httpFile)}}function wu(e){try{return new Ji.URL(e)}catch{return}}async function Xi(e,t,r){let o=f.dirname(r.fileName);e.options||(e.options={}),e.options.https=Object.assign({},e.options.https,{certificate:await ds(t.cert,o),key:await ds(t.key,o),pfx:await ds(t.pfx,o),passphrase:t.passphrase})}async function ds(e,t){if(e)if(g(e)){let r=await N(e,t);if(r)return await f.readBuffer(r)}else return await f.readBuffer(e)}ee.emptyLineProvider.push(()=>[{name:"GET",description:"The GET method requests a representation of the specified resource. Requests using GET should only retrieve data."},{name:"HEAD",description:"The GET method requests a representation of the specified resource. Requests using GET should only retrieve data."},{name:"POST",description:"The POST method is used to submit an entity to the specified resource, often causing a change in state or side effects on the server."},{name:"PUT",description:"The PUT method replaces all current representations of the target resource with the request payload."},{name:"DELETE",description:"The DELETE method deletes the specified resource."},{name:"CONNECT",description:"The CONNECT method establishes a tunnel to the server identified by the target resource."},{name:"OPTIONS",description:"The OPTIONS method is used to describe the communication options for the target resource."},{name:"TRACE",description:"The TRACE method performs a message loop-back test along the path to the target resource."},{name:"PATCH",description:"The PATCH method is used to apply partial modifications to a resource."}]);ee.requestHeaderProvider.push(e=>D(e)?[{name:"A-IM",description:"Acceptable instance-manipulations for the request."},{name:"Accept",description:"Media type(s)\xA0that is/are acceptable for the response. See\xA0Content negotiation."},{name:"Accept-Charset",description:"Character sets that are acceptable."},{name:"Accept-Datetime",description:"Acceptable version in time."},{name:"Accept-Encoding",description:"List of acceptable encodings. See\xA0HTTP compression."},{name:"Accept-Language",description:"List of acceptable human languages for response. See\xA0Content negotiation."},{name:"Access-Control-Request-Method",description:"Initiates a request for\xA0cross-origin resource sharing\xA0with\xA0Origin\xA0(below)."},{name:"Access-Control-Request-Headers",description:"Initiates a request for\xA0cross-origin resource sharing\xA0with\xA0Origin\xA0(below)."},{name:"Authorization",description:"Authentication credentials for\xA0HTTP authentication."},{name:"Cache-Control",description:"Used to specify directives that\xA0must\xA0be obeyed by all caching mechanisms along the request-response chain."},{name:"Connection",description:"Control options for the current connection and list of hop-by-hop request fields. Must not be used with HTTP/2."},{name:"Content-Encoding",description:"The type of encoding used on the data. See\xA0HTTP compression."},{name:"Content-Length",description:"The length of the request body in\xA0octets\xA0(8-bit bytes)."},{name:"Content-MD5",description:"A\xA0Base64-encoded binary\xA0MD5\xA0sum of the content of the request body."},{name:"Content-Type",description:"The\xA0Media type\xA0of the body of the request (used with POST and PUT requests)."},{name:"Cookie",description:"An\xA0HTTP cookie\xA0previously sent by the server with\xA0Set-Cookie\xA0(below)."},{name:"Date",description:'The date and time at which the message was originated (in "HTTP-date" format as defined by\xA0RFC 7231 Date/Time Formats).'},{name:"Expect",description:"Indicates that particular server behaviors are required by the client."},{name:"Forwarded",description:"Disclose original information of a client connecting to a web server through an HTTP proxy."},{name:"From",description:"The email address of the user making the request."},{name:"Host",description:"The domain name of the server (for\xA0virtual hosting), and the\xA0TCP port\xA0number on which the server is listening. The\xA0port\xA0number may be omitted if the port is the standard port for the service requested. Mandatory since HTTP/1.1.\xA0If the request is generated directly in HTTP/2, it should not be used."},{name:"HTTP2-Settings",description:"A request that upgrades from HTTP/1.1 to HTTP/2 MUST include exactly one\xA0HTTP2-Setting\xA0header field. The\xA0HTTP2-Settings\xA0header field is a connection-specific header field that includes parameters that govern the HTTP/2 connection, provided in anticipation of the server accepting the request to upgrade."},{name:"If-Match",description:"Only perform the action if the client supplied entity matches the same entity on the server. This is mainly for methods like PUT to only update a resource if it has not been modified since the user last updated it."},{name:"If-Modified-Since",description:"Allows a\xA0304 Not Modified\xA0to be returned if content is unchanged."},{name:"If-None-Match",description:"Allows a\xA0304 Not Modified\xA0to be returned if content is unchanged, see\xA0HTTP ETag."},{name:"If-Range",description:"If the entity is unchanged, send me the part(s) that I am missing; otherwise, send me the entire new entity."},{name:"If-Unmodified-Since",description:"Only send the response if the entity has not been modified since a specific time."},{name:"Max-Forwards",description:"Limit the number of times the message can be forwarded through proxies or gateways."},{name:"Origin",description:"Initiates a request for\xA0cross-origin resource sharing\xA0(asks server for\xA0Access-Control-*\xA0response fields)."},{name:"Pragma",description:"Implementation-specific fields that may have various effects anywhere along the request-response chain."},{name:"Proxy-Authorization",description:"Authorization credentials for connecting to a proxy."},{name:"Range",description:"Request only part of an entity. Bytes are numbered from 0. See\xA0Byte serving."},{name:"Referer",description:'This is the address of the previous web page from which a link to the currently requested page was followed. (The word "referrer" has been misspelled in the RFC as well as in most implementations to the point that it has become standard usage and is considered correct terminology)'},{name:"TE",description:'The transfer encodings the user agent is willing to accept: the same values as for the response header field Transfer-Encoding can be used, plus the "trailers" value (related to the "chunked" transfer method) to notify the server it expects to receive additional fields in the trailer after the last, zero-sized, chunk. Only\xA0trailers\xA0is supported in HTTP/2.'},{name:"Trailer",description:"The Trailer general field value indicates that the given set of header fields is present in the trailer of a message encoded with\xA0chunked transfer coding."},{name:"Transfer-Encoding",description:"The form of encoding used to safely transfer the entity to the user.\xA0Currently defined methods\xA0are:\xA0chunked, compress, deflate, gzip, identity. Must not be used with HTTP/2"},{name:"User-Agent",description:"The\xA0user agent string\xA0of the user agent."},{name:"Upgrade",description:"Ask the server to upgrade to another protocol. Must not be used in HTTP/2."},{name:"Via",description:"Informs the server of proxies through which the request was sent."},{name:"Warning",description:"A general warning about possible problems with the entity body."},{name:"Upgrade-Insecure-Requests",description:"Tells a server which (presumably in the middle of a HTTP -> HTTPS migration) hosts mixed content that the client would prefer redirection to HTTPS and can handle\xA0Content-Security-Policy: upgrade-insecure-requests Must not be used with HTTP/2"},{name:"X-Requested-With",description:"Mainly used to identify\xA0Ajax\xA0requests (most\xA0JavaScript frameworks\xA0send this field with value of\xA0XMLHttpRequest); also identifies Android apps using WebView"},{name:"DNT",description:"Requests a web application to disable their tracking of a user. This is Mozilla`s version of the X-Do-Not-Track header field (since\xA0Firefox 4.0\xA0Beta 11).\xA0Safari\xA0and\xA0IE9\xA0also have support for this field.\xA0On March 7, 2011, a draft proposal was submitted to IETF.\xA0The\xA0W3C\xA0Tracking Protection Working Group is producing a specification."},{name:"X-Forwarded-For",description:"A\xA0de facto\xA0standard\xA0for identifying the originating IP address of a client connecting to a web server through an HTTP proxy or load balancer. Superseded by\xA0Forwarded\xA0header."},{name:"X-Forwarded-Host",description:"A\xA0de facto\xA0standard\xA0for identifying the original host requested by the client in the\xA0Host\xA0HTTP request header, since the host name and/or port of the reverse proxy (load balancer) may differ from the origin server handling the request. Superseded by\xA0Forwarded\xA0header."},{name:"X-Forwarded-Proto",description:"A\xA0de facto\xA0standard\xA0for identifying the originating protocol of an HTTP request, since a reverse proxy (or a load balancer) may communicate with a web server using HTTP even if the request to the reverse proxy is HTTPS. An alternative form of the header (X-ProxyUser-Ip) is used by Google clients talking to Google servers. Superseded by\xA0Forwarded\xA0header."},{name:"Front-End-Https",description:"Non-standard header field used by Microsoft applications and load-balancers"},{name:"X-Http-Method-Override",description:"Requests a web application to override the method specified in the request (typically POST) with the method given in the header field (typically PUT or DELETE). This can be used when a user agent or firewall prevents PUT or DELETE methods from being sent directly (note that this is either a bug in the software component, which ought to be fixed, or an intentional configuration, in which case bypassing it may be the wrong thing to do)."},{name:"X-ATT-DeviceId",description:"Allows easier parsing of the MakeModel/Firmware that is usually found in the User-Agent String of AT&T Devices"},{name:"X-Wap-Profile",description:"Links to an XML file on the Internet with a full description and details about the device currently connecting. In the example to the right is an XML file for an AT&T Samsung Galaxy S2."},{name:"Proxy-Connection",description:"Implemented as a misunderstanding of the HTTP specifications. Common because of mistakes in implementations of early HTTP versions. Has exactly the same functionality as standard Connection field. Must not be used with HTTP/2."},{name:"X-UIDH",description:'Server-side\xA0deep packet insertion\xA0of a unique ID identifying customers of\xA0Verizon Wireless; also known as "perma-cookie" or "supercookie"'},{name:"X-Csrf-Token",description:"Used to prevent\xA0cross-site request forgery. Alternative header names are:\xA0X-CSRFToken\xA0and\xA0X-XSRF-TOKEN"},{name:"X-Request-ID",description:"Correlates HTTP requests between a client and server."},{name:"X-Correlation-ID",description:"Correlates HTTP requests between a client and server."},{name:"Save-Data",description:"The Save-Data client hint request header available in Chrome, Opera, and Yandex browsers lets developers deliver lighter, faster applications to users who opt-in to data saving mode in their browser."}]:[]);var $t=require("tough-cookie");var Or=class{constructor(){this.id="cookieJar"}async beforeTrigger(t){let{request:r,httpRegion:o,config:s,options:n}=t.args[0];if(D(r)&&!o.metaData.noCookieJar&&(s!=null&&s.cookieJarEnabled)){let i=this.getCookieStorePrefix(t.args[0]),a=S.userSessions.filter(p=>p.type==="Cookie"&&p.id.startsWith(i)),l=new $t.MemoryCookieStore;for(let p of a)p.cookie&&l.putCookie(p.cookie,c=>{c&&h.info(c)});n.memoryStore=l;let d={};s.cookieJarEnabled!==!0&&Object.assign(d,s.cookieJarEnabled);let u=new $t.CookieJar(l,d);r.options||(r.options={}),r.options.cookieJar=u}return!0}async afterTrigger(t){let{options:r}=t.args[0],o=r.memoryStore;if(o&&o instanceof $t.MemoryCookieStore){o.getAllCookies((n,i)=>{if(!n)for(let a of i||[]){let l={id:`${this.getCookieStorePrefix(t.args[0])}_${a.toString()}`,title:`${a.domain} ${a.path} ${a.key}`,description:`${a}`,type:"Cookie",details:Object.fromEntries(Object.entries(a).map(([d,u])=>u?u instanceof Date?[d,u.toISOString()]:[d,u]:[]).filter(d=>d.length>0)),cookie:a};S.setUserSession(l)}});let s=S.userSessions.filter(n=>n.type==="Cookie");for(let n of s)n.cookie&&o.putCookie(n.cookie,i=>{i&&h.info(i)})}return!0}getCookieStorePrefix(t){var r,o;return`Cookies_${M(t.activeEnvironment)}_${((o=(r=t.httpFile.rootDir)==null?void 0:r.toString)==null?void 0:o.call(r))||"none"}`}};var Yi=require("tough-cookie");async function Qi(e,t,r){var s;let{request:o}=r;if(t.toLowerCase()==="cookie"&&D(o)&&o.url&&((s=o.options)==null?void 0:s.cookieJar)instanceof Yi.CookieJar){if(g(e))o.options.cookieJar.setCookie(e,o.url);else if(Array.isArray(e))for(let n of e)await o.options.cookieJar.setCookie(n,o.url);return}return e}var na=require("crypto"),ia=require("url"),aa=require("uuid");var Zi=require("filesize"),$r=T(require("got")),ea=require("http-proxy-agent"),ta=require("https-proxy-agent"),ra=T(require("lodash/merge")),oa=require("socks-proxy-agent");async function sa(e,t){try{let r=us(e,t),s=await(0,$r.default)(e.url||"",r);return Ue(s,e)}catch(r){if(r instanceof $r.CancelError)return!1;throw r}}function us(e,t){var s;let{config:r}=t,o=(0,ra.default)({decompress:!0,retry:0,throwHttpErrors:!1,allowGetBody:!0},r==null?void 0:r.request,{method:e.method,headers:e.headers,body:e.body,timeout:e.timeout},e.options);return e.noRedirect&&(o.followRedirect=!1),e.noRejectUnauthorized&&(o.https=((s=e.options)==null?void 0:s.https)||{},o.https.rejectUnauthorized=!1),Pu(o,e.proxy),ku(o.headers),h.debug("request",o),o}function Pu(e,t){if(t)if(t.startsWith("socks://")){let r=new oa.SocksProxyAgent(t);e.agent={http:r,https:r}}else e.agent={http:new ea.HttpProxyAgent(t),https:new ta.HttpsProxyAgent(t)}}function ku(e){if(e){for(let[t,r]of Object.entries(e))if(typeof r<"u"){let o;Array.isArray(r)?o=r.map(s=>w(s)||s):o=w(r)||"",e[t]=o}}}function Ue(e,t){var r;return{name:`${e.statusCode} - ${t.method||"GET"} ${t.url}`,statusCode:e.statusCode,protocol:`HTTP/${e.httpVersion}`,statusMessage:e.statusMessage,body:e.body,rawHeaders:e.rawHeaders,rawBody:e.rawBody,headers:e.headers,timings:e.timings.phases,httpVersion:e.httpVersion,request:{protocol:"HTTP",method:e.request.options.method,url:`${e.request.options.url}`,headers:e.request.options.headers,body:ps(e.request.options.body)},contentType:Fe(e.headers),meta:{ip:e.ip,redirectUrls:e.redirectUrls,size:(0,Zi.filesize)(e.rawHeaders.map(o=>o.length).reduce((o,s)=>o+s,0)+(((r=e.rawBody)==null?void 0:r.length)||0))}}}function ps(e){if(typeof e=="string"||Buffer.isBuffer(e))return e}var Hu=/^\s*(digest)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,Cu=/^\s*(digest)\s+(?<user>.*):(?<password>.*)$/iu;async function la(e,t,r){let{request:o}=r;if(t.toLowerCase()==="authorization"&&g(e)&&D(o)){let s=Cu.exec(e)||Hu.exec(e);if(s&&s.groups&&s.groups.user&&s.groups.password){o.options||(o.options={}),o.options.hooks||(o.options.hooks={}),o.options.hooks.afterResponse||(o.options.hooks.afterResponse=[]),o.options.hooks.afterResponse.push(Su(s.groups.user,s.groups.password,r));return}}return e}function Su(e,t,r){return async function(s,n){let i=s.headers["www-authenticate"];if(s.statusCode===401&&i&&i.toLowerCase().startsWith("digest")){let a=Ue(s,{url:s.request.requestUrl});await Ve(a,r);let l=new ia.URL(s.url),d={qop:"",algorithm:"",realm:"",nonce:"",opaque:""};Eu(d,i);let u=/(^|,)\s*auth\s*($|,)/u.test(d.qop)&&"auth",p=u&&"00000001",c=u&&(0,aa.v4)().replace(/-/gu,""),m=Lu(d.algorithm,e,t,d.realm,d.nonce,c),y=At(`${s.request.options.method}:${l.pathname}`),v=At(u?`${m}:${d.nonce}:${p}:${c}:${u}:${y}`:`${m}:${d.nonce}:${y}`);return n({headers:{authorization:`Digest ${Tu({username:e,realm:d.realm,nonce:d.nonce,uri:l.pathname,qop:u,response:v,nc:p,cnonce:c,algorithm:d.algorithm,opaque:d.opaque})}`}})}return s}}function Tu(e){let t=[];for(let[r,o]of Object.entries(e))o&&(["qop","nc","algorithm"].indexOf(r)>=0?t.push(`${r}=${o}`):t.push(`${r}="${o}"`));return t.join(", ")}function At(e){return(0,na.createHash)("md5").update(e).digest("hex")}function Lu(e,t,r,o,s,n){let i=At(`${t}:${o}:${r}`);return n&&(e==null?void 0:e.toLowerCase())==="md5-sess"?At(`${i}:${s}:${n}`):i}function Eu(e,t){for(let r of t.split(",")){let o=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/giu.exec(r);o&&(e[o[1]]=o[2]||o[3])}}var Dt=T(require("got"));var Ar=class extends yt{constructor(r,o){super();this.request=r;this.context=o}get reportMessage(){return`perform Http Request (${this.request.url})`}get supportsStreaming(){return!1}get nativeClient(){return Dt.default}async connect(){return this.nativeClient}async send(r){if(D(this.request)&&this.request.url)try{let o=us(this.request,this.context);r&&(o.body=he(r)),this.cancelableRequest=(0,Dt.default)(this.request.url,o),this.registerEvents(this.cancelableRequest);let s=await this.cancelableRequest;this.onMessage("message",Ue(s,this.request))}catch(o){if(o instanceof Dt.CancelError)return;throw o instanceof TypeError&&o.message==="Invalid URL"&&(o.message=`Invalid URL: ${o.input||this.request.url}`),o}finally{delete this.cancelableRequest}}disconnect(r){var o;r&&((o=this.cancelableRequest)==null||o.cancel(),this.onDisconnect())}registerEvents(r){r.on("downloadProgress",s=>{this.onProgress(s.percent)});let o=s=>(...n)=>{this.onMetaData(s,{protocol:"HTTP",statusCode:0,message:n.length>0?`${w(n[0])}`:void 0,body:{...n}})};r.on("redirect",o("redirect")),r.on("retry",o("retry")),r.on("downloadProgress",o("downloadProgress")),r.on("uploadProgress",o("uploadProgress"))}};async function da(e,t){var r,o;if(e&&D(e)){e.options||(e.options={}),(r=e.options)!=null&&r.hooks||(e.options.hooks={}),(o=e.options)!=null&&o.hooks.beforeRedirect||(e.options.hooks.beforeRedirect=[]),e.options.hooks.beforeRequest||(e.options.hooks.beforeRequest=[]);let s;e.options.hooks.beforeRequest.push(n=>{s={protocol:"HTTP",method:n.method,url:`${n.url}`,headers:n.headers,body:ps(n.body)}}),e.options.hooks.beforeRedirect.push(async(n,i)=>{let a=Ue(i,s||{url:w(n.url)||""});await Ve(a,t)})}}function ua(e,t,r){return e==="postRedirectGet"?(r.httpRegion.hooks.onRequest.addHook("postRedirectGet",async o=>{D(o)&&(o.options||(o.options={}),o.options.hooks||(o.options.hooks={}),o.options.hooks.beforeRedirect||(o.options.hooks.beforeRedirect=[]),o.options.hooks.beforeRedirect.push(s=>{s.method="GET",s.body=void 0}))}),!0):!1}me.exchange=sa;me.createRequestClient=(e,t)=>new Ar(e,t);function pa(e){e.hooks.parseMetaData.addHook("postRedirectGet",ua),e.hooks.execute.addInterceptor(new Or),e.hooks.replaceVariable.addHook("aws",Ki),e.hooks.replaceVariable.addHook("basicAuth",Wi),e.hooks.replaceVariable.addHook("clientCertificate",zi),e.hooks.replaceVariable.addHook("digestAuth",la),e.hooks.replaceVariable.addHook("cookie",Qi),e.hooks.onRequest.addHook("logHttpRedirect",da)}var st=class{constructor(t,r,o){this.extensions=t;this.beginCodeBlock=r;this.endCodeBlock=o}async beforeTrigger(t){let r=t.args[0],o=t.args[1];if(f.hasExtension(o.httpFile.fileName,...this.extensions)){let s=this.getHttpBlockLines(o.lines,o.data);t.args[0]=function*(i){if(s.length>0){let a=r(!0);for(let l of a){let d=s.find(u=>u.startLine<=l.line&&l.line<u.endLine);if(d)if(d.startLine===l.line)yield{line:l.line,textLine:"###"};else{if(!i&&Re.test(l.textLine))break;yield l}else break}}}}return!0}getHttpBlockLines(t,r){if(r.codeBlocks)return r.codeBlocks;let o=[],s=-1;for(let n=0;n<t.length;n++){let i=t[n];s<0?Array.isArray(this.beginCodeBlock)?t.length>n+this.beginCodeBlock.length&&this.beginCodeBlock.every((a,l)=>a.test(t[n+l]))&&(s=n+this.beginCodeBlock.length-1,n+=this.beginCodeBlock.length-1):this.beginCodeBlock.test(i)&&(s=n):this.endCodeBlock.test(i)&&(o.push({startLine:s,endLine:n}),s=-1)}return r.codeBlocks=o,o}};var Dr=class extends st{constructor(){super(["adoc","asciidoc","asc"],[/^\[source,http\]\s*$/iu,/^----\s*$/u],/^----\s*$/u);this.id="asciidoc"}};var Fr=class extends st{constructor(){super(["md","markdown","mdown","mkdn","mdtxt","mdtext","text","rmd"],/^```\s*(http|rest)$/iu,/^```\s*$/u);this.id="markdown"}};function ca(e){e.hooks.parse.addInterceptor(new Fr),e.hooks.parse.addInterceptor(new Dr)}var oe=require("crypto");var Ir=class{constructor(){this.hmac=new fs}sha1(){return new ce((0,oe.createHash)("sha1"))}sha256(){return new ce((0,oe.createHash)("sha256"))}sha384(){return new ce((0,oe.createHash)("sha384"))}sha512(){return new ce((0,oe.createHash)("sha512"))}md5(){return new ce((0,oe.createHash)("md5"))}},ce=class e{constructor(t){this.hash=t}updateWithText(t,r){let o=Qe(r),s=this.hash.update(Buffer.from(t,o));return new e(s)}updateWithHex(t){let r=this.hash.update(Buffer.from(t,"hex"));return new e(r)}updateWithBase64(t,r){let o=this.hash.update(Buffer.from(t,r?"base64url":"base64"));return new e(o)}digest(){return new cs(this.hash)}},cs=class{constructor(t){this.hash=t}toHex(){return this.hash instanceof oe.Hmac?this.hash.digest("hex"):this.hash.digest("hex")}toBase64(t){let r=t?"base64url":"base64";return this.hash instanceof oe.Hmac?this.hash.digest(r):this.hash.digest(r)}},fs=class{sha1(){return new _e("sha1")}sha256(){return new _e("sha256")}sha384(){return new _e("sha384")}sha512(){return new _e("sha512")}md5(){return new _e("md5")}},_e=class{constructor(t){this.algorithm=t}withTextSecret(t,r){let o=(0,oe.createHmac)(this.algorithm,Buffer.from(t,Qe(r)));return new ce(o)}withHexSecret(t){let r=(0,oe.createHmac)(this.algorithm,Buffer.from(t,"hex"));return new ce(r)}withBase64Secret(t,r){let o=(0,oe.createHmac)(this.algorithm,Buffer.from(t,r?"base64url":"base64"));return new ce(o)}};var fa=require("assert");var Ge=class{constructor(t){this.context=t;this.userSession=this.getIntellijSession()}getIntellijSession(){let t="intellij_global_cache",r=S.getUserSession(t);if(this.isIntellijGlobalCacheSession(r))return r;let o={id:t,title:"Intellij Cache",description:"Global Cache for all Intellij Variables",details:{},type:"intellij_global_cache"};return S.setUserSession(o),o}isIntellijGlobalCacheSession(t){return!!(t!=null&&t.id)&&!!t.title}set(t,r){this.userSession.details[t]=r,F({[t]:r},this.context)}get(t){return this.context.variables[t]}isEmpty(){return Object.entries(this.userSession.details).length===0}clear(t){delete this.userSession.details[t],Me(t,this.context)}clearAll(){for(let[t]of Object.entries(this.userSession.details))this.clear(t)}};var jr=class{constructor(t){this.context=t;this.global=new Ge(t)}test(t,r){Pt(this.context)(t,r)}assert(t,r){(0,fa.ok)(t,r)}log(t){this.context.scriptConsole&&this.context.scriptConsole.info(t)}exit(){var t;(t=this.context.scriptConsole)==null||t.warn("exit not supported")}};var ga=require("uuid");function Mr(e){let t=e.trim();if(["$uuid","$random.uuid"].indexOf(t)>=0)return(0,ga.v4)();if(t==="$timestamp")return w(Date.now());if(t==="$isoTimestamp")return new Date().toISOString();if(t==="$randomInt")return`${Math.floor(Math.random()*1e3)}`;if(t.startsWith("$random.integer")){let r=ma(t);if(r)return`${Math.floor(r)}`}if(t.startsWith("$random.float")){let r=ma(t);if(r)return`${r}`}if(t.startsWith("$random.alphabetic"))return qu(t);if(t.startsWith("$random.alphanumeric"))return Ou(t);if(t.startsWith("$random.hexadecimal"))return $u(t);if(t.startsWith("$random.email"))return et()}function ma(e){var r,o,s,n;let t=/^\$random.(integer|float)\s*\(\s*(?<from>-?\d+)\s*,\s*(?<to>-?\d+)\s*\)$/u.exec(e);if(t&&((r=t.groups)!=null&&r.from)&&((o=t.groups)!=null&&o.to)){let i=C((s=t.groups)==null?void 0:s.from)||0,a=C((n=t.groups)==null?void 0:n.to)||0;if(!Number.isNaN(i)&&!Number.isNaN(a)){if(i>a){let l=a;a=i,i=l}return Math.random()*(a-i)+i}}}function qu(e){var r,o;let t=/^\$random.alphabetic\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=C((o=t.groups)==null?void 0:o.length);if(s)return Y(s,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz")}}function Ou(e){var r,o;let t=/^\$random.alphanumeric\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=C((o=t.groups)==null?void 0:o.length);if(s)return Y(s)}}function $u(e){var r,o;let t=/^\$random.hexadecimal\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=C((o=t.groups)==null?void 0:o.length);if(s)return Y(s,"1234567890ABCDEF")}}async function ha(e,t,r){return U(e,async o=>Mr(o))}var Vr=class{url(){return this._url}body(){return this._body||""}constructor(t){var r,o,s,n;this._url=((r=t.request)==null?void 0:r.url)||"",this.method=((o=t.request)==null?void 0:o.method)||"",this._body=((s=t.request)==null?void 0:s.body)&&w((n=t.request)==null?void 0:n.body),this.headers=new Nr(t),this.environment=new _r(t.variables),this.variables=new Ge(t)}},Br=class{constructor(t){var r;this.url=new gs(t),this.method=((r=t.request)==null?void 0:r.method)||"",this.body=new ms(t),this.headers=new Nr(t),this.environment=new _r(t.variables),this.variables=new Ge(t)}},ms=class{constructor(t){this.context=t}getRaw(){var t;return w((t=this.context.request)==null?void 0:t.body)||""}tryGetSubstituted(){var r;let t=hs(this.getRaw(),this.context.variables);return t&&((r=this.context.request)!=null&&r.body)&&(this.context.request.body=t),t}},Nr=class{constructor(t){this.context=t}all(){var t;return(t=this.context.request)!=null&&t.headers?Object.keys(this.context.request.headers).map(r=>new Ur(r,this.context)):[]}findByName(t){var r;return $((r=this.context.request)==null?void 0:r.headers,t)?new Ur(t,this.context):null}},Ur=class{constructor(t,r){this.name=t;this.context=r}value(){return this.getRawValue()}getRawValue(){var t;return w($((t=this.context.request)==null?void 0:t.headers,this.name))||""}tryGetSubstitutedValue(){var r;let t=hs(this.getRawValue(),this.context.variables);return t&&((r=this.context.request)!=null&&r.headers)&&(co(this.context.request.headers,this.name),this.context.request.headers[this.name]=t),t}},gs=class{constructor(t){this.context=t}getRaw(){var t;return((t=this.context.request)==null?void 0:t.url)||""}tryGetSubstituted(){var r;let t=hs(this.getRaw(),this.context.variables);return t&&((r=this.context.request)!=null&&r.body)&&(this.context.request.body=t),t}},_r=class{constructor(t){this.variables=t}get(t){let r=w(this.variables[t]);return Xe(r)?null:r}};function hs(e,t){let r=e,o=[Mr,s=>{let n=t[s];if(!Xe(n))return w(n)}];for(let s of o)r=Au(r,s);return r}function Au(e,t){if(!g(e))return e;let r,o,s=e,n=0;for(;o!==s&&n++<100;)for(o=s;(r=Ct.exec(o))!==null;){let[i,a]=r,l=t(a,i);if(typeof l<"u"&&i===e)return l;let d=w(l);typeof d<"u"&&(s=s.replace(i,()=>d))}return s}var Gr=class{constructor(t){this.body=t.parsedBody||t.body,this.status=t.statusCode,this.contentType=ys(t.contentType),this.headers=new Kr(t.headers)}};function ys(e){return{mimeType:(e==null?void 0:e.mimeType)||"application/octet-stream",charset:(e==null?void 0:e.charset)||"utf-8"}}var Kr=class{constructor(t){this.headers=t}valueOf(t){if(this.headers){let r=$(this.headers,t);if(r&&g(r))return r}return null}valuesOf(t){if(this.headers){let r=$(this.headers,t);if(r){if(g(r))return[r];if(Array.isArray(r))return r}}return[]}},Wr=class{constructor(t,r){this.requestClient=t;this.resolve=r;this.status=0;this.contentType=ys();this.lazyHeaders={};this.body={onEachLine:(...o)=>this.onEachLine(...o),onEachMessage:(...o)=>this.onEachMessage(...o)},this.headers=new Kr(this.lazyHeaders)}onEachLine(t,r){this.onEachMessage(t,r)}onEachMessage(t,r){let o=s=>{let[,n]=s.detail;this.status=n.statusCode,Object.assign(this.headers,n.headers),this.contentType=ys(n.contentType);let i=w(n.body);i&&t(i,()=>{this.requestClient.removeEventListener("message",o),this.resolve()},d=>this.requestClient.send(d))};this.requestClient.addEventListener("message",o),r&&this.requestClient.addEventListener("end",r)}};var ya=T(require("dayjs"));var ba=require("uuid"),Jr=class{alphabetic(t=10){return Y(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz")}numeric(t=10){return Y(t)}hexadecimal(t=10){return Y(t,"1234567890ABCDEF")}get email(){return et()}float(t=0,r=100){return Math.random()*(r-t)+t}integer(t=0,r=100){return Math.floor(Math.random()*(r-t)+t)}get uuid(){return(0,ba.v4)()}date(t=new Date,r=void 0){return(0,ya.default)(t).format(r)}};var zr=class{btoa(t){return global.btoa(t)}atob(t){return global.atob(t)}};ee.variableProvider.push(()=>[{name:"$uuid",description:"UUID"},{name:"$uuid",description:"UUID"},{name:"$random.uuid",description:"UUID"},{name:"$timestamp",description:"Timestamp"},{name:"$isoTimestamp",description:"ISOTimestamp"},{name:"$randomInt",description:"randomInt (0 -1000)"},{name:"$random.integer",description:"integer"},{name:"$random.float",description:"float"},{name:"$random.alphabetic",description:"Alphabetic Text"},{name:"$random.alphanumeric",description:"Alphanumeric Text"},{name:"$random.hexadecimal",description:"Hexadecimal String"},{name:"$random.email",description:"EMail"}]);var Xr=class{constructor(t,r){this.scriptData=t;this.id="intellij";r&&(this.before=["requestVariableReplacer"])}isStreamingScript(t){return["onEachLine","onEachMessage"].some(r=>t.script.indexOf(r)>0)}async processOnRequest(t,r){q(r,"execute Intellij Javascript");let o=await this.loadScript(r);if(this.isStreamingScript(o))return;let s=bs(r);await this.executeScriptData(o,s,r)}async processOnStreaming(t){let r=await this.loadScript(t);if(this.scriptData=r,this.isStreamingScript(r)&&t.requestClient){let o=t.requestClient;await new Promise(s=>{let n=bs(t);n.response=new Wr(o,s),this.executeScriptData(r,n,t)})}}async processOnResponse(t,r){q(r,"execute Intellij Javascript");let o=await this.loadScript(r);if(this.isStreamingScript(o))return;let s=bs(r);s.response=new Gr(t),await this.executeScriptData(o,s,r)}async executeScriptData(t,r,o){return L.runScript?(await L.runScript(t.script,{fileName:o.httpFile.fileName,context:{console:o.scriptConsole,...r},lineOffset:t.lineOffset}),!0):!1}async loadScript(t){if(this.isIntellijScriptData(this.scriptData))try{return{script:await be(this.scriptData.fileName,t,r=>f.readFile(r,"utf-8"))||"",lineOffset:0}}catch(r){throw(t.scriptConsole||h).error(this.scriptData.fileName,r),new Error(`error loading script ${this.scriptData.fileName}`)}else return this.scriptData}isIntellijScriptData(t){return!!t.fileName}};function bs(e){let t={client:new jr(e),crypto:new Ir,$random:new Jr,$env:process.env,Window:new zr};return e.request&&(e.httpRegion.response?t.request=new Vr(e):t.request=new Br(e)),t}async function Ra(){let e=S.getUserSession("intellij_global_cache");return(e==null?void 0:e.details)||{}}async function xa(e,{httpRegion:t}){let r=e(),o=Fu(r,!!t.request);if(o){let s=new Xr(o.data,o.isBeforeRequest);return o.isBeforeRequest?t.hooks.onRequest.addObjHook(n=>n.processOnRequest,s):(t.hooks.onStreaming.addObjHook(n=>n.processOnStreaming,s),t.hooks.onResponse.addObjHook(n=>n.processOnResponse,s)),{nextParserLine:o.endLine,symbols:[new P({name:"Intellij Script",description:"Intellij Script",kind:"script",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset,children:o.symbols})]}}return!1}function Fu(e,t){var o,s,n;let r=e.next();if(!r.done){let i=r.value.line,a=/^\s*(?<event>(<|>))\s+(?<fileName>[^\s{%}]+\s*)$/u.exec(r.value.textLine);if((o=a==null?void 0:a.groups)!=null&&o.fileName){if(a.groups.event==="<"&&t)return!1;let u=a.groups.fileName.trim();return{startLine:i,endLine:i,endOffset:r.value.textLine.length,data:{fileName:u},isBeforeRequest:a.groups.event==="<",symbols:[new P({name:"filename",description:u,kind:"path",startLine:r.value.line,startOffset:r.value.textLine.indexOf(u),endLine:r.value.line,endOffset:r.value.textLine.indexOf(u)+u.length})]}}let l=/^\s*(?<event>(<|>))\s+\{%\s*(?<script>.*)\s*%\}\s*$/u.exec(r.value.textLine);if((s=l==null?void 0:l.groups)!=null&&s.script)return l.groups.event==="<"&&t?!1:{startLine:i,endLine:i,endOffset:r.value.textLine.length,data:{script:l.groups.script,lineOffset:i},isBeforeRequest:l.groups.event==="<"};let d=/^\s*(?<event>(<|>))\s+\{%\s*$/u.exec(r.value.textLine);if((n=d==null?void 0:d.groups)!=null&&n.event){if(d.groups.event==="<"&&t)return!1;r=e.next();let u=[];for(;!r.done;){if(/^\s*%\}\s*$/u.test(r.value.textLine))return{startLine:i,endLine:r.value.line,endOffset:r.value.textLine.length,data:{script:G(u),lineOffset:i},isBeforeRequest:d.groups.event==="<"};u.push(r.value.textLine),r=e.next()}}}return!1}async function va(e,t,r){return U(e,async o=>{if(o.trim()==="$projectRoot")return r.httpFile.rootDir})}async function wa(e){let t=Object.keys(await Pa(e));return h.info("Intellij Env Provider found environments",t),t}async function Pa(e){var i;let t=[],r=a=>["http-client.env.json","http-client.private.env.json"].includes(a),o=process.env.HTTPYAC_ENV;if(o&&g(o)){let a=await N(o,e.httpFile.rootDir);a&&t.push(...await Rs(a,r))}if((i=e.config)!=null&&i.envDirName){let a=await N(e.config.envDirName,e.httpFile.rootDir);a&&t.push(...await Rs(a,r))}let s=f.dirname(e.httpFile.fileName);s&&await Pe(s,e.httpFile.rootDir,async a=>{t.push(...await Rs(a,r))});let n={};t.length>0&&h.trace(`Intellij environment files found: ${t.join(", ")}`),t.sort((a,l)=>{let d=f.toString(a),u=f.toString(l),p=d.endsWith("private.env.json"),c=u.endsWith("private.env.json");return p===c?d.localeCompare(u):p?1:-1});for(let a of t){let l=await Iu(a);if(l)for(let[d,u]of Object.entries(l))n[d]?(f.toString(a).endsWith("private.env.json")||h.warn(`Multiple files with environment ${d} were found.`),Object.assign(n[d],u)):n[d]=u}return n}async function Rs(e,t){return(await je(f.readdir(e),[])).filter(t).map(o=>f.joinPath(e,o))}async function ka(e,t){let r=await Pa(t),o=[];if(e)for(let s of e)o.push(r[s]);return Object.assign({},...o)}async function Iu(e){try{if(await f.exists(e)){let t=await f.readFile(e,"utf-8");return JSON.parse(t)}}catch(t){h.trace(`${e} not found`),h.trace(t)}}function Ha(e){e.hooks.parse.addHook("intellijScript",xa,{before:["request"]}),e.hooks.provideEnvironments.addHook("intellij",wa),e.hooks.provideVariables.addHook("intellij",ka),e.hooks.provideVariables.addHook("intellij_global",Ra),e.hooks.replaceVariable.addHook("intellijDynamic",ha,{before:["name"]}),e.hooks.replaceVariable.addHook("intellijProjectContext",va,{before:["name"]})}ee.emptyLineProvider.push(()=>[{name:`{{@streaming
`,description:"Streaming Javascript Block"},{name:`{{@response
`,description:"Response Javascript Block"},{name:`{{@request
`,description:"Request Javascript Block"}]);ee.variableProvider.push(()=>[{name:"$random.alphabetic()",description:"random letters"},{name:"$random.number()",description:"random number"},{name:"$random.hexadecimal()",description:"random hexadecimal"},{name:"$random.email()",description:"random email"},{name:"$random.float()",description:"random float"},{name:"$random.integer()",description:"random integer"},{name:"$random.uuid()",description:"random uuid"},{name:"$random.date()",description:"Date format function"}]);async function Ca(e){let t=Sa(e),r=S.getUserSession(t);return(r==null?void 0:r.details)||{$global:{}}}var Yr=class{constructor(){this.id="globalVariables"}async afterLoop(t){let[r]=t.args,o=r.variables.$global;if(o&&typeof o=="object"&&Object.keys(o).length>0){let s=Sa(r.activeEnvironment);S.setUserSession({id:s,title:"global store",description:r.activeEnvironment?`global Variables for ${r.activeEnvironment.join(", ")}`:"global Variables",type:"global_cache",details:{$global:o}})}return!0}};function Sa(e){return`global_cache_${M(e)}`}var Qr=class{constructor(t,r){this.context=t;this.httpFileStore=r}findHttpRegionInContext(t){return Be(t,this.context)}async import(t){return await Lt(t,this.httpFileStore,this.context)}setVariables(t){F(t,this.context)}async execute(t,r){r&&F(r,this.context);let o;if(g(t)?o=Be(t,this.context):o=t,o&&await(o==null?void 0:o.execute(this.context))){let n=M(this.context.activeEnvironment);F(o.variablesPerEnv[n],this.context)}return this.context.variables}};var Ft=T(require("module")),It=T(require("path")),Ta=T(require("vm"));function La(e,t){let r;try{try{r=Ft.default.createRequire(It.default.resolve(t,"package.json")).resolve(e)}catch{r=require.resolve(e,{paths:[t]})}}catch(o){h.debug(o)}return r}function Ea(e,t,r=!1){if(O.isTrusted("loadModule"))try{return r&&Mu(e,t),Ft.default.createRequire(It.default.resolve(t,"package.json"))(e)}catch{let o=La(e,t);if(o)return r&&xs(o),require(o)}}function ju(e,t){let r=new Ft.default(e,require.main);return r.filename=e,r.paths=Ft.default._nodeModulePaths(It.default.dirname(e)),t&&r._compile(t,e),r}function Mu(e,t){let r=La(e,t);r&&xs(r)}function xs(e,t=new Map){let r=require.cache[e];r&&(t.set(e,!0),r.children.forEach(o=>{t.get(o.id)||xs(o.id,t)}),delete require.cache[e])}async function jt(e,t){if(!O.isTrusted("runScript"))return{};let r=Vu(t.fileName),o=ju(r);function s(p){let c=L.require;return c&&c[p]?c[p]:o.require(p)}let n=Nu(t.context),i=Object.assign({$context:n,...n}),a=Object.keys(i),l=`(async function userJS(exports, require, module, __filename, __dirname, context){ with(context){${f.EOL}${e}${f.EOL}}})`;await Ta.default.runInThisContext(l,{filename:r,lineOffset:t.lineOffset,displayErrors:!0}).apply(i,[o.exports,s,o,r,It.default.dirname(r),i]),Bu(a,i,t.deleteVariable);let u=o.exports;if(Ze(u))u=await u;else for(let[p,c]of Object.entries(u))Ze(c)&&(u[p]=await c);return u}function Vu(e){return f.fsPath(e)||f.toString(e)}function Bu(e,t,r){if(r)for(let o of e)try{t[o]===void 0&&r(o)}catch(s){h.info(`error on delete of ${o}`,s)}}async function Zr(e,t,r){if(!O.isTrusted("evalExpression"))return;let o=`exports.$result = (${e});`,s=t.httpRegion.symbol.startLine;if(t.httpRegion.symbol.source){let i=se(t.httpRegion.symbol.source).findIndex(a=>a.indexOf(e)>=0);i>=0&&(s+=i)}return(await jt(o,{fileName:t.httpFile.fileName,context:{...t.variables,httpFile:t.httpFile,httpRegion:t.httpRegion,request:t.request,console:t.scriptConsole,$random:Et,...r,$context:t},lineOffset:s})).$result}function Nu(e){let t={};for(let[r,o]of Object.entries(e)){let s=r.trim().replace(/\s/gu,"-").replace(/-./gu,n=>n[1].toUpperCase());Oa.indexOf(s)<0&&typeof o<"u"&&(t[s]=o)}return t}function qa(e){return Oa.indexOf(e)>=0?(h.warn(`Keyword ${e} prevented, because Javascript Keyword`),!1):Uu.indexOf(e)>=0?(h.warn(`Keyword ${e} prevented, because used by httpYac`),!1):!0}var Uu=["httpFile","httpRegion","request","test","sleep"],Oa=["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","implements","import","in","instanceof","interface","let","new","null","package","private","protected","public","return","super","switch","static","this","throw","try","true","typeof","var","void","while","with","yield"];var Gu=/^\s*\{\{(@js\s+)?(?<modifier>\+|@)?(?<event>(request|streaming|response|after|responseLogging)?)?\s*$/iu,Ku=/^\s*\}\}\s*$/u;async function $a(e,{httpRegion:t,httpFile:r,httpFileStore:o}){let s=e(),n=s.next();if(!n.done){let i=Gu.exec(n.value.textLine);if(i!=null&&i.groups){let a=n.value.line;n=s.next();let l=[];for(;!n.done;){if(Ku.test(n.value.textLine)){let d={script:G(l),lineOffset:a},u=i.groups.modifier==="+";switch(i.groups.event){case"request":zu(u?r.hooks:t.hooks,d,o);break;case"streaming":Wu(u?r.hooks:t.hooks,d,o);break;case"response":Xu(u?r.hooks:t.hooks,d,o);break;case"after":Qu(u?r.hooks:t.hooks,d,o);break;case"responseLogging":Yu(u?r.hooks:t.hooks,d,o);break;default:Ju(u?r.hooks:t.hooks,d,o);break}return{nextParserLine:n.value.line,symbols:[new P({name:"script",description:"nodejs script",kind:"script",startLine:a,startOffset:0,endLine:n.value.line,endOffset:n.value.textLine.length})]}}l.push(n.value.textLine),n=s.next()}}}return!1}function Wu(e,t,r){e.onStreaming.addHook("js",async o=>await nt(t,o,r,"streaming")?void 0:ht)}function Ju(e,t,r){e.execute.addHook("js",o=>nt(t,o,r))}function zu(e,t,r){e.onRequest.addHook("js",async(o,s)=>await nt(t,s,r,"request")?void 0:ht)}function Xu(e,t,r){e.onResponse.addHook("js",async(o,s)=>(s.variables.response=o,await nt(t,s,r,"response")?void 0:ht))}function Yu(e,t,r){e.responseLogging.addHook("js",async(o,s)=>{let n=s.variables.response;s.variables.response=o,await nt(t,s,r,"responseLogging"),s.variables.response=n})}function Qu(e,t,r){e.execute.addInterceptor(new vs(t,r))}var vs=class{constructor(t,r){this.scriptData=t;this.httpFileStore=r;this.id=`afterJavascript_${t.script}`}async afterLoop(t){return await nt(this.scriptData,t.args[0],this.httpFileStore,"after")}};async function nt(e,t,r,o){q(t,o?`execute javascript (@${o})`:"execute javascript");let s=await jt(e.script,{fileName:t.httpFile.fileName,context:{...t.variables,httpFile:t.httpFile,httpRegion:t.httpRegion,request:t.request,console:t.scriptConsole,sleep:Ce,test:Pt(t),$httpyac:new Qr(t,r),$random:Et,$context:t},lineOffset:e.lineOffset,deleteVariable:i=>Me(i,t)}),n=s.$cancel;return n&&(delete s.$cancel,ne(t.httpRegion)),F(s,t),!n}async function Aa(e,t,r){return await U(e,async(o,s)=>{try{return await Zr(o,r)}catch(n){if(t==="Variable")(r.scriptConsole||h).debug(`variable ${o} not defined`),(r.scriptConsole||h).debug(n);else throw(r.scriptConsole||h).error(`expression ${o} throws error`),n;return s}})}var Da=T(require("dayjs")),Zu=T(require("uuid"));B.javascriptProvider.loadModule=Ea;function Fa(e){e.hooks.replaceVariable.addHook("javascript",Aa,{before:["aws"]}),e.hooks.parse.addHook("javascript",$a,{before:["request"]}),e.hooks.execute.addInterceptor(new Yr),e.hooks.provideVariables.addHook("globalVariables",Ca),ep(),B.javascriptProvider.evalExpression=Zr,B.javascriptProvider.runScript=jt,B.javascriptProvider.isAllowedKeyword=qa}function ep(){Object.assign(B.javascriptProvider.require,{httpyac:ws,dayjs:Da.default,uuid:Zu})}le.core=ji;le.dotenv=Ui;le.http=pa;le.intellij=Ha;le.injection=ca;le.javascript=Fa;le.assert=bn;var Ps=require("hookpoint");async function ks(e){let t=!1;return No(e)?t=await rp(e):Uo(e)?t=await Ia(e):t=await op(e),t}async function rp(e){let t=await Ke(e);return await He(t)?await e.httpRegion.execute(t,!0):!1}async function Ia(e){let t=await Ke(e);if(await He(t)){e.progress&&(e.progress.divider=e.httpRegions.length);let r=!0;for(let o of e.httpRegions){let s=await o.execute(t,!0);r=r&&s}return r}return!1}async function op(e){let t=[];for(let r of e.httpFile.httpRegions)e.httpRegionPredicate&&!e.httpRegionPredicate(r)?h.debug(`${r.symbol.name} disabled by predicate`):r.isGlobal()||t.push(r);return await Ia({...e,httpRegions:t})}async function Ke(e){return Object.assign(e,{variables:await ja(e),options:{}})}async function ja(e){e.config=await tt(e.config,e.httpFile);let t=await e.httpFile.hooks.provideVariables.trigger(e.activeEnvironment,e);if(t===Ps.HookCancel)return e.variables||{};let r={...e.variables},o=Object.assign(e.variables||{},...t.map(s=>Yt(s)),r);return h.debug("current environment variables",o),o}async function sp(e){e.config=await tt(e.config,e.httpFile);let t=await e.httpFile.hooks.provideEnvironments.trigger(e);return t!==Ps.HookCancel&&t.length>0?t.reduce((r,o)=>{for(let s of o)r.indexOf(s)<0&&r.push(s);return r},[]).sort():[]}function Mt(e,t){return e+t}function eo(e,t){let r=[];for(let o of e)r.push(Vt(o,t));return{_meta:{version:"1.1.0"},requests:r,summary:np(r)}}function np(e){return{totalRequests:e.length,skippedRequests:e.filter(t=>t.summary.skippedTests>0).length,failedRequests:e.filter(t=>t.summary.failedTests>0).length,successRequests:e.filter(t=>t.summary.failedTests+t.summary.erroredTests+t.summary.skippedTests===0).length,erroredRequests:e.filter(t=>t.summary.erroredTests>0).length,totalTests:e.map(t=>t.summary.totalTests).reduce(Mt,0),failedTests:e.map(t=>t.summary.failedTests).reduce(Mt,0),successTests:e.map(t=>t.summary.successTests).reduce(Mt,0),erroredTests:e.map(t=>t.summary.erroredTests).reduce(Mt,0),skippedTests:e.map(t=>t.summary.skippedTests).reduce(Mt,0)}}function Vt(e,t){var o,s,n,i,a,l,d,u,p,c,m,y,v,H;let r=t.output;return t.outputFailed&&((s=(o=e.testResults)==null?void 0:o.some)!=null&&s.call(o,x=>!x.status))&&(r=t.outputFailed),{fileName:f.fsPath(e.filename)||f.toString(e.filename),response:ip(e.response,r),name:w((n=e.metaData)==null?void 0:n.name)||e.symbol.name,line:e.symbol.startLine,title:w((i=e.metaData)==null?void 0:i.title),description:w((a=e.metaData)==null?void 0:a.description),testResults:e.testResults,timestamp:new Date(performance.timeOrigin+e.start).toISOString(),duration:e.duration,summary:{totalTests:((l=e.testResults)==null?void 0:l.length)||0,failedTests:((u=(d=e.testResults)==null?void 0:d.filter)==null?void 0:u.call(d,x=>x.status==="FAILED").length)||0,successTests:((c=(p=e.testResults)==null?void 0:p.filter)==null?void 0:c.call(p,x=>x.status==="SUCCESS").length)||0,erroredTests:((y=(m=e.testResults)==null?void 0:m.filter)==null?void 0:y.call(m,x=>x.status==="ERROR").length)||0,skippedTests:((H=(v=e.testResults)==null?void 0:v.filter)==null?void 0:H.call(v,x=>x.status==="SKIPPED").length)||0}}}function ip(e,t){var r;if(e)switch(delete e.rawHeaders,delete e.rawBody,delete e.prettyPrintBody,delete e.parsedBody,delete e.contentType,delete e.tags,t){case"body":case"response":return delete e.request,e;case"short":return delete e.body,delete e.request,e;case"none":return;case"headers":return delete e.body,(r=e.request)==null||delete r.body,e;case"exchange":default:return e}}var Ma=T(require("crypto")),Nt=T(require("fs")),Bt=T(require("path"));var Va=".uctest-deps";async function Ba(e){let t=Bt.default.join(e,Va);try{let r=await Nt.default.promises.readFile(t,"utf-8");return JSON.parse(r)}catch(r){if(r.code==="ENOENT")return;throw r}}async function Na(e,t){let r=Bt.default.join(e,Va);await Nt.default.promises.writeFile(r,JSON.stringify(t,null,2),"utf-8")}async function Ua(e,t){let{globby:r}=await import("globby"),o=(await r("**/*.http",{cwd:t})).sort(),s=Object.keys(e.files).sort();if(!lp(o,s))return{valid:!1,reason:"files_changed"};for(let[n,i]of Object.entries(e.files)){let a=Nt.default.statSync(Bt.default.join(t,n));if((a.mtimeMs!==i.mtime||a.size!==i.size)&&ap(Bt.default.join(t,n))!==i.checksum)return{valid:!1,reason:"content_changed",file:n}}return{valid:!0}}function ap(e){let t=Nt.default.readFileSync(e);return Ma.default.createHash("sha256").update(t).digest("hex")}function lp(e,t){return e.length!==t.length?!1:e.every((r,o)=>r===t[o])}var Wa=T(require("crypto")),Ss=T(require("fs")),ve=T(require("path"));var dp=/\{\{.*?\}\}/;async function Ja(e,t={}){var n;let r=ve.default.resolve(e),o=(n=t.files)!=null&&n.length?t.files:await up(r);if(o.length===0)throw new Error(`No .http files found under ${r}`);let s={version:"1.0",generated:new Date().toISOString(),rootDir:r,files:{},regions:{},regionsByName:{},importGraph:{},checksums:{},mtimes:{}};for(let i of o.sort()){let a=pp(r,i),l=Ss.default.statSync(a),d=Ss.default.readFileSync(a,"utf-8"),u=cp(d),p=[],c=new Set,m=fp(d,a,i,c,p,s),y={path:i,checksum:u,mtime:l.mtimeMs,size:l.size,imports:Array.from(c),regionIds:p,hasGlobalRegion:m};s.files[i]=y,s.importGraph[i]=y.imports,s.checksums[i]=u,s.mtimes[i]=l.mtimeMs}return yp(s.importGraph),bp(s),s}async function up(e){let{globby:t}=await import("globby");return t("**/*.http",{cwd:e})}function pp(e,t){return ve.default.isAbsolute(t)?t:ve.default.join(e,t)}function cp(e){return Wa.default.createHash("sha256").update(e).digest("hex")}function fp(e,t,r,o,s,n){var u,p;let i=e.split(/\r?\n/u),a=!1,l=_a(0),d=c=>{l.endLine=c;let m=mp(l,t,r);if(n.regions[m.id]=m,s.push(m.id),m.name){let y=n.regionsByName[m.name]||[];y.push(m.id),n.regionsByName[m.name]=y}m.isGlobal&&(a=!0)};for(let c=0;c<i.length;c+=1){let m=i[c],y=Re.exec(m);if(y){d(Math.max(c-1,l.startLine)),l=_a(c+1);let H=(p=(u=y.groups)==null?void 0:u.title)==null?void 0:p.trim();if(H){let x=Ga(`# ${H}`);x&&Ka(x,l,o,c+1,r)}continue}let v=Ga(m);v&&Ka(v,l,o,c+1,r),hp(m)&&(l.hasRequest=!0)}return d(i.length-1),a}function _a(e){return{startLine:e,endLine:e,tags:[],refs:[],forceRefs:[],hasRequest:!1}}function mp(e,t,r){let o=`${t}_${e.startLine}`,s=`${r}:${e.startLine}`;return{id:o,modelId:s,file:r,startLine:e.startLine,endLine:e.endLine,name:e.name,tags:Cs(e.tags),refs:Cs(e.refs),forceRefs:Cs(e.forceRefs),isGlobal:!e.hasRequest}}function Ga(e){var s;let t=/^\s*(#+|\/{2,})\s+@(?<key>[^\s]+)\s*(?<value>.*)$/u.exec(e);if(!((s=t==null?void 0:t.groups)!=null&&s.key))return null;let r=t.groups.key;if(!["name","tag","ref","forceRef","import"].includes(r))return null;let o=(t.groups.value||"").trim();return{key:r,value:o}}function Ka(e,t,r,o,s){switch(e.key){case"import":to(e.value,"Dynamic import not allowed",o),r.add(gp(e.value,s));break;case"name":to(e.value,"Dynamic @name not allowed",o),t.name=e.value;break;case"tag":t.tags.push(...Hs(e.value));break;case"ref":to(e.value,"Dynamic ref not allowed",o),t.refs.push(...Hs(e.value));break;case"forceRef":to(e.value,"Dynamic ref not allowed",o),t.forceRefs.push(...Hs(e.value));break;default:break}}function Hs(e){return e.split(/[,\s]+/u).map(t=>t.trim()).filter(Boolean)}function to(e,t,r){if(dp.test(e))throw new Error(`${t} (line ${r}): use literal. Found: ${e}`)}function gp(e,t){if(ve.default.isAbsolute(e))return e;let r=ve.default.dirname(t);return ve.default.normalize(ve.default.join(r,e)).split(ve.default.sep).join("/")}function hp(e){return/^\s*(GET|POST|PUT|DELETE|PATCH|OPTIONS|HEAD|TRACE|CONNECT)\s+/iu.test(e)}function yp(e){let t=[],r=new Set,o=s=>{if(t.includes(s)){let i=t.indexOf(s),a=[...t.slice(i),s];throw new Error(`Circular import: ${a.join(" \u2192 ")}`)}if(r.has(s))return;r.add(s),t.push(s);let n=e[s]||[];for(let i of n)o(i);t.pop()};Object.keys(e).forEach(o)}function bp(e){for(let t of Object.keys(e.files)){let r=Rp(t,e.importGraph),o=new Map;for(let s of r){let n=e.files[s];if(n)for(let i of n.regionIds){let a=e.regions[i];if(a!=null&&a.name){let l=o.get(a.name);if(l)throw new Error(`Duplicate @name "${a.name}" in scope of ${t}: ${l} and ${a.file}:${a.startLine}`);o.set(a.name,`${a.file}:${a.startLine}`)}}}}}function Rp(e,t){let r=[],o=[e],s=new Set;for(;o.length>0;){let n=o.shift();if(s.has(n))continue;s.add(n),r.push(n);let i=t[n]||[];for(let a of i)o.push(a)}return r}function Cs(e){return Array.from(new Set(e))}function za(e){let t=[],r=new Set,o=xp(e);for(let s of o){if(r.has(s.id))continue;let n=[],i=new Set,a=!1,l=s;for(;l&&(n.unshift(l.id),r.add(l.id),l.refs.forEach(d=>i.add(d.id)),l.forceRefs.length!==0);){if(l.forceRefs.length>1){l.forceRefs.forEach(d=>i.add(d.id)),a=!0;break}l=l.forceRefs[0]}if(!a&&n.length>1){let d=n[n.length-1];t.push({id:`chain_${n[0]}_${d}`,regionIds:n,softDeps:i})}}return vp(t)}function xp(e){let t=[],r=new Map;for(let o of Object.values(e.nodes))for(let s of o.forceRefs)r.set(s.id,(r.get(s.id)||0)+1);for(let o of Object.values(e.nodes))o.forceRefs.length>0&&!r.has(o.id)&&t.push(o);return t}function vp(e){let t=[],r=e.sort((o,s)=>s.regionIds.length-o.regionIds.length||o.id.localeCompare(s.id));for(let o of r){let s=t.find(n=>wp(n.regionIds,o.regionIds));if(s){o.softDeps.forEach(n=>s.softDeps.add(n));continue}t.push(o)}return t}function wp(e,t){return e.length<t.length?!1:t.every((r,o)=>e[o]===r)}var it=T(require("path"));var Pp={createProcessorContext:Ke,executeGlobalScripts:He};async function Ts(e,t,r,o,s={},n=Pp){var y,v;if(s.showPlan)return Op(e,t),[];let i=o.processedHttpRegions||[];o.processedHttpRegions=i;let a=Cp(r,t),l=Sp(r,t.rootDir),d=new Set,u=new Set,p=new Set,c=[],m=!!s.resumeState;for(let H of e.stages)for(let x of H.units)for(let b of x.regionIds){let k=a.get(b);if(!k)throw new Error(`Region ${b} not found in loaded http files`);if(m)if(s.resumeState&&Tp(k.httpRegion,k.httpFile,s.resumeState))m=!1;else{u.add(b);continue}if(!s.showProgress){let Z=k.httpFile.fileName,J=typeof Z=="string"?Z:((y=Z==null?void 0:Z.toString)==null?void 0:y.call(Z))||"";!p.has(J)&&o.scriptConsole&&(o.scriptConsole.info(`--------------------- ${J}  --`),p.add(J))}await Xa(k.entry.file,t,l,o,n,d);let X={...o,httpFile:k.httpFile,httpRegion:k.httpRegion,variables:o.variables||{},options:o.options||{},scriptConsole:o.scriptConsole,logResponse:o.logResponse,logStream:o.logStream},Q=performance.now(),I=i.length,Te=await k.httpRegion.execute(X,!0);u.add(b),kp(k.httpRegion,X);let fe=i.length,ie;if(fe>I?ie=i[fe-1]:(ie=Hp(k.httpRegion,k.httpFile,Q),i.push(ie)),(v=o.processedHttpRegionListener)==null||v.call(o,ie),c.push(ie),!Te)return c}return qp(e,u),c}function kp(e,t){let r=M(t.activeEnvironment),o=e.variablesPerEnv[r];o&&F(o,t)}function Hp(e,t,r){var s;let o=performance.now();return{id:e.id,filename:t.fileName,symbol:e.symbol,isGlobal:e.isGlobal(),metaData:{...e.metaData},testResults:e.testResults,request:(s=e.response)==null?void 0:s.request,response:e.response,start:r,end:o,duration:o-r}}function Cp(e,t){let r=new Map;for(let o of e)for(let s of o.httpRegions){let n=t.regions[s.id];n&&r.set(s.id,{httpRegion:s,httpFile:o,entry:n})}return r}function Sp(e,t){let r=new Map;for(let o of e){let s=Ep(o.fileName,t);s&&r.set(s,o)}return r}async function Xa(e,t,r,o,s,n){var p;let i=M(o.activeEnvironment),a=`${e}::${i}`;if(n.has(a))return;let l=t.importGraph[e]||[];for(let c of l)await Xa(c,t,r,o,s,n);let d=r.get(e);if(!d)throw new Error(`HTTP file not loaded for ${e}`);let u={...o,httpFile:d,httpRegion:d.httpRegions[0]||{},variables:o.variables||{},options:o.options||{},processedHttpRegions:[]};await s.executeGlobalScripts(u);try{if(Array.isArray(d.globalHttpRegions))for(let c of d.globalHttpRegions){let m=(p=c==null?void 0:c.variablesPerEnv)==null?void 0:p[i];m&&F(m,o)}}catch{}u.variables&&(o.variables={...o.variables||{},...u.variables}),n.add(a)}function Tp(e,t,r){let o=Lp(t);return!o||o!==r.fileName?!1:e.symbol.startLine===r.line}function Lp(e){let t=typeof e.fileName=="string"?e.fileName:e.fileName&&"toString"in e.fileName?e.fileName.toString():void 0;if(t)return it.default.isAbsolute(t)?it.default.relative(process.cwd(),t):t}function Ep(e,t){if(!e)return;let r=typeof e=="string"?e:e&&"toString"in e?e.toString():void 0;return r?(it.default.isAbsolute(r)?it.default.relative(t,r):r).split(it.default.sep).join("/"):void 0}function Ya(e,t){let r=new Set;for(let o of e.stages)for(let s of o.units)for(let n of s.regionIds){let i=t.regions[n];i&&r.add(i.file)}return r.size}function qp(e,t){let r=e.requestedRegionIds.filter(o=>!t.has(o));if(r.length>0)throw new Error(`Execution coverage failed. Missing requested regions: ${r.join(", ")}`)}function Op(e,t){let r=[];r.push("Execution Plan:"),e.stages.forEach((o,s)=>{for(let n of o.units){let i=n.type==="chain"?"chain":"region",a=n.regionIds.map(l=>{var d;return((d=t.regions[l])==null?void 0:d.name)||l}).join(" \u2192 ");r.push(`  Stage ${s+1}: [${i}] ${a} (reason: ${n.reason})`)}}),r.push(`Total: ${e.stats.totalRegions} requests`),console.info(r.join(`
`))}function Za(e){let t={};Object.values(e.regions).forEach(r=>{t[r.id]=Ap(r)});for(let r of Object.values(t)){let o=r.region;for(let s of o.refs){let n=Qa(s,o.file,e);if(!n)throw new Error(`ref "${s}" not found in scope ${o.file}`);let i=t[n.id];r.refs.push(i),i.dependents.push(r)}for(let s of o.forceRefs){let n=Qa(s,o.file,e);if(!n)throw new Error(`ref "${s}" not found in scope ${o.file}`);let i=t[n.id];r.forceRefs.push(i),i.dependents.push(r)}}return Dp(t),{nodes:t}}function Qa(e,t,r){let o=$p(t,r),s=[];for(let n of o){let i=r.files[n];if(i)for(let a of i.regionIds){let l=r.regions[a];(l==null?void 0:l.name)===e&&s.push(l)}}if(s.length===0)return null;if(s.length>1)throw new Error(`Ambiguous reference "${e}" in scope ${t}: ${s.map(n=>`${n.file}:${n.startLine}`).join(", ")}`);return s[0]}function $p(e,t){let r=[e],o=[e],s=new Set([e]);for(;o.length>0;){let n=o.shift(),i=t.importGraph[n]||[];for(let a of i)s.has(a)||(s.add(a),r.push(a),o.push(a))}return r}function Ap(e){return{id:e.id,region:e,refs:[],forceRefs:[],dependents:[]}}function Dp(e){let t=new Set,r=new Set,o=(s,n)=>{if(r.has(s.id))return;if(t.has(s.id)){let a=n.indexOf(s.id),l=[...n.slice(a),s.id];throw new Error(`Circular reference: ${l.join(" \u2192 ")}`)}t.add(s.id);let i=[...n,s.id];for(let a of[...s.refs,...s.forceRefs])o(a,i);t.delete(s.id),r.add(s.id)};Object.values(e).forEach(s=>o(s,[]))}function rl(e,t,r,o={}){let s=Fp(e,o),n=new Set(s),i=Mp(n,t,r),a=Vp(i,r);a.forEach(y=>y.regionIds.forEach(v=>i.add(v))),a.forEach(y=>y.softDeps.forEach(v=>i.add(v)));let l=el(e,i,n,a),d;try{d=tl(l,t,a)}catch(y){if(Up(y))a=[],l=el(e,i,n,a),d=tl(l,t,a);else throw y}let u=l.reduce((y,v)=>y+v.regionIds.length,0),p=l.filter(y=>y.reason==="filter_match").length,c=l.filter(y=>y.type==="chain").length,m=l.length-p-c;return{stages:d,requestedRegionIds:s,stats:{totalRegions:u,leafRegions:p,dependencyRegions:m,forceRefChains:c,requestedRegions:s.length}}}function Fp(e,t){if(t.selection&&t.selection.length>0)return t.selection.map(n=>e.regions[n]).filter(n=>!!n&&!n.isGlobal).map(n=>n.id);let r=t.filters||{},o=[],s=Object.values(e.files);for(let n of s)for(let i of n.regionIds){let a=e.regions[i];!a||a.isGlobal||jp(a,r)&&o.push(a.id)}if(o.length===0&&!Ip(r))for(let n of s)for(let i of n.regionIds){let a=e.regions[i];a&&!a.isGlobal&&o.push(a.id)}return o}function Ip(e){return!!(e.tags&&e.tags.length>0||e.names&&e.names.length>0||e.line!==void 0)}function jp(e,t){return!(t.tags&&t.tags.length>0&&!t.tags.every(r=>e.tags.includes(r))||t.names&&t.names.length>0&&(!e.name||!t.names.includes(e.name))||typeof t.line=="number"&&(t.line<e.startLine||t.line>e.endLine))}function Mp(e,t,r){let o=new Set,s=[...e],n=new Set;for(r.forEach(a=>a.regionIds.forEach(l=>n.add(l)));s.length>0;){let a=s.pop();if(o.has(a))continue;o.add(a);let l=t.nodes[a];l&&(l.refs.forEach(d=>{o.has(d.id)||s.push(d.id)}),l.forceRefs.forEach(d=>{o.has(d.id)||s.push(d.id)}))}let i=[];for(let a of r)a.regionIds.some(l=>o.has(l))&&(a.regionIds.forEach(l=>o.add(l)),a.softDeps.forEach(l=>{o.has(l)||(o.add(l),i.push(l))}));for(;i.length>0;){let a=i.pop(),l=t.nodes[a];l&&(l.refs.forEach(d=>{o.has(d.id)||(o.add(d.id),i.push(d.id))}),l.forceRefs.forEach(d=>{o.has(d.id)||(o.add(d.id),i.push(d.id))}))}return o}function Vp(e,t){return t.filter(r=>r.regionIds.some(o=>e.has(o)))}function el(e,t,r,o){let s=[],n=new Set;for(let i of o)s.push({id:i.id,type:"chain",regionIds:i.regionIds,reason:"forceRef_chain"}),i.regionIds.forEach(l=>n.add(l));return t.forEach(i=>{if(n.has(i)||!e.regions[i])return;let l=r.has(i)?"filter_match":"ref_dependency";s.push({id:i,type:"region",regionIds:[i],reason:l})}),s.sort((i,a)=>i.id.localeCompare(a.id)),s}function Bp(e){let t=new Map,r=e.slice().sort((o,s)=>s.regionIds.length-o.regionIds.length||o.id.localeCompare(s.id));for(let o of r)for(let s of o.regionIds)t.has(s)||t.set(s,o);return t}function tl(e,t,r){let o=new Map(e.map(u=>[u.id,u])),s=Np(e,r),n=new Map,i=new Map;for(let u of e)n.set(u.id,new Set),i.set(u.id,0);let a=(u,p)=>{if(u===p)return;let c=n.get(u);c&&(c.has(p)||(c.add(p),i.set(p,(i.get(p)||0)+1)))};for(let u of e){for(let p of u.regionIds){let c=t.nodes[p];if(!c)continue;[...c.refs.map(y=>y.id),...c.forceRefs.map(y=>y.id)].forEach(y=>{let v=s.get(y),H=s.get(p);v&&H&&a(v,H)})}if(u.type==="chain"){let p=r.find(c=>c.id===u.id);p==null||p.softDeps.forEach(c=>{let m=s.get(c);m&&a(m,u.id)})}}let l=[];i.forEach((u,p)=>{u===0&&l.push(p)}),l.sort();let d=[];for(;l.length>0;){let u=l.shift(),p=o.get(u);if(!p)continue;d.push({units:[p]});let c=n.get(u);c&&c.forEach(m=>{let y=(i.get(m)||0)-1;i.set(m,y),y===0&&(l.push(m),l.sort())})}if(d.length!==e.length){let u=e.map(m=>({unit:m,indegree:i.get(m.id)||0})).filter(m=>m.indegree>0).map(m=>`${m.unit.id}(${m.indegree})`),p=e.filter(m=>!u.some(y=>y.startsWith(m.id))).map(m=>m.id),c=[...u,...p].join(", ");throw new Error(`Circular reference detected in execution plan. Remaining: ${c}`)}return d}function Np(e,t){let r=new Map,o=Bp(t);for(let s of e)for(let n of s.regionIds)if(s.type==="chain")r.set(n,s.id);else{let i=o.get(n);r.set(n,i?i.id:s.id)}return r}function Up(e){return e instanceof Error&&e.message.startsWith("Circular reference detected in execution plan")}async function ol(e,t={}){if(!t.noCache){let o=await Ba(e);if(o&&(await Ua(o,e)).valid)return o}let r=await Ja(e,t);return t.noCache||await Na(e,r),r}function Ls(e){if(e.json||e.jsonl)return 1e3;if(e.silent)return 100;if(e.verbose)return 1}var Es=!1,sl={id:"bailOnFailed",beforeLoop:async function(t){if(Es){let[r]=t.args;return ne(r.httpRegion,"request skipped because of bail"),!1}return!0},onError:async function(){return Es=!0,!0},afterTrigger:async function(t){var s,n;return((n=(s=t.args[0].httpRegion.testResults)==null?void 0:s.find)==null?void 0:n.call(s,i=>["FAILED"].includes(i.status)))&&(Es=!0),!0}};var nl={id:"loggerFlush",afterLoop:async function(t){var o,s;let r=t.args[0];return(s=(o=r==null?void 0:r.scriptConsole)==null?void 0:o.flush)==null||s.call(o),!0}};var il={id:"testExitCode",onError:async function(){return process.exitCode=10,!0},afterTrigger:async function(t){let r=t.args[0];if(r.httpRegion.testResults===void 0)return!0;let o=!1,s=!1;for(let n of r.httpRegion.testResults){if(n.status==="ERROR"){o=!0;break}n.status==="FAILED"&&(s=!0)}return o?process.exitCode=19:s&&(process.exitCode=20),!0}};function al(e){return function(r){r.hooks.execute.addInterceptor(nl),r.hooks.execute.addInterceptor(il),e&&r.hooks.execute.addInterceptor(sl)}}var ll=T(require("cli-progress")),We=T(require("chalk"));var Ut=class{constructor(t,r){this.config=t;this.enabled=r;this.bar=null;this.stats={success:0,failed:0,errored:0,skipped:0};this.requestedCompleted=0;this.seenRequested=new Set;this.seenAll=new Set}start(){if(!this.enabled)return;let t=this.config.requestedRegionIds.size;this.bar=new ll.default.SingleBar({format:"Testing... {bar} {percentage}% | {requested}/{totalRequested} tests | {stats}",barCompleteChar:"\u2588",barIncompleteChar:"\u2591",hideCursor:!0,clearOnComplete:!1,stopOnComplete:!1}),this.bar.start(t,0,{requested:0,totalRequested:t,stats:We.default.gray("starting...")})}update(t){this.bar&&(this.seenAll.has(t.id)||(this.seenAll.add(t.id),this.updateStats(t)),this.config.requestedRegionIds.has(t.id)?this.seenRequested.has(t.id)||(this.seenRequested.add(t.id),this.requestedCompleted++,this.bar.update(this.requestedCompleted,{requested:this.requestedCompleted,stats:this.formatStats()})):this.bar.update(this.requestedCompleted,{stats:this.formatStats()}))}updateStats(t){let r=t.testResults||[],o=r.some(i=>i.status==="ERROR"),s=r.some(i=>i.status==="FAILED"),n=r.some(i=>i.status==="SKIPPED");o?this.stats.errored++:s?this.stats.failed++:n?this.stats.skipped++:this.stats.success++}stop(){this.bar&&this.bar.stop()}getStats(){return{...this.stats}}getTotalExecuted(){return this.seenAll.size}formatStats(){let t=[];return this.stats.success>0&&t.push(We.default.green(`${this.stats.success} \u2713`)),this.stats.failed>0&&t.push(We.default.red(`${this.stats.failed} \u2717`)),this.stats.errored>0&&t.push(We.default.red(`${this.stats.errored} \u26A0`)),this.stats.skipped>0&&t.push(We.default.yellow(`${this.stats.skipped} \u2298`)),t.join(" ")||We.default.gray("starting...")}};function qs(e){return e.json||e.jsonl||e.silent||e.verbose?!1:process.stdout.isTTY===!0}async function dl(e,t){return _p(t)?Gp(e,t):e.map(o=>({httpFile:o}))}function _p(e){return!!(e.tag&&e.tag.length>0||e.name&&e.name.length>0||e.line!==void 0)}function Gp(e,t){let r=[],o=t.tag||[],s=t.name||[],n=t.line;for(let i of e){let a=i.httpRegions.filter(l=>!(o.length>0&&!Kp(l,o)||s.length>0&&!Wp(l,s)||n!==void 0&&!Jp(l,n)));a.length>0&&r.push({httpFile:i,httpRegions:a})}return r}function Kp(e,t){var o;if(!g((o=e.metaData)==null?void 0:o.tag))return!1;let r=e.metaData.tag.split(",").map(s=>s.trim()).filter(Boolean);return r.length===0?!1:t.every(s=>r.includes(s))}function Wp(e,t){var r;return g((r=e.metaData)==null?void 0:r.name)?t.includes(e.metaData.name):!1}function Jp(e,t){return e.symbol.startLine<=t&&e.symbol.endLine>=t}function cl(){return new pl.Command("uctest").description("HTTP test runner for Unsafe Code Lab").usage("[@tag...] [:name...] [path...] [options]").argument("[args...]","Tags (@tag), names (:name), and paths").option("-k, --keep-going","continue running after failures (default: stop on first)").option("--json","use json output").option("--jsonl","stream json lines output").option("-l, --line <line>","line of the http requests",C).option("--no-color","disable color support").option("-o, --output <output>","output format of response (short, body, headers, response, exchange, none)","none").option("--output-failed <output>","output format of failed response (short, body, headers, response, exchange, none)","exchange").option("-s, --silent","log only request").option("-a, --all","run all requests including referenced dependencies (default: optimize with prune-refs)").option("--no-cache","skip cache, always rebuild dependency model").option("--show-plan","print execution plan without running").option("-r, --resume","resume from last failed request").option("--state-file <path>","path to state file for resume (default: .uctest-state)").option("--timeout <timeout>","maximum time allowed for connections",C).option("--var  <variables...>",'list of variables (e.g foo="bar")').option("-v, --verbose","make the operation more talkative").action(Xp)}function zp(e){let t=[],r=[],o=[];for(let s of e)if(s.startsWith("@")){let n=s.slice(1);n&&(n.includes(",")&&(console.error(`Error: Commas not supported in tags. Use separate arguments: @${n.split(",").join(" @")}`),process.exit(1)),t.push(n))}else if(s.startsWith(":")){let n=s.slice(1);n&&r.push(n)}else o.push(s);return{tags:t,names:r,paths:o}}async function Xp(e,t){var m,y;let r=zp(e);r.tags.length>0&&(t.tag=r.tags),r.names.length>0&&(t.name=r.names);let o=r.paths.length>0?r.paths:["./**/*.http"],s=!t.keepGoing,n=qs(t),i=lc(t),{httpFiles:a,config:l,httpFileStore:d}=await uc(o,s,i.config||{});i.config=l,dc(t,i,n);let u=(0,A.join)(process.cwd(),".uctest-state"),p=t.resume?t.stateFile||u:void 0,c=p?await ac(p):void 0;try{if(a.length>0){let v=await dl(a,t);if(v.length===0&&(console.error("No tests match the specified filters"),process.exit(1)),!t.all){await rc(a,d,v,i,t,c,p,s);return}c&&(v=nc(v,c),c=void 0);let H=Qp(v,a),x=H.totalRequests,b=H.totalFiles,k=ec(v),X=new Ut({requestedRegionIds:k},n),Q=0,I=t.jsonl?gl():void 0;t.jsonl?(I==null||I({type:"start",totalRequests:x,totalFiles:b}),i.processedHttpRegionListener=J=>{Q+=1,I==null||I({type:"request",index:Q,totalRequests:x,request:Vt(J,t)})}):n?i.processedHttpRegionListener=J=>{X.update(J)}:i.processedHttpRegionListener=void 0,i.processedHttpRegions=[],X.start();let Te=v.map(({httpFile:J,httpRegions:de})=>async function(){!t.json&&!n&&i.scriptConsole&&i.scriptConsole.info(`--------------------- ${J.fileName}  --`),await ks(Object.assign({},i,{httpFile:J,httpRegions:de}))});await _o(1,...Te),X.stop(),n&&console.info("");let fe=i.processedHttpRegions||[],ie=s?yl(fe):void 0;if(t.jsonl){Q=ml(fe,t,I,Q,x);let J=eo(fe,t);I==null||I({type:"summary",totalRequests:x,totalFiles:b,summary:J.summary})}else fl(i,t,{showFailureDetails:n,bailEnabled:s});let Z=t.stateFile||(0,A.join)(process.cwd(),".uctest-state");s&&ie?await Rl(Z,ie):t.resume&&await xl(Z)}else console.error(`uctest cannot find any .http files matching: ${o.join(", ")}`)}finally{(y=(m=i.scriptConsole)==null?void 0:m.flush)==null||y.call(m)}}function fl(e,t,r={}){let o=e.processedHttpRegions||[],s=eo(o,t);if(t.json)console.info(j(s,2));else if(e.scriptConsole){let n=s.summary.failedRequests>0||s.summary.erroredRequests>0;r.showFailureDetails&&n&&r.bailEnabled&&Yp(o),e.scriptConsole.info("---------------------");let i=[];s.summary.successRequests>0&&i.push(W.default`{green ${s.summary.successRequests} succeeded}`),s.summary.failedRequests>0&&i.push(W.default`{red ${s.summary.failedRequests} failed}`),s.summary.erroredRequests>0&&i.push(W.default`{red ${s.summary.erroredRequests} errored}`),s.summary.skippedRequests>0&&i.push(W.default`{yellow ${s.summary.skippedRequests} skipped}`),e.scriptConsole.info(W.default`{bold ${s.summary.totalRequests}} requests processed (${i.join(", ")})`)}}function Yp(e){var r,o,s,n,i;let t=e.filter(a=>{var l;return(l=a.testResults)==null?void 0:l.some(d=>d.status==="ERROR"||d.status==="FAILED")});if(t.length!==0){console.info(W.default.red.bold("\u2550\u2550\u2550 Test Failure \u2550\u2550\u2550"));for(let a of t){let l=f.fsPath(a.filename)||f.toString(a.filename),d=(0,A.isAbsolute)(l)?(0,A.relative)(process.cwd(),l):l,u=w((r=a.metaData)==null?void 0:r.name)||((o=a.symbol)==null?void 0:o.name)||"unnamed",p=(s=a.symbol)==null?void 0:s.startLine;if(console.info(""),console.info(W.default.red(`\u2717 ${u}`)),console.info(W.default.gray(`  ${d}${p?`:${p}`:""}`)),a.request){let y=a.request.method||"GET",v=a.request.url||"";console.info(W.default.cyan(`  ${y} ${v}`))}if((n=a.response)!=null&&n.statusCode){let y=a.response.statusCode,v=y>=400?W.default.red:W.default.green;console.info(W.default.gray(`  Response: ${v(y)}`))}let c=new Set,m=((i=a.testResults)==null?void 0:i.filter(y=>y.status==="ERROR"||y.status==="FAILED"))||[];for(let y of m){if(c.has(y.message))continue;c.add(y.message);let v=y.status==="ERROR"?"\u26A0":"\u2717",H=y.status==="ERROR"?W.default.yellow:W.default.red;console.info(H(`  ${v} ${y.message}`))}}console.info(""),console.info(W.default.gray("Resume state saved. Run with --resume (-r) to restart."))}}function ml(e,t,r,o,s){if(!r)return o;for(let n=o;n<e.length;n+=1)r({type:"request",index:n+1,totalRequests:s,request:Vt(e[n],t)});return Math.max(o,e.length)}function gl(){return e=>{process.stdout.write(`${j(e)}
`)}}function Qp(e,t){var a,l,d,u,p;let r=new Map,o=new Map;for(let c of t)for(let m of c.httpRegions){o.set(m,c);let y=w((a=m.metaData)==null?void 0:a.name);if(!y)continue;let v=r.get(y)||[];v.push(m),r.set(y,v)}let s=new Set,n=new Set,i=[];for(let{httpFile:c,httpRegions:m}of e){let y=m??c.httpRegions;for(let v of y)((l=v.metaData)==null?void 0:l.disabled)===!0||(d=v.metaData)!=null&&d.skip||i.push(v)}for(;i.length>0;){let c=i.pop();if(!c||s.has(c))continue;s.add(c);let m=o.get(c);m&&n.add(m);for(let y of sc(c)){let v=r.get(y);if(v)for(let H of v)((u=H.metaData)==null?void 0:u.disabled)===!0||(p=H.metaData)!=null&&p.skip||i.push(H)}}return{totalRequests:s.size,totalFiles:n.size}}function Zp(e){var r,o;let t=[];for(let{httpFile:s,httpRegions:n}of e){let i=n??s.httpRegions;for(let a of i)((r=a.metaData)==null?void 0:r.disabled)===!0||(o=a.metaData)!=null&&o.skip||a.isGlobal()||t.push(a.id)}return t}function ec(e){var r,o;let t=new Set;for(let{httpFile:s,httpRegions:n}of e){let i=n??s.httpRegions;for(let a of i)((r=a.metaData)==null?void 0:r.disabled)===!0||(o=a.metaData)!=null&&o.skip||a.isGlobal()||t.add(a.id)}return t}async function tc(e,t,r,o,s){let n=new Map;for(let d of r){let u=hl(d.fileName,t.rootDir);u&&n.set(u,d)}let i=new Set;for(let d of e.stages)for(let u of d.units)for(let p of u.regionIds){let c=t.regions[p];c&&i.add(c.file)}let a=Array.from(i);for(;a.length>0;){let d=a.pop();if(!d)continue;let u=t.importGraph[d]||[];for(let p of u)i.has(p)||(i.add(p),a.push(p))}let l={workingDir:process.cwd(),config:s};for(let d of Array.from(i)){if(n.has(d))continue;let u=(0,A.join)(t.rootDir,d),p=await o.getOrCreate(u,async()=>await at.promises.readFile(u,"utf8"),0,l);n.set(d,p),r.push(p)}return l.config}async function rc(e,t,r,o,s,n,i,a){var Z,J;let l=Zp(r),d=oc(e),u=await ol(d,{noCache:s.noCache}),p=Za(u),c=za(p),m=rl(u,p,c,{selection:l,filters:{tags:s.tag,names:s.name,line:s.line}});if(s.showPlan){await Ts(m,u,e,o,{showPlan:!0});return}o.options={...o.options||{},skipRefResolution:!0},o.processedHttpRegions=[];let y=m.requestedRegionIds[0]||((J=(Z=m.stages[0])==null?void 0:Z.units[0])==null?void 0:J.regionIds[0]);if(y){let de=u.regions[y];if(de){let ro=e.find(_t=>hl(_t.fileName,u.rootDir)===de.file);if(ro){let _t=await Ke({...o,httpFile:ro});_t.variables&&(o.variables={...o.variables||{},..._t.variables})}}}let v=await tc(m,u,e,t,o.config);o.config=v||o.config;let H=m.stats.totalRegions,x=Ya(m,u),b=new Set(m.requestedRegionIds),k=qs(s),X=new Ut({requestedRegionIds:b},k),Q=0,I=s.jsonl?gl():void 0;s.jsonl?(I==null||I({type:"start",totalRequests:H,totalFiles:x}),o.processedHttpRegionListener=de=>{Q+=1,I==null||I({type:"request",index:Q,totalRequests:H,request:Vt(de,s)})}):k?o.processedHttpRegionListener=de=>{X.update(de)}:o.processedHttpRegionListener=void 0,X.start(),await Ts(m,u,e,o,{resumeState:n,showProgress:k}),X.stop(),k&&console.info("");let Te=o.processedHttpRegions||[],fe=a?yl(Te):void 0;if(s.jsonl){Q=ml(Te,s,I,Q,H);let de=eo(Te,s);I==null||I({type:"summary",totalRequests:H,totalFiles:x,summary:de.summary})}else fl(o,s,{showFailureDetails:k,bailEnabled:a});let ie=i||s.stateFile||(0,A.join)(process.cwd(),".uctest-state");a&&fe?await Rl(ie,fe):s.resume&&await xl(ie)}function hl(e,t){if(!e)return;let r=f.fsPath(e)||f.toString(e);return r?((0,A.isAbsolute)(r)?(0,A.relative)(t,r):r).split(A.sep).join("/"):void 0}function yl(e){return e.find(t=>{var r;return(r=t.testResults)==null?void 0:r.some(o=>o.status==="ERROR"||o.status==="FAILED")})}function oc(e){let t=e.map(i=>f.fsPath(i.fileName)||f.toString(i.fileName)).filter(i=>!!i).map(i=>(0,A.isAbsolute)(i)?i:(0,A.resolve)(process.cwd(),i));if(t.length===0)return process.cwd();let r=(0,A.parse)(t[0]).root||process.cwd(),o=t.map(i=>{let a=(0,A.parse)(i).dir,l=(0,A.relative)(r,a);return l?l.split(A.sep).filter(Boolean):[]}),s=Math.min(...o.map(i=>i.length)),n=[];for(let i=0;i<s;i+=1){let a=o[0][i];if(o.every(l=>l[i]===a))n.push(a);else break}return(0,A.join)(r,...n)}function sc(e){var o,s;let t=[],r=[(o=e.metaData)==null?void 0:o.ref,(s=e.metaData)==null?void 0:s.forceRef];for(let n of r){if(!n||n===!0)continue;let i=w(n);if(!i)continue;let a=i.split(/[,\s]+/u).map(l=>l.trim()).filter(Boolean);t.push(...a)}return t}function nc(e,t){var s,n;let r=[],o=!0;for(let i of e){let a=i.httpRegions??i.httpFile.httpRegions,l=bl(i.httpFile.fileName),d=[];for(let u of a)((s=u.metaData)==null?void 0:s.disabled)===!0||(n=u.metaData)!=null&&n.skip||(o?ic(l,u,t)&&(o=!1,d.push(u)):d.push(u));if(d.length>0){let u=a===i.httpFile.httpRegions&&d.length===a.length;r.push({httpFile:i.httpFile,httpRegions:u?void 0:d})}}return o?e:r}function ic(e,t,r){return!e||e!==r.fileName?!1:t.symbol.startLine===r.line}function bl(e){if(!e)return;let t=f.fsPath(e)||f.toString(e);if(t)return(0,A.isAbsolute)(t)?(0,A.relative)(process.cwd(),t):t}async function ac(e){try{let t=await at.promises.readFile(e,"utf-8");return JSON.parse(t)}catch(t){t.code!=="ENOENT"&&console.warn(`Failed to read resume state from ${e}:`,t);return}}async function Rl(e,t){var s;let r=bl(t.filename);if(!r)return;let o={fileName:r,line:t.symbol.startLine,name:w((s=t.metaData)==null?void 0:s.name)};await at.promises.writeFile(e,j(o,2))}async function xl(e){try{await at.promises.unlink(e)}catch(t){t.code!=="ENOENT"&&console.warn(`Failed to clear resume state at ${e}:`,t)}}function lc(e){return{config:{log:{level:Ls(e)},request:{timeout:e.timeout}},variables:e.var?Object.fromEntries(e.var.map(r=>{let o=r.split("=");return[o[0],o.slice(1).join("=")]})):void 0,options:{}}}function dc(e,t,r=!1){if(e.jsonl)return;let o=new ze({level:Ls(e)});if(o.collectMessages(),t.scriptConsole=o,!e.json){t.logStream=cc(e);let s=fc(e,t.config,o);t.logResponse=async(n,i)=>{s&&await s(n,i),r||o.flush()}}}async function uc(e,t,r){let o=[],s=new Ot({cli:al(t)}),n={workingDir:process.cwd(),config:r},i=[];for(let a of e)i.push(...await pc(a));for(let a of i){let l=await s.getOrCreate(a,async()=>await at.promises.readFile(a,"utf8"),0,n);o.push(l)}return{httpFiles:o,config:n.config,httpFileStore:s}}async function pc(e){let t={gitignore:!0},{globby:r}=await import("globby"),o=await r(e,t);return o&&o.length>0||A.sep==="/"?o:await r(e.replace(/\\/gu,"/"),t)}function cc(e){if(e.output!=="none")return async function(r,o){let s=Buffer.isBuffer(o.body)?o.body.toString("utf-8"):o.body;console.info(`${new Date().toLocaleTimeString()} - ${r}: `,s)}}function fc(e,t,r){var i,a;let o={responseBodyPrettyPrint:!0},s=ul(e.output,o,(i=t==null?void 0:t.log)==null?void 0:i.options),n=ul(e.outputFailed,o,(a=t==null?void 0:t.log)==null?void 0:a.options);if(s||n)return mo(l=>r.logPriority(l),s,n)}function ul(e,...t){let r;switch(e){case"body":r={responseBodyLength:0};break;case"headers":r={requestOutput:!0,requestHeaders:!0,responseHeaders:!0};break;case"response":r={responseHeaders:!0,responseBodyLength:0};break;case"none":return;case"short":r={useShort:!0};break;case"timings":r={timings:!0};break;case"exchange":r={requestOutput:!0,requestHeaders:!0,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0,timings:!0};break;default:r={requestOutput:!0,requestHeaders:!0,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0};break}return Object.assign({},...t,r)}async function wl(){let e=await wt((0,vl.join)(__dirname,"../package.json")),t=cl();return t.version((e==null?void 0:e.version)||"0.0.1"),t}async function mc(e){try{await Ko(),await(await wl()).parseAsync(e)}catch(t){throw console.error(t),process.exitCode||(process.exitCode=1),t}finally{process.exit()}}0&&(module.exports={AbstractRequestClient,ExecuteHook,HookCancel,HttpSymbol,HttpSymbolKind,LogLevel,OnRequestHook,OnResponseHook,OnStreaming,ParseEndRegionHook,ParseHook,ParseMetaDataHook,ProvideAssertValue,ProvideEnvironmentsHook,ProvideVariablesHook,RepeatOrder,ReplaceVariableHook,RequestClientEvent,ResponseLoggingHook,TestResultStatus,VariableType,cli,createEmptyProcessorContext,getEnvironments,getVariables,io,send,store,testSymbols,utils});
//# sourceMappingURL=index.js.map
