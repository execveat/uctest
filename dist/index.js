"use strict";var hl=Object.create;var Bt=Object.defineProperty;var yl=Object.getOwnPropertyDescriptor;var bl=Object.getOwnPropertyNames;var xl=Object.getPrototypeOf,Rl=Object.prototype.hasOwnProperty;var it=(e,t)=>{for(var r in t)Bt(e,r,{get:t[r],enumerable:!0})},Ss=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of bl(t))!Rl.call(e,s)&&s!==r&&Bt(e,s,{get:()=>t[s],enumerable:!(o=yl(t,s))||o.enumerable});return e};var L=(e,t,r)=>(r=e!=null?hl(xl(e)):{},Ss(t||!e||!e.__esModule?Bt(r,"default",{value:e,enumerable:!0}):r,e)),vl=e=>Ss(Bt({},"__esModule",{value:!0}),e);var ys={};it(ys,{AbstractRequestClient:()=>gt,ExecuteHook:()=>Le,HookCancel:()=>mt,HttpSymbol:()=>P,HttpSymbolKind:()=>_,LogLevel:()=>Ue,OnRequestHook:()=>He,OnResponseHook:()=>Ce,OnStreaming:()=>Se,ParseEndRegionHook:()=>ut,ParseHook:()=>at,ParseMetaDataHook:()=>lt,ProvideAssertValue:()=>dt,ProvideEnvironmentsHook:()=>ct,ProvideVariablesHook:()=>pt,RepeatOrder:()=>Qr,ReplaceVariableHook:()=>ft,RequestClientEvent:()=>ue,ResponseLoggingHook:()=>Te,TestResultStatus:()=>Z,VariableType:()=>oe,cli:()=>Cs,createEmptyProcessorContext:()=>Ne,getEnvironments:()=>Yu,getVariables:()=>Oa,io:()=>V,send:()=>xs,store:()=>Go,testSymbols:()=>X,utils:()=>x});module.exports=vl(ys);var Cs={};it(Cs,{createProgram:()=>gl,execute:()=>nc,initFileProvider:()=>en,initIOProvider:()=>Bo});var ml=require("path");var x={};it(x,{ENVIRONMENT_NONE:()=>As,HandlebarsSingleLine:()=>kt,OAuth2Regex:()=>id,RegionSeparator:()=>me,addHttpFileRequestClientHooks:()=>Pt,addSkippedTestResult:()=>te,addTestResultToHttpRegion:()=>Re,assertHasNoResponseBody:()=>bo,assertHasResponseBody:()=>yo,assertHeaderContains:()=>ho,assertHeaderEquals:()=>go,assertMaxTotalTime:()=>mo,assertResponseBodyEquals:()=>xo,assertStatusEquals:()=>fo,cleanVariables:()=>Wt,cloneRequest:()=>qs,cloneResponse:()=>ce,createResponseProxy:()=>Jt,decodeJWT:()=>ao,defaultConfigFiles:()=>Gt,deleteHeader:()=>io,deleteVariableInContext:()=>De,distinct:()=>wl,ensureString:()=>Nt,equalsPath:()=>vo,errorToString:()=>_l,executeGlobalScripts:()=>ve,executeRequestClientFactory:()=>So,expandVariable:()=>Fs,extensionName:()=>Ro,findHttpRegionInContext:()=>Ie,findRootDir:()=>Ut,findRootDirOfFile:()=>xt,getBufferEncoding:()=>We,getDisplayName:()=>wt,getHeader:()=>$,getHeaderArray:()=>Ol,getHeaderBoolean:()=>El,getHeaderNumber:()=>ql,getHeaderString:()=>Ll,getHttpyacConfig:()=>wo,getMarkdownSyntax:()=>Gs,getPartOfBody:()=>uo,getPlugins:()=>Po,getRegionDescription:()=>To,importHttpFileInContext:()=>St,isBufferEncoding:()=>Os,isError:()=>ie,isHttpRegionSendContext:()=>Io,isHttpRegionsSendContext:()=>jo,isHttpRequest:()=>A,isHttpRequestMethod:()=>Tl,isHttpResponse:()=>po,isMimeTypeCSS:()=>ro,isMimeTypeFormUrlEncoded:()=>qe,isMimeTypeHtml:()=>to,isMimeTypeImage:()=>Cl,isMimeTypeJSON:()=>yt,isMimeTypeJavascript:()=>Zr,isMimeTypeMarkdown:()=>bt,isMimeTypeMultiPartFormData:()=>oo,isMimeTypeMultiPartMixed:()=>so,isMimeTypeNewlineDelimitedJSON:()=>no,isMimeTypePdf:()=>Hl,isMimeTypeXml:()=>eo,isOpenIdInformation:()=>sd,isProcessorContext:()=>nd,isPromise:()=>Je,isString:()=>m,isStringEmpty:()=>Ee,isUndefined:()=>Ge,iterateDirectoryTree:()=>_t,iterateUntilRoot:()=>xe,joinMarkdown:()=>zt,knownMetaData:()=>Xs,logResponse:()=>Fe,mergeRawHttpHeaders:()=>Il,mergeResponses:()=>Kt,parseComments:()=>Ht,parseContentType:()=>Oe,parseDefaultHeadersFactory:()=>Oo,parseError:()=>$e,parseFileImport:()=>Ct,parseHandlebarsString:()=>U,parseHandlebarsSymbols:()=>ae,parseInlineResponse:()=>Do,parseJson:()=>Rt,parseMimeType:()=>ht,parseQueryLineFactory:()=>Ao,parseRequestHeaderFactory:()=>Yt,parseRequestLineFactory:()=>Fo,parseSubsequentLines:()=>Xt,parseUrlLineFactory:()=>$o,promiseQueue:()=>Mo,randomArrayValue:()=>Vo,randomData:()=>Tt,randomEmail:()=>ze,randomText:()=>J,repeat:()=>ko,replaceFilePath:()=>fe,replaceInvalidChars:()=>jl,replaceVariables:()=>j,report:()=>q,requestLoggerFactory:()=>lo,resolveClientCertificates:()=>$s,setVariableInContext:()=>D,shortenFileName:()=>Ml,shrinkCloneResponse:()=>co,sleep:()=>we,stateGenerator:()=>Pl,stringifySafe:()=>F,testFactory:()=>vt,testFactoryAsync:()=>Ho,toAbsoluteFilename:()=>N,toBoolean:()=>be,toBufferLike:()=>pe,toEnvironmentKey:()=>I,toHttpString:()=>rd,toHttpStringHeader:()=>Lo,toHttpStringRequest:()=>Us,toHttpStringResponse:()=>Ns,toMarkdown:()=>od,toMarkdownHeader:()=>Eo,toMarkdownMeta:()=>Js,toMarkdownRequest:()=>Ks,toMarkdownResponse:()=>_s,toMarkdownTestResults:()=>Ws,toMarkdownTimings:()=>zs,toMultiLineArray:()=>ee,toMultiLineString:()=>G,toNumber:()=>C,toQueryParams:()=>$l,toString:()=>v,unsetVariableInContext:()=>Kl,useDefaultOnError:()=>Ae});function wl(e){function t(r,o,s){return s.indexOf(r)===o}return e.filter(t)}var K=L(require("chalk")),Es=require("util");var V={};it(V,{Logger:()=>_e,completionItemProvider:()=>z,fileProvider:()=>c,httpClientProvider:()=>de,javascriptProvider:()=>T,log:()=>g,userInteractionProvider:()=>O});var z={emptyLineProvider:[],variableProvider:[],requestHeaderProvider:[]};var c={EOL:`\r
`,exists:()=>{throw new Error("Not Implemented")},dirname:()=>{throw new Error("Not Implemented")},hasExtension:()=>{throw new Error("Not Implemented")},isAbsolute:()=>{throw new Error("Not Implemented")},joinPath:()=>{throw new Error("Not Implemented")},readFile:()=>{throw new Error("Not Implemented")},readBuffer:()=>{throw new Error("Not Implemented")},writeBuffer:()=>{throw new Error("Not Implemented")},readdir:()=>{throw new Error("Not Implemented")},fsPath:Ts,toString:Ts};function Ts(e){return typeof e=="string"?e:e.toString()}var de={};var T={require:{},evalExpression:async function(t,r){return r.variables[t]}};var W=require("hookpoint"),at=class extends W.LastOutHook{constructor(){super(t=>!!t),this.id="ParseHook"}},lt=class extends W.LastOutHook{constructor(){super(t=>!!t),this.id="ParseMetaDataHook"}},dt=class extends W.LastOutHook{constructor(){super(t=>t!==!1),this.id="ProvideAssertValue"}},ut=class extends W.SeriesHook{constructor(){super(),this.id="ParseEndRegionHook"}},pt=class extends W.SeriesHook{constructor(){super(),this.id="ProvideVariablesHook"}},ct=class extends W.SeriesHook{constructor(){super(),this.id="ProvideEnvironmentsHook"}},ft=class extends W.WaterfallHook{constructor(){super(t=>t===void 0),this.id="ReplaceVariableHook"}},He=class extends W.SeriesHook{constructor(){super(),this.id="BeforeRequestHook"}},Ce=class extends W.SeriesHook{constructor(){super(),this.id="AfterRequestHook"}},Se=class extends W.SeriesHook{constructor(){super(),this.id="OnStreaming"}},Te=class extends W.SeriesHook{constructor(){super(),this.id="ResponseLoggingHook"}},Le=class extends W.SeriesHook{constructor(){super(t=>!t),this.id="ExecuteHook"}};var Ls=require("hookpoint"),mt=Ls.HookCancel;var P=class{constructor(t){this.name=t.name||"symbol",this.description=t.description,this.kind=t.kind,this.startLine=t.startLine,this.startOffset=t.startOffset,this.endLine=t.endLine,this.endOffset=t.endOffset,this.children=t.children,this.source=t.source}getSymbolsForLine(t){let r=[];if((this.startLine<=t||this.endLine>=t)&&(r.push(this),this.children))for(let o of this.children)r.push(...o.getSymbolsForLine(t));return r}filter(t){let r=[];if(t(this)&&r.push(this),this.children)for(let o of this.children)r.push(...o.filter(t));return r}};var _=(y=>(y.request="request",y.requestLine="requestLine",y.requestHeader="requestHeader",y.requestBody="requestBody",y.response="response",y.gql="gql",y.proto="proto",y.script="script",y.metaData="metaData",y.comment="comment",y.url="url",y.operator="operator",y.key="key",y.value="value",y.variable="variable",y.path="path",y.variableDefinition="variableDefinition",y.text="text",y))(_||{});var Ue=(i=>(i[i.trace=1]="trace",i[i.debug=2]="debug",i[i.warn=5]="warn",i[i.info=10]="info",i[i.error=100]="error",i[i.none=1e3]="none",i))(Ue||{});var Qr=(r=>(r[r.sequential=0]="sequential",r[r.parallel=1]="parallel",r))(Qr||{});var ue=class extends Event{constructor(r,o){super(r);this.detail=o}},gt=class{constructor(){this.eventEmitter=new EventTarget}addEventListener(t,r){this.eventEmitter.addEventListener(t,o=>this.isRequestClientEvent(o)?r(o):void 0)}removeEventListener(t,r){this.eventEmitter.removeEventListener(t,o=>this.isRequestClientEvent(o)?r(o):void 0)}isRequestClientEvent(t){return t instanceof ue}onMessage(t,r){this.eventEmitter.dispatchEvent(new ue("message",[t,r]))}onProgress(t){this.eventEmitter.dispatchEvent(new ue("progress",t))}onMetaData(t,r){this.eventEmitter.dispatchEvent(new ue("metaData",[t,r]))}onDisconnect(){this.eventEmitter.dispatchEvent(new ue("disconnect",void 0))}triggerEnd(){this.eventEmitter.dispatchEvent(new ue("end",void 0))}};var X={ok:"\u2713",error:"\u2716",skipped:"\u25CB"};var Z=(s=>(s.SUCCESS="SUCCESS",s.FAILED="FAILED",s.SKIPPED="SKIPPED",s.ERROR="ERROR",s))(Z||{});var oe=(s=>(s.variable="Variable",s.url="Url",s.body="Body",s.filePath="FilePath",s))(oe||{});var _e=class{constructor(t,r){this.options=t;this.parentLogger=r}collectMessages(){var t;(t=this.parentLogger)==null||t.collectMessages(),this.collectCache=[],this.priorityCache=[]}flush(){var t;(t=this.parentLogger)==null||t.flush(),this.priorityCache=this.flushCache(this.priorityCache),this.collectCache=this.flushCache(this.collectCache)}flushCache(t){if(t){for(let r of t)r();return[]}}writeLog(t,r,o,s){var n,i;if(!((n=this.options)!=null&&n.level)||t>=this.options.level){let a=()=>o(...s);(i=this.options)!=null&&i.logMethod&&(a=()=>{var l,d;return(d=(l=this.options)==null?void 0:l.logMethod)==null?void 0:d.call(l,t,...s)}),r?r.push(a):a()}}info(...t){var r;(r=this.parentLogger)==null||r.info(...t),this.writeLog(10,this.collectCache,console.info,t)}log(...t){var r;(r=this.parentLogger)==null||r.log(...t),this.writeLog(10,this.collectCache,console.log,t)}trace(...t){var r;(r=this.parentLogger)==null||r.trace(...t),this.writeLog(1,this.collectCache,this.options.noTrace?console.debug:console.trace,t)}debug(...t){var r;(r=this.parentLogger)==null||r.debug(...t),this.writeLog(2,this.collectCache,console.debug,t)}error(...t){var r;(r=this.parentLogger)==null||r.error(...t),this.writeLog(100,this.collectCache,console.error,t)}warn(...t){var r;(r=this.parentLogger)==null||r.warn(...t),this.writeLog(5,this.collectCache,console.warn,t)}logPriority(...t){this.writeLog(10,this.priorityCache,console.info,t)}clear(){console.clear()}},g=new _e({level:5,noTrace:!0});var O={isTrusted:()=>!0,showNote:async function(){throw new Error("Not Implemented")},showInputPrompt:async function(){throw new Error("Not Implemented")},showListPrompt:async function(){throw new Error("Not Implemented")}};function G(e){return e.join(c.EOL)}function ee(e){return e.split(/\r?\n/gu)}function Ge(e){return typeof e>"u"}function m(e){return typeof e=="string"}function Ee(e){return typeof e=="string"&&/^(\s*)?$/u.test(e)}function Pl(e=30){let t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-._~",r=[];for(let o=e;o>0;--o)r.push(t[Math.floor(Math.random()*t.length)]);return r.join("")}function v(e){if(m(e))return e;if(typeof e=="number")return`${e}`;if(e instanceof Date)return e.toISOString();if(e instanceof Error)return e.message;if(Buffer.isBuffer(e))return e.toString("utf-8");if(Array.isArray(e)&&e.every(t=>Buffer.isBuffer(t))){let t=e.map(r=>Buffer.isBuffer(r)&&r.toString("utf8"));return F(t)}if(e)return F(e)}function F(e,t=0){try{return JSON.stringify(e,(r,o)=>kl(o)?Buffer.from(o.data).toString("base64"):o,t)}catch(r){return g.debug("JSON.stringify error",r),JSON.stringify(e,(()=>{let s=new WeakSet;return(n,i)=>{if(typeof i=="object"&&i!==null){if(s.has(i))return;s.add(i)}return i}})(),t)}}function Nt(e){return typeof e>"u"||e===null||m(e)?e:`${e}`}function kl(e){let t=e;return(t==null?void 0:t.type)==="Buffer"&&Array.isArray(t.data)&&!!t.data.length}function be(e,t=!1){var s;if(typeof e=="boolean")return e;if(typeof e=="number")return!!e;let r=(s=Nt(e))==null?void 0:s.trim();if(!r)return t;if(/^true$/iu.test(r))return!0;if(/^false$/iu.test(r))return!1;let o=parseFloat(r);return isNaN(o)?t:!!o}function C(e){if(typeof e=="number")return e;let t=Nt(e);if(t){let r=Number.parseFloat(t.trim());if(!Number.isNaN(r))return r}}function pe(e){return Buffer.isBuffer(e)?e:v(e)}function ht(e){var n,i;let[t,...r]=e.split(";").map(a=>a.trim()),o=(n=r.find(a=>a.startsWith("charset=")))==null?void 0:n.split("=")[1],s=(i=r.find(a=>a.startsWith("boundary=")))==null?void 0:i.split("=")[1];return{mimeType:t,contentType:e,charset:o,boundary:s}}function yt(e){return!!e&&(e.mimeType==="application/json"||e.mimeType==="text/json"||e.mimeType.indexOf("+json")>=0||e.mimeType.indexOf("x-amz-json")>=0)}function Zr(e){return(e==null?void 0:e.mimeType)==="application/javascript"||(e==null?void 0:e.mimeType)==="text/x-javascript"}function eo(e){return!!e&&(e.mimeType==="application/xml"||e.mimeType==="text/xml"||e.mimeType.indexOf("+xml")>=0)}function to(e){return(e==null?void 0:e.mimeType)==="text/html"}function ro(e){return(e==null?void 0:e.mimeType)==="text/css"}function bt(e){return(e==null?void 0:e.mimeType)==="text/markdown"}function oo(e){return(e==null?void 0:e.mimeType)==="multipart/form-data"}function so(e){return(e==null?void 0:e.mimeType)==="multipart/mixed"}function no(e){return(e==null?void 0:e.mimeType)==="application/x-ndjson"}function qe(e){return(e==null?void 0:e.mimeType)==="application/x-www-form-urlencoded"}function Hl(e){return(e==null?void 0:e.mimeType)==="application/pdf"}function Cl(e){return e?["image/jpeg","image/gif","image/webp","image/png","image/bmp"].indexOf(e.mimeType)>=0:!1}function Tl(e){return e?["ACL","BASELINE-CONTROL","CHECKIN","CHECKOUT","CONNECT","COPY","DELETE","GET","GRAPHQL","HEAD","LOCK","MERGE","MKACTIVITY","MKCALENDAR","MKCOL","MKWORKSPACE","MOVE","OPTIONS","PATCH","POST","PROPFIND","PROPPATCH","PUT","REPORT","SEARCH","TRACE","UNLOCK","VERSION-CONTROL"].includes(e.toUpperCase()):!1}function A(e){return(e==null?void 0:e.protocol)==="HTTP"}function io(e,...t){if(e)for(let r of t){let o=Object.entries(e).find(([s])=>s.toLowerCase()===r.toLowerCase());o&&o.length>1&&delete e[o[0]]}}function Ll(e,t){let r=$(e,t);if(m(r))return r}function El(e,t,r=!1){let o=$(e,t);return be(o,r)}function $(e,t){if(e){let r=Object.entries(e).find(([o])=>o.toLowerCase()===t.toLowerCase());if(r&&r.length>1)return r[1]}}function ql(e,t){let r=$(e,t);return C(r)}function Ol(e,t,r=[]){let o=$(e,t);return o?m(o)?[o]:o:r}function Oe(e){let t=$(e,"content-type");if(m(t))return ht(t)}function ao(e){try{let t=e.split(".");if(t.length!==3)return null;let r=t[1];switch(r=r.replace(/-/gu,"+"),r=r.replace(/_/gu,"/"),r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:return null}let o=new Es.TextDecoder().decode(Buffer.from(r,"base64"));return JSON.parse(o)}catch(t){return g.warn(t),null}}function $l(e){return Object.entries(e).filter(([,t])=>!!t).map(([t,r])=>Array.isArray(r)?r.map(o=>`${t}=${encodeURIComponent(o||"")}`).join("&"):`${t}=${encodeURIComponent(r||"")}`).join("&")}function lo(e,t,r){return async function(s,n){var l,d,u,p,f,h,b,k,H,R;let i=t;if(r&&(n!=null&&n.testResults)&&n.testResults.some(y=>["FAILED","ERROR"].includes(y.status))&&(i=r),!i||i.onlyFailed&&(!(n!=null&&n.testResults)||n.testResults.every(y=>y.status==="SUCCESS")))return;if(e(""),e("---------------------"),e(""),(l=n==null?void 0:n.metaData)!=null&&l.title||(d=n==null?void 0:n.metaData)!=null&&d.name||(u=n==null?void 0:n.metaData)!=null&&u.description){let y=((p=n==null?void 0:n.metaData)==null?void 0:p.title)||((f=n==null?void 0:n.metaData)==null?void 0:f.name);y&&e(K.default`{gray === ${y} ===}`),(h=n==null?void 0:n.metaData)!=null&&h.description&&e(K.default`{gray ${n.metaData.description}}`),e("")}let a=(s==null?void 0:s.request)||(n==null?void 0:n.request);if(a&&(i.useShort?e(K.default`{yellow ${(a==null?void 0:a.method)||"GET"}} {gray ${(a==null?void 0:a.url)||"?"}}`):i.requestOutput&&Al(a,{headers:i.requestHeaders,bodyLength:i.requestBodyLength}).forEach(y=>e(y))),s)if(i.useShort)e(K.default`{gray =>} {cyan.bold ${s.statusCode}} ({yellow ${((b=s.timings)==null?void 0:b.total)||"?"} ms}, {yellow ${((k=s.meta)==null?void 0:k.size)||"?"}})`);else{let y=[];if(i.responseHeaders&&(y.length>0&&y.push(""),y.push(...Dl(s))),i.timings&&(y.length>0&&y.push(""),y.push(...Fl(s))),m(s.body)&&i.responseBodyLength!==void 0){let w=s.body;i.responseBodyPrettyPrint&&s.prettyPrintBody&&(w=s.prettyPrintBody),w=uo(w,i.responseBodyLength),w&&(y.length>0&&y.push(""),y.push(w))}e(G(y))}if(n!=null&&n.testResults)for(let y of n.testResults){let w=K.default`{green ${X.ok} ${y.message||"Test passed"}}`;if(y.status==="SKIPPED")w=K.default`{yellow ${X.skipped} Test skipped}`;else if(["ERROR","FAILED"].includes(y.status)){let B=y.error?` (${(H=y.error)==null?void 0:H.displayMessage})`:"";if(w=K.default`{red ${X.error} ${y.message||"Test failed"}${B}}`,!(t!=null&&t.useShort)&&y.status==="ERROR"&&((R=y.error)!=null&&R.error.stack)){let Q=ee(y.error.error.stack).slice(0,3);w=G([w,...Q])}}e(w)}}}function uo(e,t){let r=e;if(!(typeof t>"u"||t<0))return t>0&&(r=e.slice(0,Math.min(e.length,t)),e.length>=t&&(r+=`... (${e.length-t} characters more)`)),r}function Al(e,t){var o,s,n,i;let r=[];return r.push(K.default`{cyan.bold ${e.method} ${e.url}}`),e.headers&&t.headers&&r.push(...Object.entries(e.headers).map(([a,l])=>K.default`{yellow ${a}}: ${l}`).sort()),A(e)&&((s=(o=e.options)==null?void 0:o.https)!=null&&s.certificate||(i=(n=e.options)==null?void 0:n.https)!=null&&i.pfx)&&r.push(K.default`{yellow client-cert}: true`),m(e.body)&&t.bodyLength!==void 0&&(r.push(""),r.push(K.default`{gray ${uo(e.body,t.bodyLength)}}`)),r}function Dl(e){let t=[];return t.push(K.default`{cyan.bold ${e.protocol}} {cyan.bold ${e.statusCode}} {bold ${e.statusMessage?` - ${e.statusMessage}`:""}}`),e.headers&&t.push(...Object.entries(e.headers).filter(([r])=>!r.startsWith(":")).map(([r,o])=>K.default`{yellow ${r}}: ${o}`).sort()),t}function Fl(e){let t=[];return e.timings&&(t.push(K.default`{cyan.bold Timings}:`),t.push(...Object.entries(e.timings).filter(([,r])=>!!r).map(([r,o])=>K.default`{yellow ${r}}: ${o}`).sort())),t}function qs(e){return{url:e.url,method:e.method,body:e.body,contentType:e.contentType&&{...e.contentType},headers:e.headers&&{...e.headers},supportsStreaming:e.supportsStreaming}}function po(e){let t=e;return!!(t!=null&&t.statusCode)}function co(e){let t=ce(e);return delete t.rawBody,delete t.prettyPrintBody,delete t.request,t}function ce(e){return{name:e.name,protocol:e.protocol,statusCode:e.statusCode,statusMessage:e.statusMessage,httpVersion:e.httpVersion,headers:e.headers,body:e.body,rawHeaders:e.rawHeaders,rawBody:e.rawBody,parsedBody:e.parsedBody,prettyPrintBody:e.prettyPrintBody,contentType:e.contentType,timings:e.timings&&{...e.timings},meta:e.meta,tags:e.tags,request:e.request&&qs(e.request)}}function Il(e){let t={};for(let r=0;r<e.length;r+=2){let o=e[r],s=e[r+1];if(typeof s>"u")continue;let n=o.toLowerCase();t[n]=t[n]||[],t[n].push(s)}return t}function Ke(e,t){if(!e)throw new Error(t)}function fo(e,t){Ke(e.statusCode===t,`response status is ${e.statusCode} (expected: ${t})`)}function mo(e,t){var r,o;Ke((r=e.timings)!=null&&r.total?e.timings.total<t:!0,`total time is ${(o=e.timings)==null?void 0:o.total} (expected max ${t})`)}function go(e,t,r){let o=$(e.headers,t);Ke(o===r,`response header ${t} is ${o} (expected: ${r})`)}function ho(e,t,r){let o=$(e.headers,t);(m(o)||Array.isArray(o))&&Ke(!!o.indexOf(r),`response header contains ${r}`)}function yo(e){console.assert(!!e.body,"response body exists")}function bo(e){Ke(!e.body,"response body does not exists")}function xo(e,t){Ke(e.body===t,`response body equals ${t}`)}function Os(e){return["ascii","utf8","utf-8","utf16le","ucs2","ucs-2","base64","latin1","binary","hex"].indexOf(e)>=0}function We(e){return e&&Os(e)?e:"utf8"}async function N(e,t){if(e){if(await c.isAbsolute(e)&&await c.exists(e))return e;if(t&&m(e)){let r=c.joinPath(t,e);if(await c.exists(r))return r}}}function Ro(e){let t=c.toString(e),r=t.lastIndexOf(".");if(r>0&&r<t.length-2)return t.slice(r+1)}function jl(e){return e.replace(/[/\\?%*:|"<>\s()@\-~,=$]/gu,"_").split("_").filter(r=>r.length>0).join("_")}function Ml(e,t=50){let r=[],o=0;for(let n of e.split("_").reverse())n.length+o<t?(r.push(n),o+=n.length+1):r.length===0&&r.push(n);let s=r.reverse().join("_");return s.slice(Math.max(s.length-t,0))}async function xt(e,t,...r){let o=e,s=c.fsPath(e);!await c.isAbsolute(e)&&t&&s&&(o=c.joinPath(t,s));let n=c.dirname(o);return await Ut(n,...r)}async function Ut(e,...t){return _t(e,async r=>{let o=await c.readdir(r);if(o.some(s=>t.indexOf(s)>=0))return!0;for(let s of t)if(o.some(n=>s.startsWith(n))&&await c.exists(c.joinPath(r,s)))return!0;return!1})}async function xe(e,t,r){return _t(e,async o=>(await r(o),!!t&&vo(t,o)))}async function _t(e,t){if(e){if(await t(e))return e;if(!vo(c.dirname(e),e))return _t(c.dirname(e),t)}}function vo(e,t){return!!e&&!!t&&c.toString(e)===c.toString(t)}async function wo(e,t){let r;return t&&(r=await Vl(t),r||(r=await Bl(e,t)),r&&await $s(r,t)),r}var Gt=[".httpyac.js",".httpyac.cjs",".httpyac.config.js",".httpyac.config.cjs","httpyac.config.js","httpyac.config.cjs",".httpyac.json","httpyac.config.json"];async function Vl(e){let t;for(let r of Gt){let o=r&&c.joinPath(e,r);if(o&&await c.exists(o)){t=c.fsPath(o);break}}if(t){let r=c.fsPath(e);if(r&&T.loadModule){let o=T.loadModule(t,r,!0);return typeof o=="function"?o():o}}}async function Bl(e,t){let r=[];if(await xe(e,t,async o=>{var n;let s=(n=await Rt(c.joinPath(o,"package.json")))==null?void 0:n.httpyac;s&&r.push(s)}),r.length>0)return Object.assign({},...r.reverse())}async function Rt(e){try{if(await c.exists(e)){let t=await c.readFile(e,"utf-8");return JSON.parse(t)}}catch(t){g.debug(`json parse of ${e} failed`,t)}}async function $s(e,t){if(e.clientCertificates)for(let[,r]of Object.entries(e.clientCertificates))r.cert&&(r.cert=await N(r.cert,t)||r.cert),r.key&&(r.key=await N(r.key,t)||r.key),r.pfx&&(r.pfx=await N(r.pfx,t)||r.pfx)}async function Po(e){let t=await Nl(e),r={};if(t!=null&&t.json){let o=[...Object.keys(t.json.dependencies||{}),...Object.keys(t.json.devDependencies||{})].filter(Ul);for(let s of o){let n=c.fsPath(t.dir);if(n&&T.loadModule){let i=T.loadModule(s,n);i&&(r[s]=i)}}}return r}async function Nl(e){let t=await Ut(e,"package.json");if(t)return{dir:t,json:await Rt(c.joinPath(t,"package.json"))}}function Ul(e){return/^(httpyac-|@[\w-]+(\.)?[\w-]+\/httpyac-)plugin-/u.test(e)}var As="__NONE__";function I(e){return e&&e.length>0?e.sort().join(","):As}function ie(e){if(!e)return!1;if(e instanceof Error)return!0;let t=e;return!!t.message&&!!t.stack&&!!t.name}function $e(e){var t;if(e.stack){let r=/^(?<error>.*):\s*(?<message>.*)\r?\n\s*at (?<file>.*):(?<line>\d*):(?<offset>\d*)/mu.exec(e.stack);if(r&&((t=r.groups)!=null&&t.error))return{error:e,errorType:r.groups.error,message:r.groups.message,file:r.groups.file,line:r.groups.line,offset:r.groups.offset,displayMessage:`${r.groups.error}: ${r.groups.message} - ${r.groups.file}:${r.groups.line}:${r.groups.offset}`}}return{error:e,displayMessage:e.message}}function _l(e){return ie(e)?F({message:e.message,name:e.name,stack:e.stack}):v(e)}async function Ae(e,t){try{return await e}catch(r){return g.warn("promise has read error",r),t}}var Bs=require("hookpoint");var Co=require("hookpoint");function q(e,t){var r,o;g.debug(t),(o=(r=e.progress)==null?void 0:r.report)==null||o.call(r,{message:t})}async function ko(e,t){var n,i;let r=[],o=1;(n=t.repeat)!=null&&n.count&&t.isMainContext&&(o=t.repeat.count);for(let a=0;a<o;a++)r.push(e);let s=[];if(((i=t.repeat)==null?void 0:i.type)===1){let a=await Promise.all(r.map(l=>l()));for(let l of a)l&&a.push(l)}else for(let a of r){let l=await a();l&&s.push(l)}return Kt(s)}function Kt(e){if(e.length>1){let t=ce(e[0]);delete t.prettyPrintBody,delete t.rawBody,delete t.meta,delete t.timings;let r={responses:[],statusCount:{},count:e.length},o=[];for(let s of e){s.statusCode>t.statusCode&&(t.statusCode=s.statusCode,t.statusMessage=s.statusMessage);let n=`${s.statusCode}`;r.statusCount[n]?r.statusCount[n]+=1:r.statusCount[n]=1,s.timings&&o.push(s.timings),delete s.prettyPrintBody,delete s.parsedBody,delete s.rawBody,r.responses.push(ce(s)),o.length>0&&(t.timings=Gl(o))}return t.parsedBody=r,t.body=F(r,2),t}return e.pop()}function Gl(e){let t=[],r=[],o=[],s=[],n=[],i=[],a=[],l=[];for(let u of e)t.push(u.dns||0),r.push(u.download||0),o.push(u.firstByte||0),s.push(u.request||0),n.push(u.tcp||0),i.push(u.tls||0),a.push(u.total||0),l.push(u.wait||0);let d=u=>{let p=u.filter(f=>f>0);if(p.length>0)return p.reduce((f,h)=>f+h,0)/p.length};return{dns:d(t),download:d(r),firstByte:d(o),request:d(s),tcp:d(n),tls:d(i),total:d(a),wait:d(l)}}var Ds=require("hookpoint");async function j(e,t,r){var o,s;return(s=(o=r.progress)==null?void 0:o.isCanceled)!=null&&s.call(o)?(g.trace("process canceled by user"),Ds.HookCancel):await r.httpFile.hooks.replaceVariable.trigger(e,t,r)}async function fe(e,t,r){var s,n,i,a;let o=await j(e,"FilePath",t);if(m(o)){let l=await N(o,c.dirname(t.httpFile.fileName));if(l)return await r(l);let d=`file not found: ${e}`;(n=(s=O).showWarnMessage)==null||n.call(s,d),g.warn(d)}else{let l=`file replace made file invalid: ${e} <> ${o}`;(a=(i=O).showWarnMessage)==null||a.call(i,l),g.warn(l)}}function Fs(e,t){if(e&&m(e)){let r=e,o,s=/\{{2}\s*([a-zA-Z0-9_]+)\s*\}{2}/gu;for(;(o=s.exec(r))!==null;){let[n,i]=o,a=Fs(t[i],t);t[i]=a,r=r.replace(n,()=>`${a}`)}return r}return e}function D(e,t){if(e){let r=Wt(e);Object.assign(t.variables,r);let o=I(t.activeEnvironment);t.httpRegion.variablesPerEnv[o]||(t.httpRegion.variablesPerEnv[o]={}),Object.assign(t.httpRegion.variablesPerEnv[o],r)}}function Wt(e){return Object.fromEntries(Object.entries(e).filter(([t])=>!T.isAllowedKeyword||T.isAllowedKeyword(t)))}function De(e,t){delete t.variables[e];let r=I(t.activeEnvironment);t.httpRegion.variablesPerEnv[r]&&delete t.httpRegion.variablesPerEnv[r][e]}function Kl(e,t){let r=I(t.activeEnvironment),o=t.httpRegion.variablesPerEnv[r];for(let s of Object.keys(e))delete t.variables[s],o&&delete o[s]}var Ms=require("uuid");function Ho({httpRegion:e},t){return async function(o,s){var i;let n={message:o,status:"SUCCESS"};if(typeof s=="function")try{await s(n)}catch(a){Is(n,a),t.ignoreErrorFile&&((i=n.error)!=null&&i.errorType)&&(n.error.displayMessage=`${n.error.errorType}: ${n.error.message}`)}Re(e,n)}}function Is(e,t){e.status="FAILED",ie(t)?e.error=$e(t):e.error={displayMessage:`${t}`,error:new Error(`${t}`)}}function vt({httpRegion:e,variables:t}){let r=function(n,i){let a={message:n,status:"SUCCESS"};if(typeof i=="function")try{i()}catch(l){Is(a,l)}Re(e,a)};function o(){return po(t.response)?t.response:e.response}return r.status=s=>{let n=o();n&&r(`response status equals to ${s}`,()=>fo(n,s))},r.totalTime=s=>{let n=o();n&&r(`total time exceeded ${s}`,()=>mo(n,s))},r.header=(s,n)=>{let i=o();i&&r(`response header ${s} equals ${n}`,()=>go(i,s,n))},r.headerContains=(s,n)=>{let i=o();i&&r(`response header ${s} contains ${n}`,()=>ho(i,s,n))},r.responseBody=s=>{let n=o();n&&r(`response body equals ${s}`,()=>xo(n,s))},r.hasResponseBody=()=>{let s=o();s&&r("response body exists",()=>yo(s))},r.hasNoResponseBody=()=>{let s=o();s&&r("response body does not exists",()=>bo(s))},r}function Re(e,t){e.testResults||(e.testResults=[]),e.testResults.push(t)}function te(e,t="request is skipped"){Re(e,{message:t,status:"SKIPPED"})}function So(e,t){return async function(r){var s;let{request:o}=r;if(o!=null&&o.url){if(!await Ql(r))return!1;let n=e(o,r);D({$requestClient:n},r),r.requestClient=n;let i=Jl(n,r),a=((s=n.getSessionId)==null?void 0:s.call(n))||(0,Ms.v4)(),l=td(t,a,o,()=>{n.disconnect(new Error("user cancellation"))});try{let d=[];zl(n,r),Xl(n,r,d),Yl(n,r,d),q(r,n.reportMessage);let u=await n.connect(l.connection);g.debug(`requestClient ${o.url} connect`),l.connectionCount++,u!==l.connection&&(l.connection=u),await Promise.all([ko(()=>n.send(),r),Zl(r).then(()=>{var h;(h=n.streamEnded)==null||h.call(n)})]);let p=await Promise.all(d),f=Kt(Wl(...p));return f&&!await ed(f,r)?!1:(l.connectionCount--,js(t,l)&&(g.debug(`requestClient ${o.url} disconnect`),n.disconnect()),!0)}catch(d){throw l.connectionCount--,js(t,l)&&((r.scriptConsole||g).error(r.request),g.debug(`requestClient ${o.url} disconnect`),ie(d)?n.disconnect(d):n.disconnect(new Error(v(d)))),d}finally{n.triggerEnd(),i==null||i(),delete r.requestClient,De("$requestClient",r)}}return!1}}function Wl(...e){let t=[];for(let r of e)r&&t.push(r);return t}function Jl(e,t){var r,o;if((r=t.progress)!=null&&r.register)return(o=t.progress)==null?void 0:o.register(()=>{te(t.httpRegion,"user cancellation"),e.disconnect(new Error("user cancellation"))})}function zl(e,t){var r;if(t.isMainContext&&((r=t.progress)!=null&&r.report)){let o=0;e.addEventListener("progress",s=>{var a;let n=s.detail,i=n-o;if(o=n,(a=t.progress)!=null&&a.report){g.trace(`progress to ${n}`);let l=t.progress.divider||1;t.progress.report({message:"request progress",increment:i/l*100})}})}}function Xl(e,t,r){e.addEventListener("message",o=>{let[s,n]=o.detail;g.debug(s,(n==null?void 0:n.message)||(n==null?void 0:n.body)),r.push(Promise.resolve(n)),e.supportsStreaming&&!t.httpRegion.metaData.noStreamingLog&&t.logStream&&r.push(t.logStream(s,{...n}))})}function Yl(e,t,r){e.addEventListener("metaData",o=>{let[s,n]=o.detail;g.debug(`event ${s} for ${n.protocol}`,(n==null?void 0:n.message)||(n==null?void 0:n.body)),t.httpRegion.metaData.metaDataLogging&&t.logStream&&r.push(t.logStream(s,n))})}async function Ql(e){let t=e.hooks.onRequest;return e.progress&&t.addInterceptor(Vs(()=>{var r;return!!((r=e.progress)!=null&&r.isCanceled())})),e.request&&await t.trigger(e.request,e)!==Co.HookCancel}async function Zl(e){let t=e.hooks.onStreaming;e.progress&&t.addInterceptor(Vs(()=>{var r;return!!((r=e.progress)!=null&&r.isCanceled())})),await t.trigger(e)}async function ed(e,t){return await t.hooks.onResponse.trigger(Jt(e),t)===Co.HookCancel?!1:(t.httpRegion.response=e,!0)}function Vs(e){return{id:"isCanceled",async beforeTrigger(){return!e()},async afterTrigger(){return!e()}}}function Jt(e){return new Proxy(e,{set(...r){let[o,s,n]=r,i=Reflect.set(...r);return s==="body"&&(delete o.prettyPrintBody,delete o.parsedBody,delete o.rawBody,typeof n=="string"&&(o.rawBody=Buffer.from(n))),i}})}function td(e,t,r,o){let s=e.getUserSession(t);if(s!=null&&s.connection)return s;let n={id:t,description:"Pending Connection",details:{method:r.method,url:r.url},title:`${r.method} ${r.url}`,type:"Stream",connectionCount:0,delete:o};return e.setUserSession(n),n}function js(e,t){return t.connectionCount<=0&&(delete t.delete,e.removeUserSession(t.id)),t.connectionCount===0}function wt(e,t="global"){var r,o,s,n;if(e){if(m(e.metaData.title))return e.metaData.title;if(m(e.metaData.name))return e.metaData.name;if((r=e.request)!=null&&r.url){let i=e.request.url.indexOf("?");i<0&&(i=e.request.url.length);let a=((n=(s=(o=e.symbol.children)==null?void 0:o.find)==null?void 0:s.call(o,l=>l.kind==="requestLine"))==null?void 0:n.startLine)||e.symbol.startLine;return`${e.request.method} ${e.request.url.slice(0,i)} (line: ${a+1})`}}return t}function To(e,t="-"){var r;return m(e.metaData.description)?e.metaData.description:(r=e.request)!=null&&r.url?`${e.request.method} ${e.request.url}`:t}async function Fe(e,t){let r;e&&(r=ce(e),await t.hooks.responseLogging.trigger(Jt(r),t)===Bs.HookCancel)||!t.httpRegion.metaData.noLog&&t.logResponse&&await t.logResponse(r,t.httpRegion)}async function ve(e){for(let t of e.httpFile.globalHttpRegions)if(!await t.execute(e))return!1;return!0}function Pt(e,t){return{onRequest:t.hooks.onRequest.merge(...t.globalHttpRegions.map(r=>r.hooks.onRequest),e.onRequest),onResponse:t.hooks.onResponse.merge(e.onResponse,...t.globalHttpRegions.map(r=>r.hooks.onResponse)),onStreaming:t.hooks.onStreaming.merge(e.onStreaming,...t.globalHttpRegions.map(r=>r.hooks.onStreaming)),responseLogging:t.hooks.responseLogging.merge(e.responseLogging,...t.globalHttpRegions.map(r=>r.hooks.responseLogging))}}function rd(e,t){let r=[];return e.request&&(r.push(...Us(e.request,{body:!!(t!=null&&t.requestBody)})),r.push("")),r.push(...Ns(e,{prettyPrint:!!(t!=null&&t.prettyPrint),body:!!(t!=null&&t.responseBody)})),G(r)}function Ns(e,t){let r=[];return r.push(`${e.protocol} ${e.statusCode} ${e.statusMessage?` - ${e.statusMessage}`:""}`),e.headers&&r.push(...Lo(e.headers)),t!=null&&t.body&&m(e.body)&&(r.push(""),r.push(t!=null&&t.prettyPrint&&e.prettyPrintBody?e.prettyPrintBody:e.body)),r}function Us(e,t){let r=[];return r.push(`${e.method} ${e.url}`),e.headers&&r.push(...Lo(e.headers)),t!=null&&t.body&&m(e.body)&&(r.push(""),r.push(e.body)),r}function Lo(e){return Object.entries(e).map(([t,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):m(r)||(o=F(r))),`${t}: ${o}`})}function od(e,t){let r=[];return e.request&&(r.push(...Ks(e.request,{body:!!(t!=null&&t.requestBody)})),r.push("")),r.push(..._s(e,{prettyPrint:!!(t!=null&&t.prettyPrint),body:!!(t!=null&&t.responseBody)})),t!=null&&t.testResults&&(r.push(""),r.push(""),r.push(...Ws(t.testResults))),t!=null&&t.timings&&e.timings&&(r.push(""),r.push(""),r.push(...zs(e.timings))),t!=null&&t.meta&&e.meta&&(r.push(""),r.push(""),r.push(...Js(e.meta))),zt(r)}function _s(e,t){let r=[];if(r.push(`\`${e.protocol} ${e.statusCode}${e.statusMessage?` - ${e.statusMessage}`:""}\``),e.headers&&r.push(...Eo(e.headers)),t!=null&&t.body&&m(e.body)){r.push(""),r.push(`\`\`\`${Gs(e.contentType)}`);let o=t.prettyPrint&&e.prettyPrintBody?e.prettyPrintBody:e.body;r.push(zt(ee(o))),r.push("```")}return r}function Gs(e){return yt(e)?"json":eo(e)?"xml":to(e)?"html":Zr(e)?"js":ro(e)?"css":bt(e)?"markdown":""}function Ks(e,t){let r=[];return r.push(`\`${e.method} ${e.url}\``),e.headers&&r.push(...Eo(e.headers)),t!=null&&t.body&&m(e.body)&&(r.push(""),r.push("```json"),r.push(zt(ee(e.body))),r.push("```")),r}function Ws(e){let t=[];t.push("`TestResults`"),t.push("");for(let r of e){let o=`${X.ok}: ${r.message}`;r.status==="SKIPPED"?o=`${X.skipped}: ${r.message}`:["FAILED","ERROR"].includes(r.status)&&(o=`${X.error}: ${r.message}`,r.error&&(o+=` (${r.error.displayMessage})`)),t.push(o)}return t}function Eo(e){return Object.entries(e).map(([t,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):m(r)||(o=F(r))),`*${t}*: ${o}`}).sort()}function Js(e){let t=[];t.push("`Meta`"),t.push("");for(let[r,o]of Object.entries(e))Array.isArray(o)?o.length>0&&t.push(`*${r}*: ${o.join(",")}`):t.push(`*${r}*: ${o}`);return t}function zs(e){let t=[];return t.push("`Timings`"),t.push(""),e.wait&&t.push(`*Wait*: ${e.wait} ms`),e.dns&&t.push(`*DNS*: ${e.dns} ms`),e.tcp&&t.push(`*TCP*: ${e.tcp} ms`),e.tls&&t.push(`*TLS*: ${e.tls} ms`),e.request&&t.push(`*Request*: ${e.request} ms`),e.firstByte&&t.push(`*First Byte*: ${e.firstByte} ms`),e.download&&t.push(`*Download*: ${e.download} ms`),e.total&&t.push(`*Total*: ${e.total} ms`),t}function zt(e){return e.join(`  ${c.EOL}`)}function sd(e){let t=e;return!!(t!=null&&t.accessToken)}function nd(e){let t=e;return!!(t!=null&&t.httpRegion)&&!!(t!=null&&t.httpFile)&&!!(t!=null&&t.variables)&&!!(t!=null&&t.config)}var kt=/\{{2}\s*(.+?)\s*\}{2}/gu,me=/^\s*#{3,}(?<title>.*)$/u,id=/^\s*(?<type>openid|oauth2)(\s+(?<flow>client(_credentials)?|(authorization_)?code|device(_code)?|password|implicit|hybrid))?(\s+(?<variablePrefix>[^\s]*))?\s*((token_exchange)\s+(?<tokenExchangePrefix>[^\s]*))?\s*$/iu;async function Xt(e,t,r){let o={parseResults:[]},s=e.next();for(;!s.done;){let n=!1;for(let i of t){let a=await i(s.value,r);if(a){o.parseResults.push(a),n=!0;break}}if(!n)break;o.nextLine=s.value.line,s=e.next()}return o}function Yt(e){return async function(r){var s;let o=/^\s*(?<key>[!#$%&'*+\-.^_`|~0-9A-Za-z]+)\s*:\s*(?<value>.*?),?\s*$/u.exec(r.textLine);if((s=o==null?void 0:o.groups)!=null&&s.key){let n=o.groups.key,i=o.groups.value,a=e[n];a?Array.isArray(a)?a.push(i):e[n]=[a,i]:e[n]=i;let l=r.textLine.indexOf(i);return{symbols:[new P({name:n,description:i,kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.length,children:[new P({name:n,description:"request header key",kind:"key",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.indexOf(n)+n.length}),i?new P({name:i,description:"request header value",kind:"value",startLine:r.line,startOffset:l,endLine:r.line,endOffset:l+i.length,children:ae(i,r.line,l)}):void 0].filter(d=>!!d)})]}}return!1}}function Oo(e=(t,r)=>{r.request&&(r.request.headers?Object.assign(r.request.headers,t):r.request.headers=t)}){return async function(r,o){var n;let s=/^\s*\.{3}(?<variableName>[^\s]+),?\s*$/u.exec(r.textLine);if((n=s==null?void 0:s.groups)!=null&&n.variableName){let i=new qo(s.groups.variableName,e);o.httpRegion.hooks.execute.addObjHook(l=>l.process,i);let a=r.textLine.trim();return{symbols:[new P({name:a||"hader variable",description:"Header Variable",kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(a),endOffset:r.textLine.length,endLine:r.line,children:[new P({name:s.groups.variableName,description:"Header Variable",kind:"variable",startLine:r.line,startOffset:s.index,endOffset:s.groups.variableName.length,endLine:r.line})]})]}}return!1}}var qo=class{constructor(t,r){this.data=t;this.setHeaders=r;this.id="defaultHeaders"}async process(t){if(this.data&&t.variables){q(t,"set request headers");let r=await T.evalExpression(this.data,t);r&&this.setHeaders(Object.assign({},r),t)}return!0}};function $o(e){return async function(r){if(/^\s*(\/)[^*]*$/u.test(r.textLine)){let o=r.textLine.trim();return e(o),{symbols:[new P({name:o||"URL Part",description:"URL Part",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line,children:ae(r.textLine,r.line)})]}}return!1}}function Ao(e){return async function(r){if(/^\s*(\?|&)((([^(=?&)]+)=(.*))|\{\{.*\}\})\s*$/u.test(r.textLine)){let o=r.textLine.trim();return e(o),{symbols:[new P({name:o||"Query",description:"Query",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line,children:ae(r.textLine,r.line,0)})]}}return!1}}async function Ht(e,t,r=/^\s*((#\s+)|(\/{2}))/u){var o;if(r.test(e.textLine)){let s={symbols:[new P({name:"comment",description:e.textLine,kind:"metaData",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length})]},n=/^\s*(#+|\/{2,})\s+@(?<key>[^\s]*)(\s+)?"?(?<value>.*)?"?$/u.exec(e.textLine);if(n&&n.groups&&n.groups.key){let i=n.groups.key.replace(/-./gu,l=>l[1].toUpperCase());s.symbols[0].children=[new P({name:i||"metadata",description:n.groups.value||"-",kind:"metaData",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:[new P({name:i||"metadata key",description:((o=Xs.find(l=>l.name===i))==null?void 0:o.description)||"key of meta data",kind:"key",startLine:e.line,startOffset:e.textLine.indexOf(n.groups.key),endLine:e.line,endOffset:e.textLine.indexOf(n.groups.key)+n.groups.key.length})]})];let a;n.groups.value&&(a=n.groups.value.trim(),s.symbols[0].children.push(new P({name:n.groups.value||"metadata value",description:"value of meta data",kind:"value",startLine:e.line,startOffset:e.textLine.indexOf(n.groups.value),endLine:e.line,endOffset:e.textLine.indexOf(n.groups.value)+n.groups.value.length}))),t.httpRegion.metaData=Object.assign(t.httpRegion.metaData||{},{[i]:a||!0}),await t.httpFile.hooks.parseMetaData.trigger(i,a,t)}return s}return!1}var Xs=[{name:"name",description:"responses of a requests with a name are automatically added as variables and can be reused by other requests",completions:["${1}"]},{name:"debug",description:"enable debug log level"},{name:"description",description:"additional description of region",completions:["${1}"]},{name:"disabled",description:"requests can be disabled"},{name:"extension",description:"extension of file for save or openWith.",completions:["${1}"]},{name:"forceRef",description:"When the request is called, it is ensured that the referenced request is always called beforehand",completions:["${1}"]},{name:"import",description:"reference Requests from other files.",completions:["${1}"]},{name:"injectVariables",description:"Inject Variables in request body (needed because of compatibility with Intellij)."},{name:"jwt",description:"supports auto decode of jwt token."},{name:"language",description:"language id of the response view",completions:["${1}"]},{name:"loop",description:"allows multiple Invocations of a Request with different parameters.",completions:["for ${1} of ${2}","for ${1}","while ${1}"]},{name:"keepStreaming",description:"keep streaming until the user session is ended manually"},{name:"noLog",description:"prevent logging of request data in output console"},{name:"noCookieJar",description:"cookieJar support is disabled for this request"},{name:"noClientCert",description:"SSL client certificate is not send for this request"},{name:"noProxy",description:"disable proxy for this request"},{name:"noRejectUnauthorized",description:"all invalid SSL certificates will be ignored and no error will be thrown."},{name:"noResponseView",description:"prevent output in editor document."},{name:"noStreamingLog",description:"prevent logging of streaming request data in output console"},{name:"note",description:"shows a confirmation dialog before sending request",completions:["${1}"]},{name:"openWith",description:"viewType of custom editor to preview files",completions:["${1}"]},{name:"ref",description:"When the request is called, it is ensured that the referenced request is called beforehand",completions:["${1}"]},{name:"ratelimit",description:"allows throttling requests",completions:["minIdleTime ${1}","max ${1} expire ${2}","minIdleTime ${1} max ${2} expire ${3}"]},{name:"save",description:"If specified, the response will not be displayed but saved directly."},{name:"sleep",description:"wait specified milliseconds, before next step.",completions:["${1}"]},{name:"title",description:"additional title of region",completions:["${1}"]},{name:"timeout",description:"set timeout for request",completions:["${1}"]},{name:"verbose",description:"enable trace log level"}],ad=100;async function U(e,t){if(!m(e))return e;let r,o,s=e,n=0;for(;o!==s&&n++<ad;)for(o=s;(r=kt.exec(o))!==null;){let[i,a]=r,l=await t(a,i);if(typeof l<"u"&&i===e)return l;let d=l===null?"null":v(l);typeof d<"u"&&(s=s.replace(i,()=>d))}return s}function ae(e,t,r=0){let o=[];if(e){let s;for(;(s=kt.exec(e))!==null;){let[n,i]=s;o.push(new P({name:i||"variable",description:i,startLine:t,endLine:t,kind:"variable",startOffset:r+s.index,endOffset:r+s.index+n.length,source:i}))}}return o}async function Do(e,t,r){var n,i;let o=e(),s=o.next();if(!s.done){if(t.data.httpResponseSymbol){let l=t.data.httpResponseSymbol;return l.body.push(s.value.textLine),l.symbol.endLine=s.value.line,l.symbol.endOffset=s.value.textLine.length,{nextParserLine:s.value.line,symbols:[]}}let a=r.exec(s.value.textLine);if(a&&((n=a.groups)!=null&&n.statusCode)){let l={};t.httpRegion.response={protocol:`HTTP/${a.groups.httpVersion||"1.1"}`,httpVersion:a.groups.httpVersion,statusCode:+a.groups.statusCode,statusMessage:a.groups.statusMessage,headers:l};let d=new P({name:"response",description:"response",kind:"response",startLine:s.value.line,startOffset:0,endLine:s.value.line,endOffset:s.value.textLine.length,children:[]});t.data.httpResponseSymbol={symbol:d,body:[]};let u=[t.data.httpResponseSymbol.symbol],p={nextParserLine:s.value.line,symbols:u},f=await Xt(o,[Yt(l)],t);p.nextParserLine=f.nextLine||p.nextParserLine;for(let h of f.parseResults)for(let b of h.symbols)(i=d.children)==null||i.push(b),d.endLine=b.endLine,d.endOffset=b.endOffset;return p}}return!1}function Ct(e){let t=/^<(?:(?<injectVariables>@)(?<encoding>\w+)?)?\s+(?<fileName>.+?)\s*$/u.exec(e);if(t&&t.length===4&&t.groups)return{fileName:t.groups.fileName.trim(),injectVariables:!!t.groups.injectVariables,encoding:We(t.groups.encoding)}}function Fo(e){return async function(r,o){var i,a,l;let s=r(),n=s.next();if(!n.done&&ud(n.value,o,e)){if(o.httpRegion.request)return{endRegionLine:n.value.line-1,nextParserLine:n.value.line-1,symbols:[]};let d=dd(n.value,e);if(!d)return!1;o.httpRegion.request=d.request;let u=new P({name:n.value.textLine||"request line",description:`${e.protocol} request-line`,kind:"requestLine",startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:n.value.textLine.length,children:[d.symbol]}),p={nextParserLine:n.value.line,symbols:[u]},f={};d.request.headers=f;let h=await Xt(s,[Ht,Yt(f),Oo(),Ao(b=>d.request.url+=b),$o(b=>d.request.url+=b)],o);p.nextParserLine=h.nextLine||p.nextParserLine;for(let b of h.parseResults)(a=(i=p.symbols)==null?void 0:i.push)==null||a.call(i,...b.symbols);if((l=e.modifyRequest)==null||l.call(e,d.request),d.request.headers){let b=$(d.request.headers,"content-type");m(b)&&(d.request.contentType=ht(b))}return o.httpRegion.hooks.execute.addHook(e.protocol.toLowerCase(),So(e.requestClientFactory,e.sessionStore)),p}return!1}}function dd(e,t){var s,n,i,a;let r=t.methodRegex.exec(e.textLine);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,protocol:t.protocol.toUpperCase(),method:((s=r.groups)==null?void 0:s.method)||t.method||t.protocol},symbol:new P({name:r.groups.url||"request",description:`${t.protocol} Url`,kind:"url",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:ae(e.textLine,e.line)})};let o=(n=t.protocolRegex)==null?void 0:n.exec(e.textLine);if(o&&o.length>1&&((i=o.groups)!=null&&i.url))return{request:{url:o.groups.url,protocol:t.protocol.toUpperCase(),method:((a=o.groups)==null?void 0:a.method)||t.method||t.protocol},symbol:new P({name:o.groups.url||"request",description:`${t.protocol} Url`,kind:"url",startLine:e.line,startOffset:0,endLine:e.line,endOffset:e.textLine.length,children:ae(e.textLine,e.line)})}}function ud(e,t,r){var o,s,n,i;return Ee(e.textLine)||t.forceRegionDelimiter&&t.httpRegion.request?!1:(s=(o=r.methodRegex.exec(e.textLine))==null?void 0:o.groups)!=null&&s.url?!0:!t.httpRegion.request&&r.protocolRegex?!!((i=(n=r.protocolRegex.exec(e.textLine))==null?void 0:n.groups)!=null&&i.url):!1}function Io(e){let t=e;return!!(t!=null&&t.httpRegion)}function jo(e){let t=e;return Array.isArray(t==null?void 0:t.httpRegions)}function Ie(e,t){let r=t.httpFile.findHttpRegion(e);if(r)return r;if(t.options.httpFiles)for(let{ref:o}of t.options.httpFiles.filter(s=>s.base===t.httpFile)){let s=o.findHttpRegion(e);if(s)return s}}async function St(e,t,r){var s,n;let o=await fe(e,r,async i=>{g.debug(`parse imported file ${i}`),r.options.httpFiles||(r.options.httpFiles=[]);let a=r.options.httpFiles.filter(d=>d.ref.fileName===i);if(a.length>0){let d=a[0].ref;return a.some(u=>u.base===r.httpFile)||r.options.httpFiles.push({base:r.httpFile,ref:d}),d}let l=await t.getOrCreate(i,async()=>await c.readFile(i,"utf-8"),0,{workingDir:r.httpFile.rootDir,config:r.config});return r.hooks=Pt(r.hooks,l),r.options.httpFiles.push({base:r.httpFile,ref:l}),l});if(o&&(!r.options.globalScriptsExecuted||((n=(s=r.options.globalScriptsExecuted).indexOf)==null?void 0:n.call(s,o))<0)){r.options.globalScriptsExecuted||(r.options.globalScriptsExecuted=[]),g.debug(`execute global scripts for import ${o.fileName}`),r.options.globalScriptsExecuted.push(o);let i={...r,httpFile:o};return await ve(i)}return!!o}function Je(e){let t=e;return t&&!!t.then}function we(e){return new Promise(t=>setTimeout(t,e))}async function Mo(e,...t){let r=[],o=async()=>{let n;for(;n=t.shift();)r.push(await n())},s=[];for(let n=0;n<e;n++)s.push(o());return await Promise.all(s),r}var Ys=L(require("dayjs")),Qs=require("uuid"),Tt={alphabetic:(e=10)=>J(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"),numeric:(e=10)=>J(e),hexadecimal:(e=10)=>J(e,"1234567890ABCDEF"),email:ze,float:(e=0,t=100)=>Math.random()*(t-e)+e,integer:(e=0,t=100)=>Math.floor(Math.random()*(t-e)+e),uuid:()=>(0,Qs.v4)(),date:(e=new Date,t=void 0)=>(0,Ys.default)(e).format(t)};function ze(){return`${J(30)}@${J(10)}.${Vo(["com","org","at","de","fr","uk","it","ch","info","edu","asia","gov","app","io"])}`}function J(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_"){let r=[];if(e>0){let o=t.split("");for(let s=0;s<e;s++)r.push(Vo(o))}return r.join("")}function Vo(e){return e[Math.floor(Math.random()*(e.length-1))]}var je=require("fs"),Zs=require("os"),Pe=require("path");async function Bo(){en(),await fd(),pd()}function pd(){process.platform==="win32"&&(X.ok="[x]",X.error="[-]",X.skipped="[*]")}function en(){c.EOL=Zs.EOL,c.isAbsolute=async e=>(0,Pe.isAbsolute)(c.toString(e)),c.dirname=e=>(0,Pe.dirname)(c.toString(e)),c.hasExtension=(e,...t)=>{let r=(0,Pe.extname)(c.toString(e));return r.startsWith(".")&&(r=r.slice(1)),t.indexOf(r)>=0},c.joinPath=(e,t)=>(0,Pe.join)(c.toString(e),t),c.exists=async e=>{try{return!!await je.promises.stat(c.toString(e))}catch{return!1}},c.readFile=async(e,t)=>{let r=c.fsPath(e);if(r)return je.promises.readFile(r,t);throw new Error("No valid path for cli")},c.readBuffer=async e=>{let t=c.fsPath(e);if(t){let r=(0,je.createReadStream)(t);return cd(r)}throw new Error("No valid path for cli")},c.writeBuffer=(e,t)=>je.promises.writeFile(c.toString(e),t),c.readdir=async e=>je.promises.readdir(c.toString(e))}function cd(e){return new Promise((t,r)=>{let o=[];e.on("data",s=>{Buffer.isBuffer(s)?o.push(s):o.push(Buffer.from(s))}),e.on("end",()=>t(Buffer.concat(o))),e.on("error",s=>r(s)),e.resume()})}async function fd(){O.showNote=async function(t){return console.log(`Note: ${t}`),!0},O.showInputPrompt=async function(t,r,o){if(r!==void 0)return r;throw new Error("Interactive input not supported in uctest. Use --var to pass values.")},O.showListPrompt=async function(t,r){if(r.length>0)return r[0];throw new Error("Interactive selection not supported in uctest.")},O.getClipboard=async function(){return""},O.setClipboard=async function(t){}}var rt=L(require("chalk")),sl=require("commander"),ot=require("fs"),M=require("path");var nn=require("assert");var Qt=class{constructor(){this.id=["endsWith"]}match(t,r){let o=v(t),s=v(r);return o&&s?o==null?void 0:o.endsWith(s):!1}};var Zt=class{constructor(){this.id=["==","===","equals"]}match(t,r){return typeof t=="object"?F(t)===F(r):t===r}};var er=class{constructor(){this.id=["exists","isTrue"]}match(t){return!!t}};var tr=class{constructor(){this.id=[">="]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o>=s:!1}};var rr=class{constructor(){this.id=[">"]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o>s:!1}};var or=class{constructor(){this.id=["contains","includes"]}match(t,r){let o=v(t),s=v(r);return o&&s?o.includes(s):Array.isArray(t)?t.indexOf(r)>=0:!1}};var sr=class{constructor(){this.id=["isArray"]}match(t){return Array.isArray(t)}};var nr=class{constructor(){this.id=["isBoolean"]}match(t){return typeof t=="boolean"}};var ir=class{constructor(){this.id=["isFalse"]}match(t){return!t}};var ar=class{constructor(){this.id=["isNumber"]}match(t){return typeof t=="number"}};var lr=class{constructor(){this.id=["isString"]}match(t){return typeof t=="string"}};var dr=class{constructor(){this.id=["<="]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o<=s:!1}};var ur=class{constructor(){this.id=["<"]}match(t,r){let o=C(t),s=C(r);return o!==void 0&&s!==void 0?o<s:!1}};var pr=class{constructor(){this.id=["matches"];this.noAutoConvert=!0}match(t,r){let o=v(t),s=v(r);return o&&s?new RegExp(s,"u").test(o):!1}};var tn=require("crypto");var cr=class{constructor(){this.id=["md5"];this.noAutoConvert=!0}match(t,r){let o=pe(t);return o?(0,tn.createHash)("md5").update(o).digest("base64")===r:!1}};var fr=class{constructor(){this.id=["!=","!==","not equals"]}match(t,r){return t!==r}};var rn=require("crypto");var mr=class{constructor(){this.id=["sha256"];this.noAutoConvert=!0}match(t,r){let o=pe(t);return o?(0,rn.createHash)("sha256").update(o).digest("base64")===r:!1}};var on=require("crypto");var gr=class{constructor(){this.id=["sha512"];this.noAutoConvert=!0}match(t,r){let o=pe(t);return o?(0,on.createHash)("sha512").update(o).digest("base64")===r:!1}};var hr=class{constructor(){this.id=["startsWith"]}match(t,r){let o=v(t),s=v(r);return o&&s?o==null?void 0:o.startsWith(s):!1}};var sn=[new Qt,new Zt,new er,new tr,new rr,new or,new sr,new nr,new ar,new lr,new dr,new ur,new pr,new fr,new hr,new mr,new cr,new gr,new ir];async function an(e,{httpRegion:t}){let o=e().next();if(!o.done&&o.value.textLine){let s=o.value.textLine,i=`^\\s*\\?\\?\\s*(?<type>[^\\s]*)(\\s+(?<value>.*))?\\s+(?<predicate>(${sn.reduce((l,d)=>(l.push(...d.id),l),[]).join("|")}))\\s*(?<expected>.*)\\s*$`,a=new RegExp(i,"iu").exec(s);if(a&&a.groups&&a.groups.type&&a.groups.predicate){let l=a.groups.type,d=a.groups.value,u=a.groups.expected,p=sn.find(f=>{var h;return((h=a.groups)==null?void 0:h.predicate)&&f.id.indexOf(a.groups.predicate)>=0});return p&&t.hooks.onResponse.addHook(`test ${s}`,async(f,h)=>{await Ho(h,{ignoreErrorFile:!0})(`${d||l} ${p.id[0]} ${u||""}`.trim(),async k=>{let H=await h.httpFile.hooks.provideAssertValue.trigger(l,d,f,h),R=u&&await j(u,"Variable",h);R!==u&&(k.message=`${d||l} ${p.id[0]} ${R}`);let y=p.noAutoConvert?R:gd(H,R);(0,nn.ok)(p.match(H,y),`${d||l} (${H}) ${p.id[0]} ${v(y)||""}`.trim())})}),{nextParserLine:o.value.line,symbols:[new P({name:`assert ${a.groups.type}`,description:`${a.groups.predicate} ${a.groups.expected||""}`.trim(),kind:"script",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length})]}}}return!1}function gd(e,t){if(t!=null){if(typeof e=="number")return C(t);if(typeof e=="boolean")return be(t,!!t);if(typeof e=="string")return v(t);if(e===null&&t==="null")return null;if(e===void 0&&t==="undefined")return;if(typeof e=="object"&&typeof t=="string")try{return JSON.parse(t)}catch{return t}}return t}z.emptyLineProvider.push(()=>[{name:"?? status == ",description:"Status assert (200)"},{name:"?? status == 200",description:"Status assert (200)"},{name:"?? duration <",description:"Duration assert"},{name:"?? body contains",description:"Body assert"},{name:"?? body matches",description:"Body assert"},{name:"?? body md5",description:"Body assert"},{name:"?? body sh256",description:"Body assert"},{name:"?? header",description:"Header assert"}]);function ln(e,t,r){var o,s,n,i,a,l,d;if(e==="duration")switch(t){case"firstByte":return(o=r==null?void 0:r.timings)==null?void 0:o.firstByte;case"download":return(s=r==null?void 0:r.timings)==null?void 0:s.download;case"wait":return(n=r==null?void 0:r.timings)==null?void 0:n.wait;case"request":return(i=r==null?void 0:r.timings)==null?void 0:i.request;case"tcp":return(a=r==null?void 0:r.timings)==null?void 0:a.tcp;case"tls":return(l=r==null?void 0:r.timings)==null?void 0:l.tls;default:return(d=r==null?void 0:r.timings)==null?void 0:d.total}return!1}function dn(e,t,r){return e==="header"&&t?$(r.headers,t):!1}async function un(e,t,r,o){return e==="js"&&t?await T.evalExpression(t,o,{response:r}):e==="body"?t?await T.evalExpression(`(response.parsedBody || response.body).${t}`,o,{response:r}):r.body:!1}function pn(e,t,r){return e==="status"?r==null?void 0:r.statusCode:!1}var yr=class{constructor(){this.id="testFailed";this.before=["processedHttpRegion"]}async onError(t,r){if(ie(t)){let{httpRegion:o}=r.args[0];Re(o,{message:t.message,error:$e(t),status:"ERROR"})}return!0}};function cn(e){e.hooks.execute.addInterceptor(new yr),e.hooks.provideAssertValue.addHook("status",pn,{before:["request"]}),e.hooks.provideAssertValue.addHook("header",dn,{before:["request"]}),e.hooks.provideAssertValue.addHook("javascript",un,{before:["request"]}),e.hooks.provideAssertValue.addHook("duration",ln,{before:["request"]}),e.hooks.parse.addHook("assert",an,{before:["request"]})}z.variableProvider.push(()=>[{name:"$prompt ",description:"Prompt"},{name:"$input",description:"Input"},{name:"$input-askonce",description:"Input"},{name:"$password",description:"Password"},{name:"$pick <placeholder> $value:",description:"Password"},{name:"$pick-askonce <placeholder> $value:",description:"Password"},{name:"$timestamp",description:"Timestamp"},{name:"$datetime",description:"Datetime"},{name:"$localDatetime",description:"Local Datetime"}]);var fn="$default",mn="$shared";async function gn(e){var t;if((t=e.config)!=null&&t.environments){let r=Object.keys(e.config.environments).filter(o=>[fn,mn].indexOf(o)<0);return g.info("Config Env Provider found environments",r),r}return[]}async function hn(e,t){var o;let r=[];if((o=t.config)!=null&&o.environments){let s=t.config.environments;r.push(s[mn]),e&&e.length>0?r.push(...e.map(n=>s[n])):r.push(s[fn])}return Object.assign({},...r)}var Go={};it(Go,{HttpFile:()=>Lt,HttpFileStore:()=>Et,HttpRegion:()=>Ye,UserSessionStore:()=>xr,closeHttpRegion:()=>br,createReaderFactory:()=>No,getEnvironmentConfig:()=>Xe,parseHttpFile:()=>_o,pluginStore:()=>se,setSource:()=>Uo,userSessionStore:()=>S});var yn=L(require("chalk")),bn=L(require("lodash/merge"));async function Xe(e,t){let r=[];if(t){let s=await wo(t.fileName,t.rootDir);s&&r.push(s)}e&&r.push(e);let o=(0,bn.default)({log:{level:5,supportAnsiColors:!0},cookieJarEnabled:!0,envDirName:"env"},...r);return hd(o),o}function hd(e){var t,r,o;typeof((t=e==null?void 0:e.log)==null?void 0:t.level)>"u"?g.options.level=5:g.options.level=(r=e==null?void 0:e.log)==null?void 0:r.level,((o=e==null?void 0:e.log)==null?void 0:o.supportAnsiColors)===!1&&(yn.default.level=0)}var Lt=class{constructor(t,r){this.fileName=t;this.rootDir=r;this.hooks={parse:new at,parseMetaData:new lt,parseEndRegion:new ut,provideAssertValue:new dt,replaceVariable:new ft,provideEnvironments:new ct,provideVariables:new pt,execute:new Le,onStreaming:new Se,onRequest:new He,onResponse:new Ce,responseLogging:new Te};this.httpRegions=[]}findHttpRegion(t){return this.httpRegions.find(r=>{var o;return((o=r.metaData)==null?void 0:o.name)===t&&!r.metaData.disabled})}get globalHttpRegions(){return this.httpRegions.filter(t=>t.isGlobal()&&!t.metaData.disabled)}};var wn=require("hookpoint");async function br(e){await e.httpFile.hooks.parseEndRegion.trigger(e);let{httpRegion:t}=e;e.httpRegion.symbol.name=wt(t),e.httpRegion.symbol.description=To(t),e.httpFile.httpRegions.push(e.httpRegion),delete e.forceRegionDelimiter}function No(e,t){return function*(o){for(let s=e;s<t.length;s++){let n=t[s];if(yield{textLine:n,line:s},!o&&me.test(n))break}}}var vn=require("hookpoint");var xn=require("hookpoint");var Ye=class e{constructor(t,r=0){this.httpFile=t;this.variablesPerEnv={};this.metaData={};this.hooks={execute:new Le,onRequest:new He,onStreaming:new Se,onResponse:new Ce,responseLogging:new Te};this.dependentsPerEnv=[];this.symbol=new P({name:"-",description:"-",kind:"request",startLine:r,startOffset:0,endLine:r,endOffset:0})}get id(){return`${this.httpFile.fileName}_${this.symbol.startLine}`}isGlobal(){return!(this.request||this.metaData.name)}clone(t){let r=new e(t||this.httpFile);return r.request=this.request,Object.assign(r.symbol,this.symbol),Object.assign(r.hooks,this.hooks),Object.assign(r.variablesPerEnv,this.variablesPerEnv),Object.assign(r.metaData,this.metaData),r}async execute(t,r){var s,n,i;delete this.response,this.testResults=[],t.httpRegion&&this.registerRegionDependent(t.httpRegion),(n=(s=t.progress)==null?void 0:s.report)==null||n.call(s,{message:`${this.symbol.name}`});let o=this.hooks.execute;if(!this.isGlobal()){o=this.httpFile.hooks.execute.merge(o);for(let a of this.httpFile.httpRegions.filter(l=>l.isGlobal()))a instanceof e&&a.registerRegionDependent(this)}try{let a=await o.trigger({...t,httpFile:this.httpFile,httpRegion:this,hooks:Pt(this.hooks,this.httpFile),isMainContext:r});return this.isGlobal()||this.resetDependentRegionsWithVisitor(I(t.activeEnvironment),this,[]),a!==xn.HookCancel&&a.every(l=>!!l)}catch(a){return ie(a)&&(Re(this,{message:a.message,status:"ERROR",error:$e(a)}),a.handled||(await((i=t.logResponse)==null?void 0:i.call(t,this.response,this)),a.handled=!0)),!1}}resetDependentRegionsWithVisitor(t,r,o){let s=r.dependentsPerEnv.filter(n=>!o.includes(n));for(let n of s)delete n.response,delete n.variablesPerEnv[t],o.push(n),n instanceof e&&this.resetDependentRegionsWithVisitor(t,n,o)}registerRegionDependent(t){t&&!this.dependentsPerEnv.includes(t)&&t!==this&&this.dependentsPerEnv.push(t)}};function Uo(e,t){for(let r of e)Rn(r.symbol,t)}function Rn(e,t){e.source=G(t.slice(e.startLine,e.endLine+1));let r=e.endOffset-t[e.endLine].length;if(r>=0&&(r=void 0),e.source=e.source.slice(e.startOffset,r),e.children)for(let o of e.children)Rn(o,t)}async function _o(e,t,r){let o=ee(t),s={lines:o,httpFile:e,httpRegion:new Ye(e,0),data:{},httpFileStore:r};for(let n=0;n<o.length;n++){let i=await e.hooks.parse.trigger(No(n,o),s);i&&i!==vn.HookCancel&&(i.endRegionLine!==void 0&&i.endRegionLine>=0&&(s.httpRegion.symbol.endLine=i.endRegionLine,s.httpRegion.symbol.endOffset=o[i.endRegionLine].length,await br(s),s.httpRegion=new Ye(e,i.nextParserLine+1)),i.symbols&&(s.httpRegion.symbol.children?s.httpRegion.symbol.children.push(...i.symbols):s.httpRegion.symbol.children=i.symbols),n=i.nextParserLine)}return await br(s),s.httpRegion.symbol.endLine=o.length-1,s.httpRegion.symbol.endOffset=o[o.length-1].length,Uo(e.httpRegions,o),e}var se={};var Et=class{constructor(t={}){this.plugins=t;this.storeCache=[]}getFromStore(t,r){let o=c.toString(t),s=this.storeCache.find(n=>n.cacheKey===o);return s||(s={cacheKey:o,version:r},this.storeCache.push(s)),s}get(t){var o;let r=c.toString(t);return(o=this.storeCache.find(s=>s.cacheKey===r))==null?void 0:o.httpFile}getAll(){let t=[];for(let r of this.storeCache)r.httpFile&&t.push(r.httpFile);return t}getOrCreate(t,r,o,s){let n=this.getFromStore(t,o);return o>n.version||!n.httpFile?(n.promise&&o<=n.version||(n.promise=r().then(i=>this.parse(t,i,s)).then(i=>{if(delete n.promise,n.httpFile)for(let a of i.httpRegions){let l=n.httpFile.httpRegions.find(d=>d.symbol.source===a.symbol.source);l&&Object.assign(a.variablesPerEnv,l.variablesPerEnv)}return n.version=o,n.httpFile=i,i}).catch(i=>{throw delete n.promise,n.httpFile&&this.remove(n.httpFile.fileName),i})),n.promise):n.promise||Promise.resolve(n.httpFile)}async parse(t,r,o){let s=await this.initHttpFile(t,o);return await _o(s,r,this)}remove(t){let r=c.toString(t),o=this.storeCache.findIndex(s=>s.cacheKey===r);return o>=0?(this.storeCache.splice(o,1),!0):!1}rename(t,r){let o=c.toString(t),s=this.storeCache.find(n=>n.cacheKey===o);s&&(s.cacheKey=c.toString(r),s.httpFile&&(s.httpFile.fileName=r))}clear(){this.storeCache.length=0}async initHttpFile(t,r){var l,d;let o=await N(t,r.workingDir)||t,s=await xt(o,r.workingDir,...Gt)||await xt(o,r.workingDir,"package.json",((l=r.config)==null?void 0:l.envDirName)||"env")||r.workingDir,n=new Lt(o,s);r.config=await Xe(r.config,n);let i={...se,...this.plugins};s&&(Object.assign(i,await Po(s)),(d=r.config)!=null&&d.configureHooks&&(i[".httpyac.js"]=r.config.configureHooks));let a=process.env.HTTPYAC_PLUGIN;if(a)try{let u=require(a);u.configureHooks&&(i.HTTPYAC_PLUGIN=u.configureHooks)}catch(u){g.warn("Global Hook Plugin not loaded",u)}return await this.configureHooks(n,r,i),n}async configureHooks(t,r,o){if(r.config){let s={version:"1.0.0",rootDir:t.rootDir,config:r.config,httpFile:t,hooks:t.hooks,log:g,fileProvider:c,sessionStore:S,userInteractionProvider:O,httpClientProvider:de,javascriptProvider:T,utils:x,getHookCancel:()=>wn.HookCancel};for(let[n,i]of Object.entries(o))try{let a=i(s);Je(a)&&await a}catch(a){g.error(`error in ${n}`,a)}}}};var xr=class{constructor(){this.userSessions=[];this.sessionChangedListener=[]}onSessionChanged(t){return this.sessionChangedListener.push(t),()=>{let r=this.sessionChangedListener.indexOf(t);r>=0&&this.sessionChangedListener.splice(r,1)}}async reset(){for(let t of this.userSessions)t.delete&&t.delete();this.userSessions.length=0,this.notifySessionChanged()}getUserSession(t){return this.userSessions.find(r=>r.id===t)}setUserSession(t){this.removeUserSession(t.id),this.userSessions.push(t),this.notifySessionChanged()}notifySessionChanged(){for(let t of this.sessionChangedListener)t()}removeUserSession(t){let r=this.userSessions.find(o=>o.id===t);r&&(this.userSessions.splice(this.userSessions.indexOf(r),1),r.delete&&r.delete(),this.notifySessionChanged())}isUserSession(t){let r=t;return r&&!!r.description&&!!r.id&&!!r.title&&!!r.type&&!!r.details}},S=new xr;async function Pn(){let e=S.getUserSession("last_response");return e!=null&&e.response?{response:e.response}:{}}var kn=L(require("lodash/cloneDeep"));var Rr=class{constructor(){this.id="createRequest"}async beforeLoop(t){let[r]=t.args;return r.httpRegion.request&&(q(r,"init request"),r.request=(0,kn.default)(r.httpRegion.request)),!0}};var Hn=require("hookpoint");var bd="variable",vr=class{constructor(){this.id="variable"}async beforeLoop(t){let r=t.args[0];return r.options.lazyVariables=!0,!0}async beforeTrigger(t){var o;let r=t.args[0];return((o=t.hookItem)==null?void 0:o.id)!==bd&&r.options.lazyVariables&&(await this.replaceAllVariables(r),delete r.options.lazyVariables),!0}async replaceAllVariables(t){for(let[r,o]of Object.entries(t.variables)){let s=await j(o,"Variable",t);s!==Hn.HookCancel&&(t.variables[r]=s)}}};var wr=class{constructor(){this.id="logResponse"}async afterLoop(t){let r=t.args[0],o;return r.httpRegion.response&&(o=ce(r.httpRegion.response),o.tags||(o.tags=[]),o.tags.push("httpRegion",r.isMainContext?"mainResponse":"refResponse"),delete r.httpRegion.response),await Fe(o,r),!0}};var Pr=class{constructor(){this.id="processedHttpRegion";this.emitted=new WeakSet}getResponseLoggingInterceptor(){return{id:this.id,afterLoop:this.afterResponseLoggingLoop.bind(this)}}async beforeLoop(t){let[r]=t.args;if(r.processedHttpRegions){let o=this.toProcessedHttpRegion(r);r.processedHttpRegions.push(o)}return!0}async onError(t,r){return this.updateProcessedHttpRegionAfterLoop(r.args[0]),this.emitProcessedHttpRegion(r.args[0]),!0}async afterLoop(t){return this.updateProcessedHttpRegionAfterLoop(t.args[0]),this.emitProcessedHttpRegion(t.args[0]),!0}updateProcessedHttpRegionAfterLoop(t){var o,s,n;let r=(s=(o=t.processedHttpRegions)==null?void 0:o.slice().reverse())==null?void 0:s.find(i=>i.id===t.httpRegion.id);r&&(r.end=performance.now(),r.duration=r.end-r.start,r.metaData={...t.httpRegion.metaData},r.testResults=t.httpRegion.testResults,r.response=t.httpRegion.response||r.response,r.request=((n=t.httpRegion.response)==null?void 0:n.request)||r.request)}async afterResponseLoggingLoop(t){var n;let[r,o]=t.args,s=(n=o.processedHttpRegions)==null?void 0:n.find(i=>i.id===o.httpRegion.id);return s&&(s.request=r.request,s.response=r),this.updateProcessedHttpRegionAfterLoop(o),this.emitProcessedHttpRegion(o),!0}toProcessedHttpRegion(t){return{id:t.httpRegion.id,filename:t.httpFile.fileName,symbol:t.httpRegion.symbol,isGlobal:t.httpRegion.isGlobal(),testResults:t.httpRegion.testResults,start:performance.now()}}emitProcessedHttpRegion(t){var o;if(!t.processedHttpRegionListener)return;let r=(o=t.processedHttpRegions)==null?void 0:o.find(s=>s.id===t.httpRegion.id);r&&!this.emitted.has(r)&&r.duration!==void 0&&(this.emitted.add(r),t.processedHttpRegionListener(r))}};var kr=class{constructor(){this.id="regionScopedVariables"}async beforeLoop(t){var s;let r=t.args[0],o=I(r.activeEnvironment);if((s=r.config)!=null&&s.useRegionScopedVariables){let n=r.options;n.variables=r.variables,r.variables=Object.assign({},r.variables,...r.httpFile.globalHttpRegions.map(i=>i.variablesPerEnv[o]))}else r.variables=Object.assign(r.variables,...r.httpFile.httpRegions.map(n=>n.variablesPerEnv[o]));return!0}async afterLoop(t){var o;let r=t.args[0];if((o=r.config)!=null&&o.useRegionScopedVariables){let s=r.options;if(s.variables){let n=r.variables;r.variables=s.variables,this.autoShareNewVariables(n,r)}}return!0}autoShareNewVariables(t,r){for(let[o,s]of Object.entries(t))r.variables[o]||(r.variables[o]=s)}};function Cn(e,t,r){return e==="disabled"?(t?typeof t=="string"&&r.httpRegion.hooks.execute.addHook("disabled",async o=>{let s=await T.evalExpression(t,o);return s&&te(o.httpRegion),!s}):r.httpRegion.hooks.execute.addInterceptor({id:"disabled",async beforeLoop(o){o.bail=!0;let{httpRegion:s}=o.args[0];return te(s),!0}}),!0):!1}function Sn(e,t,r){return e==="forceRegionDelimiter"&&(r.forceRegionDelimiter=!0),!1}function Tn(e,t,r){return e==="import"&&t?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new Ko(t,r.httpFileStore)),!0):!1}var Ko=class{constructor(t,r){this.fileName=t;this.httpFileStore=r;this.id="import"}async process(t){return St(this.fileName,this.httpFileStore,t)}};function Ln(e,t,r){return e==="jwt"?(r.httpRegion.hooks.onResponse.addHook("jwt",async o=>{let s=o.parsedBody||o.body;if(s&&typeof s=="object"){let n=Object.entries(s),i=n;t&&(i=n.filter(([d])=>t.indexOf(d)>=0));for(let[d,u]of i){let p=Rd(u);p&&n.push([`${d}_parsed`,p])}let a=Object.fromEntries(n),l=F(a,2);o.body=l,o.prettyPrintBody=l,o.parsedBody=a}}),!0):!1}function Rd(e){return m(e)?ao(e):null}var En=require("uuid");function qn(e,t,r){if(e==="keepStreaming"){let o=`keep_streaming_${(0,En.v4)()}`;return r.httpRegion.hooks.onStreaming.addHook("keepStreaming",async s=>{s.request&&(q(s,"stream until manual cancellation"),await new Promise(n=>{s.requestClient&&s.requestClient.addEventListener("disconnect",()=>n(!0))}))}),r.httpRegion.hooks.onResponse.addHook("keepStreaming",()=>{S.removeUserSession(o)}),!0}return!1}var On=require("hookpoint"),$n=require("uuid");function An(e,t,r){var o,s,n,i;if(e==="loop"&&t){let a=/^\s*for\s+(?<variable>.*)\s+of\s+(?<iterable>.*)\s*/u.exec(t);if((o=a==null?void 0:a.groups)!=null&&o.iterable&&((s=a==null?void 0:a.groups)!=null&&s.variable))return Wo(r,{type:1,variable:a.groups.variable,iterable:a.groups.iterable}),!0;let l=/^\s*for\s*(?<counter>\d*)\s*$/u.exec(t);if((n=l==null?void 0:l.groups)!=null&&n.counter)return Wo(r,{type:0,counter:Number.parseInt(l.groups.counter,10)}),!0;let d=/^\s*while\s*(?<expression>.*)\s*$/u.exec(t);if((i=d==null?void 0:d.groups)!=null&&i.expression)return Wo(r,{type:2,expression:d.groups.expression}),!0}return!1}function Wo(e,t){let r=new Jo(t);e.httpRegion.hooks.execute.addInterceptor(r),e.httpRegion.hooks.execute.addObjHook(o=>o.process,r)}var Jo=class{constructor(t){this.data=t;this.isInLoop=!1;this.id=`loop_${(0,$n.v4)()}`}async beforeLoop(t){return this.hook=t.hook,this.isInLoop&&(t.index=t.hook.items.findIndex(r=>r.id===this.id)),!0}async process(t){if(this.hook&&!this.isInLoop){let r=[];try{this.isInLoop=!0;let o=this.iterate(t),s=await o.next();for(;!s.done;){q(t,`${s.value.index+1} loop pass`);let n={...t,httpRegion:this.createHttpRegionClone(t.httpRegion,s.value.index),variables:Object.assign(t.variables,s.value.variables)};if(await this.hook.trigger(n)===On.HookCancel)return!1;r.push(n.variables.response),s=await o.next()}t.httpRegion.metaData.name&&r.length>0&&D({[`${t.httpRegion.metaData.name}`]:r[0],[`${t.httpRegion.metaData.name}List`]:r},t)}finally{this.isInLoop=!1}}return!0}async afterTrigger(t){var r;return!this.isInLoop&&((r=t.hookItem)==null?void 0:r.id)===this.id&&(t.bail=!0),!0}async*iterate(t){switch(this.data.type){case 1:yield*this.iterateForOfLoop(t);break;case 0:yield*this.iterateForLoop();break;case 2:yield*this.iterateWhileLoop(t);break;default:break}}async*iterateForOfLoop(t){if(this.data.variable&&this.data.iterable){let r=await T.evalExpression(this.data.iterable,t),o;if(Array.isArray(r)&&(o=r),o){let s=0;for(let n of o){let i={$index:s};i[this.data.variable]=n,yield{index:s,variables:i},s++}}}}async*iterateWhileLoop(t){if(this.data.expression){let r=0;for(;await T.evalExpression(this.data.expression,t);)yield{index:r,variables:{$index:r}},r++}}*iterateForLoop(){if(this.data.counter)for(let t=0;t<this.data.counter;t++)yield{index:t,variables:{$index:t}}}createHttpRegionClone(t,r){let o=t.clone();return o.metaData.name=t.metaData.name?`${t.metaData.name}${r}`:void 0,o}};function Dn(e,t,r){return e==="noRedirect"?(r.httpRegion.hooks.onRequest.addHook("noRedirect",async o=>{o.noRedirect=!0}),!0):!1}function Fn(e,t,r){return e==="noRejectUnauthorized"?(r.httpRegion.hooks.onRequest.addHook("noRejectUnauthorized",async o=>{o.noRejectUnauthorized=!0}),!0):!1}function In(e,t,r){if(e==="note"){let o=t||`Are you sure you want to send the request ${wt(r.httpRegion)}?`;return r.httpRegion.hooks.execute.addInterceptor({id:"note",beforeLoop:()=>O.showNote(o)}),!0}return!1}function jn(e,t,r){return e==="proxy"?(r.httpRegion.hooks.onRequest.addHook("proxy",async o=>{o.proxy=t}),!0):!1}function Mn(e,t,{httpRegion:r}){if(e==="ratelimit"&&t){let o=/^\s*(slot(:)?\s*(?<slot>[^\s]+))?\s*(minIdleTime(:)?\s*(?<minIdleTime>\d*))?\s*(max(:)?\s*(?<max>\d*))\s*(expire(:)?\s*(?<expire>\d*))?\s*$/iu.exec(t);if(o!=null&&o.groups){let s=o.groups.slot||"rateLimit",n=o.groups.minIdleTime||"0",i=o.groups.max||"0",a=o.groups.expire||"0";r.hooks.execute.addHook("rateLimit",async l=>{let d=Pd(s,Number.parseInt(n,10),Number.parseInt(i,10),Number.parseInt(a,10));return d.requests.push(await vd(d,l)),!0})}}return!1}async function vd(e,t){for(;e.requests.length>0;){let r=new Date;if(kd(e.requests,r,e.expire),e.max>0&&e.requests.length>=e.max){let o=e.requests[0],s=e.expire+o.getTime()-r.getTime();s>0&&(q(t,`rate limit max reached. wait for ${s}`),g.debug(`rate limit max reached. wait for ${s} (slot ${e.slot})`),await we(s),g.debug("rate limit max waited"));continue}if(e.requests.length>0){let o=e.requests[e.requests.length-1];if(o&&e.minIdleTime>0){let s=o.getTime()+e.minIdleTime-r.getTime();if(s>0){q(t,`rate limit minIdleTime, wait for ${s}`),g.debug(`rate limit minIdleTime, wait for ${s} (slot ${e.slot})`),await we(s),g.debug("rate limit minIdleTime waited");continue}}}return r}return new Date}function wd(e){let t=e;return!!(t!=null&&t.requests)&&t.type==="RateLimit"}function Pd(e,t,r,o){let s=`ratelimit_${e}`,n=S.getUserSession(s);if(wd(n))return n.max=r,n.minIdleTime=t,n.expire=o,n;let i=[];t>0&&i.push(`minIdleTime ${t}ms`),o>0&&i.push(`max ${r} with expire ${o}ms`);let a={id:s,type:"RateLimit",title:`rate limit slot ${e}`,details:{slot:e,minIdleTime:t,max:r,expire:o},description:i.join(", "),slot:e,minIdleTime:t,max:r,expire:o,requests:[]};return S.setUserSession(a),a}function kd(e,t,r){if(r>0){let o=0;for(let s of e)if(t.getTime()-s.getTime()>=r)o++;else break;e.splice(0,o)}else e.splice(0,e.length-1)}var Vn=20,Hr=[],Cr=0,Bn=500;function Nn(e,t,r){return["ref","forceRef"].indexOf(e)>=0&&t?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new zo({name:t,force:e==="forceRef"})),!0):!1}var zo=class{constructor(t){this.data=t;this.id="ref"}async process(t){var s,n,i;if(((s=t.options)==null?void 0:s.skipRefResolution)===!0){let a=await j(this.data.name,this.id,t);if(typeof a!="string"||!a)return!0;let l=Ie(a,t);if(l&&((n=t.processedHttpRegions)!=null&&n.some(d=>d.id===l.id))){let d=I(t.activeEnvironment);D(l.variablesPerEnv[d],t)}return!0}let r=await j(this.data.name,this.id,t);if(typeof r!="string"||!r)throw g.error(`ref ${this.data.name} not resolvable to a valid name: ${this.data.name} -> ${r}`),new Error(`ref ${this.data.name} not resolvable to a valid name: ${this.data.name} -> ${r}`);Cr++;let o=`${t.httpRegion.id}:${r}`;if(Cr>Bn)throw g.error(`Total reference calls (${Cr}) exceeded limit (${Bn})`),new Error(`Too many reference calls (${Cr}) - possible infinite loop or runaway forceRef`);if(Hr.length>=Vn){let a=Hr.slice(-10).join(" -> ");throw g.error(`Reference depth limit (${Vn}) exceeded. Recent refs: ${a}`),new Error(`Reference depth limit exceeded - possible infinite loop. Recent: ${a}`)}Hr.push(o);try{let a=!0;q(t,`load reference ${r}`);let l=Ie(r,t);if(l){if(this.isReferenceErroredOrSkipped(l))return te(t.httpRegion),!1;let d=I(t.activeEnvironment);D(l.variablesPerEnv[d],t),g.trace("import variables",l.variablesPerEnv[d]);let u=Ge(t.variables[r])&&!((i=t.processedHttpRegions)!=null&&i.some(p=>p.id===l.id));(this.data.force||u)&&(a=await l.execute(t),a&&D(l.variablesPerEnv[d],t))}else throw g.error(`ref ${r} not found`),new Error(`ref ${r} not found`);return a}finally{Hr.pop()}}isReferenceErroredOrSkipped(t){var r;return!!((r=t.testResults)!=null&&r.some(o=>o.status==="ERROR"||o.status==="SKIPPED"))}};function Un(e,t,r){return e==="responseRef"&&t&&(r.httpRegion.responseRefs||(r.httpRegion.responseRefs=[]),r.httpRegion.responseRefs.push(t)),!1}function _n(e,t,r){return e==="sleep"&&t?(r.httpRegion.hooks.execute.addHook("sleep",async o=>{let s=await T.evalExpression(t,o);return Number.isSafeInteger(s)&&(await q(o,`Sleep for ${s}ms`),await we(s)),!0}),!0):!1}function Gn(e,t,r){let o=C(t);return e==="timeout"&&o!==void 0?(r.httpRegion.hooks.onRequest.addHook("timeout",async s=>{s.timeout=o}),!0):!1}function Kn(e,t,r){if(e==="verbose"||e==="debug"){let o=e==="debug"?2:1;return g.options.level=o,r.httpRegion.hooks.execute.addInterceptor({id:"verbose",async beforeLoop(){return g.options.level=o,!0}}),!0}return!1}async function Wn(e,{httpRegion:t}){let r=e(!0),o=Cd(r);return o?(t.metaData.description||(t.metaData.description=o.comment),{nextParserLine:o.endLine,symbols:[new P({name:"comment",description:o.comment,kind:"comment",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset})]}):!1}function Cd(e){var r;let t=e.next();if(!t.done){let o=t.value.line,s=/^\s*\/\/\s*(?<comment>.*)\s*$/u.exec(t.value.textLine);if((r=s==null?void 0:s.groups)!=null&&r.comment)return{startLine:o,endLine:o,endOffset:t.value.textLine.length,comment:s.groups.comment};if(/^\s*\/\*$/u.exec(t.value.textLine)){t=e.next();let i=[];for(;!t.done;){if(/^\s*\*\/\s*$/u.test(t.value.textLine))return{startLine:o,endLine:t.value.line,endOffset:t.value.textLine.length,comment:G(i)};i.push(t.value.textLine),t=e.next()}}}return!1}var Jn=/^\s*(#+|\/{2})/u;async function zn(e,t){var i,a;let r=e(),{httpRegion:o,data:s}=t;s.metaTitle&&(o.metaData.title=s.metaTitle.trim(),o.metaData.name||(o.metaData.name=s.metaTitle.trim()),delete s.metaTitle);let n=r.next();if(!n.done){let l=n.value.textLine;if(Jn.test(l)){if(Sd(t)&&l.trim()!=="###")return g.debug("request with markdown only supports delimiter after request line"),!1;let d={nextParserLine:n.value.line,symbols:[]},u=me.exec(l);if(u)d.endRegionLine=n.value.line-1,d.symbols.push(new P({name:"separator",description:((i=u.groups)==null?void 0:i.title)||"-",kind:"metaData",startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:l.length})),s.metaTitle=(a=u.groups)==null?void 0:a.title;else{let p=await Ht(n.value,t,Jn);p&&(d.symbols=p.symbols)}return d}}return!1}function Sd(e){var t;if((t=e.httpRegion.request)!=null&&t.headers){let r=Oe(e.httpRegion.request.headers);if(bt(r))return!0}return!1}async function Xn(e,t){var o,s,n;let r=e();if(t.httpRegion.request){let i=Xo(t),a=r.next();if(!a.done&&(i.rawBody.length>0||!Ee(a.value.textLine))){let l=[];!i.symbol||i.symbol.endLine!==a.value.line-1?(i.symbol=new P({name:"request body",description:"request body",kind:"requestBody",startLine:a.value.line,startOffset:0,endLine:a.value.line,endOffset:a.value.textLine.length,children:ae(a.value.textLine,a.value.line)}),l.push(i.symbol)):(i.symbol.endLine=a.value.line,i.symbol.endOffset=a.value.textLine.length,(s=(o=i.symbol.children)==null?void 0:o.push)==null||s.call(o,...ae(a.value.textLine,a.value.line)));let d=Ct(a.value.textLine);return d?(i.rawBody.push(d),(n=i.symbol.children)==null||n.push(new P({name:"filename",description:d.fileName,kind:"path",startLine:a.value.line,startOffset:a.value.textLine.indexOf(d.fileName),endLine:a.value.line,endOffset:a.value.textLine.indexOf(d.fileName)+d.fileName.length}))):i.rawBody.push(a.value.textLine),{nextParserLine:a.value.line,symbols:l}}}return!1}function Xo(e){let t=e.data.request_body;return t||(t={rawBody:[]},e.data.request_body=t),t}var Sr=class{get id(){return"multipart/mixed"}async beforeLoop(t){var o;let r=t.args[1];if(r.httpRegion.request&&so(r.httpRegion.request.contentType)){if(r.forceRegionDelimiter===void 0)r.forceRegionDelimiter=!0;else if(r.forceRegionDelimiter){let s=((o=r.httpRegion.request.contentType)==null?void 0:o.boundary)||"",n=Xo(r).rawBody.slice().pop();m(n)&&n.includes(`--${s}--`)&&(r.forceRegionDelimiter=!1)}}return!0}};async function Yn(e,{httpRegion:t}){var s;let o=e().next();if(!o.done){let n=o.value.textLine,i=/^\s*>>(?<force>!)?\s+(?<fileName>.+)\s*$/u.exec(n);if(i&&((s=i.groups)!=null&&s.fileName)){let a=i.groups.fileName.trim(),l=!!i.groups.force;return t.hooks.onResponse.addHook("outputRedirection",async(d,u)=>{try{if(d.rawBody){let p=v(await j(a,"Variable",u));if(p){let f=await Td(p,l,u.httpFile.fileName);f?await c.writeBuffer(f,d.rawBody):g.debug(`file ${a} not found`)}else g.debug(`file ${a} not found`)}}catch(p){g.error(`output redirection failed for ${a}`,p)}}),{nextParserLine:o.value.line,symbols:[new P({name:"outputredirection",description:i.groups.filename,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new P({name:"filename",description:a,kind:"path",startLine:o.value.line,startOffset:o.value.textLine.indexOf(a),endLine:o.value.line,endOffset:o.value.textLine.indexOf(a)+a.length})]})]}}}return!1}async function Td(e,t,r){let o=await Yo(e,r);if(!t&&await c.exists(o)){let s=e.lastIndexOf(".");if(s>0&&s<e.length-2){let n=e.slice(0,s),i=e.slice(s+1),a=1;for(o=await Yo(`${n}-${a}.${i}`,r);await c.exists(o);)o=await Yo(`${n}-${a++}.${i}`,r)}}return o}async function Yo(e,t){if(!await c.isAbsolute(e)){let r=c.dirname(t);if(r)return c.joinPath(r,e)}return e}var Qn=Fo({protocol:"HTTP",methodRegex:/^\s*(?<method>GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS|CONNECT|TRACE|PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|CHECKOUT|CHECKIN|REPORT|MERGE|MKACTIVITY|MKWORKSPACE|VERSION-CONTROL|BASELINE-CONTROL|MKCALENDAR|ACL|SEARCH|GRAPHQL)\s+(?<url>.+?)$/u,protocolRegex:/^\s*(?<url>.+)\s*$/iu,requestClientFactory(e,t){if(de.createRequestClient)return de.createRequestClient(e,t);throw new Error("Missing Http Client Provider")},modifyRequest(e){e.method==="HTTP"&&(e.method="GET"),A(e)&&Ld(e)},sessionStore:S});function Ld(e){var t;if(e.url){let r=/(?<url>.*)\s+HTTP\/(?<version>(\S+))/u.exec(e.url);(t=r==null?void 0:r.groups)!=null&&t.version&&r.groups.url&&(e.url=r.groups.url.trim(),["1.1","1.0"].indexOf(r.groups.version)<0&&(e.options||(e.options={}),e.options.http2=!0))}}async function Zn(e,t){return Do(e,t,/^\s*HTTP\/(?<httpVersion>\S+)\s*(?<statusCode>[1-5][0-9][0-9])\s*(-)?\s*(?<statusMessage>.*)$/u)}async function ei(e,{httpRegion:t}){var s;let o=e().next();if(!o.done){let n=o.value.textLine,i=/^\s*<>\s*(?<fileName>.+?)\s*$/u.exec(n);if(i&&((s=i.groups)!=null&&s.fileName)){t.responseRefs||(t.responseRefs=[]);let a=i.groups.fileName;return t.responseRefs.push(a),{nextParserLine:o.value.line,symbols:[new P({name:"responseRef",description:i.groups.filename,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new P({name:"filename",description:a,kind:"path",startLine:o.value.line,startOffset:n.indexOf(a),endLine:o.value.line,endOffset:n.indexOf(a)+a.length})]})]}}}return!1}async function ti(e,{httpRegion:t}){let o=e().next();if(!o.done){let s=o.value.textLine,n=/^\s*@(?<useGlobal>global\.)?(?<key>[^\s=:]*)\s*(?<lazyIndicator>:?)=*\s*"?(?<value>.*)"?\s*$/u.exec(s);if(n&&n.groups&&n.groups.key&&n.groups.value){let i=n.groups.key,a=!!n.groups.lazyIndicator,l=!!n.groups.useGlobal,d=n.groups.value;return t.hooks.execute.addHook(`variable_${i}`,async u=>{let p=d;a?u.options.lazyVariables=!0:p=await j(d,"Variable",u);let f=u.variables.$global;return l&&f&&typeof f=="object"?Object.assign(f,{[i]:p}):D({[i]:p},u),!0}),{nextParserLine:o.value.line,symbols:[new P({name:n.groups.key,description:n.groups.value,kind:"variableDefinition",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[new P({name:n.groups.key,description:"key",kind:"key",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.key),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.key)+n.groups.key.length}),new P({name:n.groups.value,description:"value",kind:"value",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.value),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.value)+n.groups.value.length})]})]}}}return!1}function ri(e){e.httpRegion.hooks.execute.addInterceptor({id:"cancel",beforeLoop:async function(r){var s,n;return(n=(s=r.args[0].progress)==null?void 0:s.isCanceled)!=null&&n.call(s)?(g.debug("process canceled by user"),!1):!0}})}async function oi(e,t){var r;if(e&&((r=t.config)!=null&&r.defaultHeaders)){q(t,"set default request headers");let o=t.config.defaultHeaders;if(!e.headers)e.headers={...o};else for(let[s,n]of Object.entries(o))$(e.headers,s)||(e.headers[s]=n)}}var si=L(require("encodeurl"));async function ni(e){e.body&&m(e.body)&&qe(e.contentType)&&(e.body=(0,si.default)(e.body))}var ii={id:"excludeProxy",afterLoop:async function(t){var s,n;let[r,o]=t.args;return r.proxy||(r.proxy=(s=o.config)==null?void 0:s.proxy),r.proxy&&(o.httpRegion.metaData.noProxy||(n=o.config)!=null&&n.proxyExcludeList&&o.config.proxyExcludeList.some(i=>r.url.startsWith(i)))&&delete r.proxy,!0}};var ai={id:"isTrusted",afterLoop:async function(t){if(!O.isTrusted()){let[r]=t.args;return await O.showNote(`Is call to ${r.method} ${r.url} allowed, because workspace is not trusted.`)}return!0}};var ge=require("hookpoint");async function li(e,t){if(q(t,"replace variables in request"),e.url){let r=await j(e.url,"Url",t)||e.url;if(r===ge.HookCancel)return ge.HookCancel;m(r)&&(e.url=r)}if(await Qo(e,t)===!1)return ge.HookCancel;if(await qd(e,t)===!1)return ge.HookCancel}async function Qo(e,t){if(e.body){if(m(e.body)){let r=await j(e.body,"Body",t);if(r===ge.HookCancel)return!1;m(r)||Buffer.isBuffer(r)?e.body=r:e.body=v(r)}else if(Array.isArray(e.body)){let r=[];for(let o of e.body)if(m(o)){let s=await j(o,"Body",t);if(s===ge.HookCancel)return!1;m(s)&&r.push(s)}else r.push(o);e.body=r}}return!0}async function qd(e,t){if(e.headers)for(let[r,o]of Object.entries(e.headers))if(Array.isArray(o)){let s=[];for(let n of o){let i=await j(n,r,t);if(i===ge.HookCancel)return!1;s.push(i)}e.headers[r]=s}else{let s=await j(o,r,t);if(s===ge.HookCancel)return!1;e.headers[r]=s}return!0}async function di(e,t){if(e.body&&Array.isArray(e.body)){let r=[];for(let o of e.body)if(m(o))r.push(o);else if(Buffer.isBuffer(o))r.push(o);else{let s=await o(t);s&&r.push(s)}e.body=r}}async function ui(e){if(e){let t={Accept:"*/*","User-Agent":"httpyac"};if(!e.headers)e.headers=t;else for(let[r,o]of Object.entries(t))$(e.headers,r)||(e.headers[r]=o)}}async function pi(e,{variables:t}){Od(e,t),$d(e,t),Ad(e,t),Fd(e,t),Dd(e)}function Od(e,t){e&&t&&typeof t.request_rejectUnauthorized<"u"&&(e.noRejectUnauthorized=!be(t.request_rejectUnauthorized))}function $d(e,t){e&&t&&typeof t.request_noRedirect<"u"&&(e.noRedirect=be(t.request_noRedirect))}function Ad(e,t){m(t==null?void 0:t.request_proxy)&&(e.proxy=t.request_proxy)}function Dd(e){if(e.proxy||!A(e))return;let t=process.env.https_proxy||process.env.HTTPS_PROXY,r=process.env.http_proxy||process.env.HTTP_PROXY;e.url.toLowerCase().startsWith("https")&&m(t)?e.proxy=t:m(r)&&(e.proxy=process.env.httpProxy)}function Fd(e,t){let r=C(t==null?void 0:t.request_timeout);r!==void 0&&(e.timeout=r)}async function ci(e,t){e.body&&(e.body=await Zo(e.body,t))}async function Zo(e,t){return m(e)||Buffer.isBuffer(e)?e:await Id(e,t)}async function Id(e,t){let r=[];for(let o of e)if(m(o))r.push(o);else if(Buffer.isBuffer(o))r.push(o);else{let s=await o(t);s&&r.push(s)}return r.some(o=>Buffer.isBuffer(o))?Buffer.concat(r.map(o=>Buffer.isBuffer(o)?o:Buffer.from(o))):r.join("")}async function fi(e){if(e.body&&m(e.body)&&qe(e.contentType)){let t=ee(e.body);if(t.length>0){let r=[],o=["=","&"];for(let s of t)r.push(o.reduce((n,i)=>n.split(i).map(a=>a.trim()).join(i),s));e.body=r.join("")}}}async function hi(e){var r;let t=Vd(e);if(e.httpRegion.request&&t){let o=e.httpRegion.request;Nd(t.rawBody);let s=await Ud(t.rawBody);if(s.length>0){let n=Gd(s,o.contentType);n.length>0&&!n[0].wait&&(o.body=(r=n.shift())==null?void 0:r.body),n.length>0&&Wd(n,e)}}}function mi(e,t){return qe(t)?_d(e):(Bd(e,t),Md(e,t))}function Md(e,t){let r=[],o=[],s=oo(t)?`\r
`:c.EOL;for(let n of e)m(n)?o.push(n):(o.length>0&&(o.push(""),r.push(o.join(s)),o.length=0),r.push(n),o.push(""));return o.length>0&&r.length===0?o.join(s):(o.length>0&&r.push(o.join(s)),r)}function Vd(e){let t=e.data.request_body;return t&&delete e.data.request_body,t}function Bd(e,t){e.every(r=>m(r))&&no(t)&&e.push("")}function Nd(e){for(;e.length>0&&Ee(e[e.length-1]);)e.pop();if(e.length>0){let t=e[e.length-1];m(t)&&/\s*<--->\s*/u.test(t)&&e.pop()}}async function Ud(e){let t=[];for(let r of e)if(m(r))t.push(r);else{let{injectVariables:o,fileName:s}=r,n=(i,a)=>{var l;if(a.httpRegion.metaData.injectVariables)return!0;if((l=a.config)!=null&&l.requestBodyInjectVariablesExtensions){let d=Ro(i);if(d)return a.config.requestBodyInjectVariablesExtensions.indexOf(d)>=0}return!1};t.push(async i=>await fe(s,i,async a=>o||n(r.fileName,i)?await c.readFile(a,r.encoding):c.readBuffer(a)))}return t}function _d(e){let t=e.reduce((r,o,s)=>{let n=r;return m(o)&&(n+=`${s===0||o.startsWith("&")?"":c.EOL}${o}`),n},"");return m(t)?t:""}function Gd(e,t){let r=[],o=[],s=!1;for(let n of e){let i=Kd(n);i?(o.push({wait:s,body:mi(r,t)}),s=i.waitForServer,r.length=0):r.push(n)}return r.length>0&&o.push({wait:s,body:mi(r,t)}),o}function Kd(e){var t;if(m(e)){let r=/\s*={3}\s*(?<wait>wait-for-server)?\s*$/u.exec(e);if(r)return{waitForServer:!!((t=r==null?void 0:r.groups)!=null&&t.wait)}}}function Wd(e,t){t.httpRegion.hooks.onStreaming.addHook("streaming_body",async r=>{if(r.requestClient)return new Promise(o=>{Jd(e,r,o)})})}async function Jd(e,t,r){var s;let o=0;for(let n of e){let i=e.indexOf(n)===e.length-1;if(n.wait&&o++,o===0)await gi(n,t),i&&r();else{let a=0,l=o;(s=t.requestClient)==null||s.addEventListener("message",async()=>{++a===l&&(await gi(n,t),i&&r())})}}}async function gi(e,t){var r;if(await Qo(e,t),e.body){let o=await Zo(e.body,t);o&&await((r=t.requestClient)==null?void 0:r.send(o))}}async function yi(e){if(e.data.httpResponseSymbol){if(e.httpRegion.response&&e.data.httpResponseSymbol.body.length>0){let t=e.httpRegion.response,r=G(e.data.httpResponseSymbol.body);t.body=r,t.rawBody=Buffer.from(r),t.headers&&(t.contentType=Oe(t.headers));let o=e.data.httpResponseSymbol.symbol;if(o.children){let s=e.data.httpResponseSymbol.body.at(-1);o.children.push(new P({name:"response body",description:"response body",kind:"response",startLine:o.endLine-e.data.httpResponseSymbol.body.length+1,startOffset:0,endLine:o.endLine,endOffset:(s==null?void 0:s.length)||0}))}}delete e.data.httpResponseSymbol}}async function bi(e){let{httpRegion:t,httpFile:r}=e,{metaData:o}=t;zd(o),Xd(t,r)}function zd(e){let t=e.name;if(typeof t!="string")return;let r=es(e);for(let o of r)if(o===t){let s=`Self-reference detected: region named "${t}" has @ref/@forceRef to itself. This causes an infinite loop. Check for missing ### separator between requests.`;throw g.error(s),new Error(s)}}function Xd(e,t){let r=e.metaData.name;if(typeof r!="string")return;let o=es(e.metaData);if(o.length===0)return;let s=new Map;for(let d of t.httpRegions){let u=d.metaData.name;typeof u=="string"&&s.set(u,es(d.metaData))}s.set(r,o);let n=new Set,i=[];function a(d){if(i.includes(d)){let p=i.indexOf(d);return[...i.slice(p),d]}if(n.has(d))return null;n.add(d),i.push(d);let u=s.get(d);if(u)for(let p of u){let f=a(p);if(f)return f}return i.pop(),null}let l=a(r);if(l){let u=`Circular reference detected: ${l.join(" -> ")}. This will cause an infinite loop at runtime.`;throw g.error(u),new Error(u)}}function es(e){let t=[];return typeof e.ref=="string"&&t.push(...e.ref.split(/\s*,\s*/)),typeof e.forceRef=="string"&&t.push(...e.forceRef.split(/\s*,\s*/)),t}var xi={id:"escapeVariable",afterLoop:async function(t){let[r]=t.args;if(m(r)){let o=/(?:\\\{){2}([^}]+?)(?:\\\}){2}/gu,s,n=r;for(;m(n)&&(s=o.exec(r))!==null;){let[i,a]=s;n=n.replace(i,()=>`{{${a}}}`)}n!==r&&t.results.push(n)}return!0}};async function Ri(e,t,r){return U(e,async o=>{let s=Ct(o);if(s){let n=await fe(s.fileName,r,async i=>s.injectVariables||s.encoding?await c.readFile(i,s.encoding):c.readBuffer(i));return s.injectVariables&&(n=await j(n,t,r)),n}})}async function vi(e,t,{variables:r,request:o}){if(m(e)&&"Url"===t&&e.startsWith("/")){let s=$(o==null?void 0:o.headers,"Host");if(m(s)){let[,n]=s.toString().split(":");return`${n==="443"||n==="8443"?"https":"http"}://${s}${e}`}if(r.host)return`${r.host}${e}`}return e}async function wi(e,t,r){return U(e,async o=>r.variables[o])}var Qe=L(require("dayjs")),ts=L(require("dayjs/plugin/utc")),Pi=require("uuid");Qe.default.extend(ts.default);async function ki(e,t,{variables:r}){return U(e,async o=>{var n,i,a,l,d,u,p,f,h,b,k,H;let s=o.trim();if(s==="$guid")return(0,Pi.v4)();if(s.startsWith("$randomInt")){let R=/^\$randomInt\s*(?<min>-?\d+)?\s*(?<max>-?\d+)?\s*$/u.exec(s);if(R&&((n=R.groups)!=null&&n.min)&&((i=R.groups)!=null&&i.max)){let y=C((a=R.groups)==null?void 0:a.min)??0,w=C((l=R.groups)==null?void 0:l.max)??100;if(!Number.isNaN(y)&&!Number.isNaN(w)){if(y>w){let B=w;w=y,y=B}return`${Math.floor(Math.random()*(w-y))+y}`}}}else if(s.startsWith("$timestamp")){let R=/^\$timestamp(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if(R){Qe.default.extend(ts.default);let y=Qe.default.utc();return(d=R.groups)!=null&&d.offset&&((u=R.groups)!=null&&u.option)&&(y=y.add(Number(R.groups.offset),R.groups.option)),`${y.unix()}`}}else if(s.startsWith("$datetime")){let R=/^\$datetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if((p=R==null?void 0:R.groups)!=null&&p.type){let y=Qe.default.utc();return(f=R.groups)!=null&&f.offset&&((h=R.groups)!=null&&h.option)&&(y=y.add(Number(R.groups.offset),R.groups.option)),R.groups.type==="rfc1123"?y.toDate().toUTCString():R.groups.type==="iso8601"?y.toISOString():y.format(R.groups.type.slice(1,R.groups.type.length-1))}}else if(s.startsWith("$localDatetime")){let R=/^\$localDatetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(s);if((b=R==null?void 0:R.groups)!=null&&b.type){let y=Qe.default.utc().local();return(k=R.groups)!=null&&k.offset&&((H=R.groups)!=null&&H.option)&&(y=y.add(Number(R.groups.offset),R.groups.option)),R.groups.type==="rfc1123"?y.locale("en").format("ddd, DD MMM YYYY HH:mm:ss ZZ"):R.groups.type==="iso8601"?y.format():y.format(R.groups.type.slice(1,R.groups.type.length-1))}}else{if(s.startsWith("$processEnv"))return process.env[s.slice(11).trim()]||"";if(s.startsWith("$dotenv"))return r[s.slice(7).trim()]||""}})}var Hi=require("hookpoint");async function Ci(e,t,{variables:r}){return U(e,async o=>{var i;let n=/^\$(?<type>(prompt|input|password))(?<askonce>-askonce)?\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))?\s*$/u.exec(o);if((i=n==null?void 0:n.groups)!=null&&i.placeholder){let a=n.groups.placeholder.trim(),l=n.groups.type,d=`input_${a}`,u=S.getUserSession(d);if(n.groups.askonce){if((r==null?void 0:r[a])!==void 0)return r[a];if(u!=null&&u.answer)return u.answer}let p=l==="password",f=await O.showInputPrompt(a,(u==null?void 0:u.answer)||n.groups.value,p);return f!==void 0?(S.setUserSession({id:d,title:p?a:`${a}=${f}`,description:`Cache for ${l}`,type:"input",details:{placeholder:a,inputType:l,answer:p?void 0:f},answer:f}),f):Hi.HookCancel}})}var Si=require("hookpoint");async function Ti(e,t,r){return U(e,async o=>{var n,i;let s=/^\$pick(?<save>-askonce)?\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))\s*$/u.exec(o);if((n=s==null?void 0:s.groups)!=null&&n.placeholder&&((i=s==null?void 0:s.groups)!=null&&i.value)){let a=s.groups.placeholder.trim(),l=`input_${a}`,d=S.getUserSession(l);if(d!=null&&d.answer&&s.groups.save)return d.answer;let u=await Qd(s.groups.value,r),p=await O.showListPrompt(a,u);return p!==void 0?(S.setUserSession({id:l,title:`${a}=${p}`,description:"Cache for $pick",type:"input",details:{placeholder:a,answer:p},answer:p}),p):Si.HookCancel}})}async function Qd(e,t){let r=e.split(",");if(r.length===1)try{let o=await T.evalExpression(e,t);if(Array.isArray(o))return o}catch(o){g.trace("error in quickpick",o)}return r}function Li(e,t){let{httpRegion:r}=t;if(m(r.metaData.name)){let o=r.metaData.name.trim().replace(/\s/gu,"-").replace(/-./gu,s=>s[1].toUpperCase());D({[o]:e.parsedBody||e.body,[`${o}Response`]:e},t)}}var Ei={id:"jsonResponseBody",beforeLoop:async function(t){let[r]=t.args;if(r&&yt(r.contentType)&&m(r.body)&&r.body.length>0)try{r.parsedBody||(r.parsedBody=JSON.parse(r.body)),r.prettyPrintBody||(r.prettyPrintBody=F(r.parsedBody,2))}catch(o){g.warn("json parse error",r.body,o)}return!0}};function qi(e,t){let r=co(e);S.setUserSession({id:"last_response",title:"last response",description:`response of ${t.httpRegion.symbol.name}`,details:{},type:"LAST_RESPONSE",response:r}),t.variables.response=e}function Oi(e){tu(e),ru(e),ou(e),au(e),iu(e),su(e),lu(e),nu(e)}function tu(e){e.hooks.onRequest.addHook("attachDefaultHeaders",oi),e.hooks.onRequest.addHook("setEnvRequestOptions",pi),e.hooks.onRequest.addHook("resolveRequestBody",di),e.hooks.onRequest.addHook("setDefaultHttpyacHeaders",ui),e.hooks.onRequest.addHook("requestVariableReplacer",li),e.hooks.onRequest.addHook("transformRequestBody",ci),e.hooks.onRequest.addHook("transformMultilineFormUrlEncoded",fi),e.hooks.onRequest.addHook("encodeRequestBody",ni),e.hooks.onRequest.addInterceptor(ai),e.hooks.onRequest.addInterceptor(ii)}function ru(e){e.hooks.onResponse.addHook("handleMetaDataName",Li),e.hooks.onResponse.addHook("setLastResponseInVariables",qi),e.hooks.onResponse.addInterceptor(Ei)}function ou(e){e.hooks.parse.addHook("meta",zn),e.hooks.parse.addHook("comment",Wn),e.hooks.parse.addHook("variable",ti),e.hooks.parse.addHook("request",Qn),e.hooks.parse.addHook("outputRedirection",Yn),e.hooks.parse.addHook("responseRef",ei),e.hooks.parse.addHook("response",Zn),e.hooks.parse.addHook("requestBody",Xn),e.hooks.parse.addInterceptor(new Sr)}function su(e){e.hooks.parseEndRegion.addHook("registerCancelExecutionInterceptor",ri),e.hooks.parseEndRegion.addHook("response",yi),e.hooks.parseEndRegion.addHook("requestBody",hi),e.hooks.parseEndRegion.addHook("validateHttpRegion",bi)}function nu(e){e.hooks.replaceVariable.addHook("host",vi),e.hooks.replaceVariable.addHook("name",wi),e.hooks.replaceVariable.addHook("file",Ri),e.hooks.replaceVariable.addHook("showInputBox",Ci),e.hooks.replaceVariable.addHook("showQuickPick",Ti),e.hooks.replaceVariable.addHook("restClientDynamic",ki),e.hooks.replaceVariable.addInterceptor(xi)}function iu(e){e.hooks.parseMetaData.addHook("disabled",Cn),e.hooks.parseMetaData.addHook("import",Tn),e.hooks.parseMetaData.addHook("jwt",Ln),e.hooks.parseMetaData.addHook("keepStreaming",qn),e.hooks.parseMetaData.addHook("loop",An),e.hooks.parseMetaData.addHook("noRedirect",Dn),e.hooks.parseMetaData.addHook("noRejectUnauthorized",Fn),e.hooks.parseMetaData.addHook("timeout",Gn),e.hooks.parseMetaData.addHook("note",In),e.hooks.parseMetaData.addHook("proxy",jn),e.hooks.parseMetaData.addHook("rateLimit",Mn),e.hooks.parseMetaData.addHook("ref",Nn),e.hooks.parseMetaData.addHook("responseRef",Un),e.hooks.parseMetaData.addHook("sleep",_n),e.hooks.parseMetaData.addHook("verbose",Kn),e.hooks.parseMetaData.addHook("forceRegionDelimiter",Sn)}function au(e){let t=new Pr;e.hooks.execute.addInterceptor(new kr),e.hooks.execute.addInterceptor(t),e.hooks.responseLogging.addInterceptor(t.getResponseLoggingInterceptor()),e.hooks.execute.addInterceptor(new Rr),e.hooks.execute.addInterceptor(new vr),e.hooks.execute.addInterceptor(new wr)}function lu(e){e.hooks.provideEnvironments.addHook("config",gn),e.hooks.provideVariables.addHook("config",hn),e.hooks.provideVariables.addHook("response",Pn)}var $i=require("dotenv");var rs=".env";async function Ai(e){let t=[];if(process.env.HTTPYAC_ENV)try{t.push(...await c.readdir(process.env.HTTPYAC_ENV))}catch(s){g.warn(`HTTPYAC_ENV ${process.env.HTTPYAC_ENV} has read error`,s)}let r=c.dirname(e.httpFile.fileName);r&&await xe(r,e.httpFile.rootDir,async s=>{t.push(...await du(Fi(e),s)),t.push(...await Ae(c.readdir(s),[]))});let o=[];for(let s of t){let n;s.startsWith(`${rs}.`)?n=s.slice(5):s.endsWith(rs)&&(n=s.slice(0,s.length-4)),n&&o.push(n)}return g.info("dotenv Env Provider found environments",o),o}async function du(e,t){let r=[];if(e){let o=await N(e,t);o&&r.push(...await Ae(c.readdir(o),[]))}return r}async function Di(e,t){let r=uu(e),o=[];process.env.HTTPYAC_ENV&&o.push(...await os(r,process.env.HTTPYAC_ENV));let s=c.dirname(t.httpFile.fileName);if(s){let n=[];await xe(s,t.httpFile.rootDir,async i=>{n.unshift(...await pu(Fi(t),r,i)),n.unshift(...await os(r,i))}),o.push(...n)}return Object.assign({},...o)}function Fi(e){var t;return((t=e.config)==null?void 0:t.envDirName)||"env"}function uu(e){let t=[rs];if(e)for(let r of e)t.push(`${r}.env`,`.env.${r}`);return t}async function pu(e,t,r){let o=[];if(e){let s=await N(e,r);s&&o.push(...await os(t,s))}return o}async function os(e,t){let r=await Ae(c.readdir(t),[]),o=e.filter(n=>r.indexOf(n)>=0),s=[];for(let n of o){let i=c.joinPath(t,n);g.trace(`.env environment file found: ${i}`);try{let a=await c.readFile(i,"utf-8"),l=(0,$i.parse)(a);s.push(l)}catch(a){g.trace(`${c.toString(i)} not found`,a)}}return s}function Ii(e){e.hooks.provideEnvironments.addHook("dotenv",Ai),e.hooks.provideVariables.addHook("dotenv",Di)}var ji=L(require("aws4")),Mi=require("url");async function Vi(e,t,r){var s;let{request:o}=r;if(t.toLowerCase()==="authorization"&&m(e)&&A(o)&&(o!=null&&o.url)){let n=/^\s*(aws)\s+(?<accessKeyId>[^\s]*)\s+(?<secretAccessKey>[^\s]*)\s*(token:\s*(?<token>[^\s]*))?\s*(region:\s*(?<region>[^\s]*))?\s*(service:\s*(?<service>[^\s]*))?\s*$/iu.exec(e);if(n&&n.groups&&n.groups.accessKeyId&&n.groups.secretAccessKey){q(r,"get AWS Authorization");let i={accessKeyId:n.groups.accessKeyId,secretAccessKey:n.groups.secretAccessKey,sessionToken:n.groups.token},a=new Mi.URL(o.url);o.headers||(o.headers={});let l={method:o.method,headers:o.headers,host:a.host,path:`${a.pathname}${a.search}`,region:n.groups.region,service:n.groups.service,body:Buffer.isBuffer(o.body)||m(o.body)?o.body:void 0},d=await ji.default.sign(l,i);return Object.assign(o,{http2:!1}),Object.assign(o.headers,d.headers),(s=d.headers)==null?void 0:s.Authorization}}return e}var cu=/^\s*(basic)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,fu=/^\s*(basic)\s+(?<user>.*):(?<password>.*)$/iu;async function Bi(e,t){if(t.toLowerCase()==="authorization"&&m(e)){let r=fu.exec(e)||cu.exec(e);if(r&&r.groups&&r.groups.user)return`Basic ${Buffer.from(`${r.groups.user}:${r.groups.password}`).toString("base64")}`}return e}var Ni=require("url");async function Ui(e,t,r){var i,a,l;let{request:o,httpRegion:s,httpFile:n}=r;if(m(e)&&A(o)&&!s.metaData.noClientCert){if(t==="Url"&&((i=r.config)!=null&&i.clientCertificates))await mu(e,o,r);else if(t.toLowerCase().endsWith("clientcert")){let d=/^\s*(cert:\s*(?<cert>[^\s]*)\s*)?(key:\s*(?<key>[^\s]*)\s*)?(pfx:\s*(?<pfx>[^\s]*)\s*)?(passphrase:\s*(?<passphrase>[^\s]*)\s*)?\s*$/u.exec(e);if((a=d==null?void 0:d.groups)!=null&&a.cert||(l=d==null?void 0:d.groups)!=null&&l.pfx){await _i(o,{cert:d.groups.cert,key:d.groups.key,pfx:d.groups.pfx,passphrase:d.groups.passphrase},n);return}}}return e}async function mu(e,t,r){var s,n;let o=gu(e);if(o&&((s=r.config)!=null&&s.clientCertificates)){let i=(n=r.config)==null?void 0:n.clientCertificates[o.host];i&&await _i(t,i,r.httpFile)}}function gu(e){try{return new Ni.URL(e)}catch{return}}async function _i(e,t,r){let o=c.dirname(r.fileName);e.options||(e.options={}),e.options.https=Object.assign({},e.options.https,{certificate:await ss(t.cert,o),key:await ss(t.key,o),pfx:await ss(t.pfx,o),passphrase:t.passphrase})}async function ss(e,t){if(e)if(m(e)){let r=await N(e,t);if(r)return await c.readBuffer(r)}else return await c.readBuffer(e)}z.emptyLineProvider.push(()=>[{name:"GET",description:"The GET method requests a representation of the specified resource. Requests using GET should only retrieve data."},{name:"HEAD",description:"The GET method requests a representation of the specified resource. Requests using GET should only retrieve data."},{name:"POST",description:"The POST method is used to submit an entity to the specified resource, often causing a change in state or side effects on the server."},{name:"PUT",description:"The PUT method replaces all current representations of the target resource with the request payload."},{name:"DELETE",description:"The DELETE method deletes the specified resource."},{name:"CONNECT",description:"The CONNECT method establishes a tunnel to the server identified by the target resource."},{name:"OPTIONS",description:"The OPTIONS method is used to describe the communication options for the target resource."},{name:"TRACE",description:"The TRACE method performs a message loop-back test along the path to the target resource."},{name:"PATCH",description:"The PATCH method is used to apply partial modifications to a resource."}]);z.requestHeaderProvider.push(e=>A(e)?[{name:"A-IM",description:"Acceptable instance-manipulations for the request."},{name:"Accept",description:"Media type(s)\xA0that is/are acceptable for the response. See\xA0Content negotiation."},{name:"Accept-Charset",description:"Character sets that are acceptable."},{name:"Accept-Datetime",description:"Acceptable version in time."},{name:"Accept-Encoding",description:"List of acceptable encodings. See\xA0HTTP compression."},{name:"Accept-Language",description:"List of acceptable human languages for response. See\xA0Content negotiation."},{name:"Access-Control-Request-Method",description:"Initiates a request for\xA0cross-origin resource sharing\xA0with\xA0Origin\xA0(below)."},{name:"Access-Control-Request-Headers",description:"Initiates a request for\xA0cross-origin resource sharing\xA0with\xA0Origin\xA0(below)."},{name:"Authorization",description:"Authentication credentials for\xA0HTTP authentication."},{name:"Cache-Control",description:"Used to specify directives that\xA0must\xA0be obeyed by all caching mechanisms along the request-response chain."},{name:"Connection",description:"Control options for the current connection and list of hop-by-hop request fields. Must not be used with HTTP/2."},{name:"Content-Encoding",description:"The type of encoding used on the data. See\xA0HTTP compression."},{name:"Content-Length",description:"The length of the request body in\xA0octets\xA0(8-bit bytes)."},{name:"Content-MD5",description:"A\xA0Base64-encoded binary\xA0MD5\xA0sum of the content of the request body."},{name:"Content-Type",description:"The\xA0Media type\xA0of the body of the request (used with POST and PUT requests)."},{name:"Cookie",description:"An\xA0HTTP cookie\xA0previously sent by the server with\xA0Set-Cookie\xA0(below)."},{name:"Date",description:'The date and time at which the message was originated (in "HTTP-date" format as defined by\xA0RFC 7231 Date/Time Formats).'},{name:"Expect",description:"Indicates that particular server behaviors are required by the client."},{name:"Forwarded",description:"Disclose original information of a client connecting to a web server through an HTTP proxy."},{name:"From",description:"The email address of the user making the request."},{name:"Host",description:"The domain name of the server (for\xA0virtual hosting), and the\xA0TCP port\xA0number on which the server is listening. The\xA0port\xA0number may be omitted if the port is the standard port for the service requested. Mandatory since HTTP/1.1.\xA0If the request is generated directly in HTTP/2, it should not be used."},{name:"HTTP2-Settings",description:"A request that upgrades from HTTP/1.1 to HTTP/2 MUST include exactly one\xA0HTTP2-Setting\xA0header field. The\xA0HTTP2-Settings\xA0header field is a connection-specific header field that includes parameters that govern the HTTP/2 connection, provided in anticipation of the server accepting the request to upgrade."},{name:"If-Match",description:"Only perform the action if the client supplied entity matches the same entity on the server. This is mainly for methods like PUT to only update a resource if it has not been modified since the user last updated it."},{name:"If-Modified-Since",description:"Allows a\xA0304 Not Modified\xA0to be returned if content is unchanged."},{name:"If-None-Match",description:"Allows a\xA0304 Not Modified\xA0to be returned if content is unchanged, see\xA0HTTP ETag."},{name:"If-Range",description:"If the entity is unchanged, send me the part(s) that I am missing; otherwise, send me the entire new entity."},{name:"If-Unmodified-Since",description:"Only send the response if the entity has not been modified since a specific time."},{name:"Max-Forwards",description:"Limit the number of times the message can be forwarded through proxies or gateways."},{name:"Origin",description:"Initiates a request for\xA0cross-origin resource sharing\xA0(asks server for\xA0Access-Control-*\xA0response fields)."},{name:"Pragma",description:"Implementation-specific fields that may have various effects anywhere along the request-response chain."},{name:"Proxy-Authorization",description:"Authorization credentials for connecting to a proxy."},{name:"Range",description:"Request only part of an entity. Bytes are numbered from 0. See\xA0Byte serving."},{name:"Referer",description:'This is the address of the previous web page from which a link to the currently requested page was followed. (The word "referrer" has been misspelled in the RFC as well as in most implementations to the point that it has become standard usage and is considered correct terminology)'},{name:"TE",description:'The transfer encodings the user agent is willing to accept: the same values as for the response header field Transfer-Encoding can be used, plus the "trailers" value (related to the "chunked" transfer method) to notify the server it expects to receive additional fields in the trailer after the last, zero-sized, chunk. Only\xA0trailers\xA0is supported in HTTP/2.'},{name:"Trailer",description:"The Trailer general field value indicates that the given set of header fields is present in the trailer of a message encoded with\xA0chunked transfer coding."},{name:"Transfer-Encoding",description:"The form of encoding used to safely transfer the entity to the user.\xA0Currently defined methods\xA0are:\xA0chunked, compress, deflate, gzip, identity. Must not be used with HTTP/2"},{name:"User-Agent",description:"The\xA0user agent string\xA0of the user agent."},{name:"Upgrade",description:"Ask the server to upgrade to another protocol. Must not be used in HTTP/2."},{name:"Via",description:"Informs the server of proxies through which the request was sent."},{name:"Warning",description:"A general warning about possible problems with the entity body."},{name:"Upgrade-Insecure-Requests",description:"Tells a server which (presumably in the middle of a HTTP -> HTTPS migration) hosts mixed content that the client would prefer redirection to HTTPS and can handle\xA0Content-Security-Policy: upgrade-insecure-requests Must not be used with HTTP/2"},{name:"X-Requested-With",description:"Mainly used to identify\xA0Ajax\xA0requests (most\xA0JavaScript frameworks\xA0send this field with value of\xA0XMLHttpRequest); also identifies Android apps using WebView"},{name:"DNT",description:"Requests a web application to disable their tracking of a user. This is Mozilla`s version of the X-Do-Not-Track header field (since\xA0Firefox 4.0\xA0Beta 11).\xA0Safari\xA0and\xA0IE9\xA0also have support for this field.\xA0On March 7, 2011, a draft proposal was submitted to IETF.\xA0The\xA0W3C\xA0Tracking Protection Working Group is producing a specification."},{name:"X-Forwarded-For",description:"A\xA0de facto\xA0standard\xA0for identifying the originating IP address of a client connecting to a web server through an HTTP proxy or load balancer. Superseded by\xA0Forwarded\xA0header."},{name:"X-Forwarded-Host",description:"A\xA0de facto\xA0standard\xA0for identifying the original host requested by the client in the\xA0Host\xA0HTTP request header, since the host name and/or port of the reverse proxy (load balancer) may differ from the origin server handling the request. Superseded by\xA0Forwarded\xA0header."},{name:"X-Forwarded-Proto",description:"A\xA0de facto\xA0standard\xA0for identifying the originating protocol of an HTTP request, since a reverse proxy (or a load balancer) may communicate with a web server using HTTP even if the request to the reverse proxy is HTTPS. An alternative form of the header (X-ProxyUser-Ip) is used by Google clients talking to Google servers. Superseded by\xA0Forwarded\xA0header."},{name:"Front-End-Https",description:"Non-standard header field used by Microsoft applications and load-balancers"},{name:"X-Http-Method-Override",description:"Requests a web application to override the method specified in the request (typically POST) with the method given in the header field (typically PUT or DELETE). This can be used when a user agent or firewall prevents PUT or DELETE methods from being sent directly (note that this is either a bug in the software component, which ought to be fixed, or an intentional configuration, in which case bypassing it may be the wrong thing to do)."},{name:"X-ATT-DeviceId",description:"Allows easier parsing of the MakeModel/Firmware that is usually found in the User-Agent String of AT&T Devices"},{name:"X-Wap-Profile",description:"Links to an XML file on the Internet with a full description and details about the device currently connecting. In the example to the right is an XML file for an AT&T Samsung Galaxy S2."},{name:"Proxy-Connection",description:"Implemented as a misunderstanding of the HTTP specifications. Common because of mistakes in implementations of early HTTP versions. Has exactly the same functionality as standard Connection field. Must not be used with HTTP/2."},{name:"X-UIDH",description:'Server-side\xA0deep packet insertion\xA0of a unique ID identifying customers of\xA0Verizon Wireless; also known as "perma-cookie" or "supercookie"'},{name:"X-Csrf-Token",description:"Used to prevent\xA0cross-site request forgery. Alternative header names are:\xA0X-CSRFToken\xA0and\xA0X-XSRF-TOKEN"},{name:"X-Request-ID",description:"Correlates HTTP requests between a client and server."},{name:"X-Correlation-ID",description:"Correlates HTTP requests between a client and server."},{name:"Save-Data",description:"The Save-Data client hint request header available in Chrome, Opera, and Yandex browsers lets developers deliver lighter, faster applications to users who opt-in to data saving mode in their browser."}]:[]);var qt=require("tough-cookie");var Tr=class{constructor(){this.id="cookieJar"}async beforeTrigger(t){let{request:r,httpRegion:o,config:s,options:n}=t.args[0];if(A(r)&&!o.metaData.noCookieJar&&(s!=null&&s.cookieJarEnabled)){let i=this.getCookieStorePrefix(t.args[0]),a=S.userSessions.filter(p=>p.type==="Cookie"&&p.id.startsWith(i)),l=new qt.MemoryCookieStore;for(let p of a)p.cookie&&l.putCookie(p.cookie,f=>{f&&g.info(f)});n.memoryStore=l;let d={};s.cookieJarEnabled!==!0&&Object.assign(d,s.cookieJarEnabled);let u=new qt.CookieJar(l,d);r.options||(r.options={}),r.options.cookieJar=u}return!0}async afterTrigger(t){let{options:r}=t.args[0],o=r.memoryStore;if(o&&o instanceof qt.MemoryCookieStore){o.getAllCookies((n,i)=>{if(!n)for(let a of i||[]){let l={id:`${this.getCookieStorePrefix(t.args[0])}_${a.toString()}`,title:`${a.domain} ${a.path} ${a.key}`,description:`${a}`,type:"Cookie",details:Object.fromEntries(Object.entries(a).map(([d,u])=>u?u instanceof Date?[d,u.toISOString()]:[d,u]:[]).filter(d=>d.length>0)),cookie:a};S.setUserSession(l)}});let s=S.userSessions.filter(n=>n.type==="Cookie");for(let n of s)n.cookie&&o.putCookie(n.cookie,i=>{i&&g.info(i)})}return!0}getCookieStorePrefix(t){var r,o;return`Cookies_${I(t.activeEnvironment)}_${((o=(r=t.httpFile.rootDir)==null?void 0:r.toString)==null?void 0:o.call(r))||"none"}`}};var Gi=require("tough-cookie");async function Ki(e,t,r){var s;let{request:o}=r;if(t.toLowerCase()==="cookie"&&A(o)&&o.url&&((s=o.options)==null?void 0:s.cookieJar)instanceof Gi.CookieJar){if(m(e))o.options.cookieJar.setCookie(e,o.url);else if(Array.isArray(e))for(let n of e)await o.options.cookieJar.setCookie(n,o.url);return}return e}var Zi=require("crypto"),ea=require("url"),ta=require("uuid");var Wi=require("filesize"),Lr=L(require("got")),Ji=require("http-proxy-agent"),zi=require("https-proxy-agent"),Xi=L(require("lodash/merge")),Yi=require("socks-proxy-agent");async function Qi(e,t){try{let r=ns(e,t),s=await(0,Lr.default)(e.url||"",r);return Me(s,e)}catch(r){if(r instanceof Lr.CancelError)return!1;throw r}}function ns(e,t){var s;let{config:r}=t,o=(0,Xi.default)({decompress:!0,retry:0,throwHttpErrors:!1,allowGetBody:!0},r==null?void 0:r.request,{method:e.method,headers:e.headers,body:e.body,timeout:e.timeout},e.options);return e.noRedirect&&(o.followRedirect=!1),e.noRejectUnauthorized&&(o.https=((s=e.options)==null?void 0:s.https)||{},o.https.rejectUnauthorized=!1),hu(o,e.proxy),yu(o.headers),g.debug("request",o),o}function hu(e,t){if(t)if(t.startsWith("socks://")){let r=new Yi.SocksProxyAgent(t);e.agent={http:r,https:r}}else e.agent={http:new Ji.HttpProxyAgent(t),https:new zi.HttpsProxyAgent(t)}}function yu(e){if(e){for(let[t,r]of Object.entries(e))if(typeof r<"u"){let o;Array.isArray(r)?o=r.map(s=>v(s)||s):o=v(r)||"",e[t]=o}}}function Me(e,t){var r;return{name:`${e.statusCode} - ${t.method||"GET"} ${t.url}`,statusCode:e.statusCode,protocol:`HTTP/${e.httpVersion}`,statusMessage:e.statusMessage,body:e.body,rawHeaders:e.rawHeaders,rawBody:e.rawBody,headers:e.headers,timings:e.timings.phases,httpVersion:e.httpVersion,request:{protocol:"HTTP",method:e.request.options.method,url:`${e.request.options.url}`,headers:e.request.options.headers,body:is(e.request.options.body)},contentType:Oe(e.headers),meta:{ip:e.ip,redirectUrls:e.redirectUrls,size:(0,Wi.filesize)(e.rawHeaders.map(o=>o.length).reduce((o,s)=>o+s,0)+(((r=e.rawBody)==null?void 0:r.length)||0))}}}function is(e){if(typeof e=="string"||Buffer.isBuffer(e))return e}var bu=/^\s*(digest)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,xu=/^\s*(digest)\s+(?<user>.*):(?<password>.*)$/iu;async function ra(e,t,r){let{request:o}=r;if(t.toLowerCase()==="authorization"&&m(e)&&A(o)){let s=xu.exec(e)||bu.exec(e);if(s&&s.groups&&s.groups.user&&s.groups.password){o.options||(o.options={}),o.options.hooks||(o.options.hooks={}),o.options.hooks.afterResponse||(o.options.hooks.afterResponse=[]),o.options.hooks.afterResponse.push(Ru(s.groups.user,s.groups.password,r));return}}return e}function Ru(e,t,r){return async function(s,n){let i=s.headers["www-authenticate"];if(s.statusCode===401&&i&&i.toLowerCase().startsWith("digest")){let a=Me(s,{url:s.request.requestUrl});await Fe(a,r);let l=new ea.URL(s.url),d={qop:"",algorithm:"",realm:"",nonce:"",opaque:""};Pu(d,i);let u=/(^|,)\s*auth\s*($|,)/u.test(d.qop)&&"auth",p=u&&"00000001",f=u&&(0,ta.v4)().replace(/-/gu,""),h=wu(d.algorithm,e,t,d.realm,d.nonce,f),b=Ot(`${s.request.options.method}:${l.pathname}`),k=Ot(u?`${h}:${d.nonce}:${p}:${f}:${u}:${b}`:`${h}:${d.nonce}:${b}`);return n({headers:{authorization:`Digest ${vu({username:e,realm:d.realm,nonce:d.nonce,uri:l.pathname,qop:u,response:k,nc:p,cnonce:f,algorithm:d.algorithm,opaque:d.opaque})}`}})}return s}}function vu(e){let t=[];for(let[r,o]of Object.entries(e))o&&(["qop","nc","algorithm"].indexOf(r)>=0?t.push(`${r}=${o}`):t.push(`${r}="${o}"`));return t.join(", ")}function Ot(e){return(0,Zi.createHash)("md5").update(e).digest("hex")}function wu(e,t,r,o,s,n){let i=Ot(`${t}:${o}:${r}`);return n&&(e==null?void 0:e.toLowerCase())==="md5-sess"?Ot(`${i}:${s}:${n}`):i}function Pu(e,t){for(let r of t.split(",")){let o=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/giu.exec(r);o&&(e[o[1]]=o[2]||o[3])}}var $t=L(require("got"));var Er=class extends gt{constructor(r,o){super();this.request=r;this.context=o}get reportMessage(){return`perform Http Request (${this.request.url})`}get supportsStreaming(){return!1}get nativeClient(){return $t.default}async connect(){return this.nativeClient}async send(r){if(A(this.request)&&this.request.url)try{let o=ns(this.request,this.context);r&&(o.body=pe(r)),this.cancelableRequest=(0,$t.default)(this.request.url,o),this.registerEvents(this.cancelableRequest);let s=await this.cancelableRequest;this.onMessage("message",Me(s,this.request))}catch(o){if(o instanceof $t.CancelError)return;throw o instanceof TypeError&&o.message==="Invalid URL"&&(o.message=`Invalid URL: ${o.input||this.request.url}`),o}finally{delete this.cancelableRequest}}disconnect(r){var o;r&&((o=this.cancelableRequest)==null||o.cancel(),this.onDisconnect())}registerEvents(r){r.on("downloadProgress",s=>{this.onProgress(s.percent)});let o=s=>(...n)=>{this.onMetaData(s,{protocol:"HTTP",statusCode:0,message:n.length>0?`${v(n[0])}`:void 0,body:{...n}})};r.on("redirect",o("redirect")),r.on("retry",o("retry")),r.on("downloadProgress",o("downloadProgress")),r.on("uploadProgress",o("uploadProgress"))}};async function oa(e,t){var r,o;if(e&&A(e)){e.options||(e.options={}),(r=e.options)!=null&&r.hooks||(e.options.hooks={}),(o=e.options)!=null&&o.hooks.beforeRedirect||(e.options.hooks.beforeRedirect=[]),e.options.hooks.beforeRequest||(e.options.hooks.beforeRequest=[]);let s;e.options.hooks.beforeRequest.push(n=>{s={protocol:"HTTP",method:n.method,url:`${n.url}`,headers:n.headers,body:is(n.body)}}),e.options.hooks.beforeRedirect.push(async(n,i)=>{let a=Me(i,s||{url:v(n.url)||""});await Fe(a,t)})}}function sa(e,t,r){return e==="postRedirectGet"?(r.httpRegion.hooks.onRequest.addHook("postRedirectGet",async o=>{A(o)&&(o.options||(o.options={}),o.options.hooks||(o.options.hooks={}),o.options.hooks.beforeRedirect||(o.options.hooks.beforeRedirect=[]),o.options.hooks.beforeRedirect.push(s=>{s.method="GET",s.body=void 0}))}),!0):!1}de.exchange=Qi;de.createRequestClient=(e,t)=>new Er(e,t);function na(e){e.hooks.parseMetaData.addHook("postRedirectGet",sa),e.hooks.execute.addInterceptor(new Tr),e.hooks.replaceVariable.addHook("aws",Vi),e.hooks.replaceVariable.addHook("basicAuth",Bi),e.hooks.replaceVariable.addHook("clientCertificate",Ui),e.hooks.replaceVariable.addHook("digestAuth",ra),e.hooks.replaceVariable.addHook("cookie",Ki),e.hooks.onRequest.addHook("logHttpRedirect",oa)}var Ze=class{constructor(t,r,o){this.extensions=t;this.beginCodeBlock=r;this.endCodeBlock=o}async beforeTrigger(t){let r=t.args[0],o=t.args[1];if(c.hasExtension(o.httpFile.fileName,...this.extensions)){let s=this.getHttpBlockLines(o.lines,o.data);t.args[0]=function*(i){if(s.length>0){let a=r(!0);for(let l of a){let d=s.find(u=>u.startLine<=l.line&&l.line<u.endLine);if(d)if(d.startLine===l.line)yield{line:l.line,textLine:"###"};else{if(!i&&me.test(l.textLine))break;yield l}else break}}}}return!0}getHttpBlockLines(t,r){if(r.codeBlocks)return r.codeBlocks;let o=[],s=-1;for(let n=0;n<t.length;n++){let i=t[n];s<0?Array.isArray(this.beginCodeBlock)?t.length>n+this.beginCodeBlock.length&&this.beginCodeBlock.every((a,l)=>a.test(t[n+l]))&&(s=n+this.beginCodeBlock.length-1,n+=this.beginCodeBlock.length-1):this.beginCodeBlock.test(i)&&(s=n):this.endCodeBlock.test(i)&&(o.push({startLine:s,endLine:n}),s=-1)}return r.codeBlocks=o,o}};var qr=class extends Ze{constructor(){super(["adoc","asciidoc","asc"],[/^\[source,http\]\s*$/iu,/^----\s*$/u],/^----\s*$/u);this.id="asciidoc"}};var Or=class extends Ze{constructor(){super(["md","markdown","mdown","mkdn","mdtxt","mdtext","text","rmd"],/^```\s*(http|rest)$/iu,/^```\s*$/u);this.id="markdown"}};function ia(e){e.hooks.parse.addInterceptor(new Or),e.hooks.parse.addInterceptor(new qr)}var Y=require("crypto");var $r=class{constructor(){this.hmac=new ls}sha1(){return new le((0,Y.createHash)("sha1"))}sha256(){return new le((0,Y.createHash)("sha256"))}sha384(){return new le((0,Y.createHash)("sha384"))}sha512(){return new le((0,Y.createHash)("sha512"))}md5(){return new le((0,Y.createHash)("md5"))}},le=class e{constructor(t){this.hash=t}updateWithText(t,r){let o=We(r),s=this.hash.update(Buffer.from(t,o));return new e(s)}updateWithHex(t){let r=this.hash.update(Buffer.from(t,"hex"));return new e(r)}updateWithBase64(t,r){let o=this.hash.update(Buffer.from(t,r?"base64url":"base64"));return new e(o)}digest(){return new as(this.hash)}},as=class{constructor(t){this.hash=t}toHex(){return this.hash instanceof Y.Hmac?this.hash.digest("hex"):this.hash.digest("hex")}toBase64(t){let r=t?"base64url":"base64";return this.hash instanceof Y.Hmac?this.hash.digest(r):this.hash.digest(r)}},ls=class{sha1(){return new Ve("sha1")}sha256(){return new Ve("sha256")}sha384(){return new Ve("sha384")}sha512(){return new Ve("sha512")}md5(){return new Ve("md5")}},Ve=class{constructor(t){this.algorithm=t}withTextSecret(t,r){let o=(0,Y.createHmac)(this.algorithm,Buffer.from(t,We(r)));return new le(o)}withHexSecret(t){let r=(0,Y.createHmac)(this.algorithm,Buffer.from(t,"hex"));return new le(r)}withBase64Secret(t,r){let o=(0,Y.createHmac)(this.algorithm,Buffer.from(t,r?"base64url":"base64"));return new le(o)}};var aa=require("assert");var Be=class{constructor(t){this.context=t;this.userSession=this.getIntellijSession()}getIntellijSession(){let t="intellij_global_cache",r=S.getUserSession(t);if(this.isIntellijGlobalCacheSession(r))return r;let o={id:t,title:"Intellij Cache",description:"Global Cache for all Intellij Variables",details:{},type:"intellij_global_cache"};return S.setUserSession(o),o}isIntellijGlobalCacheSession(t){return!!(t!=null&&t.id)&&!!t.title}set(t,r){this.userSession.details[t]=r,D({[t]:r},this.context)}get(t){return this.context.variables[t]}isEmpty(){return Object.entries(this.userSession.details).length===0}clear(t){delete this.userSession.details[t],De(t,this.context)}clearAll(){for(let[t]of Object.entries(this.userSession.details))this.clear(t)}};var Ar=class{constructor(t){this.context=t;this.global=new Be(t)}test(t,r){vt(this.context)(t,r)}assert(t,r){(0,aa.ok)(t,r)}log(t){this.context.scriptConsole&&this.context.scriptConsole.info(t)}exit(){var t;(t=this.context.scriptConsole)==null||t.warn("exit not supported")}};var da=require("uuid");function Dr(e){let t=e.trim();if(["$uuid","$random.uuid"].indexOf(t)>=0)return(0,da.v4)();if(t==="$timestamp")return v(Date.now());if(t==="$isoTimestamp")return new Date().toISOString();if(t==="$randomInt")return`${Math.floor(Math.random()*1e3)}`;if(t.startsWith("$random.integer")){let r=la(t);if(r)return`${Math.floor(r)}`}if(t.startsWith("$random.float")){let r=la(t);if(r)return`${r}`}if(t.startsWith("$random.alphabetic"))return ku(t);if(t.startsWith("$random.alphanumeric"))return Hu(t);if(t.startsWith("$random.hexadecimal"))return Cu(t);if(t.startsWith("$random.email"))return ze()}function la(e){var r,o,s,n;let t=/^\$random.(integer|float)\s*\(\s*(?<from>-?\d+)\s*,\s*(?<to>-?\d+)\s*\)$/u.exec(e);if(t&&((r=t.groups)!=null&&r.from)&&((o=t.groups)!=null&&o.to)){let i=C((s=t.groups)==null?void 0:s.from)||0,a=C((n=t.groups)==null?void 0:n.to)||0;if(!Number.isNaN(i)&&!Number.isNaN(a)){if(i>a){let l=a;a=i,i=l}return Math.random()*(a-i)+i}}}function ku(e){var r,o;let t=/^\$random.alphabetic\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=C((o=t.groups)==null?void 0:o.length);if(s)return J(s,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz")}}function Hu(e){var r,o;let t=/^\$random.alphanumeric\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=C((o=t.groups)==null?void 0:o.length);if(s)return J(s)}}function Cu(e){var r,o;let t=/^\$random.hexadecimal\s*\(\s*(?<length>-?\d+)\s*\)\s*$/u.exec(e);if(t&&((r=t.groups)!=null&&r.length)){let s=C((o=t.groups)==null?void 0:o.length);if(s)return J(s,"1234567890ABCDEF")}}async function ua(e,t,r){return U(e,async o=>Dr(o))}var Fr=class{url(){return this._url}body(){return this._body||""}constructor(t){var r,o,s,n;this._url=((r=t.request)==null?void 0:r.url)||"",this.method=((o=t.request)==null?void 0:o.method)||"",this._body=((s=t.request)==null?void 0:s.body)&&v((n=t.request)==null?void 0:n.body),this.headers=new jr(t),this.environment=new Vr(t.variables),this.variables=new Be(t)}},Ir=class{constructor(t){var r;this.url=new us(t),this.method=((r=t.request)==null?void 0:r.method)||"",this.body=new ds(t),this.headers=new jr(t),this.environment=new Vr(t.variables),this.variables=new Be(t)}},ds=class{constructor(t){this.context=t}getRaw(){var t;return v((t=this.context.request)==null?void 0:t.body)||""}tryGetSubstituted(){var r;let t=ps(this.getRaw(),this.context.variables);return t&&((r=this.context.request)!=null&&r.body)&&(this.context.request.body=t),t}},jr=class{constructor(t){this.context=t}all(){var t;return(t=this.context.request)!=null&&t.headers?Object.keys(this.context.request.headers).map(r=>new Mr(r,this.context)):[]}findByName(t){var r;return $((r=this.context.request)==null?void 0:r.headers,t)?new Mr(t,this.context):null}},Mr=class{constructor(t,r){this.name=t;this.context=r}value(){return this.getRawValue()}getRawValue(){var t;return v($((t=this.context.request)==null?void 0:t.headers,this.name))||""}tryGetSubstitutedValue(){var r;let t=ps(this.getRawValue(),this.context.variables);return t&&((r=this.context.request)!=null&&r.headers)&&(io(this.context.request.headers,this.name),this.context.request.headers[this.name]=t),t}},us=class{constructor(t){this.context=t}getRaw(){var t;return((t=this.context.request)==null?void 0:t.url)||""}tryGetSubstituted(){var r;let t=ps(this.getRaw(),this.context.variables);return t&&((r=this.context.request)!=null&&r.body)&&(this.context.request.body=t),t}},Vr=class{constructor(t){this.variables=t}get(t){let r=v(this.variables[t]);return Ge(r)?null:r}};function ps(e,t){let r=e,o=[Dr,s=>{let n=t[s];if(!Ge(n))return v(n)}];for(let s of o)r=Su(r,s);return r}function Su(e,t){if(!m(e))return e;let r,o,s=e,n=0;for(;o!==s&&n++<100;)for(o=s;(r=kt.exec(o))!==null;){let[i,a]=r,l=t(a,i);if(typeof l<"u"&&i===e)return l;let d=v(l);typeof d<"u"&&(s=s.replace(i,()=>d))}return s}var Br=class{constructor(t){this.body=t.parsedBody||t.body,this.status=t.statusCode,this.contentType=cs(t.contentType),this.headers=new Nr(t.headers)}};function cs(e){return{mimeType:(e==null?void 0:e.mimeType)||"application/octet-stream",charset:(e==null?void 0:e.charset)||"utf-8"}}var Nr=class{constructor(t){this.headers=t}valueOf(t){if(this.headers){let r=$(this.headers,t);if(r&&m(r))return r}return null}valuesOf(t){if(this.headers){let r=$(this.headers,t);if(r){if(m(r))return[r];if(Array.isArray(r))return r}}return[]}},Ur=class{constructor(t,r){this.requestClient=t;this.resolve=r;this.status=0;this.contentType=cs();this.lazyHeaders={};this.body={onEachLine:(...o)=>this.onEachLine(...o),onEachMessage:(...o)=>this.onEachMessage(...o)},this.headers=new Nr(this.lazyHeaders)}onEachLine(t,r){this.onEachMessage(t,r)}onEachMessage(t,r){let o=s=>{let[,n]=s.detail;this.status=n.statusCode,Object.assign(this.headers,n.headers),this.contentType=cs(n.contentType);let i=v(n.body);i&&t(i,()=>{this.requestClient.removeEventListener("message",o),this.resolve()},d=>this.requestClient.send(d))};this.requestClient.addEventListener("message",o),r&&this.requestClient.addEventListener("end",r)}};var pa=L(require("dayjs"));var ca=require("uuid"),_r=class{alphabetic(t=10){return J(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz")}numeric(t=10){return J(t)}hexadecimal(t=10){return J(t,"1234567890ABCDEF")}get email(){return ze()}float(t=0,r=100){return Math.random()*(r-t)+t}integer(t=0,r=100){return Math.floor(Math.random()*(r-t)+t)}get uuid(){return(0,ca.v4)()}date(t=new Date,r=void 0){return(0,pa.default)(t).format(r)}};var Gr=class{btoa(t){return global.btoa(t)}atob(t){return global.atob(t)}};z.variableProvider.push(()=>[{name:"$uuid",description:"UUID"},{name:"$uuid",description:"UUID"},{name:"$random.uuid",description:"UUID"},{name:"$timestamp",description:"Timestamp"},{name:"$isoTimestamp",description:"ISOTimestamp"},{name:"$randomInt",description:"randomInt (0 -1000)"},{name:"$random.integer",description:"integer"},{name:"$random.float",description:"float"},{name:"$random.alphabetic",description:"Alphabetic Text"},{name:"$random.alphanumeric",description:"Alphanumeric Text"},{name:"$random.hexadecimal",description:"Hexadecimal String"},{name:"$random.email",description:"EMail"}]);var Kr=class{constructor(t,r){this.scriptData=t;this.id="intellij";r&&(this.before=["requestVariableReplacer"])}isStreamingScript(t){return["onEachLine","onEachMessage"].some(r=>t.script.indexOf(r)>0)}async processOnRequest(t,r){q(r,"execute Intellij Javascript");let o=await this.loadScript(r);if(this.isStreamingScript(o))return;let s=fs(r);await this.executeScriptData(o,s,r)}async processOnStreaming(t){let r=await this.loadScript(t);if(this.scriptData=r,this.isStreamingScript(r)&&t.requestClient){let o=t.requestClient;await new Promise(s=>{let n=fs(t);n.response=new Ur(o,s),this.executeScriptData(r,n,t)})}}async processOnResponse(t,r){q(r,"execute Intellij Javascript");let o=await this.loadScript(r);if(this.isStreamingScript(o))return;let s=fs(r);s.response=new Br(t),await this.executeScriptData(o,s,r)}async executeScriptData(t,r,o){return T.runScript?(await T.runScript(t.script,{fileName:o.httpFile.fileName,context:{console:o.scriptConsole,...r},lineOffset:t.lineOffset}),!0):!1}async loadScript(t){if(this.isIntellijScriptData(this.scriptData))try{return{script:await fe(this.scriptData.fileName,t,r=>c.readFile(r,"utf-8"))||"",lineOffset:0}}catch(r){throw(t.scriptConsole||g).error(this.scriptData.fileName,r),new Error(`error loading script ${this.scriptData.fileName}`)}else return this.scriptData}isIntellijScriptData(t){return!!t.fileName}};function fs(e){let t={client:new Ar(e),crypto:new $r,$random:new _r,$env:process.env,Window:new Gr};return e.request&&(e.httpRegion.response?t.request=new Fr(e):t.request=new Ir(e)),t}async function fa(){let e=S.getUserSession("intellij_global_cache");return(e==null?void 0:e.details)||{}}async function ma(e,{httpRegion:t}){let r=e(),o=Lu(r,!!t.request);if(o){let s=new Kr(o.data,o.isBeforeRequest);return o.isBeforeRequest?t.hooks.onRequest.addObjHook(n=>n.processOnRequest,s):(t.hooks.onStreaming.addObjHook(n=>n.processOnStreaming,s),t.hooks.onResponse.addObjHook(n=>n.processOnResponse,s)),{nextParserLine:o.endLine,symbols:[new P({name:"Intellij Script",description:"Intellij Script",kind:"script",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset,children:o.symbols})]}}return!1}function Lu(e,t){var o,s,n;let r=e.next();if(!r.done){let i=r.value.line,a=/^\s*(?<event>(<|>))\s+(?<fileName>[^\s{%}]+\s*)$/u.exec(r.value.textLine);if((o=a==null?void 0:a.groups)!=null&&o.fileName){if(a.groups.event==="<"&&t)return!1;let u=a.groups.fileName.trim();return{startLine:i,endLine:i,endOffset:r.value.textLine.length,data:{fileName:u},isBeforeRequest:a.groups.event==="<",symbols:[new P({name:"filename",description:u,kind:"path",startLine:r.value.line,startOffset:r.value.textLine.indexOf(u),endLine:r.value.line,endOffset:r.value.textLine.indexOf(u)+u.length})]}}let l=/^\s*(?<event>(<|>))\s+\{%\s*(?<script>.*)\s*%\}\s*$/u.exec(r.value.textLine);if((s=l==null?void 0:l.groups)!=null&&s.script)return l.groups.event==="<"&&t?!1:{startLine:i,endLine:i,endOffset:r.value.textLine.length,data:{script:l.groups.script,lineOffset:i},isBeforeRequest:l.groups.event==="<"};let d=/^\s*(?<event>(<|>))\s+\{%\s*$/u.exec(r.value.textLine);if((n=d==null?void 0:d.groups)!=null&&n.event){if(d.groups.event==="<"&&t)return!1;r=e.next();let u=[];for(;!r.done;){if(/^\s*%\}\s*$/u.test(r.value.textLine))return{startLine:i,endLine:r.value.line,endOffset:r.value.textLine.length,data:{script:G(u),lineOffset:i},isBeforeRequest:d.groups.event==="<"};u.push(r.value.textLine),r=e.next()}}}return!1}async function ga(e,t,r){return U(e,async o=>{if(o.trim()==="$projectRoot")return r.httpFile.rootDir})}async function ha(e){let t=Object.keys(await ya(e));return g.info("Intellij Env Provider found environments",t),t}async function ya(e){var i;let t=[],r=a=>["http-client.env.json","http-client.private.env.json"].includes(a),o=process.env.HTTPYAC_ENV;if(o&&m(o)){let a=await N(o,e.httpFile.rootDir);a&&t.push(...await ms(a,r))}if((i=e.config)!=null&&i.envDirName){let a=await N(e.config.envDirName,e.httpFile.rootDir);a&&t.push(...await ms(a,r))}let s=c.dirname(e.httpFile.fileName);s&&await xe(s,e.httpFile.rootDir,async a=>{t.push(...await ms(a,r))});let n={};t.length>0&&g.trace(`Intellij environment files found: ${t.join(", ")}`),t.sort((a,l)=>{let d=c.toString(a),u=c.toString(l),p=d.endsWith("private.env.json"),f=u.endsWith("private.env.json");return p===f?d.localeCompare(u):p?1:-1});for(let a of t){let l=await Eu(a);if(l)for(let[d,u]of Object.entries(l))n[d]?(c.toString(a).endsWith("private.env.json")||g.warn(`Multiple files with environment ${d} were found.`),Object.assign(n[d],u)):n[d]=u}return n}async function ms(e,t){return(await Ae(c.readdir(e),[])).filter(t).map(o=>c.joinPath(e,o))}async function ba(e,t){let r=await ya(t),o=[];if(e)for(let s of e)o.push(r[s]);return Object.assign({},...o)}async function Eu(e){try{if(await c.exists(e)){let t=await c.readFile(e,"utf-8");return JSON.parse(t)}}catch(t){g.trace(`${e} not found`),g.trace(t)}}function xa(e){e.hooks.parse.addHook("intellijScript",ma,{before:["request"]}),e.hooks.provideEnvironments.addHook("intellij",ha),e.hooks.provideVariables.addHook("intellij",ba),e.hooks.provideVariables.addHook("intellij_global",fa),e.hooks.replaceVariable.addHook("intellijDynamic",ua,{before:["name"]}),e.hooks.replaceVariable.addHook("intellijProjectContext",ga,{before:["name"]})}z.emptyLineProvider.push(()=>[{name:`{{@streaming
`,description:"Streaming Javascript Block"},{name:`{{@response
`,description:"Response Javascript Block"},{name:`{{@request
`,description:"Request Javascript Block"}]);z.variableProvider.push(()=>[{name:"$random.alphabetic()",description:"random letters"},{name:"$random.number()",description:"random number"},{name:"$random.hexadecimal()",description:"random hexadecimal"},{name:"$random.email()",description:"random email"},{name:"$random.float()",description:"random float"},{name:"$random.integer()",description:"random integer"},{name:"$random.uuid()",description:"random uuid"},{name:"$random.date()",description:"Date format function"}]);async function Ra(e){let t=va(e),r=S.getUserSession(t);return(r==null?void 0:r.details)||{$global:{}}}var Wr=class{constructor(){this.id="globalVariables"}async afterLoop(t){let[r]=t.args,o=r.variables.$global;if(o&&typeof o=="object"&&Object.keys(o).length>0){let s=va(r.activeEnvironment);S.setUserSession({id:s,title:"global store",description:r.activeEnvironment?`global Variables for ${r.activeEnvironment.join(", ")}`:"global Variables",type:"global_cache",details:{$global:o}})}return!0}};function va(e){return`global_cache_${I(e)}`}var Jr=class{constructor(t,r){this.context=t;this.httpFileStore=r}findHttpRegionInContext(t){return Ie(t,this.context)}async import(t){return await St(t,this.httpFileStore,this.context)}setVariables(t){D(t,this.context)}async execute(t,r){r&&D(r,this.context);let o;if(m(t)?o=Ie(t,this.context):o=t,o&&await(o==null?void 0:o.execute(this.context))){let n=I(this.context.activeEnvironment);D(o.variablesPerEnv[n],this.context)}return this.context.variables}};var At=L(require("module")),Dt=L(require("path")),wa=L(require("vm"));function Pa(e,t){let r;try{try{r=At.default.createRequire(Dt.default.resolve(t,"package.json")).resolve(e)}catch{r=require.resolve(e,{paths:[t]})}}catch(o){g.debug(o)}return r}function ka(e,t,r=!1){if(O.isTrusted("loadModule"))try{return r&&Ou(e,t),At.default.createRequire(Dt.default.resolve(t,"package.json"))(e)}catch{let o=Pa(e,t);if(o)return r&&gs(o),require(o)}}function qu(e,t){let r=new At.default(e,require.main);return r.filename=e,r.paths=At.default._nodeModulePaths(Dt.default.dirname(e)),t&&r._compile(t,e),r}function Ou(e,t){let r=Pa(e,t);r&&gs(r)}function gs(e,t=new Map){let r=require.cache[e];r&&(t.set(e,!0),r.children.forEach(o=>{t.get(o.id)||gs(o.id,t)}),delete require.cache[e])}async function Ft(e,t){if(!O.isTrusted("runScript"))return{};let r=$u(t.fileName),o=qu(r);function s(p){let f=T.require;return f&&f[p]?f[p]:o.require(p)}let n=Du(t.context),i=Object.assign({$context:n,...n}),a=Object.keys(i),l=`(async function userJS(exports, require, module, __filename, __dirname, context){ with(context){${c.EOL}${e}${c.EOL}}})`;await wa.default.runInThisContext(l,{filename:r,lineOffset:t.lineOffset,displayErrors:!0}).apply(i,[o.exports,s,o,r,Dt.default.dirname(r),i]),Au(a,i,t.deleteVariable);let u=o.exports;if(Je(u))u=await u;else for(let[p,f]of Object.entries(u))Je(f)&&(u[p]=await f);return u}function $u(e){return c.fsPath(e)||c.toString(e)}function Au(e,t,r){if(r)for(let o of e)try{t[o]===void 0&&r(o)}catch(s){g.info(`error on delete of ${o}`,s)}}async function zr(e,t,r){if(!O.isTrusted("evalExpression"))return;let o=`exports.$result = (${e});`,s=t.httpRegion.symbol.startLine;if(t.httpRegion.symbol.source){let i=ee(t.httpRegion.symbol.source).findIndex(a=>a.indexOf(e)>=0);i>=0&&(s+=i)}return(await Ft(o,{fileName:t.httpFile.fileName,context:{...t.variables,httpFile:t.httpFile,httpRegion:t.httpRegion,request:t.request,console:t.scriptConsole,$random:Tt,...r,$context:t},lineOffset:s})).$result}function Du(e){let t={};for(let[r,o]of Object.entries(e)){let s=r.trim().replace(/\s/gu,"-").replace(/-./gu,n=>n[1].toUpperCase());Ca.indexOf(s)<0&&typeof o<"u"&&(t[s]=o)}return t}function Ha(e){return Ca.indexOf(e)>=0?(g.warn(`Keyword ${e} prevented, because Javascript Keyword`),!1):Fu.indexOf(e)>=0?(g.warn(`Keyword ${e} prevented, because used by httpYac`),!1):!0}var Fu=["httpFile","httpRegion","request","test","sleep"],Ca=["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","implements","import","in","instanceof","interface","let","new","null","package","private","protected","public","return","super","switch","static","this","throw","try","true","typeof","var","void","while","with","yield"];var ju=/^\s*\{\{(@js\s+)?(?<modifier>\+|@)?(?<event>(request|streaming|response|after|responseLogging)?)?\s*$/iu,Mu=/^\s*\}\}\s*$/u;async function Sa(e,{httpRegion:t,httpFile:r,httpFileStore:o}){let s=e(),n=s.next();if(!n.done){let i=ju.exec(n.value.textLine);if(i!=null&&i.groups){let a=n.value.line;n=s.next();let l=[];for(;!n.done;){if(Mu.test(n.value.textLine)){let d={script:G(l),lineOffset:a},u=i.groups.modifier==="+";switch(i.groups.event){case"request":Nu(u?r.hooks:t.hooks,d,o);break;case"streaming":Vu(u?r.hooks:t.hooks,d,o);break;case"response":Uu(u?r.hooks:t.hooks,d,o);break;case"after":Gu(u?r.hooks:t.hooks,d,o);break;case"responseLogging":_u(u?r.hooks:t.hooks,d,o);break;default:Bu(u?r.hooks:t.hooks,d,o);break}return{nextParserLine:n.value.line,symbols:[new P({name:"script",description:"nodejs script",kind:"script",startLine:a,startOffset:0,endLine:n.value.line,endOffset:n.value.textLine.length})]}}l.push(n.value.textLine),n=s.next()}}}return!1}function Vu(e,t,r){e.onStreaming.addHook("js",async o=>await et(t,o,r,"streaming")?void 0:mt)}function Bu(e,t,r){e.execute.addHook("js",o=>et(t,o,r))}function Nu(e,t,r){e.onRequest.addHook("js",async(o,s)=>await et(t,s,r,"request")?void 0:mt)}function Uu(e,t,r){e.onResponse.addHook("js",async(o,s)=>(s.variables.response=o,await et(t,s,r,"response")?void 0:mt))}function _u(e,t,r){e.responseLogging.addHook("js",async(o,s)=>{let n=s.variables.response;s.variables.response=o,await et(t,s,r,"responseLogging"),s.variables.response=n})}function Gu(e,t,r){e.execute.addInterceptor(new hs(t,r))}var hs=class{constructor(t,r){this.scriptData=t;this.httpFileStore=r;this.id=`afterJavascript_${t.script}`}async afterLoop(t){return await et(this.scriptData,t.args[0],this.httpFileStore,"after")}};async function et(e,t,r,o){q(t,o?`execute javascript (@${o})`:"execute javascript");let s=await Ft(e.script,{fileName:t.httpFile.fileName,context:{...t.variables,httpFile:t.httpFile,httpRegion:t.httpRegion,request:t.request,console:t.scriptConsole,sleep:we,test:vt(t),$httpyac:new Jr(t,r),$random:Tt,$context:t},lineOffset:e.lineOffset,deleteVariable:i=>De(i,t)}),n=s.$cancel;return n&&(delete s.$cancel,te(t.httpRegion)),D(s,t),!n}async function Ta(e,t,r){return await U(e,async(o,s)=>{try{return await zr(o,r)}catch(n){if(t==="Variable")(r.scriptConsole||g).debug(`variable ${o} not defined`),(r.scriptConsole||g).debug(n);else throw(r.scriptConsole||g).error(`expression ${o} throws error`),n;return s}})}var La=L(require("dayjs")),Ku=L(require("uuid"));V.javascriptProvider.loadModule=ka;function Ea(e){e.hooks.replaceVariable.addHook("javascript",Ta,{before:["aws"]}),e.hooks.parse.addHook("javascript",Sa,{before:["request"]}),e.hooks.execute.addInterceptor(new Wr),e.hooks.provideVariables.addHook("globalVariables",Ra),Wu(),V.javascriptProvider.evalExpression=zr,V.javascriptProvider.runScript=Ft,V.javascriptProvider.isAllowedKeyword=Ha}function Wu(){Object.assign(V.javascriptProvider.require,{httpyac:ys,dayjs:La.default,uuid:Ku})}se.core=Oi;se.dotenv=Ii;se.http=na;se.intellij=xa;se.injection=ia;se.javascript=Ea;se.assert=cn;var bs=require("hookpoint");async function xs(e){let t=!1;return Io(e)?t=await zu(e):jo(e)?t=await qa(e):t=await Xu(e),t}async function zu(e){let t=await Ne(e);return await ve(t)?await e.httpRegion.execute(t,!0):!1}async function qa(e){let t=await Ne(e);if(await ve(t)){e.progress&&(e.progress.divider=e.httpRegions.length);let r=!0;for(let o of e.httpRegions){let s=await o.execute(t,!0);r=r&&s}return r}return!1}async function Xu(e){let t=[];for(let r of e.httpFile.httpRegions)e.httpRegionPredicate&&!e.httpRegionPredicate(r)?g.debug(`${r.symbol.name} disabled by predicate`):r.isGlobal()||t.push(r);return await qa({...e,httpRegions:t})}async function Ne(e){return Object.assign(e,{variables:await Oa(e),options:{}})}async function Oa(e){e.config=await Xe(e.config,e.httpFile);let t=await e.httpFile.hooks.provideVariables.trigger(e.activeEnvironment,e);if(t===bs.HookCancel)return e.variables||{};let r={...e.variables},o=Object.assign(e.variables||{},...t.map(s=>Wt(s)),r);return g.debug("current environment variables",o),o}async function Yu(e){e.config=await Xe(e.config,e.httpFile);let t=await e.httpFile.hooks.provideEnvironments.trigger(e);return t!==bs.HookCancel&&t.length>0?t.reduce((r,o)=>{for(let s of o)r.indexOf(s)<0&&r.push(s);return r},[]).sort():[]}function It(e,t){return e+t}function Xr(e,t){let r=[];for(let o of e)r.push(jt(o,t));return{_meta:{version:"1.1.0"},requests:r,summary:Qu(r)}}function Qu(e){return{totalRequests:e.length,skippedRequests:e.filter(t=>t.summary.skippedTests>0).length,failedRequests:e.filter(t=>t.summary.failedTests>0).length,successRequests:e.filter(t=>t.summary.failedTests+t.summary.erroredTests+t.summary.skippedTests===0).length,erroredRequests:e.filter(t=>t.summary.erroredTests>0).length,totalTests:e.map(t=>t.summary.totalTests).reduce(It,0),failedTests:e.map(t=>t.summary.failedTests).reduce(It,0),successTests:e.map(t=>t.summary.successTests).reduce(It,0),erroredTests:e.map(t=>t.summary.erroredTests).reduce(It,0),skippedTests:e.map(t=>t.summary.skippedTests).reduce(It,0)}}function jt(e,t){var o,s,n,i,a,l,d,u,p,f,h,b,k,H;let r=t.output;return t.outputFailed&&((s=(o=e.testResults)==null?void 0:o.some)!=null&&s.call(o,R=>!R.status))&&(r=t.outputFailed),{fileName:c.fsPath(e.filename)||c.toString(e.filename),response:Zu(e.response,r),name:v((n=e.metaData)==null?void 0:n.name)||e.symbol.name,line:e.symbol.startLine,title:v((i=e.metaData)==null?void 0:i.title),description:v((a=e.metaData)==null?void 0:a.description),testResults:e.testResults,timestamp:new Date(performance.timeOrigin+e.start).toISOString(),duration:e.duration,summary:{totalTests:((l=e.testResults)==null?void 0:l.length)||0,failedTests:((u=(d=e.testResults)==null?void 0:d.filter)==null?void 0:u.call(d,R=>R.status==="FAILED").length)||0,successTests:((f=(p=e.testResults)==null?void 0:p.filter)==null?void 0:f.call(p,R=>R.status==="SUCCESS").length)||0,erroredTests:((b=(h=e.testResults)==null?void 0:h.filter)==null?void 0:b.call(h,R=>R.status==="ERROR").length)||0,skippedTests:((H=(k=e.testResults)==null?void 0:k.filter)==null?void 0:H.call(k,R=>R.status==="SKIPPED").length)||0}}}function Zu(e,t){var r;if(e)switch(delete e.rawHeaders,delete e.rawBody,delete e.prettyPrintBody,delete e.parsedBody,delete e.contentType,delete e.tags,t){case"body":case"response":return delete e.request,e;case"short":return delete e.body,delete e.request,e;case"none":return;case"headers":return delete e.body,(r=e.request)==null||delete r.body,e;case"exchange":default:return e}}var $a=L(require("crypto")),Vt=L(require("fs")),Mt=L(require("path"));var Aa=".uctest-deps";async function Da(e){let t=Mt.default.join(e,Aa);try{let r=await Vt.default.promises.readFile(t,"utf-8");return JSON.parse(r)}catch(r){if(r.code==="ENOENT")return;throw r}}async function Fa(e,t){let r=Mt.default.join(e,Aa);await Vt.default.promises.writeFile(r,JSON.stringify(t,null,2),"utf-8")}async function Ia(e,t){let{globby:r}=await import("globby"),o=(await r("**/*.http",{cwd:t})).sort(),s=Object.keys(e.files).sort();if(!tp(o,s))return{valid:!1,reason:"files_changed"};for(let[n,i]of Object.entries(e.files)){let a=Vt.default.statSync(Mt.default.join(t,n));if((a.mtimeMs!==i.mtime||a.size!==i.size)&&ep(Mt.default.join(t,n))!==i.checksum)return{valid:!1,reason:"content_changed",file:n}}return{valid:!0}}function ep(e){let t=Vt.default.readFileSync(e);return $a.default.createHash("sha256").update(t).digest("hex")}function tp(e,t){return e.length!==t.length?!1:e.every((r,o)=>r===t[o])}var Ba=L(require("crypto")),ws=L(require("fs")),he=L(require("path"));var rp=/\{\{.*?\}\}/;async function Na(e,t={}){var n;let r=he.default.resolve(e),o=(n=t.files)!=null&&n.length?t.files:await op(r);if(o.length===0)throw new Error(`No .http files found under ${r}`);let s={version:"1.0",generated:new Date().toISOString(),rootDir:r,files:{},regions:{},regionsByName:{},importGraph:{},checksums:{},mtimes:{}};for(let i of o.sort()){let a=sp(r,i),l=ws.default.statSync(a),d=ws.default.readFileSync(a,"utf-8"),u=np(d),p=[],f=new Set,h=ip(d,a,i,f,p,s),b={path:i,checksum:u,mtime:l.mtimeMs,size:l.size,imports:Array.from(f),regionIds:p,hasGlobalRegion:h};s.files[i]=b,s.importGraph[i]=b.imports,s.checksums[i]=u,s.mtimes[i]=l.mtimeMs}return up(s.importGraph),pp(s),s}async function op(e){let{globby:t}=await import("globby");return t("**/*.http",{cwd:e})}function sp(e,t){return he.default.isAbsolute(t)?t:he.default.join(e,t)}function np(e){return Ba.default.createHash("sha256").update(e).digest("hex")}function ip(e,t,r,o,s,n){var u,p;let i=e.split(/\r?\n/u),a=!1,l=ja(0),d=f=>{l.endLine=f;let h=ap(l,t,r);if(n.regions[h.id]=h,s.push(h.id),h.name){let b=n.regionsByName[h.name]||[];b.push(h.id),n.regionsByName[h.name]=b}h.isGlobal&&(a=!0)};for(let f=0;f<i.length;f+=1){let h=i[f],b=me.exec(h);if(b){d(Math.max(f-1,l.startLine)),l=ja(f+1);let H=(p=(u=b.groups)==null?void 0:u.title)==null?void 0:p.trim();if(H){let R=Ma(`# ${H}`);R&&Va(R,l,o,f+1,r)}continue}let k=Ma(h);k&&Va(k,l,o,f+1,r),dp(h)&&(l.hasRequest=!0)}return d(i.length-1),a}function ja(e){return{startLine:e,endLine:e,tags:[],refs:[],forceRefs:[],hasRequest:!1}}function ap(e,t,r){let o=`${t}_${e.startLine}`,s=`${r}:${e.startLine}`;return{id:o,modelId:s,file:r,startLine:e.startLine,endLine:e.endLine,name:e.name,tags:vs(e.tags),refs:vs(e.refs),forceRefs:vs(e.forceRefs),isGlobal:!e.hasRequest}}function Ma(e){var s;let t=/^\s*(#+|\/{2,})\s+@(?<key>[^\s]+)\s*(?<value>.*)$/u.exec(e);if(!((s=t==null?void 0:t.groups)!=null&&s.key))return null;let r=t.groups.key;if(!["name","tag","ref","forceRef","import"].includes(r))return null;let o=(t.groups.value||"").trim();return{key:r,value:o}}function Va(e,t,r,o,s){switch(e.key){case"import":Yr(e.value,"Dynamic import not allowed",o),r.add(lp(e.value,s));break;case"name":Yr(e.value,"Dynamic @name not allowed",o),t.name=e.value;break;case"tag":t.tags.push(...Rs(e.value));break;case"ref":Yr(e.value,"Dynamic ref not allowed",o),t.refs.push(...Rs(e.value));break;case"forceRef":Yr(e.value,"Dynamic ref not allowed",o),t.forceRefs.push(...Rs(e.value));break;default:break}}function Rs(e){return e.split(/[,\s]+/u).map(t=>t.trim()).filter(Boolean)}function Yr(e,t,r){if(rp.test(e))throw new Error(`${t} (line ${r}): use literal. Found: ${e}`)}function lp(e,t){if(he.default.isAbsolute(e))return e;let r=he.default.dirname(t);return he.default.normalize(he.default.join(r,e)).split(he.default.sep).join("/")}function dp(e){return/^\s*(GET|POST|PUT|DELETE|PATCH|OPTIONS|HEAD|TRACE|CONNECT)\s+/iu.test(e)}function up(e){let t=[],r=new Set,o=s=>{if(t.includes(s)){let i=t.indexOf(s),a=[...t.slice(i),s];throw new Error(`Circular import: ${a.join(" \u2192 ")}`)}if(r.has(s))return;r.add(s),t.push(s);let n=e[s]||[];for(let i of n)o(i);t.pop()};Object.keys(e).forEach(o)}function pp(e){for(let t of Object.keys(e.files)){let r=cp(t,e.importGraph),o=new Map;for(let s of r){let n=e.files[s];if(n)for(let i of n.regionIds){let a=e.regions[i];if(a!=null&&a.name){let l=o.get(a.name);if(l)throw new Error(`Duplicate @name "${a.name}" in scope of ${t}: ${l} and ${a.file}:${a.startLine}`);o.set(a.name,`${a.file}:${a.startLine}`)}}}}}function cp(e,t){let r=[],o=[e],s=new Set;for(;o.length>0;){let n=o.shift();if(s.has(n))continue;s.add(n),r.push(n);let i=t[n]||[];for(let a of i)o.push(a)}return r}function vs(e){return Array.from(new Set(e))}function Ua(e){let t=[],r=new Set,o=fp(e);for(let s of o){if(r.has(s.id))continue;let n=[],i=new Set,a=!1,l=s;for(;l&&(n.unshift(l.id),r.add(l.id),l.refs.forEach(d=>i.add(d.id)),l.forceRefs.length!==0);){if(l.forceRefs.length>1){l.forceRefs.forEach(d=>i.add(d.id)),a=!0;break}l=l.forceRefs[0]}if(!a&&n.length>1){let d=n[n.length-1];t.push({id:`chain_${n[0]}_${d}`,regionIds:n,softDeps:i})}}return mp(t)}function fp(e){let t=[],r=new Map;for(let o of Object.values(e.nodes))for(let s of o.forceRefs)r.set(s.id,(r.get(s.id)||0)+1);for(let o of Object.values(e.nodes))o.forceRefs.length>0&&!r.has(o.id)&&t.push(o);return t}function mp(e){let t=[],r=e.sort((o,s)=>s.regionIds.length-o.regionIds.length||o.id.localeCompare(s.id));for(let o of r){let s=t.find(n=>gp(n.regionIds,o.regionIds));if(s){o.softDeps.forEach(n=>s.softDeps.add(n));continue}t.push(o)}return t}function gp(e,t){return e.length<t.length?!1:t.every((r,o)=>e[o]===r)}var tt=L(require("path"));var hp={createProcessorContext:Ne,executeGlobalScripts:ve};async function Ps(e,t,r,o,s={},n=hp){var b,k;if(s.showPlan)return Hp(e,t),[];let i=o.processedHttpRegions||[];o.processedHttpRegions=i;let a=xp(r,t),l=Rp(r,t.rootDir),d=new Set,u=new Set,p=new Set,f=[],h=!!s.resumeState;for(let H of e.stages)for(let R of H.units)for(let y of R.regionIds){let w=a.get(y);if(!w)throw new Error(`Region ${y} not found in loaded http files`);if(h)if(s.resumeState&&vp(w.httpRegion,w.httpFile,s.resumeState))h=!1;else{u.add(y);continue}let B=w.httpFile.fileName,Q=typeof B=="string"?B:((b=B==null?void 0:B.toString)==null?void 0:b.call(B))||"";!p.has(Q)&&o.scriptConsole&&(o.scriptConsole.info(`--------------------- ${Q}  --`),p.add(Q)),await _a(w.entry.file,t,l,o,n,d);let ye={...o,httpFile:w.httpFile,httpRegion:w.httpRegion,variables:o.variables||{},options:o.options||{},scriptConsole:o.scriptConsole,logResponse:o.logResponse,logStream:o.logStream},re=performance.now(),ne=i.length,st=await w.httpRegion.execute(ye,!0);u.add(y),yp(w.httpRegion,ye);let ke=i.length,nt;if(ke>ne?nt=i[ke-1]:(nt=bp(w.httpRegion,w.httpFile,re),i.push(nt),(k=o.processedHttpRegionListener)==null||k.call(o,nt)),f.push(nt),!st)return f}return kp(e,u),f}function yp(e,t){let r=I(t.activeEnvironment),o=e.variablesPerEnv[r];o&&D(o,t)}function bp(e,t,r){var s;let o=performance.now();return{id:e.id,filename:t.fileName,symbol:e.symbol,isGlobal:e.isGlobal(),metaData:{...e.metaData},testResults:e.testResults,request:(s=e.response)==null?void 0:s.request,response:e.response,start:r,end:o,duration:o-r}}function xp(e,t){let r=new Map;for(let o of e)for(let s of o.httpRegions){let n=t.regions[s.id];n&&r.set(s.id,{httpRegion:s,httpFile:o,entry:n})}return r}function Rp(e,t){let r=new Map;for(let o of e){let s=Pp(o.fileName,t);s&&r.set(s,o)}return r}async function _a(e,t,r,o,s,n){var u;if(n.has(e))return;let i=t.importGraph[e]||[];for(let p of i)await _a(p,t,r,o,s,n);let a=r.get(e);if(!a)throw new Error(`HTTP file not loaded for ${e}`);let l={...o,httpFile:a,httpRegion:a.httpRegions[0]||{},variables:o.variables||{},options:o.options||{},processedHttpRegions:[]};await s.executeGlobalScripts(l);let d=I(o.activeEnvironment);try{if(Array.isArray(a.globalHttpRegions))for(let p of a.globalHttpRegions){let f=(u=p==null?void 0:p.variablesPerEnv)==null?void 0:u[d];f&&D(f,o)}}catch{}l.variables&&(o.variables={...o.variables||{},...l.variables}),n.add(e)}function vp(e,t,r){let o=wp(t);return!o||o!==r.fileName?!1:e.symbol.startLine===r.line}function wp(e){let t=typeof e.fileName=="string"?e.fileName:e.fileName&&"toString"in e.fileName?e.fileName.toString():void 0;if(t)return tt.default.isAbsolute(t)?tt.default.relative(process.cwd(),t):t}function Pp(e,t){if(!e)return;let r=typeof e=="string"?e:e&&"toString"in e?e.toString():void 0;return r?(tt.default.isAbsolute(r)?tt.default.relative(t,r):r).split(tt.default.sep).join("/"):void 0}function Ga(e,t){let r=new Set;for(let o of e.stages)for(let s of o.units)for(let n of s.regionIds){let i=t.regions[n];i&&r.add(i.file)}return r.size}function kp(e,t){let r=e.requestedRegionIds.filter(o=>!t.has(o));if(r.length>0)throw new Error(`Execution coverage failed. Missing requested regions: ${r.join(", ")}`)}function Hp(e,t){let r=[];r.push("Execution Plan:"),e.stages.forEach((o,s)=>{for(let n of o.units){let i=n.type==="chain"?"chain":"region",a=n.regionIds.map(l=>{var d;return((d=t.regions[l])==null?void 0:d.name)||l}).join(" \u2192 ");r.push(`  Stage ${s+1}: [${i}] ${a} (reason: ${n.reason})`)}}),r.push(`Total: ${e.stats.totalRegions} requests`),console.info(r.join(`
`))}function Wa(e){let t={};Object.values(e.regions).forEach(r=>{t[r.id]=Sp(r)});for(let r of Object.values(t)){let o=r.region;for(let s of o.refs){let n=Ka(s,o.file,e);if(!n)throw new Error(`ref "${s}" not found in scope ${o.file}`);let i=t[n.id];r.refs.push(i),i.dependents.push(r)}for(let s of o.forceRefs){let n=Ka(s,o.file,e);if(!n)throw new Error(`ref "${s}" not found in scope ${o.file}`);let i=t[n.id];r.forceRefs.push(i),i.dependents.push(r)}}return Tp(t),{nodes:t}}function Ka(e,t,r){let o=Cp(t,r),s=[];for(let n of o){let i=r.files[n];if(i)for(let a of i.regionIds){let l=r.regions[a];(l==null?void 0:l.name)===e&&s.push(l)}}if(s.length===0)return null;if(s.length>1)throw new Error(`Ambiguous reference "${e}" in scope ${t}: ${s.map(n=>`${n.file}:${n.startLine}`).join(", ")}`);return s[0]}function Cp(e,t){let r=[e],o=[e],s=new Set([e]);for(;o.length>0;){let n=o.shift(),i=t.importGraph[n]||[];for(let a of i)s.has(a)||(s.add(a),r.push(a),o.push(a))}return r}function Sp(e){return{id:e.id,region:e,refs:[],forceRefs:[],dependents:[]}}function Tp(e){let t=new Set,r=new Set,o=(s,n)=>{if(r.has(s.id))return;if(t.has(s.id)){let a=n.indexOf(s.id),l=[...n.slice(a),s.id];throw new Error(`Circular reference: ${l.join(" \u2192 ")}`)}t.add(s.id);let i=[...n,s.id];for(let a of[...s.refs,...s.forceRefs])o(a,i);t.delete(s.id),r.add(s.id)};Object.values(e).forEach(s=>o(s,[]))}function Xa(e,t,r,o={}){let s=Lp(e,o),n=new Set(s),i=Op(n,t,r),a=$p(i,r);a.forEach(b=>b.regionIds.forEach(k=>i.add(k))),a.forEach(b=>b.softDeps.forEach(k=>i.add(k)));let l=Ja(e,i,n,a),d;try{d=za(l,t,a)}catch(b){if(Fp(b))a=[],l=Ja(e,i,n,a),d=za(l,t,a);else throw b}let u=l.reduce((b,k)=>b+k.regionIds.length,0),p=l.filter(b=>b.reason==="filter_match").length,f=l.filter(b=>b.type==="chain").length,h=l.length-p-f;return{stages:d,requestedRegionIds:s,stats:{totalRegions:u,leafRegions:p,dependencyRegions:h,forceRefChains:f,requestedRegions:s.length}}}function Lp(e,t){if(t.selection&&t.selection.length>0)return t.selection.map(n=>e.regions[n]).filter(n=>!!n&&!n.isGlobal).map(n=>n.id);let r=t.filters||{},o=[],s=Object.values(e.files);for(let n of s)for(let i of n.regionIds){let a=e.regions[i];!a||a.isGlobal||qp(a,r)&&o.push(a.id)}if(o.length===0&&!Ep(r))for(let n of s)for(let i of n.regionIds){let a=e.regions[i];a&&!a.isGlobal&&o.push(a.id)}return o}function Ep(e){return!!(e.tags&&e.tags.length>0||e.names&&e.names.length>0||e.line!==void 0)}function qp(e,t){return!(t.tags&&t.tags.length>0&&!t.tags.every(r=>e.tags.includes(r))||t.names&&t.names.length>0&&(!e.name||!t.names.includes(e.name))||typeof t.line=="number"&&(t.line<e.startLine||t.line>e.endLine))}function Op(e,t,r){let o=new Set,s=[...e],n=new Set;for(r.forEach(a=>a.regionIds.forEach(l=>n.add(l)));s.length>0;){let a=s.pop();if(o.has(a))continue;o.add(a);let l=t.nodes[a];l&&(l.refs.forEach(d=>{o.has(d.id)||s.push(d.id)}),l.forceRefs.forEach(d=>{o.has(d.id)||s.push(d.id)}))}let i=[];for(let a of r)a.regionIds.some(l=>o.has(l))&&(a.regionIds.forEach(l=>o.add(l)),a.softDeps.forEach(l=>{o.has(l)||(o.add(l),i.push(l))}));for(;i.length>0;){let a=i.pop(),l=t.nodes[a];l&&(l.refs.forEach(d=>{o.has(d.id)||(o.add(d.id),i.push(d.id))}),l.forceRefs.forEach(d=>{o.has(d.id)||(o.add(d.id),i.push(d.id))}))}return o}function $p(e,t){return t.filter(r=>r.regionIds.some(o=>e.has(o)))}function Ja(e,t,r,o){let s=[],n=new Set;for(let i of o)s.push({id:i.id,type:"chain",regionIds:i.regionIds,reason:"forceRef_chain"}),i.regionIds.forEach(l=>n.add(l));return t.forEach(i=>{if(n.has(i)||!e.regions[i])return;let l=r.has(i)?"filter_match":"ref_dependency";s.push({id:i,type:"region",regionIds:[i],reason:l})}),s.sort((i,a)=>i.id.localeCompare(a.id)),s}function Ap(e){let t=new Map,r=e.slice().sort((o,s)=>s.regionIds.length-o.regionIds.length||o.id.localeCompare(s.id));for(let o of r)for(let s of o.regionIds)t.has(s)||t.set(s,o);return t}function za(e,t,r){let o=new Map(e.map(u=>[u.id,u])),s=Dp(e,r),n=new Map,i=new Map;for(let u of e)n.set(u.id,new Set),i.set(u.id,0);let a=(u,p)=>{if(u===p)return;let f=n.get(u);f&&(f.has(p)||(f.add(p),i.set(p,(i.get(p)||0)+1)))};for(let u of e){for(let p of u.regionIds){let f=t.nodes[p];if(!f)continue;[...f.refs.map(b=>b.id),...f.forceRefs.map(b=>b.id)].forEach(b=>{let k=s.get(b),H=s.get(p);k&&H&&a(k,H)})}if(u.type==="chain"){let p=r.find(f=>f.id===u.id);p==null||p.softDeps.forEach(f=>{let h=s.get(f);h&&a(h,u.id)})}}let l=[];i.forEach((u,p)=>{u===0&&l.push(p)}),l.sort();let d=[];for(;l.length>0;){let u=l.shift(),p=o.get(u);if(!p)continue;d.push({units:[p]});let f=n.get(u);f&&f.forEach(h=>{let b=(i.get(h)||0)-1;i.set(h,b),b===0&&(l.push(h),l.sort())})}if(d.length!==e.length){let u=e.map(h=>({unit:h,indegree:i.get(h.id)||0})).filter(h=>h.indegree>0).map(h=>`${h.unit.id}(${h.indegree})`),p=e.filter(h=>!u.some(b=>b.startsWith(h.id))).map(h=>h.id),f=[...u,...p].join(", ");throw new Error(`Circular reference detected in execution plan. Remaining: ${f}`)}return d}function Dp(e,t){let r=new Map,o=Ap(t);for(let s of e)for(let n of s.regionIds)if(s.type==="chain")r.set(n,s.id);else{let i=o.get(n);r.set(n,i?i.id:s.id)}return r}function Fp(e){return e instanceof Error&&e.message.startsWith("Circular reference detected in execution plan")}async function Ya(e,t={}){if(!t.noCache){let o=await Da(e);if(o&&(await Ia(o,e)).valid)return o}let r=await Na(e,t);return t.noCache||await Fa(e,r),r}function ks(e){if(e.json||e.jsonl)return 1e3;if(e.silent)return 100;if(e.verbose)return 1}var Hs=!1,Qa={id:"bailOnFailed",beforeLoop:async function(t){if(Hs){let[r]=t.args;return te(r.httpRegion,"request skipped because of bail"),!1}return!0},onError:async function(){return Hs=!0,!0},afterTrigger:async function(t){var s,n;return((n=(s=t.args[0].httpRegion.testResults)==null?void 0:s.find)==null?void 0:n.call(s,i=>["FAILED"].includes(i.status)))&&(Hs=!0),!0}};var Za={id:"loggerFlush",afterLoop:async function(t){var o,s;let r=t.args[0];return(s=(o=r==null?void 0:r.scriptConsole)==null?void 0:o.flush)==null||s.call(o),!0}};var el={id:"testExitCode",onError:async function(){return process.exitCode=10,!0},afterTrigger:async function(t){let r=t.args[0];if(r.httpRegion.testResults===void 0)return!0;let o=!1,s=!1;for(let n of r.httpRegion.testResults){if(n.status==="ERROR"){o=!0;break}n.status==="FAILED"&&(s=!0)}return o?process.exitCode=19:s&&(process.exitCode=20),!0}};function tl(e){return function(r){r.hooks.execute.addInterceptor(Za),r.hooks.execute.addInterceptor(el),e&&r.hooks.execute.addInterceptor(Qa)}}async function rl(e,t){return Ip(t)?jp(e,t):e.map(o=>({httpFile:o}))}function Ip(e){return!!(e.tag&&e.tag.length>0||e.name&&e.name.length>0||e.line!==void 0)}function jp(e,t){let r=[],o=t.tag||[],s=t.name||[],n=t.line;for(let i of e){let a=i.httpRegions.filter(l=>!(o.length>0&&!Mp(l,o)||s.length>0&&!Vp(l,s)||n!==void 0&&!Bp(l,n)));a.length>0&&r.push({httpFile:i,httpRegions:a})}return r}function Mp(e,t){var o;if(!m((o=e.metaData)==null?void 0:o.tag))return!1;let r=e.metaData.tag.split(",").map(s=>s.trim()).filter(Boolean);return r.length===0?!1:t.every(s=>r.includes(s))}function Vp(e,t){var r;return m((r=e.metaData)==null?void 0:r.name)?t.includes(e.metaData.name):!1}function Bp(e,t){return e.symbol.startLine<=t&&e.symbol.endLine>=t}function nl(){return new sl.Command("uctest").description("HTTP test runner for Unsafe Code Lab").usage("[@tag...] [:name...] [path...] [options]").argument("[args...]","Tags (@tag), names (:name), and paths").option("-k, --keep-going","continue running after failures (default: stop on first)").option("--json","use json output").option("--jsonl","stream json lines output").option("-l, --line <line>","line of the http requests",C).option("--no-color","disable color support").option("-o, --output <output>","output format of response (short, body, headers, response, exchange, none)","none").option("--output-failed <output>","output format of failed response (short, body, headers, response, exchange, none)","exchange").option("-s, --silent","log only request").option("--prune-refs","only execute leaf requests (prune referenced dependencies)").option("--no-cache","skip cache, always rebuild dependency model").option("--show-plan","print execution plan without running").option("-r, --resume","resume from last failed request").option("--state-file <path>","path to state file for resume (default: .uctest-state)").option("--timeout <timeout>","maximum time allowed for connections",C).option("--var  <variables...>",'list of variables (e.g foo="bar")').option("-v, --verbose","make the operation more talkative").action(Up)}function Np(e){let t=[],r=[],o=[];for(let s of e)if(s.startsWith("@")){let n=s.slice(1);n&&(n.includes(",")&&(console.error(`Error: Commas not supported in tags. Use separate arguments: @${n.split(",").join(" @")}`),process.exit(1)),t.push(n))}else if(s.startsWith(":")){let n=s.slice(1);n&&r.push(n)}else o.push(s);return{tags:t,names:r,paths:o}}async function Up(e,t){var f,h;let r=Np(e);r.tags.length>0&&(t.tag=r.tags),r.names.length>0&&(t.name=r.names);let o=r.paths.length>0?r.paths:["./**/*.http"],s=!t.keepGoing,n=Zp(t),{httpFiles:i,config:a,httpFileStore:l}=await tc(o,s,n.config||{});n.config=a,ec(t,n);let d=(0,M.join)(process.cwd(),".uctest-state"),u=t.resume?t.stateFile||d:void 0,p=u?await Qp(u):void 0;try{if(i.length>0){let b=await rl(i,t);if(b.length===0&&(console.error("No tests match the specified filters"),process.exit(1)),t.pruneRefs){await Wp(i,l,b,n,t,p,u,s);return}p&&(b=Xp(b,p),p=void 0);let k=_p(b,i),H=k.totalRequests,R=k.totalFiles,y=0,w=t.jsonl?ll():void 0;t.jsonl?(w==null||w({type:"start",totalRequests:H,totalFiles:R}),n.processedHttpRegionListener=re=>{y+=1,w==null||w({type:"request",index:y,totalRequests:H,request:jt(re,t)})}):n.processedHttpRegionListener=void 0,n.processedHttpRegions=[];let B=b.map(({httpFile:re,httpRegions:ne})=>async function(){!t.json&&n.scriptConsole&&n.scriptConsole.info(`--------------------- ${re.fileName}  --`),await xs(Object.assign({},n,{httpFile:re,httpRegions:ne}))});await Mo(1,...B);let Q=n.processedHttpRegions||[],ye=t.resume&&s?ul(Q):void 0;if(t.jsonl){y=al(Q,t,w,y,H);let re=Xr(Q,t);w==null||w({type:"summary",totalRequests:H,totalFiles:R,summary:re.summary})}else il(n,t);u&&t.resume&&s&&(ye?await cl(u,ye):await fl(u))}else console.error(`uctest cannot find any .http files matching: ${o.join(", ")}`)}finally{(h=(f=n.scriptConsole)==null?void 0:f.flush)==null||h.call(f)}}function il(e,t){let r=e.processedHttpRegions||[],o=Xr(r,t);if(t.json)console.info(F(o,2));else if(e.scriptConsole){e.scriptConsole.info("");let s=[];o.summary.successRequests>0&&s.push(rt.default`{green ${o.summary.successRequests} succeeded}`),o.summary.failedRequests>0&&s.push(rt.default`{red ${o.summary.failedRequests} failed}`),o.summary.erroredRequests>0&&s.push(rt.default`{red ${o.summary.erroredRequests} errored}`),o.summary.skippedRequests>0&&s.push(rt.default`{yellow ${o.summary.skippedRequests} skipped}`),e.scriptConsole.info(rt.default`{bold ${o.summary.totalRequests}} requests processed (${s.join(", ")})`)}}function al(e,t,r,o,s){if(!r)return o;for(let n=o;n<e.length;n+=1)r({type:"request",index:n+1,totalRequests:s,request:jt(e[n],t)});return Math.max(o,e.length)}function ll(){return e=>{process.stdout.write(`${F(e)}
`)}}function _p(e,t){var a,l,d,u,p;let r=new Map,o=new Map;for(let f of t)for(let h of f.httpRegions){o.set(h,f);let b=v((a=h.metaData)==null?void 0:a.name);if(!b)continue;let k=r.get(b)||[];k.push(h),r.set(b,k)}let s=new Set,n=new Set,i=[];for(let{httpFile:f,httpRegions:h}of e){let b=h??f.httpRegions;for(let k of b)((l=k.metaData)==null?void 0:l.disabled)===!0||(d=k.metaData)!=null&&d.skip||i.push(k)}for(;i.length>0;){let f=i.pop();if(!f||s.has(f))continue;s.add(f);let h=o.get(f);h&&n.add(h);for(let b of zp(f)){let k=r.get(b);if(k)for(let H of k)((u=H.metaData)==null?void 0:u.disabled)===!0||(p=H.metaData)!=null&&p.skip||i.push(H)}}return{totalRequests:s.size,totalFiles:n.size}}function Gp(e){var r,o;let t=[];for(let{httpFile:s,httpRegions:n}of e){let i=n??s.httpRegions;for(let a of i)((r=a.metaData)==null?void 0:r.disabled)===!0||(o=a.metaData)!=null&&o.skip||a.isGlobal()||t.push(a.id)}return t}async function Kp(e,t,r,o,s){let n=new Map;for(let d of r){let u=dl(d.fileName,t.rootDir);u&&n.set(u,d)}let i=new Set;for(let d of e.stages)for(let u of d.units)for(let p of u.regionIds){let f=t.regions[p];f&&i.add(f.file)}let a=Array.from(i);for(;a.length>0;){let d=a.pop();if(!d)continue;let u=t.importGraph[d]||[];for(let p of u)i.has(p)||(i.add(p),a.push(p))}let l={workingDir:process.cwd(),config:s};for(let d of Array.from(i)){if(n.has(d))continue;let u=(0,M.join)(t.rootDir,d),p=await o.getOrCreate(u,async()=>await ot.promises.readFile(u,"utf8"),0,l);n.set(d,p),r.push(p)}return l.config}async function Wp(e,t,r,o,s,n,i,a){var ye,re;let l=Gp(r),d=Jp(e),u=await Ya(d,{noCache:s.noCache}),p=Wa(u),f=Ua(p),h=Xa(u,p,f,{selection:l,filters:{tags:s.tag,names:s.name,line:s.line}});if(s.showPlan){await Ps(h,u,e,o,{showPlan:!0});return}o.options={...o.options||{},skipRefResolution:!0},o.processedHttpRegions=[];let b=h.requestedRegionIds[0]||((re=(ye=h.stages[0])==null?void 0:ye.units[0])==null?void 0:re.regionIds[0]);if(b){let ne=u.regions[b];if(ne){let st=e.find(ke=>dl(ke.fileName,u.rootDir)===ne.file);if(st){let ke=await Ne({...o,httpFile:st});ke.variables&&(o.variables={...o.variables||{},...ke.variables})}}}let k=await Kp(h,u,e,t,o.config);o.config=k||o.config;let H=h.stats.totalRegions,R=Ga(h,u),y=0,w=s.jsonl?ll():void 0;s.jsonl?(w==null||w({type:"start",totalRequests:H,totalFiles:R}),o.processedHttpRegionListener=ne=>{y+=1,w==null||w({type:"request",index:y,totalRequests:H,request:jt(ne,s)})}):o.processedHttpRegionListener=void 0,await Ps(h,u,e,o,{resumeState:n});let B=o.processedHttpRegions||[],Q=s.resume&&a?ul(B):void 0;if(s.jsonl){y=al(B,s,w,y,H);let ne=Xr(B,s);w==null||w({type:"summary",totalRequests:H,totalFiles:R,summary:ne.summary})}else il(o,s);i&&s.resume&&a&&(Q?await cl(i,Q):await fl(i))}function dl(e,t){if(!e)return;let r=c.fsPath(e)||c.toString(e);return r?((0,M.isAbsolute)(r)?(0,M.relative)(t,r):r).split(M.sep).join("/"):void 0}function ul(e){return e.find(t=>{var r;return(r=t.testResults)==null?void 0:r.some(o=>o.status==="ERROR"||o.status==="FAILED")})}function Jp(e){let t=e.map(i=>c.fsPath(i.fileName)||c.toString(i.fileName)).filter(i=>!!i).map(i=>(0,M.isAbsolute)(i)?i:(0,M.resolve)(process.cwd(),i));if(t.length===0)return process.cwd();let r=(0,M.parse)(t[0]).root||process.cwd(),o=t.map(i=>{let a=(0,M.parse)(i).dir,l=(0,M.relative)(r,a);return l?l.split(M.sep).filter(Boolean):[]}),s=Math.min(...o.map(i=>i.length)),n=[];for(let i=0;i<s;i+=1){let a=o[0][i];if(o.every(l=>l[i]===a))n.push(a);else break}return(0,M.join)(r,...n)}function zp(e){var o,s;let t=[],r=[(o=e.metaData)==null?void 0:o.ref,(s=e.metaData)==null?void 0:s.forceRef];for(let n of r){if(!n||n===!0)continue;let i=v(n);if(!i)continue;let a=i.split(/[,\s]+/u).map(l=>l.trim()).filter(Boolean);t.push(...a)}return t}function Xp(e,t){var s,n;let r=[],o=!0;for(let i of e){let a=i.httpRegions??i.httpFile.httpRegions,l=pl(i.httpFile.fileName),d=[];for(let u of a)((s=u.metaData)==null?void 0:s.disabled)===!0||(n=u.metaData)!=null&&n.skip||(o?Yp(l,u,t)&&(o=!1,d.push(u)):d.push(u));if(d.length>0){let u=a===i.httpFile.httpRegions&&d.length===a.length;r.push({httpFile:i.httpFile,httpRegions:u?void 0:d})}}return o?e:r}function Yp(e,t,r){return!e||e!==r.fileName?!1:t.symbol.startLine===r.line}function pl(e){if(!e)return;let t=c.fsPath(e)||c.toString(e);if(t)return(0,M.isAbsolute)(t)?(0,M.relative)(process.cwd(),t):t}async function Qp(e){try{let t=await ot.promises.readFile(e,"utf-8");return JSON.parse(t)}catch(t){t.code!=="ENOENT"&&console.warn(`Failed to read resume state from ${e}:`,t);return}}async function cl(e,t){var s;let r=pl(t.filename);if(!r)return;let o={fileName:r,line:t.symbol.startLine,name:v((s=t.metaData)==null?void 0:s.name)};await ot.promises.writeFile(e,F(o,2))}async function fl(e){try{await ot.promises.unlink(e)}catch(t){t.code!=="ENOENT"&&console.warn(`Failed to clear resume state at ${e}:`,t)}}function Zp(e){return{config:{log:{level:ks(e)},request:{timeout:e.timeout}},variables:e.var?Object.fromEntries(e.var.map(r=>{let o=r.split("=");return[o[0],o.slice(1).join("=")]})):void 0,options:{}}}function ec(e,t){if(e.jsonl)return;let r=new _e({level:ks(e)});if(r.collectMessages(),t.scriptConsole=r,!e.json){t.logStream=oc(e);let o=sc(e,t.config,r);t.logResponse=async(s,n)=>{o&&await o(s,n),r.flush()}}}async function tc(e,t,r){let o=[],s=new Et({cli:tl(t)}),n={workingDir:process.cwd(),config:r},i=[];for(let a of e)i.push(...await rc(a));for(let a of i){let l=await s.getOrCreate(a,async()=>await ot.promises.readFile(a,"utf8"),0,n);o.push(l)}return{httpFiles:o,config:n.config,httpFileStore:s}}async function rc(e){let t={gitignore:!0},{globby:r}=await import("globby"),o=await r(e,t);return o&&o.length>0||M.sep==="/"?o:await r(e.replace(/\\/gu,"/"),t)}function oc(e){if(e.output!=="none")return async function(r,o){let s=Buffer.isBuffer(o.body)?o.body.toString("utf-8"):o.body;console.info(`${new Date().toLocaleTimeString()} - ${r}: `,s)}}function sc(e,t,r){var i,a;let o={responseBodyPrettyPrint:!0},s=ol(e.output,o,(i=t==null?void 0:t.log)==null?void 0:i.options),n=ol(e.outputFailed,o,(a=t==null?void 0:t.log)==null?void 0:a.options);if(s||n)return lo(l=>r.logPriority(l),s,n)}function ol(e,...t){let r;switch(e){case"body":r={responseBodyLength:0};break;case"headers":r={requestOutput:!0,requestHeaders:!0,responseHeaders:!0};break;case"response":r={responseHeaders:!0,responseBodyLength:0};break;case"none":return;case"short":r={useShort:!0};break;case"timings":r={timings:!0};break;case"exchange":r={requestOutput:!0,requestHeaders:!0,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0,timings:!0};break;default:r={requestOutput:!0,requestHeaders:!0,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0};break}return Object.assign({},...t,r)}async function gl(){let e=await Rt((0,ml.join)(__dirname,"../package.json")),t=nl();return t.version((e==null?void 0:e.version)||"0.0.1"),t}async function nc(e){try{await Bo(),await(await gl()).parseAsync(e)}catch(t){throw console.error(t),process.exitCode||(process.exitCode=1),t}finally{process.exit()}}0&&(module.exports={AbstractRequestClient,ExecuteHook,HookCancel,HttpSymbol,HttpSymbolKind,LogLevel,OnRequestHook,OnResponseHook,OnStreaming,ParseEndRegionHook,ParseHook,ParseMetaDataHook,ProvideAssertValue,ProvideEnvironmentsHook,ProvideVariablesHook,RepeatOrder,ReplaceVariableHook,RequestClientEvent,ResponseLoggingHook,TestResultStatus,VariableType,cli,createEmptyProcessorContext,getEnvironments,getVariables,io,send,store,testSymbols,utils});
//# sourceMappingURL=index.js.map
